<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.514">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Rich Harris">

<title>Creating harmonised pseudo-Output Areas for the 2001, 2011 &amp; 2021 Censuses (England and Wales)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Creating harmonised pseudo-Output Areas for the 2001, 2011 &amp; 2021 Censuses (England and Wales)</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Rich Harris </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<p><strong>Please cite as</strong></p>
<p>Harris R (2022) Creating harmonised pseudo-Output Areas for the 2001, 2011 &amp; 2021 Censuses (England and Wales). <a href="https://profrichharris.github.io/census/harmonised" class="uri">https://profrichharris.github.io/census/harmonised</a>.</p>
<p>The resulting files can be downloaded from <a href="https://www.dropbox.com/sh/jq4dkokxyflxpei/AAD1GOvoN7R_YyRQSN3aSMQ4a?dl=0" class="uri">https://www.dropbox.com/sh/jq4dkokxyflxpei/AAD1GOvoN7R_YyRQSN3aSMQ4a?dl=0</a></p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>One of the great step forwards from the 2001 Census onwards was the use of statistical Output Areas (OAs) at the most granular scale that are kept as consistent as possible from one census to the next. However, a few do change so, to make analysing change over time a little easier, we can lightly aggregate them into a consistent set of pseudo-OAs that have the same geography for each census.</p>
</section>
<section id="source-data" class="level2">
<h2 class="anchored" data-anchor-id="source-data">Source data</h2>
<p>The key to it all are the following lookup files: <a href="https://geoportal.statistics.gov.uk/maps/output-area-2001-to-output-area-2011-to-local-authority-district-2011-lookup-in-england-and-wales-1" class="uri">https://geoportal.statistics.gov.uk/maps/output-area-2001-to-output-area-2011-to-local-authority-district-2011-lookup-in-england-and-wales-1</a></p>
<p>and, <a href="https://geoportal.statistics.gov.uk/maps/output-areas-2011-to-output-areas-2021-to-local-authority-district-2022-lookup-in-england-and-wales-version-2-1" class="uri">https://geoportal.statistics.gov.uk/maps/output-areas-2011-to-output-areas-2021-to-local-authority-district-2022-lookup-in-england-and-wales-version-2-1</a></p>
<p>We can begin by reading them into R, joining them together, and tidying them up a little:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(data.table)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">fread</span>(<span class="st">"https://www.dropbox.com/s/7xb76wliw4qoy4q/Output_Area_%282001%29_to_Output_Area_%282011%29_to_Local_Authority_District_%282011%29_Lookup_in_England_and_Wales.csv?dl=1"</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">showProgress =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">select =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span> <span class="dv">4</span>)) <span class="sc">|&gt;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fread</span>(<span class="st">"https://www.dropbox.com/s/wn6y5juef85nlgf/OA_%282011%29_to_OA_%282021%29_to_Local_Authority_District_%282022%29_for_England_and_Wales_Lookup.csv?dl=1"</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">showProgress =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">select =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span> <span class="dv">5</span>)) <span class="sc">|&gt;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>(),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"OA11CD"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">CHG11 =</span> CHGIND, <span class="at">CHG21 =</span> CHNGIND) <span class="sc">|&gt;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CHG21 =</span> <span class="fu">ifelse</span>(CHG21 <span class="sc">==</span> <span class="st">"x"</span>, <span class="st">"X"</span>, CHG21)) <span class="ot">-&gt;</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What we obtain is a data file, <code>df</code>, which shows all the ‘connections’ between Output Areas from the 2001 Census, <code>OA01CD</code>, to the 2011 Census, <code>OA11CD</code>, to the 2021 Census, <code>OA21CD</code>. For example, OA E00000001 is unchanged (“U”) across censuses, whereas E00000004 is merged (“M”) into E00166758 for 2011 but split (“S”) into OAs that include E00190429 in 2021:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(OA01CD <span class="sc">==</span> <span class="st">"E00000001"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 8
  OA01CD    OA01CDO    OA11CD    CHG11 OA21CD    CHG21 LAD22CD   LAD22NM       
  &lt;chr&gt;     &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;         
1 E00000001 00AAFA0001 E00000001 U     E00000001 U     E09000001 City of London</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(OA01CD <span class="sc">==</span> <span class="st">"E00000004"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 8
  OA01CD    OA01CDO    OA11CD    CHG11 OA21CD    CHG21 LAD22CD   LAD22NM       
  &lt;chr&gt;     &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;         
1 E00000004 00AAFA0004 E00166758 M     E00190429 S     E09000001 City of London
2 E00000004 00AAFA0004 E00166758 M     E00190433 S     E09000001 City of London</code></pre>
</div>
</div>
<p>The extra <code>OA01CDO</code> arises because the original 2001 Census Output Area codes were recoded prior to 2011. <code>OA01CDO</code> are the original codes. <code>OA01CD</code> are what they became.</p>
</section>
<section id="stage-1" class="level2">
<h2 class="anchored" data-anchor-id="stage-1">Stage 1</h2>
<p>Imagine an Output Area, X, from one census is split into Y and Z for the next. That means X, Y and Z are all connected, where X is the parent of Y and Z. Alternatively, imagine X and Y from one census are merged into Z for the next. They are still all connected but, in the second case, Z is the parent of X and Y. Applying similar logic allows a consistent OA code, <code>OAXXCD</code>, to be applied to the majority of cases in the data file, <code>df</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">OAXXCD =</span> <span class="cn">NA</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">OAXXCD =</span> <span class="fu">ifelse</span>(CHG11 <span class="sc">==</span> <span class="st">"U"</span> <span class="sc">&amp;</span> CHG21 <span class="sc">==</span> <span class="st">"U"</span>, OA21CD, OAXXCD)) <span class="sc">|&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">OAXXCD =</span> <span class="fu">ifelse</span>(CHG11 <span class="sc">==</span> <span class="st">"M"</span> <span class="sc">&amp;</span> CHG21 <span class="sc">==</span> <span class="st">"U"</span>, OA21CD, OAXXCD)) <span class="sc">|&gt;</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">OAXXCD =</span> <span class="fu">ifelse</span>(CHG11 <span class="sc">==</span> <span class="st">"S"</span> <span class="sc">&amp;</span> CHG21 <span class="sc">==</span> <span class="st">"U"</span>, OA01CD, OAXXCD)) <span class="sc">|&gt;</span> </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">OAXXCD =</span> <span class="fu">ifelse</span>(CHG11 <span class="sc">==</span> <span class="st">"U"</span> <span class="sc">&amp;</span> CHG21 <span class="sc">==</span> <span class="st">"M"</span>, OA21CD, OAXXCD)) <span class="sc">|&gt;</span>  </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">OAXXCD =</span> <span class="fu">ifelse</span>(CHG11 <span class="sc">==</span> <span class="st">"U"</span> <span class="sc">&amp;</span> CHG21 <span class="sc">==</span> <span class="st">"S"</span>, OA11CD, OAXXCD)) <span class="sc">|&gt;</span> </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">OAXXCD =</span> <span class="fu">ifelse</span>(CHG11 <span class="sc">==</span> <span class="st">"S"</span> <span class="sc">&amp;</span> CHG21 <span class="sc">==</span> <span class="st">"S"</span>, OA01CD, OAXXCD)) <span class="sc">|&gt;</span> </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">OAXXCD =</span> <span class="fu">ifelse</span>(CHG11 <span class="sc">==</span> <span class="st">"M"</span> <span class="sc">&amp;</span> CHG21 <span class="sc">==</span> <span class="st">"M"</span>, OA21CD, OAXXCD)) <span class="sc">|&gt;</span> </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">OAXXCD =</span> <span class="fu">ifelse</span>(CHG11 <span class="sc">==</span> <span class="st">"M"</span> <span class="sc">&amp;</span> CHG21 <span class="sc">==</span> <span class="st">"S"</span>, OA11CD, OAXXCD)) <span class="ot">-&gt;</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, there are some cases that cannot be resolved in this way:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(OAXXCD))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,146 × 9
   OA01CD    OA01CDO    OA11CD    CHG11 OA21CD    CHG21 LAD22CD   LAD22NM OAXXCD
   &lt;chr&gt;     &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt; 
 1 E00000233 00ABGD0001 E00175112 S     E00185671 M     E09000002 Barkin… &lt;NA&gt;  
 2 E00000105 00ABFZ0005 E00165805 X     E00165805 U     E09000002 Barkin… &lt;NA&gt;  
 3 E00000729 00ACGA0007 E00000729 U     E00178723 X     E09000003 Barnet  &lt;NA&gt;  
 4 E00000731 00ACGA0009 E00000731 U     E00178723 X     E09000003 Barnet  &lt;NA&gt;  
 5 E00000731 00ACGA0009 E00000731 U     E00178889 X     E09000003 Barnet  &lt;NA&gt;  
 6 E00000731 00ACGA0009 E00000731 U     E00178893 X     E09000003 Barnet  &lt;NA&gt;  
 7 E00000733 00ACGA0011 E00000733 U     E00178724 X     E09000003 Barnet  &lt;NA&gt;  
 8 E00000733 00ACGA0011 E00000733 U     E00178891 X     E09000003 Barnet  &lt;NA&gt;  
 9 E00000733 00ACGA0011 E00000733 U     E00178892 X     E09000003 Barnet  &lt;NA&gt;  
10 E00000734 00ACGA0012 E00000734 U     E00178724 X     E09000003 Barnet  &lt;NA&gt;  
# … with 1,136 more rows</code></pre>
</div>
</div>
<p>and they arise in the following circumstances,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(OAXXCD)) <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(CHG11, CHG21) <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(CHG11, CHG21) <span class="sc">|&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'CHG11'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
# Groups:   CHG11 [5]
  CHG11 CHG21     n
  &lt;chr&gt; &lt;chr&gt; &lt;int&gt;
1 M     X        24
2 S     M       456
3 S     X       140
4 U     X       246
5 X     S        14
6 X     U       209
7 &lt;NA&gt;  M         4
8 &lt;NA&gt;  S        15
9 &lt;NA&gt;  U        38</code></pre>
</div>
</div>
</section>
<section id="stage-2" class="level2">
<h2 class="anchored" data-anchor-id="stage-2">Stage 2</h2>
<p>Some of the cases that have yet to be resolved arise because there is no connection between the 2001 Census codes and the 2011 Census ones.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(CHG11))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 57 × 9
   OA01CD OA01CDO OA11CD    CHG11 OA21CD    CHG21 LAD22CD   LAD22NM       OAXXCD
   &lt;chr&gt;  &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;         &lt;chr&gt; 
 1 &lt;NA&gt;   &lt;NA&gt;    E00165720 &lt;NA&gt;  E00165720 U     E08000012 Liverpool     &lt;NA&gt;  
 2 &lt;NA&gt;   &lt;NA&gt;    E00165673 &lt;NA&gt;  E00165673 U     E08000035 Leeds         &lt;NA&gt;  
 3 &lt;NA&gt;   &lt;NA&gt;    E00165738 &lt;NA&gt;  E00165738 U     E07000245 West Suffolk  &lt;NA&gt;  
 4 &lt;NA&gt;   &lt;NA&gt;    E00165746 &lt;NA&gt;  E00165746 U     E08000026 Coventry      &lt;NA&gt;  
 5 &lt;NA&gt;   &lt;NA&gt;    E00165758 &lt;NA&gt;  E00165758 U     E08000012 Liverpool     &lt;NA&gt;  
 6 &lt;NA&gt;   &lt;NA&gt;    E00165767 &lt;NA&gt;  E00165767 U     E06000003 Redcar and C… &lt;NA&gt;  
 7 &lt;NA&gt;   &lt;NA&gt;    E00165770 &lt;NA&gt;  E00165770 U     E06000003 Redcar and C… &lt;NA&gt;  
 8 &lt;NA&gt;   &lt;NA&gt;    E00165773 &lt;NA&gt;  E00188170 M     E06000003 Redcar and C… &lt;NA&gt;  
 9 &lt;NA&gt;   &lt;NA&gt;    E00165703 &lt;NA&gt;  E00165703 U     E06000007 Warrington    &lt;NA&gt;  
10 &lt;NA&gt;   &lt;NA&gt;    E00165705 &lt;NA&gt;  E00165705 U     E06000007 Warrington    &lt;NA&gt;  
# … with 47 more rows</code></pre>
</div>
</div>
<p>I will resolve this through proximity matching. Specifically, by giving the population weighted centroid of <code>OA11CD</code> a holding <code>OA01CD</code> of the nearest population weighted centroid from 2001. The population weighted centroids are available from <a href="https://geoportal.statistics.gov.uk/maps/output-areas-december-2001-population-weighted-centroids-2" class="uri">https://geoportal.statistics.gov.uk/maps/output-areas-december-2001-population-weighted-centroids-2</a> and from <a href="https://geoportal.statistics.gov.uk/maps/output-areas-dec-2011-pwc" class="uri">https://geoportal.statistics.gov.uk/maps/output-areas-dec-2011-pwc</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(RANN)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">"https://www.dropbox.com/s/1fcm9ggpxudv72l/Output_Areas_%28December_2001%29_Population_Weighted_Centroids.csv?dl=1"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(X, Y, oa01cd) <span class="sc">|&gt;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">OA01CD =</span> oa01cd) <span class="ot">-&gt;</span> pts01</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">"https://www.dropbox.com/s/bsyg152nkcthvzc/Output_Areas_%28Dec_2011%29_PWC.csv?dl=1"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(X, Y, OA11CD) <span class="sc">|&gt;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(df <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(OA01CD)), <span class="at">by =</span> <span class="st">"OA11CD"</span>) <span class="ot">-&gt;</span> pts11</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="fu">nn2</span>(<span class="at">data =</span> pts01 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>OA01CD),</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">query =</span> pts11 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>OA11CD),</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">k =</span> <span class="dv">1</span>)<span class="sc">$</span>nn.idx[,<span class="dv">1</span>]</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(df,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>          <span class="fu">data.frame</span>(<span class="at">OA11CD =</span> pts11<span class="sc">$</span>OA11CD, <span class="at">nearest =</span> pts01<span class="sc">$</span>OA01CD[i]),</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">by =</span> <span class="st">"OA11CD"</span>)  <span class="sc">|&gt;</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">OA01CD =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(nearest), nearest, OA01CD)) <span class="sc">|&gt;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>nearest) <span class="ot">-&gt;</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that whilst all the cases where <code>is.na(CHG11)</code> have now been given a holding <code>OA01CD</code>, the <code>OAXXCD</code> has yet to be assigned. That will be included in the next stage.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(CHG11)) <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(OA01CD, CHG11, OAXXCD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 57 × 3
   OA01CD    CHG11 OAXXCD
   &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt; 
 1 E00033058 &lt;NA&gt;  &lt;NA&gt;  
 2 E00056821 &lt;NA&gt;  &lt;NA&gt;  
 3 E00152565 &lt;NA&gt;  &lt;NA&gt;  
 4 E00048351 &lt;NA&gt;  &lt;NA&gt;  
 5 E00032881 &lt;NA&gt;  &lt;NA&gt;  
 6 E00061137 &lt;NA&gt;  &lt;NA&gt;  
 7 E00061229 &lt;NA&gt;  &lt;NA&gt;  
 8 E00061071 &lt;NA&gt;  &lt;NA&gt;  
 9 E00063383 &lt;NA&gt;  &lt;NA&gt;  
10 E00063066 &lt;NA&gt;  &lt;NA&gt;  
# … with 47 more rows</code></pre>
</div>
</div>
</section>
<section id="stage-3" class="level2">
<h2 class="anchored" data-anchor-id="stage-3">Stage 3</h2>
<p>The next stage is to best illustrated with an example. The Output Area E00000233 has yet to be assigned an <code>OAXXCD</code> because of how it has been split but subsequently merged in successive censuses:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(OAXXCD)) <span class="sc">|&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(OA01CD, OA11CD, OA21CD, OAXXCD, CHG11, CHG21) <span class="sc">|&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="at">n =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  OA01CD    OA11CD    OA21CD    OAXXCD CHG11 CHG21
  &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;
1 E00000233 E00175112 E00185671 &lt;NA&gt;   S     M    </code></pre>
</div>
</div>
<p>What we need to do is find every output area that is connected to E00000233 through any of the censuses. Initially, these are,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(OAXXCD)) <span class="sc">|&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="ot">-&gt;</span> search</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(OA01CD <span class="sc">%in%</span> search<span class="sc">$</span>OA01CD <span class="sc">|</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>         OA11CD <span class="sc">%in%</span> search<span class="sc">$</span>OA11CD <span class="sc">|</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>         OA21CD <span class="sc">%in%</span> search<span class="sc">$</span>OA21CD) <span class="ot">-&gt;</span> found</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>found</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 9
  OA01CD    OA01CDO    OA11CD    CHG11 OA21CD    CHG21 LAD22CD   LAD22NM  OAXXCD
  &lt;chr&gt;     &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt; 
1 E00000233 00ABGD0001 E00175110 S     E00175110 U     E09000002 Barking… E0000…
2 E00000233 00ABGD0001 E00175111 S     E00185716 S     E09000002 Barking… E0000…
3 E00000233 00ABGD0001 E00175111 S     E00185773 S     E09000002 Barking… E0000…
4 E00000233 00ABGD0001 E00175111 S     E00185814 S     E09000002 Barking… E0000…
5 E00000233 00ABGD0001 E00175112 S     E00185671 M     E09000002 Barking… &lt;NA&gt;  
6 E00000233 00ABGD0001 E00175121 S     E00175121 U     E09000002 Barking… E0000…
7 E00000233 00ABGD0001 E00175122 S     E00175122 U     E09000002 Barking… E0000…
8 E00000242 00ABGD0010 E00000242 U     E00185671 M     E09000002 Barking… E0018…</code></pre>
</div>
</div>
<p>But we also need to check for the the connections of the connections and so forth, recursively, until no more are found:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(found)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>n.previous <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span>(n <span class="sc">&gt;</span> n.previous) {</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  n.previous <span class="ot">&lt;-</span> n</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  search <span class="ot">&lt;-</span> found</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">|&gt;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(OA01CD <span class="sc">%in%</span> search<span class="sc">$</span>OA01CD <span class="sc">|</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>           OA11CD <span class="sc">%in%</span> search<span class="sc">$</span>OA11CD <span class="sc">|</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>           OA21CD <span class="sc">%in%</span> search<span class="sc">$</span>OA21CD) <span class="ot">-&gt;</span> found </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(found)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once this is done, all of the connected output areas can be assigned the same identifying <code>OAXXCD</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">OAXXCD =</span> <span class="fu">ifelse</span>(OA01CD <span class="sc">%in%</span> found<span class="sc">$</span>OA01CD <span class="sc">|</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                         OA11CD <span class="sc">%in%</span> found<span class="sc">$</span>OA11CD <span class="sc">|</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                         OA21CD <span class="sc">%in%</span> found<span class="sc">$</span>OA21CD,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                         found<span class="sc">$</span>OA21CD[<span class="dv">1</span>],</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>                         OAXXCD)) <span class="ot">-&gt;</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And this whole process needs to be repeated for every instance of where <code>is.na(OAXXCD</code>), which will take a few minutes to complete.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span>(<span class="fu">nrow</span>(df <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(OAXXCD))) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">|&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">is.na</span>(OAXXCD)) <span class="sc">|&gt;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="ot">-&gt;</span> found</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(found)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  n.previous <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span>(n <span class="sc">&gt;</span> n.previous) {</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    n.previous <span class="ot">&lt;-</span> n</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    search <span class="ot">&lt;-</span> found</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">|&gt;</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(OA01CD <span class="sc">%in%</span> search<span class="sc">$</span>OA01CD <span class="sc">|</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>           OA11CD <span class="sc">%in%</span> search<span class="sc">$</span>OA11CD <span class="sc">|</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>           OA21CD <span class="sc">%in%</span> search<span class="sc">$</span>OA21CD) <span class="ot">-&gt;</span> found</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(found)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">|&gt;</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">OAXXCD =</span> <span class="fu">ifelse</span>(OA01CD <span class="sc">%in%</span> found<span class="sc">$</span>OA01CD <span class="sc">|</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>                           OA11CD <span class="sc">%in%</span> found<span class="sc">$</span>OA11CD <span class="sc">|</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>                           OA21CD <span class="sc">%in%</span> found<span class="sc">$</span>OA21CD,</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>                           found<span class="sc">$</span>OA21CD[<span class="dv">1</span>],</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>                           OAXXCD)) <span class="ot">-&gt;</span> df</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The end result is that all of the Output Areas from each of the censuses are now assigned to one of 174363 unique pseudo-OAs, each with its own <code>OAXXCD</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 190,743 × 9
   OA01CD    OA01CDO    OA11CD    CHG11 OA21CD    CHG21 LAD22CD   LAD22NM OAXXCD
   &lt;chr&gt;     &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt; 
 1 E00000001 00AAFA0001 E00000001 U     E00000001 U     E09000001 City o… E0000…
 2 E00000051 00ABFX0015 E00000051 U     E00000051 U     E09000002 Barkin… E0000…
 3 E00000002 00AAFA0002 E00166756 M     E00166756 U     E09000001 City o… E0016…
 4 E00000003 00AAFA0003 E00000003 U     E00000003 U     E09000001 City o… E0000…
 5 E00000004 00AAFA0004 E00166758 M     E00190429 S     E09000001 City o… E0016…
 6 E00000004 00AAFA0004 E00166758 M     E00190433 S     E09000001 City o… E0016…
 7 E00000005 00AAFA0005 E00000005 U     E00000005 U     E09000001 City o… E0000…
 8 E00000006 00AAFA0006 E00166758 M     E00190429 S     E09000001 City o… E0016…
 9 E00000006 00AAFA0006 E00166758 M     E00190433 S     E09000001 City o… E0016…
10 E00000007 00AAFA0007 E00000007 U     E00000007 U     E09000001 City o… E0000…
# … with 190,733 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(df<span class="sc">$</span>OAXXCD))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 174363</code></pre>
</div>
</div>
<p>These <code>OAXXCD</code> are a combination of various <code>OA01CD</code>, <code>OA11CD</code> and <code>OA21CD</code> codes. To avoid confusion, it may be better to replace those with custom numbered identifiers:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(OA01CD) <span class="ot">-&gt;</span> df</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(OAXXCD) <span class="sc">|&gt;</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(OAXXCD)) <span class="ot">-&gt;</span> gps</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">OAXXCD =</span> gps<span class="sc">$</span>OAXXCD, <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span> <span class="fu">nrow</span>(gps)) <span class="ot">-&gt;</span> gps</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(gps, <span class="at">by =</span> <span class="st">"OAXXCD"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">i =</span> <span class="fu">str_pad</span>(i, <span class="at">width =</span> <span class="dv">7</span>, <span class="at">pad =</span> <span class="st">"0"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">OAXXCD =</span> <span class="fu">paste0</span>(<span class="st">"X"</span>, i, <span class="fu">substr</span>(OAXXCD, <span class="dv">1</span>, <span class="dv">1</span>))) <span class="sc">|&gt;</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>i) <span class="ot">-&gt;</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We should also reset the <code>OA01CD</code> for those based on spatial proximity back to their original <code>NA</code> value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">OA01CD =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(CHG11), <span class="cn">NA</span>, OA01CD)) <span class="ot">-&gt;</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="look-up-files" class="level2">
<h2 class="anchored" data-anchor-id="look-up-files">Look-up files</h2>
<p>We are now in a position to save the look-up files.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">"OAXXCD_full_lookup.csv"</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(OA01CDO, OA01CD, OAXXCD) <span class="sc">|&gt;</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(OA01CD) <span class="sc">|&gt;</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">"OA01CD_to_OAXXCD.csv"</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(OA11CD, OAXXCD) <span class="sc">|&gt;</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(OA11CD) <span class="sc">|&gt;</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">"OA11CD_to_OAXXCD.csv"</span>)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(OA21CD, OAXXCD) <span class="sc">|&gt;</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(OA21CD) <span class="sc">|&gt;</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">"OA21CD_to_OAXXCD.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="higher-level-geographies" class="level2">
<h2 class="anchored" data-anchor-id="higher-level-geographies">Higher-level geographies</h2>
<p>It is helpful to know which higher-level geographies the pseudo-OAs fall within. Some of these include MSOAs and their ‘friendly names’ , available from the <a href="https://houseofcommonslibrary.github.io/msoanames/">House of Commons Library</a>, <a href="https://geoportal.statistics.gov.uk/datasets/output-area-to-lower-layer-super-output-area-to-middle-layer-super-output-area-to-local-authority-district-december-2021-lookup-in-england-and-wales-v2-1">local authority districts</a>, and <a href="https://geoportal.statistics.gov.uk/datasets/output-area-to-country-december-2021-lookup-in-england-and-wales-1">regions</a>. We begin by matching these geographies to the 2021 Census OA geography and adding in their residential population counts from <a href="https://www.nomisweb.co.uk/census/2021/bulk">census table TS021</a>, which will needed in the next step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(df <span class="sc">|&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(OAXXCD, OA21CD, LAD22CD, LAD22NM),</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_csv</span>(<span class="st">"https://www.dropbox.com/s/vcaw0emrgz5efta/OA21_LSOA21_MSOA21_LAD22_EW_LU.csv?dl=1"</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">progress =</span> <span class="cn">FALSE</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">col_select =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">|&gt;</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">OA21CD =</span> <span class="dv">1</span>, <span class="at">MSOA21CD =</span> <span class="dv">2</span>), <span class="at">by =</span> <span class="st">"OA21CD"</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">read_csv</span>(<span class="st">"https://www.dropbox.com/s/o3albmackgz0zao/MSOA-Names-2.2.csv?dl=1"</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">col_select =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">|&gt;</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">MSOA21CD =</span> <span class="dv">1</span>, <span class="at">MSOA21NM =</span> <span class="dv">2</span>), <span class="at">by =</span> <span class="st">"MSOA21CD"</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">read_csv</span>(<span class="st">"https://www.dropbox.com/s/8um5h5quf9wc2vj/OA21_RGN22_LU.csv?dl=1"</span>, <span class="at">col_select =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">OA21CD =</span> <span class="dv">1</span>, <span class="at">RGN21CD =</span> <span class="dv">2</span>, <span class="at">RGN21NM =</span> <span class="dv">3</span>), <span class="at">by =</span> <span class="st">"OA21CD"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">read_csv</span>(<span class="st">"https://www.dropbox.com/s/lw8r575noohhuu5/TS021-2021-1-filtered-2022-11-30T10_03_36Z.csv?dl=1"</span>,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">progress =</span> <span class="cn">FALSE</span>,</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">col_select =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>)) <span class="sc">|&gt;</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">OA21CD =</span> <span class="dv">1</span>, <span class="at">Popn =</span> <span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(OA21CD) <span class="sc">|&gt;</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">Popn =</span> <span class="fu">sum</span>(Popn)) <span class="sc">|&gt;</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>(), <span class="at">by =</span> <span class="st">"OA21CD"</span>) <span class="ot">-&gt;</span> geography</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>geography</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 190,743 × 9
   OAXXCD    OA21CD    LAD22CD   LAD22NM MSOA21CD MSOA21NM RGN21CD RGN21NM  Popn
   &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;   &lt;dbl&gt;
 1 X0000001E E00000001 E09000001 City o… E020000… City of… E12000… London    176
 2 X0000002E E00166756 E09000001 City o… E020000… City of… E12000… London    279
 3 X0000003E E00000003 E09000001 City o… E020000… City of… E12000… London    255
 4 X0000004E E00190429 E09000001 City o… E020000… City of… E12000… London    281
 5 X0000004E E00190433 E09000001 City o… E020000… City of… E12000… London    226
 6 X0000005E E00000005 E09000001 City o… E020000… City of… E12000… London    112
 7 X0000004E E00190429 E09000001 City o… E020000… City of… E12000… London    281
 8 X0000004E E00190433 E09000001 City o… E020000… City of… E12000… London    226
 9 X0000006E E00000007 E09000001 City o… E020000… City of… E12000… London    144
10 X0000002E E00166756 E09000001 City o… E020000… City of… E12000… London    279
# … with 190,733 more rows</code></pre>
</div>
</div>
<p>There is no guarantee that the pseudo-OAs will all fit exactly into the higher-level geographies, although most map exactly to 2021 Census OAs and will. For the ones that don’t, they are assigned the best fit, where best fit is defined by weight of population:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>geography <span class="sc">|&gt;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(OAXXCD, MSOA21CD, MSOA21NM,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>         LAD22CD, LAD22NM,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>         RGN21CD, RGN21NM, Popn) <span class="sc">|&gt;</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="ot">-&gt;</span> geography</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>geography <span class="sc">|&gt;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(OAXXCD) <span class="sc">|&gt;</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Popn =</span> <span class="fu">sum</span>(Popn), <span class="at">.groups =</span> <span class="st">"keep"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(geography <span class="sc">|&gt;</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(OAXXCD, MSOA21CD, MSOA21NM) <span class="sc">|&gt;</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">Popn =</span> <span class="fu">sum</span>(Popn), <span class="at">.groups =</span> <span class="st">"keep"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(OAXXCD) <span class="sc">|&gt;</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(OAXXCD, <span class="fu">desc</span>(Popn)) <span class="sc">|&gt;</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>Popn) <span class="sc">|&gt;</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>(), <span class="at">by =</span> <span class="st">"OAXXCD"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(geography <span class="sc">|&gt;</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(OAXXCD, LAD22CD, LAD22NM) <span class="sc">|&gt;</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">Popn =</span> <span class="fu">sum</span>(Popn), <span class="at">.groups =</span> <span class="st">"keep"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(OAXXCD) <span class="sc">|&gt;</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(OAXXCD, <span class="fu">desc</span>(Popn)) <span class="sc">|&gt;</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>Popn) <span class="sc">|&gt;</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>(), <span class="at">by =</span> <span class="st">"OAXXCD"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(geography <span class="sc">|&gt;</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(OAXXCD, RGN21CD, RGN21NM) <span class="sc">|&gt;</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">Popn =</span> <span class="fu">sum</span>(Popn), <span class="at">.groups =</span> <span class="st">"keep"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(OAXXCD) <span class="sc">|&gt;</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(OAXXCD, <span class="fu">desc</span>(Popn)) <span class="sc">|&gt;</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>Popn) <span class="sc">|&gt;</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>(), <span class="at">by =</span> <span class="st">"OAXXCD"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(OAXXCD, Popn, MSOA21CD, MSOA21NM, LAD22CD, LAD22NM,</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>         RGN21CD, RGN21NM) <span class="ot">-&gt;</span> geography</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>geography <span class="sc">|&gt;</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">"OAXXCD_to_MSOAXXNM_to_LADXXNM_RGNXXNM.csv"</span>)</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>geography</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 174,363 × 8
# Groups:   OAXXCD [174,363]
   OAXXCD     Popn MSOA21CD  MSOA21NM       LAD22CD   LAD22NM    RGN21CD RGN21NM
   &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;          &lt;chr&gt;     &lt;chr&gt;      &lt;chr&gt;   &lt;chr&gt;  
 1 X0000001E   176 E02000001 City of London E09000001 City of L… E12000… London 
 2 X0000002E   279 E02000001 City of London E09000001 City of L… E12000… London 
 3 X0000003E   255 E02000001 City of London E09000001 City of L… E12000… London 
 4 X0000004E   507 E02000001 City of London E09000001 City of L… E12000… London 
 5 X0000005E   112 E02000001 City of London E09000001 City of L… E12000… London 
 6 X0000006E   144 E02000001 City of London E09000001 City of L… E12000… London 
 7 X0000007E   348 E02000001 City of London E09000001 City of L… E12000… London 
 8 X0000008E   175 E02000001 City of London E09000001 City of L… E12000… London 
 9 X0000009E   503 E02000001 City of London E09000001 City of L… E12000… London 
10 X0000010E   255 E02000001 City of London E09000001 City of L… E12000… London 
# … with 174,353 more rows</code></pre>
</div>
</div>
</section>
<section id="boundary-file-for-the-pseudo-oas" class="level2">
<h2 class="anchored" data-anchor-id="boundary-file-for-the-pseudo-oas">Boundary file for the pseudo-OAs</h2>
<p>To map the pseudo-OAs, we need to create a boundary file for them, based on the <a href="https://geoportal.statistics.gov.uk/maps/output-areas-december-2021-boundaries-generalised-clipped-ew-bgc">2021 Census OA boundaries</a>. We begin by loading in those boundaries and appending the <code>OAXXCD</code> codes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(sf)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_read</span>(<span class="st">"https://www.dropbox.com/s/2ffk5mwezyyjzre/Output_Areas_%28December_2021%29_Boundaries_Generalised_Clipped_EW_%28BGC%29.geojson?dl=1"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(df <span class="sc">|&gt;</span> <span class="fu">select</span>(OAXXCD, OA21CD) <span class="sc">|&gt;</span> <span class="fu">unique</span>(), <span class="at">by =</span> <span class="st">"OA21CD"</span>) <span class="ot">-&gt;</span> map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `OA_2021_EW_BGC' from data source 
  `https://www.dropbox.com/s/2ffk5mwezyyjzre/Output_Areas_%28December_2021%29_Boundaries_Generalised_Clipped_EW_%28BGC%29.geojson?dl=1' 
  using driver `GeoJSON'
Simple feature collection with 188880 features and 5 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -6.418667 ymin: 49.86479 xmax: 1.763706 ymax: 55.81112
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 188880 features and 6 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -6.418667 ymin: 49.86479 xmax: 1.763706 ymax: 55.81112
Geodetic CRS:  WGS 84
First 10 features:
   OBJECTID    OA21CD                               GlobalID SHAPE_Length
1         1 E00000001 {BC5EB21B-D42B-4715-A771-2C27575A08F0}  0.005263040
2         2 E00000003 {A1A2B34F-320E-4BB8-ACB4-7CA7CA16EF9C}  0.003439877
3         3 E00000005 {9337DA1A-FE0F-4210-9C95-ED2D20FD6287}  0.004284711
4         4 E00000007 {B336E11F-AF26-48A6-AC67-44F5B8B8840A}  0.016351659
5         5 E00000010 {CA8F9874-CDF5-4C1A-9D39-F74A410DAE44}  0.002386808
6         6 E00000013 {B9B93246-BBFB-46AF-8011-6B8ED5908956}  0.005347143
7         7 E00000018 {FCB7C232-4165-44DA-8FF8-B6CC383B528A}  0.012839007
8         8 E00000019 {715E0851-2375-4D6A-94AC-532BA0833C60}  0.007299853
9         9 E00000020 {4251A2FF-8FBE-4C11-AECE-044F23AB9AF2}  0.004090582
10       10 E00000021 {48B2DF49-45ED-48A4-B7FC-E0E32C1AD088}  0.025416295
     SHAPE_Area    OAXXCD                       geometry
1  9.001827e-07 X0000001E MULTIPOLYGON (((-0.09447861...
2  5.819360e-07 X0000003E MULTIPOLYGON (((-0.09576465...
3  1.109536e-06 X0000005E MULTIPOLYGON (((-0.09627474...
4  9.843568e-06 X0000006E MULTIPOLYGON (((-0.09600549...
5  2.724187e-07 X0000008E MULTIPOLYGON (((-0.09688753...
6  1.138881e-06 X0000011E MULTIPOLYGON (((-0.09525163...
7  6.407396e-06 X0000013E MULTIPOLYGON (((-0.0924986 ...
8  1.524146e-06 X0000014E MULTIPOLYGON (((-0.08991936...
9  7.621724e-07 X0000015E MULTIPOLYGON (((-0.09147971...
10 1.786263e-05 X0000016E MULTIPOLYGON (((-0.08810299...</code></pre>
</div>
</div>
<p>The next step is to aggregate the 2021 Census OAs to the pseudo-OA geography.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">aggregate</span>(map <span class="sc">|&gt;</span> <span class="fu">select</span>(OAXXCD), <span class="at">by =</span> <span class="fu">list</span>(map<span class="sc">$</span>OAXXCD), <span class="at">FUN =</span> length) <span class="sc">|&gt;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">OAXXCD =</span> <span class="dv">1</span>, <span class="at">nOA21 =</span> <span class="dv">2</span>) <span class="ot">-&gt;</span> map</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 174363 features and 2 fields
Attribute-geometry relationship: 0 constant, 1 aggregate, 1 identity
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: -6.418667 ymin: 49.86479 xmax: 1.763706 ymax: 55.81112
Geodetic CRS:  WGS 84
First 10 features:
      OAXXCD nOA21                       geometry
1  X0000001E     1 POLYGON ((-0.09447861 51.51...
2  X0000002E     1 POLYGON ((-0.09725971 51.52...
3  X0000003E     1 POLYGON ((-0.09576465 51.52...
4  X0000004E     2 POLYGON ((-0.09505768 51.51...
5  X0000005E     1 POLYGON ((-0.09627474 51.51...
6  X0000006E     1 POLYGON ((-0.09600549 51.51...
7  X0000007E     1 POLYGON ((-0.08020353 51.52...
8  X0000008E     1 POLYGON ((-0.09688753 51.52...
9  X0000009E     2 POLYGON ((-0.0940139 51.521...
10 X0000010E     1 POLYGON ((-0.09635707 51.52...</code></pre>
</div>
</div>
<p>Then to append the higher-level geographies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>map <span class="sc">|&gt;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(geography, <span class="at">by =</span> <span class="st">"OAXXCD"</span>) <span class="ot">-&gt;</span> map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And save the file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>map <span class="sc">|&gt;</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_write</span>(<span class="at">dsn =</span> <span class="st">"OAXXCD_Boundaries_Generalised_Clipped_EW.geojson"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Writing layer `OAXXCD_Boundaries_Generalised_Clipped_EW' to data source 
  `OAXXCD_Boundaries_Generalised_Clipped_EW.geojson' using driver `GeoJSON'
Writing 174363 features with 9 fields and geometry type Unknown (any).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>map <span class="sc">|&gt;</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_write</span>(<span class="at">dsn =</span> <span class="st">"OAXXCD_Boundaries_Generalised_Clipped_EW.shp"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Writing layer `OAXXCD_Boundaries_Generalised_Clipped_EW' to data source 
  `OAXXCD_Boundaries_Generalised_Clipped_EW.shp' using driver `ESRI Shapefile'
Writing 174363 features with 9 fields and geometry type Unknown (any).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in CPL_write_ogr(obj, dsn, layer, driver,
as.character(dataset_options), : GDAL Message 1: One or several characters
couldn't be converted correctly from UTF-8 to ISO-8859-1. This warning will not
be emitted anymore.</code></pre>
</div>
</div>
<p>Here are the consistent pseudo-OAs for London.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggplot2)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>map <span class="sc">|&gt;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(RGN21NM <span class="sc">==</span> <span class="st">"London"</span>) <span class="sc">|&gt;</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.514">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Spatial Regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<script src="site_libs/quarto-search/autocomplete-preset-algolia.umd.js"></script>
<meta name="quarto:offset" content="./">
<link href="./gwstats.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 20,
  "algolia": {
    "application-id": "J0U99Q1IO1",
    "search-only-api-key": "133b4b1fa29f2b12275f6a48a26418db",
    "index-name": "dev_profrichharris",
    "analytics-events": false,
    "show-logo": true,
    "libDir": "site_libs"
  },
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.5.1/dist/algoliasearch-lite.umd.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link active" href="./index.html" aria-current="page"><i class="bi bi-house" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./index.html">Mapping and Modelling Geographic Data in R</a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Spatial Regression</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./" class="sidebar-logo-link">
      <img src="./logo.jpg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Introduction</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./start.html" class="sidebar-item-text sidebar-link">Getting Started</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Why R</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./why.html" class="sidebar-item-text sidebar-link">Why R?</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Flavours of R</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./base.html" class="sidebar-item-text sidebar-link">Base R</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tidyverse.html" class="sidebar-item-text sidebar-link">Tidyverse</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./programming.html" class="sidebar-item-text sidebar-link">Programming</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">From Maps towards Models</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./themap.html" class="sidebar-item-text sidebar-link">The Spatial Variable</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./thematicmaps.html" class="sidebar-item-text sidebar-link">Thematic maps in R</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./autocorrelation.html" class="sidebar-item-text sidebar-link">Measuring spatial autocorrelation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gwstats.html" class="sidebar-item-text sidebar-link">Geographically Weighted Statistics</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spregress.html" class="sidebar-item-text sidebar-link active">Spatial Regression</a>
  </div>
</li>
    </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started">Getting Started</a></li>
  <li><a href="#an-initial-model-to-explain-the-spatial-patterns-in-the-covid-19-rates" id="toc-an-initial-model-to-explain-the-spatial-patterns-in-the-covid-19-rates" class="nav-link" data-scroll-target="#an-initial-model-to-explain-the-spatial-patterns-in-the-covid-19-rates">An initial model to explain the spatial patterns in the COVID-19 rates</a></li>
  <li><a href="#spatial-dependencies-in-the-model-residuals" id="toc-spatial-dependencies-in-the-model-residuals" class="nav-link" data-scroll-target="#spatial-dependencies-in-the-model-residuals">Spatial dependencies in the model residuals</a>
  <ul class="collapse">
  <li><a href="#looking-again-at-the-model" id="toc-looking-again-at-the-model" class="nav-link" data-scroll-target="#looking-again-at-the-model">Looking again at the model</a></li>
  </ul></li>
  <li><a href="#spatial-regression-models" id="toc-spatial-regression-models" class="nav-link" data-scroll-target="#spatial-regression-models">Spatial regression models</a>
  <ul class="collapse">
  <li><a href="#spatial-error-model" id="toc-spatial-error-model" class="nav-link" data-scroll-target="#spatial-error-model">Spatial error model</a></li>
  <li><a href="#spatially-lagged-y-model" id="toc-spatially-lagged-y-model" class="nav-link" data-scroll-target="#spatially-lagged-y-model">Spatially lagged y model</a></li>
  <li><a href="#choosing-between-the-spatial-error-and-lagged-y-model" id="toc-choosing-between-the-spatial-error-and-lagged-y-model" class="nav-link" data-scroll-target="#choosing-between-the-spatial-error-and-lagged-y-model">Choosing between the spatial error and lagged y model</a></li>
  </ul></li>
  <li><a href="#a-geographically-weighted-spatial-weights-matrix" id="toc-a-geographically-weighted-spatial-weights-matrix" class="nav-link" data-scroll-target="#a-geographically-weighted-spatial-weights-matrix">A geographically weighted spatial weights matrix</a></li>
  <li><a href="#geographically-weighted-regression" id="toc-geographically-weighted-regression" class="nav-link" data-scroll-target="#geographically-weighted-regression">Geographically Weighted Regression</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading">Further Reading</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block">Spatial Regression</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In the previous session we looked at geographically weighted statistics, including geographically weighted correlation, which examines whether the correlation between two variables varies across a map. In this session we extend from correlation to looking at regression modelling with a spatial component. The data that we shall use are a map of the rate of COVID-19 infections per thousand population in neighbourhoods of the North West of England over the period from the week commencing 2020-03-07 to the week commencing 2022-04-16. That rate is calculated as the total number of reported infections per neighbourhood, divided by the <a href="https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/middlesuperoutputareamidyearpopulationestimates" target="blank">mid-2020 ONS estimated population</a>. There are three problems with these data, which originate (prior to adjustment) from <a href="https://coronavirus.data.gov.uk/details/download" target="_blank">https://coronavirus.data.gov.uk/details/download</a>:</p>
<ol type="1">
<li>The rate, as calculated, does not allow for re-infection (i.e.&nbsp;the same person can catch COVID-19 more than once).</li>
<li>Not everyone who had COVID was tested for a positive diagnosis. Limitations in the testing regime are described in <a href="https://link.springer.com/article/10.1007/s12061-021-09400-8" target="_blank">this paper</a> and are most severe earlier in the pandemic and again towards the end of the data period as testing was scaled-back and then largely withdrawn.</li>
<li>Where a neighbourhood had less than three cases in a week, that number was reported as zero even though it could really be one or two. That second type of undercount adds up, although, unsurprisingly it affects the largest cities most (because they have more neighbourhoods to be undercounted) in weeks when COVID is not especially prevalent. An adjustment has been made to the data to allow for this but not for the undercount caused by not testing positive.</li>
</ol>
<p>Nevertheless, the data are sufficient to illustrate the methods.</p>
</section>
<section id="getting-started" class="level2">
<h2 class="anchored" data-anchor-id="getting-started">Getting Started</h2>
<p>The data are downloaded as follows. The required packages should be installed already, from previous sessions.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"remotes"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) <span class="fu">install.packages</span>(<span class="st">"remotes"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"ggsflabel"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"yutannihilation/ggsflabel"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(sf)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggplot2)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggsflabel)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"covid.geojson"</span>)) <span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/data/covid.geojson"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="st">"covid.geojson"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(<span class="st">"covid.geojson"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(regionName <span class="sc">==</span> <span class="st">"North West"</span>) <span class="ot">-&gt;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  covid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Looking at a map of the COVID-19 rates, it appears that there are patches of higher rates that tend to cluster in cities such as Preston, Manchester and Liverpool, although not exclusively so</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>covid <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Rate <span class="sc">&gt;</span> <span class="dv">400</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(LtlaName) <span class="sc">%&gt;%</span>   <span class="co"># LtlaName is the name of the local authority</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(LtlaName)) <span class="ot">-&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  high_rate</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> covid, <span class="fu">aes</span>(<span class="at">fill =</span> Rate), <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"YlOrRd"</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_label_repel</span>(<span class="at">data =</span> high_rate, <span class="fu">aes</span>(<span class="at">label =</span> LtlaName), <span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>… and not without variation within the cities such as Manchester:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> covid <span class="sc">%&gt;%</span> <span class="fu">filter</span>(LtlaName <span class="sc">==</span> <span class="st">"Manchester"</span>)) <span class="sc">+</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Rate), <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"YlOrRd"</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Across the map there appears to be a pattern of positive spatial autocorrelation in the COVID-19 rates of contiguous neighbours, whether this is measured using a Moran test,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(spdep)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(<span class="fu">poly2nb</span>(covid, <span class="at">snap =</span> <span class="dv">1</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">moran.test</span>(covid<span class="sc">$</span>Rate, spweight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Moran I test under randomisation

data:  covid$Rate  
weights: spweight    

Moran I statistic standard deviate = 24.422, p-value &lt; 2.2e-16
alternative hypothesis: greater
sample estimates:
Moran I statistic       Expectation          Variance 
     0.4919206758     -0.0010834236      0.0004075223 </code></pre>
</div>
</div>
<p>or using the Pearson correlation,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(<span class="fu">lag.listw</span>(spweight, covid<span class="sc">$</span>Rate), covid<span class="sc">$</span>Rate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6726405</code></pre>
</div>
</div>
<p>Some of the ‘hot spots’ of infection are suggested using the geographically-weighted means,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(GWmodel)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>covid_sp <span class="ot">&lt;-</span> <span class="fu">as_Spatial</span>(covid)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(Rate <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> covid_sp,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>, <span class="at">longlat =</span> F)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>gwstats <span class="ot">&lt;-</span> <span class="fu">gwss</span>(covid_sp, <span class="at">vars =</span> <span class="st">"Rate"</span>, <span class="at">bw =</span> bw, <span class="at">kernel =</span> <span class="st">"bisquare"</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">longlat =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Plotting these,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>Rate_LM <span class="ot">&lt;-</span> gwstats<span class="sc">$</span>SDF<span class="sc">$</span>Rate_LM</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> Rate_LM)) <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"YlOrRd"</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>They also are suggested using the G-statistic with a somewhat arbitrary bandwidth of 5km.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(covid, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">5000</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>spweightB <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(covid<span class="sc">$</span>Rate, spweightB)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(covid<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(covid<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(covid<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp)) <span class="sc">+</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"G"</span>, <span class="at">values =</span> pal, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="an-initial-model-to-explain-the-spatial-patterns-in-the-covid-19-rates" class="level2">
<h2 class="anchored" data-anchor-id="an-initial-model-to-explain-the-spatial-patterns-in-the-covid-19-rates">An initial model to explain the spatial patterns in the COVID-19 rates</h2>
<p>It is likely that the spatial variation in the COVID-19 rates is due to differences in the physical attributes of the different neighbourhoods and/or of the populations who live in them. For example, the rates may be related to the relative level of deprivation in the neighbourhoods (the <a href="https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019" target="_blank">Index of Multiple Deprivation</a>, <code>IMD</code>), the age composition of their populations (e.g.&nbsp;percentage aged 0 to 11, <code>age0.11</code>), the population density (<code>density</code>), the number of carehome beds (<code>carebeds</code>, because particularly early on in the pandemic, carehome residents were at very high risk), and whether they contain an Accident and Emergency hospital (<code>AandE</code>, coded 1 if they do and 0 if they don’t). Incorporating this into a standard regression model gives,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ols1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(Rate <span class="sc">~</span> IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age12<span class="fl">.17</span> <span class="sc">+</span> age18<span class="fl">.24</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age35<span class="fl">.39</span> <span class="sc">+</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>             age50<span class="fl">.59</span> <span class="sc">+</span> age60<span class="fl">.69</span> <span class="sc">+</span> age70plus <span class="sc">+</span> density <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>             carebeds <span class="sc">+</span> AandE, <span class="at">data =</span> covid)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ols1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Rate ~ IMD + age0.11 + age12.17 + age18.24 + age25.34 + 
    age35.39 + age50.59 + age60.69 + age70plus + density + carebeds + 
    AandE, data = covid)

Residuals:
     Min       1Q   Median       3Q      Max 
-134.816  -17.761    1.592   20.124  139.444 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 182.26850  113.79175   1.602 0.109553    
IMD          -0.29381    0.10610  -2.769 0.005736 ** 
age0.11       2.21553    1.36681   1.621 0.105376    
age12.17     -2.36944    1.94032  -1.221 0.222341    
age18.24     -0.16683    1.16041  -0.144 0.885719    
age25.34      2.31424    1.19221   1.941 0.052550 .  
age35.39      6.65665    2.65716   2.505 0.012413 *  
age50.59      6.31033    1.74161   3.623 0.000307 ***
age60.69      0.34605    1.46550   0.236 0.813386    
age70plus    -0.71097    1.23595  -0.575 0.565269    
density     164.39302  636.21170   0.258 0.796162    
carebeds      0.03583    0.01489   2.407 0.016292 *  
AandE         1.13369    4.03313   0.281 0.778703    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 31.75 on 911 degrees of freedom
Multiple R-squared:  0.2039,    Adjusted R-squared:  0.1934 
F-statistic: 19.44 on 12 and 911 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p><br> which, as its R-squared value of 0.204 suggests, goes some way to explaining the variation in the rates. Looking at R’s standard diagnostic plots there is not any strong evidence that the residual Normality assumption of the regression is being violated although, not very surprisingly, the variance inflation values (VIF) do suggest high levels of colinearity between the age variables.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ols1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"car"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) <span class="fu">install.packages</span>(<span class="st">"car"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(car)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(ols1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      IMD   age0.11  age12.17  age18.24  age25.34  age35.39  age50.59  age60.69 
 2.834069 18.836543  6.050232 38.347245 27.513979 10.228388 16.430177 14.397087 
age70plus   density  carebeds     AandE 
38.881759  2.123517  1.135127  1.030432 </code></pre>
</div>
</div>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">There are no hard and fast rules but, in broad terms, a VIF value of 4 or 5 or above is considering and a value above 10 suggests a high level of multicollinearity.</font></p>
<p><br> Although I am generally cautious about automated selection procedures, in this case a stepwise model selection appears useful to address the colinearity:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ols2 <span class="ot">&lt;-</span> <span class="fu">step</span>(ols1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The results are,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ols2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Rate ~ IMD + age0.11 + age25.34 + age35.39 + age50.59 + 
    carebeds, data = covid)

Residuals:
     Min       1Q   Median       3Q      Max 
-133.943  -18.266    1.855   20.205  147.079 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 147.22402   14.35674  10.255  &lt; 2e-16 ***
IMD          -0.25971    0.09411  -2.760 0.005903 ** 
age0.11       1.81138    0.53224   3.403 0.000695 ***
age25.34      2.90621    0.47569   6.109 1.48e-09 ***
age35.39      7.27665    1.53525   4.740 2.48e-06 ***
age50.59      6.65925    0.63811  10.436  &lt; 2e-16 ***
carebeds      0.03328    0.01417   2.348 0.019069 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 31.7 on 917 degrees of freedom
Multiple R-squared:  0.2011,    Adjusted R-squared:  0.1959 
F-statistic: 38.48 on 6 and 917 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(ols2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     IMD  age0.11 age25.34 age35.39 age50.59 carebeds 
2.236588 2.865175 4.394042 3.425196 2.212515 1.031632 </code></pre>
</div>
</div>
<p>It may seem surprising to discover that the deprivation index is negatively correlated with the COVID rate – implying more deprivation, fewer infections – but this is due to the later variants of the disease which have spread quickly through more affluent populations when restrictions on mobility and social interaction have been relaxed.</p>
</section>
<section id="spatial-dependencies-in-the-model-residuals" class="level2">
<h2 class="anchored" data-anchor-id="spatial-dependencies-in-the-model-residuals">Spatial dependencies in the model residuals</h2>
<p>Although the model appears to fit the data reasonably well, there is a problem. The residuals are supposed to be random noise, meaning their values should be independent of their location and of each other, with no spatial structure. They are not. In fact, if we apply a Moran’s test to the residuals, using the test for regression residuals, <code>lm.morantest()</code>, we find that they are significantly spatially correlated:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(ols2, spweight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Global Moran I for regression residuals

data:  
model: lm(formula = Rate ~ IMD + age0.11 + age25.34 + age35.39 +
age50.59 + carebeds, data = covid)
weights: spweight

Moran I statistic standard deviate = 22.357, p-value &lt; 2.2e-16
alternative hypothesis: greater
sample estimates:
Observed Moran I      Expectation         Variance 
    0.4461249282    -0.0033794098     0.0004042296 </code></pre>
</div>
</div>
<p><br> The pattern is evident if we map the standardised residuals from the function <code>rstandard()</code>. At the risk of geographical over-simplification, there is something of a north-south divide, with a patch of negative residuals to the north of the study region. These are rural neighbouhoods where the rate of COVID-19 cases is lower than the model predicts.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids <span class="ot">&lt;-</span> <span class="fu">rstandard</span>(ols2)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(covid<span class="sc">$</span>resids, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(covid<span class="sc">$</span>resids, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(covid<span class="sc">$</span>resids, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> resids_gp)) <span class="sc">+</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"Standardised residual"</span>, <span class="at">values =</span> pal, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="looking-again-at-the-model" class="level3">
<h3 class="anchored" data-anchor-id="looking-again-at-the-model">Looking again at the model</h3>
<p>It is possible that the spatial structure in the residuals exists because the model has been mis-specified. In particular, we might wonder if it was a mistake to drop the population density variable which perhaps had a polynomial relationship with the COVID rates. Let’s find out.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ols3 <span class="ot">&lt;-</span> <span class="fu">update</span>(ols2, . <span class="sc">~</span> . <span class="sc">+</span> <span class="fu">poly</span>(density, <span class="dv">2</span>))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ols3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Rate ~ IMD + age0.11 + age25.34 + age35.39 + age50.59 + 
    carebeds + poly(density, 2), data = covid)

Residuals:
     Min       1Q   Median       3Q      Max 
-125.385  -17.887    1.057   20.094  132.985 

Coefficients:
                    Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)        185.32682   15.18181  12.207  &lt; 2e-16 ***
IMD                 -0.33794    0.09407  -3.592 0.000345 ***
age0.11              1.51411    0.51892   2.918 0.003612 ** 
age25.34             3.15458    0.46379   6.802 1.87e-11 ***
age35.39             3.95864    1.55519   2.545 0.011077 *  
age50.59             5.67418    0.69588   8.154 1.15e-15 ***
carebeds             0.02900    0.01378   2.105 0.035593 *  
poly(density, 2)1   23.82432   43.11516   0.553 0.580690    
poly(density, 2)2 -267.38867   35.45138  -7.542 1.11e-13 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 30.79 on 915 degrees of freedom
Multiple R-squared:  0.248, Adjusted R-squared:  0.2414 
F-statistic: 37.72 on 8 and 915 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p><br> Certainly, of the three models, this is the best fit to the data, as we can see from the various model fit diagnostics that are easily gathered together using the <code>glance()</code> function from the tidyverse package, <code>broom</code>.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(broom)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">glance</span>(ols1), <span class="fu">glance</span>(ols2), <span class="fu">glance</span>(ols3))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 12
  r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC   BIC
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     0.204         0.193  31.7      19.4 4.88e-38    12 -4500. 9027. 9095.
2     0.201         0.196  31.7      38.5 8.36e-42     6 -4501. 9018. 9057.
3     0.248         0.241  30.8      37.7 5.93e-52     8 -4473. 8966. 9015.
# … with 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
</div>
</div>
<p>An analysis of variance also suggests that the model fit has improved significantly.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(ols2, ols3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Model 1: Rate ~ IMD + age0.11 + age25.34 + age35.39 + age50.59 + carebeds
Model 2: Rate ~ IMD + age0.11 + age25.34 + age35.39 + age50.59 + carebeds + 
    poly(density, 2)
  Res.Df    RSS Df Sum of Sq      F    Pr(&gt;F)    
1    917 921337                                  
2    915 867305  2     54032 28.502 9.819e-13 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>However, there is still spatial autocorrelation left in the model residuals, albeit slightly reduced from before.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(ols2, spweight)<span class="sc">$</span>estimate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Observed Moran I      Expectation         Variance 
    0.4461249282    -0.0033794098     0.0004042296 </code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(ols3, spweight)<span class="sc">$</span>estimate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Observed Moran I      Expectation         Variance 
    0.4133475904    -0.0037610429     0.0004036032 </code></pre>
</div>
</div>
<p>The map of the residuals now looks like:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids <span class="ot">&lt;-</span> <span class="fu">rstandard</span>(ols3)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(covid<span class="sc">$</span>resids, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(covid<span class="sc">$</span>resids, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(covid<span class="sc">$</span>resids, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> resids_gp)) <span class="sc">+</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"Standardised residual"</span>, <span class="at">values =</span> pal, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="spatial-regression-models" class="level2">
<h2 class="anchored" data-anchor-id="spatial-regression-models">Spatial regression models</h2>
<section id="spatial-error-model" class="level3">
<h3 class="anchored" data-anchor-id="spatial-error-model">Spatial error model</h3>
<p>One way to handle the error structure is to fit a spatial simultaneous autoregressive error model which decomposes the error (the residuals) into two parts: a spatially lagged component and a remaining error: <span class="math inline">\(y = X\beta + \lambda W \xi + \epsilon\)</span>. The model can be fitted using R’s <code>spatialreg</code> package.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"spatialreg"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) <span class="fu">install.packages</span>(<span class="st">"spatialreg"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(spatialreg)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>errmod <span class="ot">&lt;-</span> <span class="fu">errorsarlm</span>(<span class="fu">formula</span>(ols3), <span class="at">data =</span> covid, <span class="at">listw =</span> spweight)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(errmod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:errorsarlm(formula = formula(ols3), data = covid, listw = spweight)

Residuals:
     Min       1Q   Median       3Q      Max 
-88.9057 -13.5631   1.0775  15.1597 108.7168 

Type: error 
Coefficients: (asymptotic standard errors) 
                     Estimate  Std. Error z value  Pr(&gt;|z|)
(Intercept)        228.423031   13.194612 17.3118 &lt; 2.2e-16
IMD                 -0.595479    0.089535 -6.6508 2.915e-11
age0.11              1.885127    0.449453  4.1943 2.738e-05
age25.34             2.612570    0.416075  6.2791 3.406e-10
age35.39             3.729976    1.369957  2.7227  0.006475
age50.59             3.339294    0.608468  5.4880 4.064e-08
carebeds             0.051339    0.010181  5.0426 4.592e-07
poly(density, 2)1 -111.989485   38.123934 -2.9375  0.003309
poly(density, 2)2 -120.005334   28.931983 -4.1478 3.356e-05

Lambda: 0.69751, LR test value: 348.94, p-value: &lt; 2.22e-16
Asymptotic standard error: 0.028893
    z-value: 24.142, p-value: &lt; 2.22e-16
Wald statistic: 582.82, p-value: &lt; 2.22e-16

Log likelihood: -4298.755 for error model
ML residual variance (sigma squared): 572.93, (sigma: 23.936)
Number of observations: 924 
Number of parameters estimated: 11 
AIC: 8619.5, (AIC for lm: 8966.5)</code></pre>
</div>
</div>
<p>The model is a better fit to the data, as the following diagnostics tell us (the lower the AIC the better)</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(ols3)<span class="sc">$</span>r.squared</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2479886</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(errmod)<span class="sc">$</span>r.squared</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5543411</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(ols3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8966.455</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(errmod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8619.511</code></pre>
</div>
</div>
<p>The differences are such that there is little doubt that the error model offers a much improved fit but if we do wish to test that difference statistically then</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(ols3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>'log Lik.' -4473.228 (df=10)</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(errmod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>'log Lik.' -4298.755 (df=11)</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>degf <span class="ot">&lt;-</span> <span class="fu">attr</span>(<span class="fu">logLik</span>(errmod), <span class="st">"df"</span>) <span class="sc">-</span> <span class="fu">attr</span>(<span class="fu">logLik</span>(ols3), <span class="st">"df"</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>LR <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> (<span class="fu">logLik</span>(ols3) <span class="sc">-</span> <span class="fu">logLik</span>(errmod))</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>LR <span class="sc">&gt;</span> <span class="fu">qchisq</span>(<span class="fl">0.99</span>, degf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Using the error model changes the estimates of the regression coefficients.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ols3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 5
  term               estimate std.error statistic  p.value
  &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 (Intercept)        185.       15.2       12.2   7.36e-32
2 IMD                 -0.338     0.0941    -3.59  3.45e- 4
3 age0.11              1.51      0.519      2.92  3.61e- 3
4 age25.34             3.15      0.464      6.80  1.87e-11
5 age35.39             3.96      1.56       2.55  1.11e- 2
6 age50.59             5.67      0.696      8.15  1.15e-15
7 carebeds             0.0290    0.0138     2.10  3.56e- 2
8 poly(density, 2)1   23.8      43.1        0.553 5.81e- 1
9 poly(density, 2)2 -267.       35.5       -7.54  1.11e-13</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(errmod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 5
   term               estimate std.error statistic  p.value
   &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1 (Intercept)        228.       13.2        17.3  0       
 2 IMD                 -0.595     0.0895     -6.65 2.91e-11
 3 age0.11              1.89      0.449       4.19 2.74e- 5
 4 age25.34             2.61      0.416       6.28 3.41e-10
 5 age35.39             3.73      1.37        2.72 6.48e- 3
 6 age50.59             3.34      0.608       5.49 4.06e- 8
 7 carebeds             0.0513    0.0102      5.04 4.59e- 7
 8 poly(density, 2)1 -112.       38.1        -2.94 3.31e- 3
 9 poly(density, 2)2 -120.       28.9        -4.15 3.36e- 5
10 lambda               0.698     0.0289     24.1  0       </code></pre>
</div>
</div>
<p>For example, where the 95% confidence interval for <code>age50.59</code> used to be 95CI [4.31, 7.04], under the error model it is 95CI [2.15, 4.53].</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(ols3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                          2.5 %        97.5 %
(Intercept)        1.555316e+02  215.12202256
IMD               -5.225593e-01   -0.15331307
age0.11            4.956890e-01    2.53253071
age25.34           2.244363e+00    4.06480619
age35.39           9.064758e-01    7.01079426
age50.59           4.308470e+00    7.03988250
carebeds           1.958051e-03    0.05604307
poly(density, 2)1 -6.079177e+01  108.44040596
poly(density, 2)2 -3.369641e+02 -197.81320842</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(errmod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                          2.5 %       97.5 %
lambda               0.64088619   0.75414281
(Intercept)        202.56206649 254.28399509
IMD                 -0.77096349  -0.41999361
age0.11              1.00421453   2.76603896
age25.34             1.79707796   3.42806128
age35.39             1.04490945   6.41504355
age50.59             2.14672005   4.53186895
carebeds             0.03138441   0.07129323
poly(density, 2)1 -186.71102210 -37.26794826
poly(density, 2)2 -176.71097755 -63.29968970</code></pre>
</div>
</div>
</section>
<section id="spatially-lagged-y-model" class="level3">
<h3 class="anchored" data-anchor-id="spatially-lagged-y-model">Spatially lagged y model</h3>
<p>Although the spatial error model fits the data better than the standard OLS model, it tells us only that there is an unexplained spatial structure to the residuals, not what caused it. It may offer better estimates of the model parameters and their statistical significance but it does not presuppose any particular spatial process generating the patterns in the values. A different model that explicitly tests for whether the value at a point is functionally dependent on the values of neighbouring points is the spatially lagged y model: <span class="math inline">\(y = \rho Wy + X\beta + \epsilon\)</span>. It models an ‘overspill’ or chain effect where the outcome (the Y value) at any location is affected by the outcomes at surrounding locations.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>lagmod <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(<span class="fu">formula</span>(ols3), <span class="at">data =</span> covid, <span class="at">listw =</span> spweight)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lagmod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:lagsarlm(formula = formula(ols3), data = covid, listw = spweight)

Residuals:
     Min       1Q   Median       3Q      Max 
-98.8140 -14.8770   1.0467  14.7420 110.1081 

Type: lag 
Coefficients: (asymptotic standard errors) 
                     Estimate  Std. Error z value  Pr(&gt;|z|)
(Intercept)         17.353050   14.403449  1.2048 0.2282866
IMD                 -0.371501    0.074903 -4.9598 7.057e-07
age0.11              1.377790    0.411239  3.3503 0.0008071
age25.34             2.678105    0.367344  7.2905 3.089e-13
age35.39             1.885234    1.235376  1.5260 0.1269996
age50.59             3.636195    0.553621  6.5680 5.099e-11
carebeds             0.042747    0.010887  3.9264 8.623e-05
poly(density, 2)1  -69.714325   34.062239 -2.0467 0.0406900
poly(density, 2)2 -156.910145   28.073145 -5.5893 2.279e-08

Rho: 0.63167, LR test value: 342.73, p-value: &lt; 2.22e-16
Asymptotic standard error: 0.02966
    z-value: 21.297, p-value: &lt; 2.22e-16
Wald statistic: 453.57, p-value: &lt; 2.22e-16

Log likelihood: -4301.863 for lag model
ML residual variance (sigma squared): 591.59, (sigma: 24.323)
Number of observations: 924 
Number of parameters estimated: 11 
AIC: 8625.7, (AIC for lm: 8966.5)
LM test for residual autocorrelation
test value: 3.5747, p-value: 0.058666</code></pre>
</div>
</div>
<p>Here, the test for residual autocorrelation does not generate a statistically significant result at a 95% level, although it is close.</p>
<p>Note that the beta estimates of the lagged y-model cannot be interpreted in the same way as for a standard OLS model. For example, the beta estimate of -0.372 for the <code>IMD</code> variable does not mean that if (hypothetically) we increased that variable by one unit at each location we should then expect the COVID-19 to everywhere decrease by 0.372 holding the other X variables constant. That is the correct interpretation for a standard (OLS) regression model and also for the spatial error model but not for where the lag of the Y variable is included as a predictor variable. The reason is because if we did raise the <code>IMD</code> value it would start something akin to a ‘chain reaction’ through the feedback of Y via the lagged Y values. The total impact is a sum of the direct effect – what is predicted to happen through the 1 unit change in <code>IMD</code> – and the indirect effect, which is that caused by ‘the chain reaction’ / feedback / ‘overspill’ in the system:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">impacts</span>(lagmod, <span class="at">listw =</span> spweight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Impact measures (lag, exact):
                        Direct     Indirect       Total
IMD                 -0.4123766   -0.5962428   -1.008619
age0.11              1.5293852    2.2112917    3.740677
age25.34             2.9727718    4.2982407    7.271013
age35.39             2.0926626    3.0257175    5.118380
age50.59             4.0362780    5.8359322    9.872210
carebeds             0.0474502    0.0686068    0.116057
poly(density, 2)1  -77.3848558 -111.8884195 -189.273275
poly(density, 2)2 -174.1746600 -251.8338663 -426.008526</code></pre>
</div>
</div>
<p>Although it wasn’t especially noticeable, there was a short pause as those impacts were calculated. The calculations could take much longer if the size of the spatial weights matrix was larger. As <a href="https://maczokni.github.io/crime_mapping_textbook/spatial-regression-models.html#fitting-and-interpreting-a-spatially-lagged-model" target="_blank">this author</a> notes, after <a href="https://www.routledge.com/Introduction-to-Spatial-Econometrics/LeSage-Pace/p/book/9781420064247" target="_blank">Lesage and Pace, 2009</a>, a faster approximation method can be used, here with <code>R = 1000</code> simulated distributions for the impact measures.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">as</span>(spweight, <span class="st">"CsparseMatrix"</span>)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>trMC <span class="ot">&lt;-</span> <span class="fu">trW</span>(W, <span class="at">type=</span><span class="st">"MC"</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>im <span class="ot">&lt;-</span><span class="fu">summary</span>(<span class="fu">impacts</span>(lagmod, <span class="at">tr =</span> trMC, <span class="at">R =</span> <span class="dv">1000</span>), <span class="at">zstats =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(im<span class="sc">$</span>res, <span class="at">row.names =</span> <span class="fu">names</span>(lagmod<span class="sc">$</span>coefficients)[<span class="sc">-</span><span class="dv">1</span>])   <span class="co"># The [-1] is to omit the intercept</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                        direct      indirect        total
IMD                 -0.4127825   -0.59583582   -1.0086183
age0.11              1.5308906    2.20978246    3.7406730
age25.34             2.9756979    4.29530708    7.2710050
age35.39             2.0947224    3.02365236    5.1183748
age50.59             4.0402510    5.83194905    9.8722000
carebeds             0.0474969    0.06855998    0.1160569
poly(density, 2)1  -77.4610260 -111.81205336 -189.2730794
poly(density, 2)2 -174.3461009 -251.66198462 -426.0080855</code></pre>
</div>
</div>
<p>An advantage of this approach is that we can also obtain z and p-values for the impact measures:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(im<span class="sc">$</span>zmat, <span class="at">row.names =</span> <span class="fu">names</span>(lagmod<span class="sc">$</span>coefficients)[<span class="sc">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                     Direct  Indirect     Total
IMD               -5.040987 -4.430669 -4.845884
age0.11            3.588123  3.265769  3.463193
age25.34           7.396350  5.358808  6.390354
age35.39           1.510795  1.472908  1.496500
age50.59           6.780106  5.286471  6.147066
carebeds           3.897915  3.488353  3.732830
poly(density, 2)1 -1.994186 -1.896356 -1.951069
poly(density, 2)2 -5.514023 -4.686951 -5.211374</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(im<span class="sc">$</span>pzmat, <span class="at">row.names =</span> <span class="fu">names</span>(lagmod<span class="sc">$</span>coefficients)[<span class="sc">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                        Direct     Indirect        Total
IMD               4.631374e-07 9.394110e-06 1.260494e-06
age0.11           3.330675e-04 1.091674e-03 5.338049e-04
age25.34          1.398881e-13 8.377261e-08 1.655025e-10
age35.39          1.308407e-01 1.407757e-01 1.345234e-01
age50.59          1.200884e-11 1.246988e-07 7.892911e-10
carebeds          9.702457e-05 4.860066e-04 1.893402e-04
poly(density, 2)1 4.613169e-02 5.791299e-02 5.104887e-02
poly(density, 2)2 3.507224e-08 2.773054e-06 1.874474e-07</code></pre>
</div>
</div>
<p>Most but not all of the impacts are significant. We can drop <code>age35.39</code> from the model with little loss of fit.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>lagmod2 <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(Rate <span class="sc">~</span>  IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span> carebeds <span class="sc">+</span> </span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">poly</span>(density, <span class="dv">2</span>), <span class="at">data =</span> covid, <span class="at">listw =</span> spweight)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(lagmod, lagmod2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        Model df    AIC  logLik Test L.Ratio p-value
lagmod      1 11 8625.7 -4301.9    1                
lagmod2     2 10 8626.1 -4303.0    2  2.3408 0.12602</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">glance</span>(lagmod), <span class="fu">glance</span>(lagmod2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  r.squared   AIC   BIC deviance logLik  nobs
      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;
1     0.532 8626. 8679.  546629. -4302.   924
2     0.532 8626. 8674.  547460. -4303.   924</code></pre>
</div>
</div>
<p><br> In fact, an increase of 1 unit in, for example, the <code>IMD</code> variable, will play out slightly differently in different places (because they have different neighbours with different Y values and at different distances from each other). The code below, which is from the first edition of <a href="https://uk.sagepub.com/en-gb/eur/spatial-regression-models/book262155" target="_blank">Ward &amp; Gleditsch (2008, pp.47)</a>, will calculate the impact (of a one unit change in <code>IMD</code>) at each location but below I have limited it to the first ten so that it doesn’t take too long to run.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(covid)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>I <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> n, <span class="at">ncol =</span> n)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(I) <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> lagmod<span class="sc">$</span>rho</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> lagmod<span class="sc">$</span>coefficients[<span class="st">"age25.34"</span>]</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>weights.matrix <span class="ot">&lt;-</span> <span class="fu">listw2mat</span>(spweight)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times=</span><span class="dv">10</span>)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, \(i) {</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>  xvector <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="at">times=</span>n)</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>  xvector[i] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>  impact <span class="ot">&lt;-</span> <span class="fu">solve</span>(I <span class="sc">-</span> rho <span class="sc">*</span> weights.matrix) <span class="sc">%*%</span> xvector <span class="sc">*</span> beta</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>  results[i] <span class="ot">&lt;-</span> impact[i]</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 2.953840 2.973231 2.949515 2.908907 3.025483 2.901597 2.949316 2.960332
 [9] 2.949171 2.946591</code></pre>
</div>
</div>
</section>
<section id="choosing-between-the-spatial-error-and-lagged-y-model" class="level3">
<h3 class="anchored" data-anchor-id="choosing-between-the-spatial-error-and-lagged-y-model">Choosing between the spatial error and lagged y model</h3>
<p>Before fitting the spatial error and lagged y models, we could have looked for evidence in support of them using the function <code>lm.LMtests()</code>. This tests the basic OLS specification against the more general spatial error and lagged y models. Anselin and Rey (2014, p.110) offer the following decision tree that can, in the absence of a more theoretical basis for the model choice (e.g.&nbsp;the type of process being modelled), be used in conjunction with the test results to help select the model.</p>
<p><img src="flowchart.jpg" class="img-fluid"></p>
<p><font size="2">Source: <a href="https://www.amazon.co.uk/Modern-Spatial-Econometrics-Practice-GeoDaSpace/dp/0986342106" target="&quot;_blank">Modern Spatial Econometrics in Practice</a></font></p>
<p>In the first step, we find that in this instance that both the LM-Error and LM-Lag tests are significant.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>ols4 <span class="ot">&lt;-</span> <span class="fu">update</span>(ols3, . <span class="sc">~</span> . <span class="sc">-</span> age35<span class="fl">.39</span>, <span class="at">data =</span> covid)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Drops the age35.39 variable</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.LMtests</span>(ols4, spweight, <span class="at">test=</span><span class="fu">c</span>(<span class="st">"LMerr"</span>, <span class="st">"LMlag"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Lagrange multiplier diagnostics for spatial dependence

data:  
model: lm(formula = Rate ~ IMD + age0.11 + age25.34 + age50.59 +
carebeds + poly(density, 2), data = covid)
weights: spweight

LMerr = 411.48, df = 1, p-value &lt; 2.2e-16


    Lagrange multiplier diagnostics for spatial dependence

data:  
model: lm(formula = Rate ~ IMD + age0.11 + age25.34 + age50.59 +
carebeds + poly(density, 2), data = covid)
weights: spweight

LMlag = 463.85, df = 1, p-value &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Moving on to the robust tests, only the LM-Lag test is significant. Given the nature of COVID-19 as an infectious disease, it does seem reasonable to suppose that high rates of infection in any an area will ‘overspill’ into neighbouring areas too.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.LMtests</span>(ols4, spweight, <span class="at">test=</span><span class="fu">c</span>(<span class="st">"RLMerr"</span>, <span class="st">"RLMlag"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Lagrange multiplier diagnostics for spatial dependence

data:  
model: lm(formula = Rate ~ IMD + age0.11 + age25.34 + age50.59 +
carebeds + poly(density, 2), data = covid)
weights: spweight

RLMerr = 2.3319, df = 1, p-value = 0.1267


    Lagrange multiplier diagnostics for spatial dependence

data:  
model: lm(formula = Rate ~ IMD + age0.11 + age25.34 + age50.59 +
carebeds + poly(density, 2), data = covid)
weights: spweight

RLMlag = 54.693, df = 1, p-value = 1.409e-13</code></pre>
</div>
</div>
</section>
</section>
<section id="a-geographically-weighted-spatial-weights-matrix" class="level2">
<h2 class="anchored" data-anchor-id="a-geographically-weighted-spatial-weights-matrix">A geographically weighted spatial weights matrix</h2>
<p>As with the tests of spatial autocorrelation in an earlier session and as with the geographically weighted statistics, the results of the spatial regression models are dependent on the specification of the spatial weights matrix which can suffer from being somewhat arbitrary. We could, if we wish, try calibrating it around the geographically weighted mean.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(GWmodel)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(Rate <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> covid_sp, <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To now create the corresponding inverse distance spatial weights matrix for the models, we can use the <code>nn2</code> function in the <code>RANN</code> package to find the <code>bw =</code> 18 nearest neighbours to each centroid point:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"RANN"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>]))  <span class="fu">install.packages</span>(<span class="st">"RANN"</span>)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(RANN)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(<span class="fu">st_centroid</span>(<span class="fu">st_geometry</span>(covid)))</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>knn <span class="ot">&lt;-</span> <span class="fu">nn2</span>(coords, coords, <span class="at">k =</span> bw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Having done so, those neighbours can be geographically weighted using a bisquare kernel, as in the GWR calibration above. (A Gaussian kernel is obtained if <code>(1 - (x / max(x))^2)^2</code> is replaced by <code>exp(-0.5 * (x / max(x))^2)</code> in the code below).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> knn<span class="sc">$</span>nn.dists</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>glist <span class="ot">&lt;-</span> <span class="fu">apply</span>(d, <span class="dv">1</span>, \(x) {</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span> <span class="sc">-</span> (x <span class="sc">/</span> <span class="fu">max</span>(x))<span class="sc">^</span><span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>}, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>knearnb <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(<span class="fu">st_centroid</span>(<span class="fu">st_geometry</span>(covid)), <span class="at">k =</span> bw))</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>spweightK <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(knearnb, glist, <span class="at">style =</span> <span class="st">"C"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The results are not very successful though. The lag model with contiguous spatial weights fits the data better,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>lagmod3 <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(<span class="fu">formula</span>(ols4), <span class="at">data =</span> covid, <span class="at">listw =</span> spweightK)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">glance</span>(lagmod2), <span class="fu">glance</span>(lagmod3))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  r.squared   AIC   BIC deviance logLik  nobs
      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;
1     0.532 8626. 8674.  547460. -4303.   924
2     0.254 8959. 9008.  860562. -4470.   924</code></pre>
</div>
</div>
<p>In addition, the inverse distance weights are not row-standardised, which may cause some knock-on problems. They could become row-standardised (<code>spweightK &lt;- nb2listw(knearnb, glist, style = "W")</code>) but if they are, by re-scaling each row of the weights to equal one, then the inverse distance weighting is altered.</p>
</section>
<section id="geographically-weighted-regression" class="level2">
<h2 class="anchored" data-anchor-id="geographically-weighted-regression">Geographically Weighted Regression</h2>
<p>In much the same way as we can calculate geographically weighted statistics that allow the measured value to vary locally from location to location across the study region, we can also calculate geographically weighted and locally estimated regression coefficients using <a href="https://www.sciencedirect.com/science/article/pii/B9780080449104004478?via%3Dihub" target="_blank">geographically weighted regression</a>. This is used to look for spatial variation in the regression relationships.</p>
<p>If the bandwidth is not known or there is no theoretical justification for it, it can be found using an automated selection procedure.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(GWmodel)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(<span class="fu">formula</span>(ols4), <span class="at">data =</span> covid_sp, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The model can then be fitted.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>gwrmod <span class="ot">&lt;-</span> <span class="fu">gwr.basic</span>(<span class="fu">formula</span>(ols4), <span class="at">data =</span> covid_sp, <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">bw =</span> bw)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>gwrmod</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   ***********************************************************************
   *                       Package   GWmodel                             *
   ***********************************************************************
   Program starts at: 2022-08-20 13:32:06 
   Call:
   gwr.basic(formula = formula(ols4), data = covid_sp, bw = bw, 
    adaptive = TRUE)

   Dependent (y) variable:  Rate
   Independent variables:  IMD age0.11 age25.34 age50.59 carebeds density
   Number of data points: 924
   ***********************************************************************
   *                    Results of Global Regression                     *
   ***********************************************************************

   Call:
    lm(formula = formula, data = data)

   Residuals:
     Min       1Q   Median       3Q      Max 
-123.194  -18.380    1.473   20.623  127.554 

   Coefficients:
                       Estimate Std. Error t value Pr(&gt;|t|)    
   (Intercept)        188.50375   15.17560  12.422  &lt; 2e-16 ***
   IMD                 -0.39649    0.09149  -4.334 1.63e-05 ***
   age0.11              2.30191    0.41777   5.510 4.66e-08 ***
   age25.34             3.93517    0.34898  11.276  &lt; 2e-16 ***
   age50.59             5.80810    0.69596   8.345 2.59e-16 ***
   carebeds             0.02904    0.01382   2.101   0.0359 *  
   poly(density, 2)1   29.14870   43.19300   0.675   0.4999    
   poly(density, 2)2 -292.74904   34.12420  -8.579  &lt; 2e-16 ***

   ---Significance stars
   Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 
   Residual standard error: 30.88 on 916 degrees of freedom
   Multiple R-squared: 0.2427
   Adjusted R-squared: 0.2369 
   F-statistic: 41.93 on 7 and 916 DF,  p-value: &lt; 2.2e-16 
   ***Extra Diagnostic information
   Residual sum of squares: 873446.4
   Sigma(hat): 30.77887
   AIC:  8970.975
   AICc:  8971.172
   BIC:  8151.892
   ***********************************************************************
   *          Results of Geographically Weighted Regression              *
   ***********************************************************************

   *********************Model calibration information*********************
   Kernel function: bisquare 
   Adaptive bandwidth: 80 (number of nearest neighbours)
   Regression points: the same locations as observations are used.
   Distance metric: Euclidean distance metric is used.

   ****************Summary of GWR coefficient estimates:******************
                            Min.     1st Qu.      Median     3rd Qu.     Max.
   Intercept         -3.9934e+01  1.3693e+02  2.1422e+02  2.6180e+02 419.5064
   IMD               -2.7499e+00 -7.8059e-01 -4.4223e-01 -1.6702e-01   0.6501
   age0.11           -4.0541e+00  2.3759e-01  3.4220e+00  6.1701e+00  12.5921
   age25.34          -3.9387e+00  1.6469e+00  2.6274e+00  4.2843e+00  13.8157
   age50.59          -9.5346e+00  2.1727e+00  5.3255e+00  8.6233e+00  14.3515
   carebeds          -5.6126e-02  2.5983e-02  5.8662e-02  8.7463e-02   0.2220
   poly(density, 2)1 -2.7204e+03 -4.1814e+02 -1.5602e+02  4.1180e-01 667.9061
   poly(density, 2)2 -2.1980e+03 -5.4619e+02 -2.5300e+02 -1.2247e+02 643.0451
   ************************Diagnostic information*************************
   Number of data points: 924 
   Effective number of parameters (2trace(S) - trace(S'S)): 270.2441 
   Effective degrees of freedom (n-2trace(S) + trace(S'S)): 653.7559 
   AICc (GWR book, Fotheringham, et al. 2002, p. 61, eq 2.33): 8552.959 
   AIC (GWR book, Fotheringham, et al. 2002,GWR p. 96, eq. 4.22): 8216.682 
   BIC (GWR book, Fotheringham, et al. 2002,GWR p. 61, eq. 2.34): 8513.32 
   Residual sum of squares: 313860.8 
   R-square value:  0.7278617 
   Adjusted R-square value:  0.6151951 

   ***********************************************************************
   Program stops at: 2022-08-20 13:32:07 </code></pre>
</div>
</div>
<p>The output requires some interpretation! The results of the global regression are those obtained from a standard OLS regression (i.e.&nbsp;<code>summary(lm(formula(ols4), data = covid_sp))</code>). It is ‘global’ because it is a model for the entire study region, without spatial variation in the regression estimates. The results of the geographically weighted regression are the results from, in this case, 924 separate but spatially overlapping regression models fitted, with geographic weighting, to spatial subsets of the data. All the local estimates are contained in the spatial data frame, <code>gwrmod$SDF</code>, including those for <code>age0.11</code> which are in <code>gwrmod$SDF$age0.11</code> and have the following distribution,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
-4.0541  0.2376  3.4220  3.3645  6.1701 12.5921 </code></pre>
</div>
</div>
<p>This is the same summary of the distribution that is included in the GWR coefficient estimates. What it means is that in at least one location the relationship of <code>age0.11</code> to <code>Rate</code> is, conditional on the other variables, negative. It is more usual for it to be positive – more children, more infections (perhaps a school effect?) – but the estimated effect size varies quite substantially. Its interquartile range is from 0.238 to 6.17. Mapping these local estimates reveals an interesting geography – it is largely in and around Manchester where a greater number of children of primary school age or younger appears to lower the infection rate.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR <span class="ot">&lt;-</span> gwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> covid, <span class="fu">aes</span>(<span class="at">fill =</span> age0<span class="fl">.11</span>GWR)) <span class="sc">+</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="st">"estimated beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>) <span class="sc">+</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>With a bit of effort we can get all the variables on the same chart…</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"gridExtra"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) <span class="fu">install.packages</span>(<span class="st">"gridExtra"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(gridExtra)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">8</span>, \(j) {</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(gwrmod<span class="sc">$</span>SDF[, j]) <span class="sc">%&gt;%</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">beta =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> beta)) <span class="sc">+</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">col =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>) <span class="sc">+</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggtitle</span>(<span class="fu">names</span>(gwrmod<span class="sc">$</span>SDF[j]))</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(<span class="at">grobs =</span> g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>… however, not all of these regression estimates are necessarily statistically significant. If we use the estimated t-values to isolate those that are not, then, for the <code>age0.11</code> variable we obtain,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR[<span class="fu">abs</span>(gwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span>_TV) <span class="sc">&gt;</span> <span class="fl">1.96</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> covid, <span class="fu">aes</span>(<span class="at">fill =</span> age0<span class="fl">.11</span>GWR)) <span class="sc">+</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="st">"aged2.11"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">na.value =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>and, with a bit more data wrangling, for the full set,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>sdf <span class="ot">&lt;-</span> <span class="fu">slot</span>(gwrmod<span class="sc">$</span>SDF, <span class="st">"data"</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">8</span>, \(j) {</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(gwrmod<span class="sc">$</span>SDF[, j]) </span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(sdf) <span class="sc">==</span> <span class="fu">paste0</span>(<span class="fu">names</span>(x)[<span class="dv">1</span>],<span class="st">"_TV"</span>))</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>  x[<span class="fu">abs</span>(sdf[, t]) <span class="sc">&gt;</span> <span class="fl">1.96</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">%&gt;%</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">beta =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> beta)) <span class="sc">+</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">col =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">na.value =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggtitle</span>(<span class="fu">names</span>(gwrmod<span class="sc">$</span>SDF[j]))</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(<span class="at">grobs =</span> g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">I am sure there is a more elegant way of doing this. Don’t worry about the code especially - the point is that not every estimate, everywhere is significant.</font></p>
<p>As with the basic GW statistics, we can undertake a randomisation test to suggest whether the spatial variation in the coefficient estimates is statistically significant. <strong>However</strong> this takes some time to run – with the default <code>nsims = 99</code> simulations it took about 12 minutes on my laptop. I have ‘commented it out’ in the code block below with the suggestion that you don’t run it now.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I suggest you do not run this</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="co"># gwr.mc &lt;- gwr.montecarlo(formula(ols4), covid_sp, adaptive = TRUE, bw = bw)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Instead, let’s jump straight to the results, which I have saved in a pre-prepared workspace.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/workspaces/gwrmc.RData"</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(url)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(url)</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>gwr.mc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                  p-value
(Intercept)          0.40
IMD                  0.38
age0.11              0.00
age25.34             0.15
age50.59             0.22
carebeds             0.97
poly(density, 2)1    0.00
poly(density, 2)2    0.00</code></pre>
</div>
</div>
<p>It appears that only the <code>age0.11</code> and <code>density</code> variables exhibit significant spatial variation. In principle it is possible to drop the other variables out from the local estimates and treat them as fixed, global estimates instead, in a Mixed GWR model (mixed global and local regression estimates). In practice, it is generating an error.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This appears to generate an error</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>gwrmixd <span class="ot">&lt;-</span> <span class="fu">gwr.mixed</span>(Rate <span class="sc">~</span> IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age18<span class="fl">.24</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age35<span class="fl">.39</span> <span class="sc">+</span> </span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>          age50<span class="fl">.59</span> <span class="sc">+</span> age60<span class="fl">.69</span> <span class="sc">+</span> <span class="fu">poly</span>(density, <span class="dv">2</span>),</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> covid_sp,</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">fixed.vars =</span> <span class="fu">c</span>(<span class="st">"IMD"</span>, <span class="st">"age18.24"</span>, <span class="st">"age25.34"</span>, <span class="st">"age35.39"</span>, <span class="st">"age50.59"</span>, <span class="st">"age60.69"</span>),</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">bw =</span> bw, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>It is also possible to fit a Multiscale GWR, which allows for the possibility of a different bandwith for each variable – see <code>?gwr.multiscale</code>. Since there is no particular reason to presume that the bandwidth should be the same for all the variables, arguably Multiscale GWR should be preferred over standard GWR, at least in the first instance. Its main drawback, however, is that it takes a very long time to run – over 12 hours for the code chunk below! (In principle it can be parallelised but it generated an error for me when I tried this with <code>parallel.method = cluster</code>.)</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>density<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">poly</span>(covid<span class="sc">$</span>density, <span class="dv">2</span>)[, <span class="dv">1</span>]</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>density<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">poly</span>(covid<span class="sc">$</span>density, <span class="dv">2</span>)[, <span class="dv">2</span>]</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Do not run!</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Took over 12 hours!</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="co">#gwrmulti &lt;- gwr.multiscale(Rate ~ IMD + age0.11 + age18.24 + age25.34 + age35.39 + </span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="co">#    age50.59 + age60.69 + density.1 + density.2, data = covid_sp, adaptive = TRUE)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To save time, the results are available below. The bandwidths do appear to vary.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/workspaces/gwrmulti.RData"</span>)</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(url)</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(url)</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>gwrmulti</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   ***********************************************************************
   *                       Package   GWmodel                             *
   ***********************************************************************
   Program starts at: 2022-08-17 18:51:17 
   Call:
   gwr.multiscale(formula = Rate ~ IMD + age0.11 + age18.24 + age25.34 + 
    age35.39 + age50.59 + age60.69 + density.1 + density.2, data = covid_sp, 
    adaptive = TRUE)

   Dependent (y) variable:  Rate
   Independent variables:  IMD age0.11 age18.24 age25.34 age35.39 age50.59 age60.69 density.1 density.2
   Number of data points: 924
   ***********************************************************************
   *                       Multiscale (PSDM) GWR                          *
   ***********************************************************************

   *********************Model calibration information*********************
   Kernel function: bisquare 
   Adaptive bandwidths for each coefficient(number of nearest neighbours): 
              (Intercept) IMD age0.11 age18.24 age25.34 age35.39 age50.59
   Bandwidth           39 693     214      130      653      193      922
              age60.69 density.1 density.2
   Bandwidth        28       599       212

   ****************Summary of GWR coefficient estimates:******************
                    Min.     1st Qu.      Median     3rd Qu.     Max.
   Intercept  -31.197218  200.811555  248.224373  306.612670 500.8892
   IMD         -0.489072   -0.452815   -0.364376   -0.241989  -0.1982
   age0.11     -2.450047   -1.639486    0.991076    2.494385   6.4147
   age18.24    -4.376451   -2.186489   -0.064498    1.117126   3.5455
   age25.34     1.520858    2.198867    2.241291    2.370821   2.5843
   age35.39    -0.660663    2.383974    6.076721    7.555532  11.4270
   age50.59     2.394868    2.410130    2.430165    2.452018   2.6210
   age60.69   -17.340715   -3.309427    1.061763    4.848025  20.4274
   density.1 -150.542024 -134.878256 -115.846289  -30.782630  16.6172
   density.2 -597.659231 -156.793018 -108.166665  -56.461964  47.9226
   ************************Diagnostic information*************************
   Number of data points: 924 
   Effective number of parameters (2trace(S) - trace(S'S)): 218.6154 
   Effective degrees of freedom (n-2trace(S) + trace(S'S)): 705.3846 
   AICc value:  8412.675 
   AIC value:  8166.915 
   BIC value:  8220.837 
   Residual sum of squares:  311112.8 
   R-square value:  0.7302444 
   Adjusted R-square value:  0.6465221 

   ***********************************************************************
   Program stops at: 2022-08-18 07:01:17 </code></pre>
</div>
</div>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this session we have looked at spatial regression models as a way to address the problem of spatial autocorrelation in regression residuals and to allow for the possibility that regression relationships vary across a map. In presenting these methods, at least some could be taken as offering a ‘technical fix’ to the statistical issue of spatial dependencies in the data, violating assumptions of independence. Whilst that may be true, and the more spatial approaches can be used as diagnostic tools to check for a mis-specified model, notably one that lacks a critical explanatory variable or where the relationship between the X and Y variables is non-linear, the limitation of this thinking is that it treats geography as an error to be resolved and/or it rests on the belief that with sufficient information the geographical differences will be explained. What geographically weighted regression, for example, reminds us is that the nature of the relationship may be complex because it is changing in form across the study region as the socio-spatial causes also vary from place to place. Such spatial complexity may be challenging to accommodate within the parameters of conventional aspatial or spatially naïve statistical thinking but ignoring the geographical variation is not a solution. What spatial thinking brings to the table is the recognition of geographical context and the knowledge that geographically rooted social outcomes are not independent of where the processes giving rise to those outcomes are taking place.</p>
</section>
<section id="further-reading" class="level2">
<h2 class="anchored" data-anchor-id="further-reading">Further Reading</h2>
<p><img src="spatial_regression.jpg" class="img-fluid" width="100"></p>
<p><a href="https://uk.sagepub.com/en-gb/eur/spatial-regression-models/book262155" target="_blank">Spatial Regression Models (2nd edition) by MD Ward &amp; KS Gleditsch (2018)</a></p>
<p>Comber et al.&nbsp;(2022) A Route Map for Successful Applications of Geographically Weighted Regression. <a href="https://doi.org/10.1111/gean.12316" target="_blank">https://doi.org/10.1111/gean.12316</a></p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./gwstats.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Geographically Weighted Statistics</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb100" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Spatial Regression"</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="co">  fig-height: 7</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>In the previous session we looked at geographically weighted statistics, including geographically weighted correlation, which examines whether the correlation between two variables varies across a map. In this session we extend from correlation to looking at regression modelling with a spatial component. The data that we shall use are a map of the rate of COVID-19 infections per thousand population in neighbourhoods of the North West of England over the period from the week commencing 2020-03-07 to the week commencing 2022-04-16. That rate is calculated as the total number of reported infections per neighbourhood, divided by the <span class="co">[</span><span class="ot">mid-2020 ONS estimated population</span><span class="co">](https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/middlesuperoutputareamidyearpopulationestimates)</span>{target="blank"}. There are three problems with these data, which originate (prior to adjustment) from <span class="co">[</span><span class="ot">https://coronavirus.data.gov.uk/details/download</span><span class="co">](https://coronavirus.data.gov.uk/details/download)</span>{target="_blank"}:</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>The rate, as calculated, does not allow for re-infection (i.e. the same person can catch COVID-19 more than once).</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Not everyone who had COVID was tested for a positive diagnosis. Limitations in the testing regime are described in <span class="co">[</span><span class="ot">this paper</span><span class="co">](https://link.springer.com/article/10.1007/s12061-021-09400-8)</span>{target="_blank"} and are most severe earlier in the pandemic and again towards the end of the data period as testing was scaled-back and then largely withdrawn.</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Where a neighbourhood had less than three cases in a week, that number was reported as zero even though it could really be one or two. That second type of undercount adds up, although, unsurprisingly it affects the largest cities most (because they have more neighbourhoods to be undercounted) in weeks when COVID is not especially prevalent. An adjustment has been made to the data to allow for this but not for the undercount caused by not testing positive.</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>Nevertheless, the data are sufficient to illustrate the methods.</span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a><span class="fu">## Getting Started</span></span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>The data are downloaded as follows. The required packages should be installed already, from previous sessions.</span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"remotes"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) <span class="fu">install.packages</span>(<span class="st">"remotes"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"ggsflabel"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"yutannihilation/ggsflabel"</span>)</span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(sf)</span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggplot2)</span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggsflabel)</span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"covid.geojson"</span>)) <span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/data/covid.geojson"</span>,</span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true" tabindex="-1"></a><span class="st">"covid.geojson"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-36"><a href="#cb100-36" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(<span class="st">"covid.geojson"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb100-37"><a href="#cb100-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(regionName <span class="sc">==</span> <span class="st">"North West"</span>) <span class="ot">-&gt;</span></span>
<span id="cb100-38"><a href="#cb100-38" aria-hidden="true" tabindex="-1"></a>  covid</span>
<span id="cb100-39"><a href="#cb100-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-40"><a href="#cb100-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-41"><a href="#cb100-41" aria-hidden="true" tabindex="-1"></a>Looking at a map of the COVID-19 rates, it appears that there are patches of higher rates that tend to cluster in cities such as Preston, Manchester and Liverpool, although not exclusively so</span>
<span id="cb100-42"><a href="#cb100-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-45"><a href="#cb100-45" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-46"><a href="#cb100-46" aria-hidden="true" tabindex="-1"></a>covid <span class="sc">%&gt;%</span></span>
<span id="cb100-47"><a href="#cb100-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Rate <span class="sc">&gt;</span> <span class="dv">400</span>) <span class="sc">%&gt;%</span></span>
<span id="cb100-48"><a href="#cb100-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(LtlaName) <span class="sc">%&gt;%</span>   <span class="co"># LtlaName is the name of the local authority</span></span>
<span id="cb100-49"><a href="#cb100-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(LtlaName)) <span class="ot">-&gt;</span></span>
<span id="cb100-50"><a href="#cb100-50" aria-hidden="true" tabindex="-1"></a>  high_rate</span>
<span id="cb100-51"><a href="#cb100-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-52"><a href="#cb100-52" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb100-53"><a href="#cb100-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> covid, <span class="fu">aes</span>(<span class="at">fill =</span> Rate), <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb100-54"><a href="#cb100-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"YlOrRd"</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb100-55"><a href="#cb100-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_label_repel</span>(<span class="at">data =</span> high_rate, <span class="fu">aes</span>(<span class="at">label =</span> LtlaName), <span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb100-56"><a href="#cb100-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb100-57"><a href="#cb100-57" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-58"><a href="#cb100-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-59"><a href="#cb100-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-60"><a href="#cb100-60" aria-hidden="true" tabindex="-1"></a>... and not without variation within the cities such as Manchester:</span>
<span id="cb100-61"><a href="#cb100-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-64"><a href="#cb100-64" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-65"><a href="#cb100-65" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> covid <span class="sc">%&gt;%</span> <span class="fu">filter</span>(LtlaName <span class="sc">==</span> <span class="st">"Manchester"</span>)) <span class="sc">+</span></span>
<span id="cb100-66"><a href="#cb100-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Rate), <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb100-67"><a href="#cb100-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"YlOrRd"</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb100-68"><a href="#cb100-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb100-69"><a href="#cb100-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-70"><a href="#cb100-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-71"><a href="#cb100-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-72"><a href="#cb100-72" aria-hidden="true" tabindex="-1"></a>Across the map there appears to be a pattern of positive spatial autocorrelation in the COVID-19 rates of contiguous neighbours, whether this is measured using a Moran test,</span>
<span id="cb100-73"><a href="#cb100-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-76"><a href="#cb100-76" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-77"><a href="#cb100-77" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(spdep)</span>
<span id="cb100-78"><a href="#cb100-78" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(<span class="fu">poly2nb</span>(covid, <span class="at">snap =</span> <span class="dv">1</span>))</span>
<span id="cb100-79"><a href="#cb100-79" aria-hidden="true" tabindex="-1"></a><span class="fu">moran.test</span>(covid<span class="sc">$</span>Rate, spweight)</span>
<span id="cb100-80"><a href="#cb100-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-81"><a href="#cb100-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-82"><a href="#cb100-82" aria-hidden="true" tabindex="-1"></a>or using the Pearson correlation,</span>
<span id="cb100-83"><a href="#cb100-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-86"><a href="#cb100-86" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-87"><a href="#cb100-87" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(<span class="fu">lag.listw</span>(spweight, covid<span class="sc">$</span>Rate), covid<span class="sc">$</span>Rate)</span>
<span id="cb100-88"><a href="#cb100-88" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-89"><a href="#cb100-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-90"><a href="#cb100-90" aria-hidden="true" tabindex="-1"></a>Some of the 'hot spots' of infection are suggested using the geographically-weighted means,</span>
<span id="cb100-91"><a href="#cb100-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-94"><a href="#cb100-94" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-95"><a href="#cb100-95" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: false</span></span>
<span id="cb100-96"><a href="#cb100-96" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(GWmodel)</span>
<span id="cb100-97"><a href="#cb100-97" aria-hidden="true" tabindex="-1"></a>covid_sp <span class="ot">&lt;-</span> <span class="fu">as_Spatial</span>(covid)</span>
<span id="cb100-98"><a href="#cb100-98" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(Rate <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> covid_sp,</span>
<span id="cb100-99"><a href="#cb100-99" aria-hidden="true" tabindex="-1"></a>             <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>, <span class="at">longlat =</span> F)</span>
<span id="cb100-100"><a href="#cb100-100" aria-hidden="true" tabindex="-1"></a>gwstats <span class="ot">&lt;-</span> <span class="fu">gwss</span>(covid_sp, <span class="at">vars =</span> <span class="st">"Rate"</span>, <span class="at">bw =</span> bw, <span class="at">kernel =</span> <span class="st">"bisquare"</span>,</span>
<span id="cb100-101"><a href="#cb100-101" aria-hidden="true" tabindex="-1"></a>                <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">longlat =</span> F)</span>
<span id="cb100-102"><a href="#cb100-102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-103"><a href="#cb100-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-104"><a href="#cb100-104" aria-hidden="true" tabindex="-1"></a>Plotting these,</span>
<span id="cb100-105"><a href="#cb100-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-108"><a href="#cb100-108" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-109"><a href="#cb100-109" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>Rate_LM <span class="ot">&lt;-</span> gwstats<span class="sc">$</span>SDF<span class="sc">$</span>Rate_LM</span>
<span id="cb100-110"><a href="#cb100-110" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> Rate_LM)) <span class="sc">+</span></span>
<span id="cb100-111"><a href="#cb100-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb100-112"><a href="#cb100-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"YlOrRd"</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb100-113"><a href="#cb100-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb100-114"><a href="#cb100-114" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-115"><a href="#cb100-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-116"><a href="#cb100-116" aria-hidden="true" tabindex="-1"></a>They also are suggested using the G-statistic with a somewhat arbitrary bandwidth of 5km.</span>
<span id="cb100-117"><a href="#cb100-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-120"><a href="#cb100-120" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-121"><a href="#cb100-121" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(covid, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-122"><a href="#cb100-122" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">5000</span>)</span>
<span id="cb100-123"><a href="#cb100-123" aria-hidden="true" tabindex="-1"></a>spweightB <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-124"><a href="#cb100-124" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(covid<span class="sc">$</span>Rate, spweightB)</span>
<span id="cb100-125"><a href="#cb100-125" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(covid<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb100-126"><a href="#cb100-126" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(covid<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb100-127"><a href="#cb100-127" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(covid<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-128"><a href="#cb100-128" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb100-129"><a href="#cb100-129" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp)) <span class="sc">+</span></span>
<span id="cb100-130"><a href="#cb100-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb100-131"><a href="#cb100-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"G"</span>, <span class="at">values =</span> pal, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb100-132"><a href="#cb100-132" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb100-133"><a href="#cb100-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb100-134"><a href="#cb100-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb100-135"><a href="#cb100-135" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-136"><a href="#cb100-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-137"><a href="#cb100-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-138"><a href="#cb100-138" aria-hidden="true" tabindex="-1"></a><span class="fu">## An initial model to explain the spatial patterns in the COVID-19 rates</span></span>
<span id="cb100-139"><a href="#cb100-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-140"><a href="#cb100-140" aria-hidden="true" tabindex="-1"></a>It is likely that the spatial variation in the COVID-19 rates is due to differences in the physical attributes of the different neighbourhoods and/or of the populations who live in them. For example, the rates may be related to the relative level of deprivation in the neighbourhoods (the <span class="co">[</span><span class="ot">Index of Multiple Deprivation</span><span class="co">](https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019)</span>{target="_blank"}, <span class="in">`IMD`</span>), the age composition of their populations (e.g. percentage aged 0 to 11, <span class="in">`age0.11`</span>), the population density (<span class="in">`density`</span>), the number of carehome beds (<span class="in">`carebeds`</span>, because particularly early on in the pandemic, carehome residents were at very high risk), and whether they contain an Accident and Emergency hospital (<span class="in">`AandE`</span>, coded 1 if they do and 0 if they don't). Incorporating this into a standard regression model gives, </span>
<span id="cb100-141"><a href="#cb100-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-144"><a href="#cb100-144" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-145"><a href="#cb100-145" aria-hidden="true" tabindex="-1"></a>ols1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(Rate <span class="sc">~</span> IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age12<span class="fl">.17</span> <span class="sc">+</span> age18<span class="fl">.24</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age35<span class="fl">.39</span> <span class="sc">+</span> </span>
<span id="cb100-146"><a href="#cb100-146" aria-hidden="true" tabindex="-1"></a>             age50<span class="fl">.59</span> <span class="sc">+</span> age60<span class="fl">.69</span> <span class="sc">+</span> age70plus <span class="sc">+</span> density <span class="sc">+</span></span>
<span id="cb100-147"><a href="#cb100-147" aria-hidden="true" tabindex="-1"></a>             carebeds <span class="sc">+</span> AandE, <span class="at">data =</span> covid)</span>
<span id="cb100-148"><a href="#cb100-148" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ols1)</span>
<span id="cb100-149"><a href="#cb100-149" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-150"><a href="#cb100-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-151"><a href="#cb100-151" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/br&gt;</span></span>
<span id="cb100-152"><a href="#cb100-152" aria-hidden="true" tabindex="-1"></a>which, as its R-squared value of <span class="in">`r round(summary(ols1)$r.squared, 3)`</span> suggests, goes some way to explaining the variation in the rates. Looking at R's standard diagnostic plots there is not any strong evidence that the residual Normality assumption of the regression is being violated although, not very surprisingly, the variance inflation values (VIF) do suggest high levels of colinearity between the age variables.</span>
<span id="cb100-153"><a href="#cb100-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-156"><a href="#cb100-156" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-157"><a href="#cb100-157" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb100-158"><a href="#cb100-158" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ols1)</span>
<span id="cb100-159"><a href="#cb100-159" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"car"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) <span class="fu">install.packages</span>(<span class="st">"car"</span>)</span>
<span id="cb100-160"><a href="#cb100-160" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(car)</span>
<span id="cb100-161"><a href="#cb100-161" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(ols1)</span>
<span id="cb100-162"><a href="#cb100-162" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-163"><a href="#cb100-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-164"><a href="#cb100-164" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width=75}</span>
<span id="cb100-165"><a href="#cb100-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-166"><a href="#cb100-166" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;font</span> <span class="er">size</span> <span class="ot">=</span> <span class="st">3</span><span class="kw">&gt;</span>There are no hard and fast rules but, in broad terms, a VIF value of 4 or 5 or above is considering and a value above 10 suggests a high level of multicollinearity.<span class="kw">&lt;/font&gt;</span></span>
<span id="cb100-167"><a href="#cb100-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-168"><a href="#cb100-168" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/br&gt;</span></span>
<span id="cb100-169"><a href="#cb100-169" aria-hidden="true" tabindex="-1"></a>Although I am generally cautious about automated selection procedures, in this case a stepwise model selection appears useful to address the colinearity:</span>
<span id="cb100-170"><a href="#cb100-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-173"><a href="#cb100-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-174"><a href="#cb100-174" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: false</span></span>
<span id="cb100-175"><a href="#cb100-175" aria-hidden="true" tabindex="-1"></a>ols2 <span class="ot">&lt;-</span> <span class="fu">step</span>(ols1)</span>
<span id="cb100-176"><a href="#cb100-176" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-177"><a href="#cb100-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-178"><a href="#cb100-178" aria-hidden="true" tabindex="-1"></a>The results are,</span>
<span id="cb100-179"><a href="#cb100-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-182"><a href="#cb100-182" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-183"><a href="#cb100-183" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ols2)</span>
<span id="cb100-184"><a href="#cb100-184" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(ols2)</span>
<span id="cb100-185"><a href="#cb100-185" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-186"><a href="#cb100-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-187"><a href="#cb100-187" aria-hidden="true" tabindex="-1"></a>It may seem surprising to discover that the deprivation index is negatively correlated with the COVID rate -- implying more deprivation, fewer infections -- but this is due to the later variants of the disease which have spread quickly through more affluent populations when restrictions on mobility and social interaction have been relaxed.</span>
<span id="cb100-188"><a href="#cb100-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-189"><a href="#cb100-189" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial dependencies in the model residuals</span></span>
<span id="cb100-190"><a href="#cb100-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-191"><a href="#cb100-191" aria-hidden="true" tabindex="-1"></a>Although the model appears to fit the data reasonably well, there is a problem. The residuals are supposed to be random noise, meaning their values should be independent of their location and of each other, with no spatial structure. They are not. In fact, if we apply a Moran's test to the residuals, using the test for regression residuals, <span class="in">`lm.morantest()`</span>, we find that they are significantly spatially correlated:</span>
<span id="cb100-192"><a href="#cb100-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-195"><a href="#cb100-195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-196"><a href="#cb100-196" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(ols2, spweight)</span>
<span id="cb100-197"><a href="#cb100-197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-198"><a href="#cb100-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-199"><a href="#cb100-199" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/br&gt;</span></span>
<span id="cb100-200"><a href="#cb100-200" aria-hidden="true" tabindex="-1"></a>The pattern is evident if we map the standardised residuals from the function <span class="in">`rstandard()`</span>. At the risk of geographical over-simplification, there is something of a north-south divide, with a patch of negative residuals to the north of the study region. These are rural neighbouhoods where the rate of COVID-19 cases is lower than the model predicts.</span>
<span id="cb100-201"><a href="#cb100-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-204"><a href="#cb100-204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-205"><a href="#cb100-205" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids <span class="ot">&lt;-</span> <span class="fu">rstandard</span>(ols2)</span>
<span id="cb100-206"><a href="#cb100-206" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(covid<span class="sc">$</span>resids, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb100-207"><a href="#cb100-207" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(covid<span class="sc">$</span>resids, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb100-208"><a href="#cb100-208" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(covid<span class="sc">$</span>resids, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-209"><a href="#cb100-209" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb100-210"><a href="#cb100-210" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> resids_gp)) <span class="sc">+</span></span>
<span id="cb100-211"><a href="#cb100-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb100-212"><a href="#cb100-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"Standardised residual"</span>, <span class="at">values =</span> pal, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb100-213"><a href="#cb100-213" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb100-214"><a href="#cb100-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb100-215"><a href="#cb100-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb100-216"><a href="#cb100-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-217"><a href="#cb100-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-218"><a href="#cb100-218" aria-hidden="true" tabindex="-1"></a><span class="fu">### Looking again at the model</span></span>
<span id="cb100-219"><a href="#cb100-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-220"><a href="#cb100-220" aria-hidden="true" tabindex="-1"></a>It is possible that the spatial structure in the residuals exists because the model has been mis-specified. In particular, we might wonder if it was a mistake to drop the population density variable which perhaps had a polynomial relationship with the COVID rates. Let's find out.</span>
<span id="cb100-221"><a href="#cb100-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-224"><a href="#cb100-224" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-225"><a href="#cb100-225" aria-hidden="true" tabindex="-1"></a>ols3 <span class="ot">&lt;-</span> <span class="fu">update</span>(ols2, . <span class="sc">~</span> . <span class="sc">+</span> <span class="fu">poly</span>(density, <span class="dv">2</span>))</span>
<span id="cb100-226"><a href="#cb100-226" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ols3)</span>
<span id="cb100-227"><a href="#cb100-227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-228"><a href="#cb100-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-229"><a href="#cb100-229" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/br&gt;</span></span>
<span id="cb100-230"><a href="#cb100-230" aria-hidden="true" tabindex="-1"></a>Certainly, of the three models, this is the best fit to the data, as we can see from the various model fit diagnostics that are easily gathered together using the <span class="in">`glance()`</span> function from the tidyverse package, <span class="in">`broom`</span>.</span>
<span id="cb100-231"><a href="#cb100-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-234"><a href="#cb100-234" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-235"><a href="#cb100-235" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(broom)</span>
<span id="cb100-236"><a href="#cb100-236" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">glance</span>(ols1), <span class="fu">glance</span>(ols2), <span class="fu">glance</span>(ols3))</span>
<span id="cb100-237"><a href="#cb100-237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-238"><a href="#cb100-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-239"><a href="#cb100-239" aria-hidden="true" tabindex="-1"></a>An analysis of variance also suggests that the model fit has improved significantly.</span>
<span id="cb100-240"><a href="#cb100-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-243"><a href="#cb100-243" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-244"><a href="#cb100-244" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(ols2, ols3)</span>
<span id="cb100-245"><a href="#cb100-245" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-246"><a href="#cb100-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-247"><a href="#cb100-247" aria-hidden="true" tabindex="-1"></a>However, there is still spatial autocorrelation left in the model residuals, albeit slightly reduced from before.</span>
<span id="cb100-248"><a href="#cb100-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-251"><a href="#cb100-251" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-252"><a href="#cb100-252" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(ols2, spweight)<span class="sc">$</span>estimate</span>
<span id="cb100-253"><a href="#cb100-253" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(ols3, spweight)<span class="sc">$</span>estimate</span>
<span id="cb100-254"><a href="#cb100-254" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-255"><a href="#cb100-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-256"><a href="#cb100-256" aria-hidden="true" tabindex="-1"></a>The map of the residuals now looks like:</span>
<span id="cb100-257"><a href="#cb100-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-260"><a href="#cb100-260" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-261"><a href="#cb100-261" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids <span class="ot">&lt;-</span> <span class="fu">rstandard</span>(ols3)</span>
<span id="cb100-262"><a href="#cb100-262" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(covid<span class="sc">$</span>resids, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb100-263"><a href="#cb100-263" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(covid<span class="sc">$</span>resids, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb100-264"><a href="#cb100-264" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(covid<span class="sc">$</span>resids, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-265"><a href="#cb100-265" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb100-266"><a href="#cb100-266" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> resids_gp)) <span class="sc">+</span></span>
<span id="cb100-267"><a href="#cb100-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb100-268"><a href="#cb100-268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"Standardised residual"</span>, <span class="at">values =</span> pal, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb100-269"><a href="#cb100-269" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb100-270"><a href="#cb100-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb100-271"><a href="#cb100-271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb100-272"><a href="#cb100-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-273"><a href="#cb100-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-274"><a href="#cb100-274" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial regression models</span></span>
<span id="cb100-275"><a href="#cb100-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-276"><a href="#cb100-276" aria-hidden="true" tabindex="-1"></a><span class="fu">### Spatial error model</span></span>
<span id="cb100-277"><a href="#cb100-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-278"><a href="#cb100-278" aria-hidden="true" tabindex="-1"></a>One way to handle the error structure is to fit a spatial simultaneous autoregressive error model which decomposes the error (the residuals) into two parts: a spatially lagged component and a remaining error: $y = X\beta + \lambda W \xi + \epsilon$. The model can be fitted using R's <span class="in">`spatialreg`</span> package.</span>
<span id="cb100-279"><a href="#cb100-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-282"><a href="#cb100-282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-283"><a href="#cb100-283" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"spatialreg"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) <span class="fu">install.packages</span>(<span class="st">"spatialreg"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-284"><a href="#cb100-284" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(spatialreg)</span>
<span id="cb100-285"><a href="#cb100-285" aria-hidden="true" tabindex="-1"></a>errmod <span class="ot">&lt;-</span> <span class="fu">errorsarlm</span>(<span class="fu">formula</span>(ols3), <span class="at">data =</span> covid, <span class="at">listw =</span> spweight)</span>
<span id="cb100-286"><a href="#cb100-286" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(errmod)</span>
<span id="cb100-287"><a href="#cb100-287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-288"><a href="#cb100-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-289"><a href="#cb100-289" aria-hidden="true" tabindex="-1"></a>The model is a better fit to the data, as the following diagnostics tell us (the lower the AIC the better)</span>
<span id="cb100-290"><a href="#cb100-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-293"><a href="#cb100-293" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-294"><a href="#cb100-294" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(ols3)<span class="sc">$</span>r.squared</span>
<span id="cb100-295"><a href="#cb100-295" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(errmod)<span class="sc">$</span>r.squared</span>
<span id="cb100-296"><a href="#cb100-296" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(ols3)</span>
<span id="cb100-297"><a href="#cb100-297" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(errmod)</span>
<span id="cb100-298"><a href="#cb100-298" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-299"><a href="#cb100-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-300"><a href="#cb100-300" aria-hidden="true" tabindex="-1"></a>The differences are such that there is little doubt that the error model offers a much improved fit but if we do wish to test that difference statistically then</span>
<span id="cb100-301"><a href="#cb100-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-304"><a href="#cb100-304" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-305"><a href="#cb100-305" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(ols3)</span>
<span id="cb100-306"><a href="#cb100-306" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(errmod)</span>
<span id="cb100-307"><a href="#cb100-307" aria-hidden="true" tabindex="-1"></a>degf <span class="ot">&lt;-</span> <span class="fu">attr</span>(<span class="fu">logLik</span>(errmod), <span class="st">"df"</span>) <span class="sc">-</span> <span class="fu">attr</span>(<span class="fu">logLik</span>(ols3), <span class="st">"df"</span>)</span>
<span id="cb100-308"><a href="#cb100-308" aria-hidden="true" tabindex="-1"></a>LR <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> (<span class="fu">logLik</span>(ols3) <span class="sc">-</span> <span class="fu">logLik</span>(errmod))</span>
<span id="cb100-309"><a href="#cb100-309" aria-hidden="true" tabindex="-1"></a>LR <span class="sc">&gt;</span> <span class="fu">qchisq</span>(<span class="fl">0.99</span>, degf)</span>
<span id="cb100-310"><a href="#cb100-310" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-311"><a href="#cb100-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-312"><a href="#cb100-312" aria-hidden="true" tabindex="-1"></a>Using the error model changes the estimates of the regression coefficients.</span>
<span id="cb100-313"><a href="#cb100-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-316"><a href="#cb100-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-317"><a href="#cb100-317" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ols3)</span>
<span id="cb100-318"><a href="#cb100-318" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(errmod)</span>
<span id="cb100-319"><a href="#cb100-319" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-320"><a href="#cb100-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-321"><a href="#cb100-321" aria-hidden="true" tabindex="-1"></a>For example, where the 95% confidence interval for <span class="in">`age50.59`</span> used to be 95CI <span class="co">[</span><span class="ot">4.31, 7.04</span><span class="co">]</span>, under the error model it is 95CI <span class="co">[</span><span class="ot">2.15, 4.53</span><span class="co">]</span>.</span>
<span id="cb100-322"><a href="#cb100-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-325"><a href="#cb100-325" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-326"><a href="#cb100-326" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(ols3)</span>
<span id="cb100-327"><a href="#cb100-327" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(errmod)</span>
<span id="cb100-328"><a href="#cb100-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-329"><a href="#cb100-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-330"><a href="#cb100-330" aria-hidden="true" tabindex="-1"></a><span class="fu">### Spatially lagged y model</span></span>
<span id="cb100-331"><a href="#cb100-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-332"><a href="#cb100-332" aria-hidden="true" tabindex="-1"></a>Although the spatial error model fits the data better than the standard OLS model, it tells us only that there is an unexplained spatial structure to the residuals, not what caused it. It may offer better estimates of the model parameters and their statistical significance but it does not presuppose any particular spatial process generating the patterns in the values. A different model that explicitly tests for whether the value at a point is functionally dependent on the values of neighbouring points is the spatially lagged y model: $y = \rho Wy + X\beta + \epsilon$. It models an ‘overspill’ or chain effect where the outcome (the Y value) at any location is affected by the outcomes at surrounding locations.</span>
<span id="cb100-333"><a href="#cb100-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-336"><a href="#cb100-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-337"><a href="#cb100-337" aria-hidden="true" tabindex="-1"></a>lagmod <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(<span class="fu">formula</span>(ols3), <span class="at">data =</span> covid, <span class="at">listw =</span> spweight)</span>
<span id="cb100-338"><a href="#cb100-338" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lagmod)</span>
<span id="cb100-339"><a href="#cb100-339" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-340"><a href="#cb100-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-341"><a href="#cb100-341" aria-hidden="true" tabindex="-1"></a>Here, the test for residual autocorrelation does not generate a statistically significant result at a 95% level, although it is close. </span>
<span id="cb100-342"><a href="#cb100-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-343"><a href="#cb100-343" aria-hidden="true" tabindex="-1"></a>Note that the beta estimates of the lagged y-model cannot be interpreted in the same way as for a standard OLS model. For example, the beta estimate of -0.372 for the <span class="in">`IMD`</span> variable does not mean that if (hypothetically) we increased that variable by one unit at each location we should then expect the COVID-19 to everywhere decrease by 0.372 holding the other X variables constant. That is the correct interpretation for a standard (OLS) regression model and also for the spatial error model but not for where the lag of the Y variable is included as a predictor variable. The reason is because if we did raise the <span class="in">`IMD`</span> value it would start something akin to a ‘chain reaction’ through the feedback of Y via the lagged Y values. The total impact is a sum of the direct effect – what is predicted to happen through the 1 unit change in <span class="in">`IMD`</span> – and the indirect effect, which is that caused by ‘the chain reaction’ / feedback / ‘overspill’ in the system:</span>
<span id="cb100-344"><a href="#cb100-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-345"><a href="#cb100-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-348"><a href="#cb100-348" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-349"><a href="#cb100-349" aria-hidden="true" tabindex="-1"></a><span class="fu">impacts</span>(lagmod, <span class="at">listw =</span> spweight)</span>
<span id="cb100-350"><a href="#cb100-350" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-351"><a href="#cb100-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-352"><a href="#cb100-352" aria-hidden="true" tabindex="-1"></a>Although it wasn't especially noticeable, there was a short pause as those impacts were calculated. The calculations could take much longer if the size of the spatial weights matrix was larger. As <span class="co">[</span><span class="ot">this author</span><span class="co">](https://maczokni.github.io/crime_mapping_textbook/spatial-regression-models.html#fitting-and-interpreting-a-spatially-lagged-model)</span>{target="_blank"} notes, after [Lesage and Pace, 2009](https://www.routledge.com/Introduction-to-Spatial-Econometrics/LeSage-Pace/p/book/9781420064247){target="_blank"}, a faster approximation method can be used, here with <span class="in">`R = 1000`</span> simulated distributions for the impact measures.</span>
<span id="cb100-353"><a href="#cb100-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-356"><a href="#cb100-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-357"><a href="#cb100-357" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">as</span>(spweight, <span class="st">"CsparseMatrix"</span>)</span>
<span id="cb100-358"><a href="#cb100-358" aria-hidden="true" tabindex="-1"></a>trMC <span class="ot">&lt;-</span> <span class="fu">trW</span>(W, <span class="at">type=</span><span class="st">"MC"</span>)</span>
<span id="cb100-359"><a href="#cb100-359" aria-hidden="true" tabindex="-1"></a>im <span class="ot">&lt;-</span><span class="fu">summary</span>(<span class="fu">impacts</span>(lagmod, <span class="at">tr =</span> trMC, <span class="at">R =</span> <span class="dv">1000</span>), <span class="at">zstats =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-360"><a href="#cb100-360" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(im<span class="sc">$</span>res, <span class="at">row.names =</span> <span class="fu">names</span>(lagmod<span class="sc">$</span>coefficients)[<span class="sc">-</span><span class="dv">1</span>])   <span class="co"># The [-1] is to omit the intercept</span></span>
<span id="cb100-361"><a href="#cb100-361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-362"><a href="#cb100-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-363"><a href="#cb100-363" aria-hidden="true" tabindex="-1"></a>An advantage of this approach is that we can also obtain z and p-values for the impact measures:</span>
<span id="cb100-364"><a href="#cb100-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-367"><a href="#cb100-367" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-368"><a href="#cb100-368" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(im<span class="sc">$</span>zmat, <span class="at">row.names =</span> <span class="fu">names</span>(lagmod<span class="sc">$</span>coefficients)[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb100-369"><a href="#cb100-369" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(im<span class="sc">$</span>pzmat, <span class="at">row.names =</span> <span class="fu">names</span>(lagmod<span class="sc">$</span>coefficients)[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb100-370"><a href="#cb100-370" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-371"><a href="#cb100-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-372"><a href="#cb100-372" aria-hidden="true" tabindex="-1"></a>Most but not all of the impacts are significant. We can drop <span class="in">`age35.39`</span> from the model with little loss of fit.</span>
<span id="cb100-373"><a href="#cb100-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-376"><a href="#cb100-376" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-377"><a href="#cb100-377" aria-hidden="true" tabindex="-1"></a>lagmod2 <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(Rate <span class="sc">~</span>  IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span> carebeds <span class="sc">+</span> </span>
<span id="cb100-378"><a href="#cb100-378" aria-hidden="true" tabindex="-1"></a>    <span class="fu">poly</span>(density, <span class="dv">2</span>), <span class="at">data =</span> covid, <span class="at">listw =</span> spweight)</span>
<span id="cb100-379"><a href="#cb100-379" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(lagmod, lagmod2)</span>
<span id="cb100-380"><a href="#cb100-380" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">glance</span>(lagmod), <span class="fu">glance</span>(lagmod2))</span>
<span id="cb100-381"><a href="#cb100-381" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-382"><a href="#cb100-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-383"><a href="#cb100-383" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/br&gt;</span></span>
<span id="cb100-384"><a href="#cb100-384" aria-hidden="true" tabindex="-1"></a>In fact, an increase of 1 unit in, for example, the <span class="in">`IMD`</span> variable, will play out slightly differently in different places (because they have different neighbours with different Y values and at different distances from each other). The code below, which is from the first edition of <span class="co">[</span><span class="ot">Ward &amp; Gleditsch (2008, pp.47)</span><span class="co">](https://uk.sagepub.com/en-gb/eur/spatial-regression-models/book262155)</span>{target="_blank"}, will calculate the impact (of a one unit change in <span class="in">`IMD`</span>) at each location but below I have limited it to the first ten so that it doesn't take too long to run.</span>
<span id="cb100-385"><a href="#cb100-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-388"><a href="#cb100-388" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-389"><a href="#cb100-389" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(covid)</span>
<span id="cb100-390"><a href="#cb100-390" aria-hidden="true" tabindex="-1"></a>I <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> n, <span class="at">ncol =</span> n)</span>
<span id="cb100-391"><a href="#cb100-391" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(I) <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb100-392"><a href="#cb100-392" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> lagmod<span class="sc">$</span>rho</span>
<span id="cb100-393"><a href="#cb100-393" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> lagmod<span class="sc">$</span>coefficients[<span class="st">"age25.34"</span>]</span>
<span id="cb100-394"><a href="#cb100-394" aria-hidden="true" tabindex="-1"></a>weights.matrix <span class="ot">&lt;-</span> <span class="fu">listw2mat</span>(spweight)</span>
<span id="cb100-395"><a href="#cb100-395" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times=</span><span class="dv">10</span>)</span>
<span id="cb100-396"><a href="#cb100-396" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, \(i) {</span>
<span id="cb100-397"><a href="#cb100-397" aria-hidden="true" tabindex="-1"></a>  xvector <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="at">times=</span>n)</span>
<span id="cb100-398"><a href="#cb100-398" aria-hidden="true" tabindex="-1"></a>  xvector[i] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb100-399"><a href="#cb100-399" aria-hidden="true" tabindex="-1"></a>  impact <span class="ot">&lt;-</span> <span class="fu">solve</span>(I <span class="sc">-</span> rho <span class="sc">*</span> weights.matrix) <span class="sc">%*%</span> xvector <span class="sc">*</span> beta</span>
<span id="cb100-400"><a href="#cb100-400" aria-hidden="true" tabindex="-1"></a>  results[i] <span class="ot">&lt;-</span> impact[i]</span>
<span id="cb100-401"><a href="#cb100-401" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb100-402"><a href="#cb100-402" aria-hidden="true" tabindex="-1"></a>results</span>
<span id="cb100-403"><a href="#cb100-403" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-404"><a href="#cb100-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-405"><a href="#cb100-405" aria-hidden="true" tabindex="-1"></a><span class="fu">### Choosing between the spatial error and lagged y model</span></span>
<span id="cb100-406"><a href="#cb100-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-407"><a href="#cb100-407" aria-hidden="true" tabindex="-1"></a>Before fitting the spatial error and lagged y models, we could have looked for evidence in support of them using the function <span class="in">`lm.LMtests()`</span>. This tests the basic OLS specification against the more general spatial error and lagged y models. Anselin and Rey (2014, p.110) offer the following decision tree that can, in the absence of a more theoretical basis for the model choice (e.g. the type of process being modelled), be used in conjunction with the test results to help select the model.</span>
<span id="cb100-408"><a href="#cb100-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-409"><a href="#cb100-409" aria-hidden="true" tabindex="-1"></a><span class="al">![](flowchart.jpg)</span></span>
<span id="cb100-410"><a href="#cb100-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-411"><a href="#cb100-411" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;font</span> <span class="er">size</span> <span class="ot">=</span> <span class="st">2</span><span class="kw">&gt;</span>Source: <span class="co">[</span><span class="ot">Modern Spatial Econometrics in Practice</span><span class="co">](https://www.amazon.co.uk/Modern-Spatial-Econometrics-Practice-GeoDaSpace/dp/0986342106)</span>{target="_blank}<span class="kw">&lt;/font&gt;</span></span>
<span id="cb100-412"><a href="#cb100-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-413"><a href="#cb100-413" aria-hidden="true" tabindex="-1"></a>In the first step, we find that in this instance that both the LM-Error and LM-Lag tests are significant.</span>
<span id="cb100-414"><a href="#cb100-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-417"><a href="#cb100-417" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-418"><a href="#cb100-418" aria-hidden="true" tabindex="-1"></a>ols4 <span class="ot">&lt;-</span> <span class="fu">update</span>(ols3, . <span class="sc">~</span> . <span class="sc">-</span> age35<span class="fl">.39</span>, <span class="at">data =</span> covid)</span>
<span id="cb100-419"><a href="#cb100-419" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Drops the age35.39 variable</span></span>
<span id="cb100-420"><a href="#cb100-420" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.LMtests</span>(ols4, spweight, <span class="at">test=</span><span class="fu">c</span>(<span class="st">"LMerr"</span>, <span class="st">"LMlag"</span>))</span>
<span id="cb100-421"><a href="#cb100-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-422"><a href="#cb100-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-423"><a href="#cb100-423" aria-hidden="true" tabindex="-1"></a>Moving on to the robust tests, only the LM-Lag test is significant. Given the nature of COVID-19 as an infectious disease, it does seem reasonable to suppose that high rates of infection in any an area will 'overspill' into neighbouring areas too.</span>
<span id="cb100-424"><a href="#cb100-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-427"><a href="#cb100-427" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-428"><a href="#cb100-428" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.LMtests</span>(ols4, spweight, <span class="at">test=</span><span class="fu">c</span>(<span class="st">"RLMerr"</span>, <span class="st">"RLMlag"</span>))</span>
<span id="cb100-429"><a href="#cb100-429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-430"><a href="#cb100-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-431"><a href="#cb100-431" aria-hidden="true" tabindex="-1"></a><span class="fu">## A geographically weighted spatial weights matrix</span></span>
<span id="cb100-432"><a href="#cb100-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-433"><a href="#cb100-433" aria-hidden="true" tabindex="-1"></a>As with the tests of spatial autocorrelation in an earlier session and as with the geographically weighted statistics, the results of the spatial regression models are dependent on the specification of the spatial weights matrix which can suffer from being somewhat arbitrary. We could, if we wish, try calibrating it around the geographically weighted mean.</span>
<span id="cb100-434"><a href="#cb100-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-437"><a href="#cb100-437" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-438"><a href="#cb100-438" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: false</span></span>
<span id="cb100-439"><a href="#cb100-439" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(GWmodel)</span>
<span id="cb100-440"><a href="#cb100-440" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(Rate <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> covid_sp, <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>)</span>
<span id="cb100-441"><a href="#cb100-441" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-442"><a href="#cb100-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-443"><a href="#cb100-443" aria-hidden="true" tabindex="-1"></a>To now create the corresponding inverse distance spatial weights matrix for the models, we can use the <span class="in">`nn2`</span> function in the <span class="in">`RANN`</span> package to find the <span class="in">`bw = `</span> <span class="in">`r bw`</span> nearest neighbours to each centroid point:</span>
<span id="cb100-444"><a href="#cb100-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-447"><a href="#cb100-447" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-448"><a href="#cb100-448" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"RANN"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>]))  <span class="fu">install.packages</span>(<span class="st">"RANN"</span>)</span>
<span id="cb100-449"><a href="#cb100-449" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(RANN)</span>
<span id="cb100-450"><a href="#cb100-450" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(<span class="fu">st_centroid</span>(<span class="fu">st_geometry</span>(covid)))</span>
<span id="cb100-451"><a href="#cb100-451" aria-hidden="true" tabindex="-1"></a>knn <span class="ot">&lt;-</span> <span class="fu">nn2</span>(coords, coords, <span class="at">k =</span> bw)</span>
<span id="cb100-452"><a href="#cb100-452" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-453"><a href="#cb100-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-454"><a href="#cb100-454" aria-hidden="true" tabindex="-1"></a>Having done so, those neighbours can be geographically weighted using a bisquare kernel, as in the GWR calibration above. (A Gaussian kernel is obtained if <span class="in">`(1 - (x / max(x))^2)^2`</span> is replaced by <span class="in">`exp(-0.5 * (x / max(x))^2)`</span> in the code below).</span>
<span id="cb100-455"><a href="#cb100-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-458"><a href="#cb100-458" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-459"><a href="#cb100-459" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> knn<span class="sc">$</span>nn.dists</span>
<span id="cb100-460"><a href="#cb100-460" aria-hidden="true" tabindex="-1"></a>glist <span class="ot">&lt;-</span> <span class="fu">apply</span>(d, <span class="dv">1</span>, \(x) {</span>
<span id="cb100-461"><a href="#cb100-461" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span> <span class="sc">-</span> (x <span class="sc">/</span> <span class="fu">max</span>(x))<span class="sc">^</span><span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb100-462"><a href="#cb100-462" aria-hidden="true" tabindex="-1"></a>}, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb100-463"><a href="#cb100-463" aria-hidden="true" tabindex="-1"></a>knearnb <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(<span class="fu">st_centroid</span>(<span class="fu">st_geometry</span>(covid)), <span class="at">k =</span> bw))</span>
<span id="cb100-464"><a href="#cb100-464" aria-hidden="true" tabindex="-1"></a>spweightK <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(knearnb, glist, <span class="at">style =</span> <span class="st">"C"</span>)</span>
<span id="cb100-465"><a href="#cb100-465" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-466"><a href="#cb100-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-467"><a href="#cb100-467" aria-hidden="true" tabindex="-1"></a>The results are not very successful though. The lag model with contiguous spatial weights fits the data better,</span>
<span id="cb100-468"><a href="#cb100-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-471"><a href="#cb100-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-472"><a href="#cb100-472" aria-hidden="true" tabindex="-1"></a>lagmod3 <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(<span class="fu">formula</span>(ols4), <span class="at">data =</span> covid, <span class="at">listw =</span> spweightK)</span>
<span id="cb100-473"><a href="#cb100-473" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">glance</span>(lagmod2), <span class="fu">glance</span>(lagmod3))</span>
<span id="cb100-474"><a href="#cb100-474" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-475"><a href="#cb100-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-476"><a href="#cb100-476" aria-hidden="true" tabindex="-1"></a>In addition, the inverse distance weights are not row-standardised, which may cause some knock-on problems. They could become row-standardised (<span class="in">`spweightK &lt;- nb2listw(knearnb, glist, style = "W")`</span>) but if they are, by re-scaling each row of the weights to equal one, then the inverse distance weighting is altered.</span>
<span id="cb100-477"><a href="#cb100-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-478"><a href="#cb100-478" aria-hidden="true" tabindex="-1"></a><span class="fu">## Geographically Weighted Regression</span></span>
<span id="cb100-479"><a href="#cb100-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-480"><a href="#cb100-480" aria-hidden="true" tabindex="-1"></a>In much the same way as we can calculate geographically weighted statistics that allow the measured value to vary locally from location to location across the study region, we can also calculate geographically weighted and locally estimated regression coefficients using <span class="co">[</span><span class="ot">geographically weighted regression</span><span class="co">](https://www.sciencedirect.com/science/article/pii/B9780080449104004478?via%3Dihub)</span>{target="_blank"}. This is used to look for spatial variation in the regression relationships.</span>
<span id="cb100-481"><a href="#cb100-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-482"><a href="#cb100-482" aria-hidden="true" tabindex="-1"></a>If the bandwidth is not known or there is no theoretical justification for it, it can be found using an automated selection procedure.</span>
<span id="cb100-483"><a href="#cb100-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-484"><a href="#cb100-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-487"><a href="#cb100-487" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-488"><a href="#cb100-488" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: false</span></span>
<span id="cb100-489"><a href="#cb100-489" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(GWmodel)</span>
<span id="cb100-490"><a href="#cb100-490" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(<span class="fu">formula</span>(ols4), <span class="at">data =</span> covid_sp, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-491"><a href="#cb100-491" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-492"><a href="#cb100-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-493"><a href="#cb100-493" aria-hidden="true" tabindex="-1"></a>The model can then be fitted.</span>
<span id="cb100-494"><a href="#cb100-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-497"><a href="#cb100-497" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-498"><a href="#cb100-498" aria-hidden="true" tabindex="-1"></a>gwrmod <span class="ot">&lt;-</span> <span class="fu">gwr.basic</span>(<span class="fu">formula</span>(ols4), <span class="at">data =</span> covid_sp, <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">bw =</span> bw)</span>
<span id="cb100-499"><a href="#cb100-499" aria-hidden="true" tabindex="-1"></a>gwrmod</span>
<span id="cb100-500"><a href="#cb100-500" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-501"><a href="#cb100-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-502"><a href="#cb100-502" aria-hidden="true" tabindex="-1"></a>The output requires some interpretation! The results of the global regression are those obtained from a standard OLS regression (i.e. <span class="in">`summary(lm(formula(ols4), data = covid_sp))`</span>). It is 'global' because it is a model for the entire study region, without spatial variation in the regression estimates. The results of the geographically weighted regression are the results from, in this case, <span class="in">`r nrow(covid)`</span> separate but spatially overlapping regression models fitted, with geographic weighting, to spatial subsets of the data. All the local estimates are contained in the spatial data frame, <span class="in">`gwrmod$SDF`</span>, including those for <span class="in">`age0.11`</span> which are in <span class="in">`gwrmod$SDF$age0.11`</span> and have the following distribution,</span>
<span id="cb100-503"><a href="#cb100-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-506"><a href="#cb100-506" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-507"><a href="#cb100-507" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span>)</span>
<span id="cb100-508"><a href="#cb100-508" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-509"><a href="#cb100-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-510"><a href="#cb100-510" aria-hidden="true" tabindex="-1"></a>This is the same summary of the distribution that is included in the GWR coefficient estimates. What it means is that in at least one location the relationship of <span class="in">`age0.11`</span> to <span class="in">`Rate`</span> is, conditional on the other variables, negative. It is more usual for it to be positive -- more children, more infections (perhaps a school effect?) -- but the estimated effect size varies quite substantially. Its interquartile range is from <span class="in">`r round(quantile(gwrmod$SDF$age0.11, probs = 0.25), 3)`</span> to <span class="in">`r round(quantile(gwrmod$SDF$age0.11, probs = 0.75), 3)`</span>. Mapping these local estimates reveals an interesting geography -- it is largely in and around Manchester where a greater number of children of primary school age or younger appears to lower the infection rate.</span>
<span id="cb100-511"><a href="#cb100-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-514"><a href="#cb100-514" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-515"><a href="#cb100-515" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR <span class="ot">&lt;-</span> gwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span></span>
<span id="cb100-516"><a href="#cb100-516" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> covid, <span class="fu">aes</span>(<span class="at">fill =</span> age0<span class="fl">.11</span>GWR)) <span class="sc">+</span></span>
<span id="cb100-517"><a href="#cb100-517" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb100-518"><a href="#cb100-518" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="st">"estimated beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>) <span class="sc">+</span></span>
<span id="cb100-519"><a href="#cb100-519" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb100-520"><a href="#cb100-520" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb100-521"><a href="#cb100-521" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-522"><a href="#cb100-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-523"><a href="#cb100-523" aria-hidden="true" tabindex="-1"></a>With a bit of effort we can get all the variables on the same chart...</span>
<span id="cb100-524"><a href="#cb100-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-527"><a href="#cb100-527" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-528"><a href="#cb100-528" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"gridExtra"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) <span class="fu">install.packages</span>(<span class="st">"gridExtra"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-529"><a href="#cb100-529" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(gridExtra)</span>
<span id="cb100-530"><a href="#cb100-530" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">8</span>, \(j) {</span>
<span id="cb100-531"><a href="#cb100-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(gwrmod<span class="sc">$</span>SDF[, j]) <span class="sc">%&gt;%</span></span>
<span id="cb100-532"><a href="#cb100-532" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">beta =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb100-533"><a href="#cb100-533" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> beta)) <span class="sc">+</span></span>
<span id="cb100-534"><a href="#cb100-534" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">col =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb100-535"><a href="#cb100-535" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>) <span class="sc">+</span></span>
<span id="cb100-536"><a href="#cb100-536" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb100-537"><a href="#cb100-537" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb100-538"><a href="#cb100-538" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggtitle</span>(<span class="fu">names</span>(gwrmod<span class="sc">$</span>SDF[j]))</span>
<span id="cb100-539"><a href="#cb100-539" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb100-540"><a href="#cb100-540" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(<span class="at">grobs =</span> g)</span>
<span id="cb100-541"><a href="#cb100-541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-542"><a href="#cb100-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-543"><a href="#cb100-543" aria-hidden="true" tabindex="-1"></a>... however, not all of these regression estimates are necessarily statistically significant. If we use the estimated t-values to isolate those that are not, then, for the <span class="in">`age0.11`</span> variable we obtain,</span>
<span id="cb100-544"><a href="#cb100-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-547"><a href="#cb100-547" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-548"><a href="#cb100-548" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR[<span class="fu">abs</span>(gwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span>_TV) <span class="sc">&gt;</span> <span class="fl">1.96</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb100-549"><a href="#cb100-549" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> covid, <span class="fu">aes</span>(<span class="at">fill =</span> age0<span class="fl">.11</span>GWR)) <span class="sc">+</span></span>
<span id="cb100-550"><a href="#cb100-550" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb100-551"><a href="#cb100-551" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="st">"aged2.11"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">na.value =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb100-552"><a href="#cb100-552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb100-553"><a href="#cb100-553" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb100-554"><a href="#cb100-554" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-555"><a href="#cb100-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-556"><a href="#cb100-556" aria-hidden="true" tabindex="-1"></a>and, with a bit more data wrangling, for the full set,</span>
<span id="cb100-557"><a href="#cb100-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-560"><a href="#cb100-560" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-561"><a href="#cb100-561" aria-hidden="true" tabindex="-1"></a>sdf <span class="ot">&lt;-</span> <span class="fu">slot</span>(gwrmod<span class="sc">$</span>SDF, <span class="st">"data"</span>)</span>
<span id="cb100-562"><a href="#cb100-562" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">8</span>, \(j) {</span>
<span id="cb100-563"><a href="#cb100-563" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(gwrmod<span class="sc">$</span>SDF[, j]) </span>
<span id="cb100-564"><a href="#cb100-564" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(sdf) <span class="sc">==</span> <span class="fu">paste0</span>(<span class="fu">names</span>(x)[<span class="dv">1</span>],<span class="st">"_TV"</span>))</span>
<span id="cb100-565"><a href="#cb100-565" aria-hidden="true" tabindex="-1"></a>  x[<span class="fu">abs</span>(sdf[, t]) <span class="sc">&gt;</span> <span class="fl">1.96</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb100-566"><a href="#cb100-566" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">%&gt;%</span></span>
<span id="cb100-567"><a href="#cb100-567" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">beta =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb100-568"><a href="#cb100-568" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> beta)) <span class="sc">+</span></span>
<span id="cb100-569"><a href="#cb100-569" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">col =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb100-570"><a href="#cb100-570" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">na.value =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb100-571"><a href="#cb100-571" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb100-572"><a href="#cb100-572" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb100-573"><a href="#cb100-573" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggtitle</span>(<span class="fu">names</span>(gwrmod<span class="sc">$</span>SDF[j]))</span>
<span id="cb100-574"><a href="#cb100-574" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb100-575"><a href="#cb100-575" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(<span class="at">grobs =</span> g)</span>
<span id="cb100-576"><a href="#cb100-576" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-577"><a href="#cb100-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-578"><a href="#cb100-578" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width=75}</span>
<span id="cb100-579"><a href="#cb100-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-580"><a href="#cb100-580" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;font</span> <span class="er">size</span> <span class="ot">=</span> <span class="st">3</span><span class="kw">&gt;</span>I am sure there is a more elegant way of doing this. Don't worry about the code especially - the point is that not every estimate, everywhere is significant.<span class="kw">&lt;/font&gt;</span></span>
<span id="cb100-581"><a href="#cb100-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-582"><a href="#cb100-582" aria-hidden="true" tabindex="-1"></a>As with the basic GW statistics, we can undertake a randomisation test to suggest whether the spatial variation in the coefficient estimates is statistically significant. **However** this takes some time to run -- with the default <span class="in">`nsims = 99`</span> simulations it took about 12 minutes on my laptop. I have 'commented it out' in the code block below with the suggestion that you don't run it now.</span>
<span id="cb100-583"><a href="#cb100-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-586"><a href="#cb100-586" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-587"><a href="#cb100-587" aria-hidden="true" tabindex="-1"></a><span class="co"># I suggest you do not run this</span></span>
<span id="cb100-588"><a href="#cb100-588" aria-hidden="true" tabindex="-1"></a><span class="co"># gwr.mc &lt;- gwr.montecarlo(formula(ols4), covid_sp, adaptive = TRUE, bw = bw)</span></span>
<span id="cb100-589"><a href="#cb100-589" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-590"><a href="#cb100-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-591"><a href="#cb100-591" aria-hidden="true" tabindex="-1"></a>Instead, let's jump straight to the results, which I have saved in a pre-prepared workspace.</span>
<span id="cb100-592"><a href="#cb100-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-595"><a href="#cb100-595" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-596"><a href="#cb100-596" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/workspaces/gwrmc.RData"</span>)</span>
<span id="cb100-597"><a href="#cb100-597" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(url)</span>
<span id="cb100-598"><a href="#cb100-598" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(url)</span>
<span id="cb100-599"><a href="#cb100-599" aria-hidden="true" tabindex="-1"></a>gwr.mc</span>
<span id="cb100-600"><a href="#cb100-600" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-601"><a href="#cb100-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-602"><a href="#cb100-602" aria-hidden="true" tabindex="-1"></a>It appears that only the <span class="in">`age0.11`</span> and <span class="in">`density`</span> variables exhibit significant spatial variation. In principle it is possible to drop the other variables out from the local estimates and treat them as fixed, global estimates instead, in a Mixed GWR model (mixed global and local regression estimates). In practice, it is generating an error.</span>
<span id="cb100-603"><a href="#cb100-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-606"><a href="#cb100-606" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-607"><a href="#cb100-607" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb100-608"><a href="#cb100-608" aria-hidden="true" tabindex="-1"></a><span class="co"># This appears to generate an error</span></span>
<span id="cb100-609"><a href="#cb100-609" aria-hidden="true" tabindex="-1"></a>gwrmixd <span class="ot">&lt;-</span> <span class="fu">gwr.mixed</span>(Rate <span class="sc">~</span> IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age18<span class="fl">.24</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age35<span class="fl">.39</span> <span class="sc">+</span> </span>
<span id="cb100-610"><a href="#cb100-610" aria-hidden="true" tabindex="-1"></a>          age50<span class="fl">.59</span> <span class="sc">+</span> age60<span class="fl">.69</span> <span class="sc">+</span> <span class="fu">poly</span>(density, <span class="dv">2</span>),</span>
<span id="cb100-611"><a href="#cb100-611" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> covid_sp,</span>
<span id="cb100-612"><a href="#cb100-612" aria-hidden="true" tabindex="-1"></a>          <span class="at">fixed.vars =</span> <span class="fu">c</span>(<span class="st">"IMD"</span>, <span class="st">"age18.24"</span>, <span class="st">"age25.34"</span>, <span class="st">"age35.39"</span>, <span class="st">"age50.59"</span>, <span class="st">"age60.69"</span>),</span>
<span id="cb100-613"><a href="#cb100-613" aria-hidden="true" tabindex="-1"></a>          <span class="at">bw =</span> bw, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-614"><a href="#cb100-614" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-615"><a href="#cb100-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-616"><a href="#cb100-616" aria-hidden="true" tabindex="-1"></a>It is also possible to fit a Multiscale GWR, which allows for the possibility of a different bandwith for each variable -- see <span class="in">`?gwr.multiscale`</span>. Since there is no particular reason to presume that the bandwidth should be the same for all the variables, arguably Multiscale GWR should be preferred over standard GWR, at least in the first instance. Its main drawback, however, is that it takes a very long time to run -- over 12 hours for the code chunk below! (In principle it can be parallelised but it generated an error for me when I tried this with <span class="in">`parallel.method = cluster`</span>.)</span>
<span id="cb100-617"><a href="#cb100-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-620"><a href="#cb100-620" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-621"><a href="#cb100-621" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb100-622"><a href="#cb100-622" aria-hidden="true" tabindex="-1"></a>density<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">poly</span>(covid<span class="sc">$</span>density, <span class="dv">2</span>)[, <span class="dv">1</span>]</span>
<span id="cb100-623"><a href="#cb100-623" aria-hidden="true" tabindex="-1"></a>density<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">poly</span>(covid<span class="sc">$</span>density, <span class="dv">2</span>)[, <span class="dv">2</span>]</span>
<span id="cb100-624"><a href="#cb100-624" aria-hidden="true" tabindex="-1"></a><span class="co"># Do not run!</span></span>
<span id="cb100-625"><a href="#cb100-625" aria-hidden="true" tabindex="-1"></a><span class="co"># Took over 12 hours!</span></span>
<span id="cb100-626"><a href="#cb100-626" aria-hidden="true" tabindex="-1"></a><span class="co">#gwrmulti &lt;- gwr.multiscale(Rate ~ IMD + age0.11 + age18.24 + age25.34 + age35.39 + </span></span>
<span id="cb100-627"><a href="#cb100-627" aria-hidden="true" tabindex="-1"></a><span class="co">#    age50.59 + age60.69 + density.1 + density.2, data = covid_sp, adaptive = TRUE)</span></span>
<span id="cb100-628"><a href="#cb100-628" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-629"><a href="#cb100-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-630"><a href="#cb100-630" aria-hidden="true" tabindex="-1"></a>To save time, the results are available below. The bandwidths do appear to vary.</span>
<span id="cb100-631"><a href="#cb100-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-634"><a href="#cb100-634" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb100-635"><a href="#cb100-635" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/workspaces/gwrmulti.RData"</span>)</span>
<span id="cb100-636"><a href="#cb100-636" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(url)</span>
<span id="cb100-637"><a href="#cb100-637" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(url)</span>
<span id="cb100-638"><a href="#cb100-638" aria-hidden="true" tabindex="-1"></a>gwrmulti</span>
<span id="cb100-639"><a href="#cb100-639" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb100-640"><a href="#cb100-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-641"><a href="#cb100-641" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb100-642"><a href="#cb100-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-643"><a href="#cb100-643" aria-hidden="true" tabindex="-1"></a>In this session we have looked at spatial regression models as a way to address the problem of spatial autocorrelation in regression residuals and to allow for the possibility that regression relationships vary across a map. In presenting these methods, at least some could be taken as offering a 'technical fix' to the statistical issue of spatial dependencies in the data, violating assumptions of independence. Whilst that may be true, and the more spatial approaches can be used as diagnostic tools to check for a mis-specified model, notably one that lacks a critical explanatory variable or where the relationship between the X and Y variables is non-linear, the limitation of this thinking is that it treats geography as an error to be resolved and/or it rests on the belief that with sufficient information the geographical differences will be explained. What geographically weighted regression, for example, reminds us is that the nature of the relationship may be complex because it is changing in form across the study region as the socio-spatial causes also vary from place to place. Such spatial complexity may be challenging to accommodate within the parameters of conventional aspatial or spatially naïve statistical thinking but ignoring the geographical variation is not a solution. What spatial thinking brings to the table is the recognition of geographical context and the knowledge that geographically  rooted social outcomes are not independent of where the processes giving rise to those outcomes are taking place. </span>
<span id="cb100-644"><a href="#cb100-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-645"><a href="#cb100-645" aria-hidden="true" tabindex="-1"></a><span class="fu">## Further Reading</span></span>
<span id="cb100-646"><a href="#cb100-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-647"><a href="#cb100-647" aria-hidden="true" tabindex="-1"></a><span class="al">![](spatial_regression.jpg)</span>{width=100}</span>
<span id="cb100-648"><a href="#cb100-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-649"><a href="#cb100-649" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Spatial Regression Models (2nd edition) by MD Ward &amp; KS Gleditsch (2018)</span><span class="co">](https://uk.sagepub.com/en-gb/eur/spatial-regression-models/book262155)</span>{target="_blank"}</span>
<span id="cb100-650"><a href="#cb100-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-651"><a href="#cb100-651" aria-hidden="true" tabindex="-1"></a>Comber et al. (2022) A Route Map for Successful Applications of Geographically Weighted Regression. <span class="co">[</span><span class="ot">https://doi.org/10.1111/gean.12316</span><span class="co">](https://doi.org/10.1111/gean.12316)</span>{target="_blank"}</span>
<span id="cb100-652"><a href="#cb100-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-653"><a href="#cb100-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-654"><a href="#cb100-654" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2022, Richard Harris</div>   
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/profrichharris">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>
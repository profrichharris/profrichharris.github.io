<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.38">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Spatial Regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<script src="site_libs/quarto-search/autocomplete-preset-algolia.umd.js"></script>
<meta name="quarto:offset" content="./">
<link href="./multilevel.html" rel="next">
<link href="./gwstats.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 20,
  "algolia": {
    "application-id": "J0U99Q1IO1",
    "search-only-api-key": "133b4b1fa29f2b12275f6a48a26418db",
    "index-name": "dev_profrichharris",
    "analytics-events": false,
    "show-logo": true,
    "libDir": "site_libs"
  },
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.5.1/dist/algoliasearch-lite.umd.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link active" href="./index.html" aria-current="page"><i class="bi bi-house" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./index.html">Mapping and Modelling Geographic Data in R</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./lectures.html">Lectures</a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Spatial Regression</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./" class="sidebar-logo-link">
      <img src="./logo.jpg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Introduction</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./start.html" class="sidebar-item-text sidebar-link">Getting Started</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Why R?</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./why.html" class="sidebar-item-text sidebar-link">A Cartographic Answer</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Flavours of R</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./base.html" class="sidebar-item-text sidebar-link">Base R</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tidyverse.html" class="sidebar-item-text sidebar-link">Tidyverse</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./program.html" class="sidebar-item-text sidebar-link">Programming</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exercise1.html" class="sidebar-item-text sidebar-link">Follow-up exercise</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">Mapping the spatial variable</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./themap.html" class="sidebar-item-text sidebar-link">The Spatial Variable</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./thematicmaps.html" class="sidebar-item-text sidebar-link">Thematic maps in R</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exercise2.html" class="sidebar-item-text sidebar-link">Follow-up exercise</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">Measuring spatial autocorrelation</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./autocorrelation.html" class="sidebar-item-text sidebar-link">Measuring spatial autocorrelation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exercise3.html" class="sidebar-item-text sidebar-link">Follow-up exercise</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">From Maps to models</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gwstats.html" class="sidebar-item-text sidebar-link">Geographically Weighted Statistics</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spregress.html" class="sidebar-item-text sidebar-link active">Spatial Regression</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">Representations of geographic space</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multilevel.html" class="sidebar-item-text sidebar-link">Continuous and discrete views of the spatial variable</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started">Getting Started</a></li>
  <li><a href="#an-initial-model-to-explain-the-spatial-patterns-in-the-covid-19-rates" id="toc-an-initial-model-to-explain-the-spatial-patterns-in-the-covid-19-rates" class="nav-link" data-scroll-target="#an-initial-model-to-explain-the-spatial-patterns-in-the-covid-19-rates">An initial model to explain the spatial patterns in the COVID-19 rates</a></li>
  <li><a href="#spatial-dependencies-in-the-model-residuals" id="toc-spatial-dependencies-in-the-model-residuals" class="nav-link" data-scroll-target="#spatial-dependencies-in-the-model-residuals">Spatial dependencies in the model residuals</a>
  <ul class="collapse">
  <li><a href="#looking-again-at-the-model" id="toc-looking-again-at-the-model" class="nav-link" data-scroll-target="#looking-again-at-the-model">Looking again at the model</a></li>
  </ul></li>
  <li><a href="#spatial-regression-models" id="toc-spatial-regression-models" class="nav-link" data-scroll-target="#spatial-regression-models">Spatial regression models</a>
  <ul class="collapse">
  <li><a href="#spatial-error-model" id="toc-spatial-error-model" class="nav-link" data-scroll-target="#spatial-error-model">Spatial error model</a></li>
  <li><a href="#spatially-lagged-y-model" id="toc-spatially-lagged-y-model" class="nav-link" data-scroll-target="#spatially-lagged-y-model">Spatially lagged y model</a></li>
  <li><a href="#choosing-between-the-spatial-error-and-lagged-y-model" id="toc-choosing-between-the-spatial-error-and-lagged-y-model" class="nav-link" data-scroll-target="#choosing-between-the-spatial-error-and-lagged-y-model">Choosing between the spatial error and lagged y model</a></li>
  </ul></li>
  <li><a href="#a-geographically-weighted-spatial-weights-matrix" id="toc-a-geographically-weighted-spatial-weights-matrix" class="nav-link" data-scroll-target="#a-geographically-weighted-spatial-weights-matrix">A geographically weighted spatial weights matrix</a></li>
  <li><a href="#geographically-weighted-regression" id="toc-geographically-weighted-regression" class="nav-link" data-scroll-target="#geographically-weighted-regression">Geographically Weighted Regression</a>
  <ul class="collapse">
  <li><a href="#mixed-gwr" id="toc-mixed-gwr" class="nav-link" data-scroll-target="#mixed-gwr">Mixed GWR</a></li>
  <li><a href="#multiscale-gwr" id="toc-multiscale-gwr" class="nav-link" data-scroll-target="#multiscale-gwr">Multiscale GWR</a></li>
  <li><a href="#geographically-and-temporally-weighted-regression" id="toc-geographically-and-temporally-weighted-regression" class="nav-link" data-scroll-target="#geographically-and-temporally-weighted-regression">Geographically and temporally weighted regression</a></li>
  <li><a href="#generalised-gwr-models-with-poisson-and-binomial-options" id="toc-generalised-gwr-models-with-poisson-and-binomial-options" class="nav-link" data-scroll-target="#generalised-gwr-models-with-poisson-and-binomial-options">Generalised GWR models with Poisson and Binomial options</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading">Further Reading</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block">Spatial Regression</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In the previous session we looked at geographically weighted statistics, including geographically weighted correlation, which examines whether the correlation – and therefore the direction and/or the strength of the relationship – between two variables varies across a map. In this session we extend from correlation to looking at regression modelling with a spatial component (spatial regression). The data we shall use are a map of the rate of COVID-19 infections per thousand population in neighbourhoods of the North West of England over the period from the week commencing 2020-03-07 to the week commencing 2022-04-16. That rate is calculated as the total number of reported infections per neighbourhood, divided by the <a href="https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/middlesuperoutputareamidyearpopulationestimates" target="blank">mid-2020 ONS estimated population</a>.</p>
<p>There are three problems with these data, which originate (prior to adjustment) from <a href="https://coronavirus.data.gov.uk/details/download" target="_blank">https://coronavirus.data.gov.uk/details/download</a>:</p>
<ol type="1">
<li>The rate, as calculated, does not allow for re-infection (i.e.&nbsp;the same person can catch COVID-19 more than once).</li>
<li>Not everyone who had COVID was tested for a positive diagnosis. Limitations in the testing regime are described in <a href="https://link.springer.com/article/10.1007/s12061-021-09400-8" target="_blank">this paper</a> and are most severe earlier in the pandemic and again towards the end of the data period when testing was scaled-back and then largely withdrawn.</li>
<li>For data protection reasons, where a neighbourhood had less than three cases in a week, that number was reported as zero even though it could really be one or two. This undercount adds up, although, unsurprisingly it affects the largest cities most (because they have more neighbourhoods to be undercounted) in weeks when COVID is not especially prevalent (because in other weeks there are more often more than two cases per neighbourhoods). An adjustment has been made to the data to allow for this censoring of the data but not for the undercount caused by not testing positive.</li>
</ol>
<p>Despite their shortcomings, the data are sufficient to illustrate the methods, below.</p>
</section>
<section id="getting-started" class="level2">
<h2 class="anchored" data-anchor-id="getting-started">Getting Started</h2>
<p>The data are downloaded as follows. The required packages should be installed already, from previous sessions. As before, you may wish to begin by opening the R Project that you created for these classes.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>installed <span class="ot">&lt;-</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>]</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sf"</span>, <span class="st">"tidyverse"</span>, <span class="st">"ggplot2"</span>, <span class="st">"spdep"</span>, <span class="st">"GWmodel"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>install <span class="ot">&lt;-</span> pkgs[<span class="sc">!</span>(pkgs <span class="sc">%in%</span> installed)]</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(install)) <span class="fu">install.packages</span>(install, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"ggsflabel"</span> <span class="sc">%in%</span> installed)) remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"yutannihilation/ggsflabel"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(sf)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggplot2)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggsflabel)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"covid.geojson"</span>)) <span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/data/covid.geojson"</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="st">"covid.geojson"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(<span class="st">"covid.geojson"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(regionName <span class="sc">==</span> <span class="st">"North West"</span>) <span class="ot">-&gt;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  covid</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># The step below is just to reformat some of the names of the data variables,</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># replacing age0-11 with age0.11, age12_17 with age 12.17, and so forth.</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(covid) <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"-"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">."</span>, <span class="fu">names</span>(covid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Looking at a map of the COVID-19 rates, it appears that there are patches of higher rates that tend to cluster in cities such as Preston, Manchester and Liverpool, although not exclusively so.</p>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">Don’t forget that you can, if you wish, use the <code>cols4all</code> and it’s functions, e.g.&nbsp;<code>scale_fill_continuous_c4a_seq()</code> instead of <code>scale_fill_distiller()</code> in the code chunk below.</font></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>covid <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Rate <span class="sc">&gt;</span> <span class="dv">400</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(LtlaName) <span class="sc">|&gt;</span>   <span class="co"># LtlaName is the name of the local authority</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(LtlaName)) <span class="ot">-&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  high_rate</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> covid, <span class="fu">aes</span>(<span class="at">fill =</span> Rate), <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"YlOrRd"</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_label_repel</span>(<span class="at">data =</span> high_rate, <span class="fu">aes</span>(<span class="at">label =</span> LtlaName), <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>… and with variation within the cities such as Manchester:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> covid <span class="sc">|&gt;</span> <span class="fu">filter</span>(LtlaName <span class="sc">==</span> <span class="st">"Manchester"</span>)) <span class="sc">+</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Rate), <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"YlOrRd"</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Across the map there appears to be a pattern of positive spatial autocorrelation in the COVID-19 rates of contiguous neighbours (‘hot spots’), as evident using a Moran test,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(spdep)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(<span class="fu">poly2nb</span>(covid, <span class="at">snap =</span> <span class="dv">1</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">moran.test</span>(covid<span class="sc">$</span>Rate, spweight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Moran I test under randomisation

data:  covid$Rate  
weights: spweight    

Moran I statistic standard deviate = 24.422, p-value &lt; 2.2e-16
alternative hypothesis: greater
sample estimates:
Moran I statistic       Expectation          Variance 
     0.4919206758     -0.0010834236      0.0004075223 </code></pre>
</div>
</div>
<p>Some of the ‘hot spots’ of infection are suggested using the geographically-weighted means,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(GWmodel)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>covid_sp <span class="ot">&lt;-</span> <span class="fu">as_Spatial</span>(covid)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(Rate <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> covid_sp,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>, <span class="at">longlat =</span> F)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>gwstats <span class="ot">&lt;-</span> <span class="fu">gwss</span>(covid_sp, <span class="at">vars =</span> <span class="st">"Rate"</span>, <span class="at">bw =</span> bw, <span class="at">kernel =</span> <span class="st">"bisquare"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">longlat =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Plotting these,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>Rate_LM <span class="ot">&lt;-</span> gwstats<span class="sc">$</span>SDF<span class="sc">$</span>Rate_LM</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> Rate_LM)) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"YlOrRd"</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>They also are suggested using the G-statistic with a somewhat arbitrary bandwidth of 5km.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(covid, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">5000</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>spweightB <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(covid<span class="sc">$</span>Rate, spweightB)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(covid<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>          <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(covid<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(covid<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp)) <span class="sc">+</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"G"</span>, <span class="at">values =</span> pal, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="an-initial-model-to-explain-the-spatial-patterns-in-the-covid-19-rates" class="level2">
<h2 class="anchored" data-anchor-id="an-initial-model-to-explain-the-spatial-patterns-in-the-covid-19-rates">An initial model to explain the spatial patterns in the COVID-19 rates</h2>
<p>It is likely that the spatial variation in the COVID-19 rates is due to differences in the physical attributes of the different neighbourhoods and/or of the populations who live in them. For example, the rates may be related to the relative level of deprivation in the neighbourhoods (the <a href="https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019" target="_blank">Index of Multiple Deprivation</a>, <code>IMD</code>), the age composition of their populations (e.g.&nbsp;percentage aged 0 to 11, <code>age0.11</code>), the population density (<code>density</code>), the number of carehome beds (<code>carebeds</code>, because particularly early on in the pandemic, carehome residents were at very high risk), and whether they contain an Accident and Emergency hospital (<code>AandE</code>, coded 1 if they do and 0 if they don’t). Incorporating this into a standard regression model gives,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ols1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(Rate <span class="sc">~</span> IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age12<span class="fl">.17</span> <span class="sc">+</span> age18<span class="fl">.24</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age35<span class="fl">.39</span> <span class="sc">+</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>             age50<span class="fl">.59</span> <span class="sc">+</span> age60<span class="fl">.69</span> <span class="sc">+</span> age70plus <span class="sc">+</span> density <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>             carebeds <span class="sc">+</span> AandE, <span class="at">data =</span> covid)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ols1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Rate ~ IMD + age0.11 + age12.17 + age18.24 + age25.34 + 
    age35.39 + age50.59 + age60.69 + age70plus + density + carebeds + 
    AandE, data = covid)

Residuals:
     Min       1Q   Median       3Q      Max 
-134.816  -17.761    1.592   20.124  139.444 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 182.26850  113.79175   1.602 0.109553    
IMD          -0.29381    0.10610  -2.769 0.005736 ** 
age0.11       2.21553    1.36681   1.621 0.105376    
age12.17     -2.36944    1.94032  -1.221 0.222341    
age18.24     -0.16683    1.16041  -0.144 0.885719    
age25.34      2.31424    1.19221   1.941 0.052550 .  
age35.39      6.65665    2.65716   2.505 0.012413 *  
age50.59      6.31033    1.74161   3.623 0.000307 ***
age60.69      0.34605    1.46550   0.236 0.813386    
age70plus    -0.71097    1.23595  -0.575 0.565269    
density     164.39302  636.21170   0.258 0.796162    
carebeds      0.03583    0.01489   2.407 0.016292 *  
AandE         1.13369    4.03313   0.281 0.778703    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 31.75 on 911 degrees of freedom
Multiple R-squared:  0.2039,    Adjusted R-squared:  0.1934 
F-statistic: 19.44 on 12 and 911 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p><br> which, as its R-squared value of 0.204 suggests, goes some way to explaining the variation in the rates. Note that you can tidier output for some models using tidyvere’s <a href="https://broom.tidymodels.org/" target="_blank">broom</a> package and functions.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(broom)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ols1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 5
   term        estimate std.error statistic  p.value
   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1 (Intercept) 182.      114.         1.60  0.110   
 2 IMD          -0.294     0.106     -2.77  0.00574 
 3 age0.11       2.22      1.37       1.62  0.105   
 4 age12.17     -2.37      1.94      -1.22  0.222   
 5 age18.24     -0.167     1.16      -0.144 0.886   
 6 age25.34      2.31      1.19       1.94  0.0525  
 7 age35.39      6.66      2.66       2.51  0.0124  
 8 age50.59      6.31      1.74       3.62  0.000307
 9 age60.69      0.346     1.47       0.236 0.813   
10 age70plus    -0.711     1.24      -0.575 0.565   
11 density     164.      636.         0.258 0.796   
12 carebeds      0.0358    0.0149     2.41  0.0163  
13 AandE         1.13      4.03       0.281 0.779   </code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(ols1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 12
  r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC   BIC
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     0.204         0.193  31.7      19.4 4.88e-38    12 -4500. 9027. 9095.
# ℹ 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
</div>
</div>
<p>Looking at R’s standard diagnostic plots there is not any strong evidence that the standard ]residual Normality assumption](https://thestatsgeek.com/2013/08/07/assumptions-for-linear-regression/){target=“_blank”} of the regression statistics is being violated although, not very surprisingly, the variance inflation values (VIF) do suggest <a href="https://www.britannica.com/topic/collinearity-statistics" target="_blank">high levels of colinearity</a> between the age variables.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ols1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"car"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) <span class="fu">install.packages</span>(<span class="st">"car"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(car)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(ols1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      IMD   age0.11  age12.17  age18.24  age25.34  age35.39  age50.59  age60.69 
 2.834069 18.836543  6.050232 38.347245 27.513979 10.228388 16.430177 14.397087 
age70plus   density  carebeds     AandE 
38.881759  2.123517  1.135127  1.030432 </code></pre>
</div>
</div>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">There are no hard and fast rules but, in broad terms, a VIF value of 4 or 5 or above is worth considering as a potential issue and a value above 10 suggests a very high level of multicollinearity. The simple solution to the issue is to drop some of the colinear variables but not all: if X1 and X2 are highly correlated, you only need to consider dropping X1 or X2, not both.</font></p>
<p><br> Although I am generally cautious about automated selection procedures, in this case a stepwise model selection appears useful to address the colinearity:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ols2 <span class="ot">&lt;-</span> <span class="fu">step</span>(ols1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The results are,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ols2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 5
  term        estimate std.error statistic  p.value
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 (Intercept) 147.       14.4        10.3  1.96e-23
2 IMD          -0.260     0.0941     -2.76 5.90e- 3
3 age0.11       1.81      0.532       3.40 6.95e- 4
4 age25.34      2.91      0.476       6.11 1.48e- 9
5 age35.39      7.28      1.54        4.74 2.48e- 6
6 age50.59      6.66      0.638      10.4  3.60e-24
7 carebeds      0.0333    0.0142      2.35 1.91e- 2</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(ols2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 12
  r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC   BIC
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     0.201         0.196  31.7      38.5 8.36e-42     6 -4501. 9018. 9057.
# ℹ 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(ols2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     IMD  age0.11 age25.34 age35.39 age50.59 carebeds 
2.236588 2.865175 4.394042 3.425196 2.212515 1.031632 </code></pre>
</div>
</div>
<p>An analysis of variance (ANOVA) shows there is no statistically gain in using the model with more variables (<code>ols1</code>) so we can prefer the simpler (<code>ols2</code>).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(ols2, ols1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Model 1: Rate ~ IMD + age0.11 + age25.34 + age35.39 + age50.59 + carebeds
Model 2: Rate ~ IMD + age0.11 + age12.17 + age18.24 + age25.34 + age35.39 + 
    age50.59 + age60.69 + age70plus + density + carebeds + AandE
  Res.Df    RSS Df Sum of Sq      F Pr(&gt;F)
1    917 921337                           
2    911 918176  6    3161.6 0.5228 0.7913</code></pre>
</div>
</div>
<p>Looking again at the model (<code>tidy(ols2)</code>), it may seem surprising that the deprivation index is negatively correlated with the COVID rate – implying more deprivation, fewer infections (geographies of health often work in the opposite direction; being poorer can come with a ‘health premium’) – but this is due to the later variants of the disease that spread quickly through more affluent populations when restrictions on mobility and social interaction have been relaxed.</p>
</section>
<section id="spatial-dependencies-in-the-model-residuals" class="level2">
<h2 class="anchored" data-anchor-id="spatial-dependencies-in-the-model-residuals">Spatial dependencies in the model residuals</h2>
<p>Although the model appears to fit the data reasonably well, there is a problem. The residuals – the differences between what the model predicts as the COVID-19 rate at each location and what those rates actually are – are supposed to be random noise, meaning their values should be independent of their location and of each other, with no spatial structure. They are not. In fact, if we apply a Moran’s test to the residuals, using the test for regression residuals, <code>lm.morantest()</code>, we find that they are significantly spatially correlated:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(ols2, spweight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Global Moran I for regression residuals

data:  
model: lm(formula = Rate ~ IMD + age0.11 + age25.34 + age35.39 +
age50.59 + carebeds, data = covid)
weights: spweight

Moran I statistic standard deviate = 22.357, p-value &lt; 2.2e-16
alternative hypothesis: greater
sample estimates:
Observed Moran I      Expectation         Variance 
    0.4461249282    -0.0033794098     0.0004042296 </code></pre>
</div>
</div>
<p><br> The pattern is evident if we map the <a href="https://www.statology.org/standardized-residuals" target="_blank">standardised residuals</a> from the function <code>rstandard()</code>. At the risk of geographic over-simplification, there is something of a north-south divide, with a patch of negative residuals to the north of the study region. These are rural neighbouhoods where the model is under-predicting the rate of COVID-19 cases.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids <span class="ot">&lt;-</span> <span class="fu">rstandard</span>(ols2)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(covid<span class="sc">$</span>resids), <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(covid<span class="sc">$</span>resids))</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(covid<span class="sc">$</span>resids, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> resids_gp)) <span class="sc">+</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"Standardised residual"</span>, <span class="at">values =</span> pal) <span class="sc">+</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="looking-again-at-the-model" class="level3">
<h3 class="anchored" data-anchor-id="looking-again-at-the-model">Looking again at the model</h3>
<p>It is possible that the spatial structure in the residuals exists because the model has been mis-specified. In particular, we might wonder if it was a mistake to drop the population density variable which perhaps had a polynomial (non-linear) relationship with the COVID rates. Let’s find out.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>ols3 <span class="ot">&lt;-</span> <span class="fu">update</span>(ols2, . <span class="sc">~</span> . <span class="sc">+</span> <span class="fu">poly</span>(density, <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><br> Certainly, of the three models, this is the best fit to the data, as we can see from the various model fit diagnostics that are easily gathered together using the <code>glance()</code> function. Note the <em>highest</em>, adjusted r-squared value and <em>lowest</em> AIC value, for example.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">glance</span>(ols1), <span class="fu">glance</span>(ols2), <span class="fu">glance</span>(ols3))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 12
  r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC   BIC
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     0.204         0.193  31.7      19.4 4.88e-38    12 -4500. 9027. 9095.
2     0.201         0.196  31.7      38.5 8.36e-42     6 -4501. 9018. 9057.
3     0.248         0.241  30.8      37.7 5.93e-52     8 -4473. 8966. 9015.
# ℹ 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
</div>
</div>
<p>An analysis of variance also suggests that the model fit has improved significantly.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(ols2, ols3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Model 1: Rate ~ IMD + age0.11 + age25.34 + age35.39 + age50.59 + carebeds
Model 2: Rate ~ IMD + age0.11 + age25.34 + age35.39 + age50.59 + carebeds + 
    poly(density, 2)
  Res.Df    RSS Df Sum of Sq      F    Pr(&gt;F)    
1    917 921337                                  
2    915 867305  2     54032 28.502 9.819e-13 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>However, there is still spatial autocorrelation left in the model residuals, albeit slightly reduced from before.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(ols2, spweight)<span class="sc">$</span>estimate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Observed Moran I      Expectation         Variance 
    0.4461249282    -0.0033794098     0.0004042296 </code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(ols3, spweight)<span class="sc">$</span>estimate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Observed Moran I      Expectation         Variance 
    0.4133475904    -0.0037610429     0.0004036032 </code></pre>
</div>
</div>
<p>The map of the residuals now looks like:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids <span class="ot">&lt;-</span> <span class="fu">rstandard</span>(ols3)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(covid<span class="sc">$</span>resids), <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(covid<span class="sc">$</span>resids))</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(covid<span class="sc">$</span>resids, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> resids_gp)) <span class="sc">+</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"Standardised residual"</span>, <span class="at">values =</span> pal) <span class="sc">+</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="spatial-regression-models" class="level2">
<h2 class="anchored" data-anchor-id="spatial-regression-models">Spatial regression models</h2>
<section id="spatial-error-model" class="level3">
<h3 class="anchored" data-anchor-id="spatial-error-model">Spatial error model</h3>
<p>One way to handle the error structure is to fit a spatial simultaneous autoregressive error model which decomposes the error (the residuals) into two parts: a spatially lagged component (the bit that allows for geographical clustering in the residuals) and a remaining error: <span class="math inline">\(y = X\beta + \lambda W \xi + \epsilon\)</span>. The model can be fitted using R’s <code>spatialreg</code> package.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"spatialreg"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) <span class="fu">install.packages</span>(<span class="st">"spatialreg"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(spatialreg)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>errmod <span class="ot">&lt;-</span> <span class="fu">errorsarlm</span>(<span class="fu">formula</span>(ols3), <span class="at">data =</span> covid, <span class="at">listw =</span> spweight)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(errmod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:errorsarlm(formula = formula(ols3), data = covid, listw = spweight)

Residuals:
     Min       1Q   Median       3Q      Max 
-88.9057 -13.5631   1.0775  15.1597 108.7168 

Type: error 
Coefficients: (asymptotic standard errors) 
                     Estimate  Std. Error z value  Pr(&gt;|z|)
(Intercept)        228.423039   13.194612 17.3118 &lt; 2.2e-16
IMD                 -0.595479    0.089535 -6.6508 2.915e-11
age0.11              1.885127    0.449453  4.1943 2.738e-05
age25.34             2.612570    0.416075  6.2791 3.406e-10
age35.39             3.729976    1.369957  2.7227  0.006475
age50.59             3.339294    0.608468  5.4880 4.064e-08
carebeds             0.051339    0.010181  5.0426 4.592e-07
poly(density, 2)1 -111.989509   38.123933 -2.9375  0.003309
poly(density, 2)2 -120.005314   28.931982 -4.1478 3.356e-05

Lambda: 0.69751, LR test value: 348.94, p-value: &lt; 2.22e-16
Asymptotic standard error: 0.028893
    z-value: 24.142, p-value: &lt; 2.22e-16
Wald statistic: 582.82, p-value: &lt; 2.22e-16

Log likelihood: -4298.755 for error model
ML residual variance (sigma squared): 572.93, (sigma: 23.936)
Number of observations: 924 
Number of parameters estimated: 11 
AIC: NA (not available for weighted model), (AIC for lm: 8966.5)</code></pre>
</div>
</div>
<p>The spatial component, <span class="math inline">\(\lambda\)</span>, the spatial autocorrelation in the residuals, is significant as a number of test statistics that are with it in the summary above show. What it confirms is what we could interpret from the earlier Moran’s test of the regression residuals: having allowed for the variables that help to predict the COVID-rates there is still an unexplained geographic pattern whereby places for which the model over-predict the rate tend to be surrounded by other places where it does the same, and places where it under-predicts are surrounded by other under-predictions. The spatial error model gives a better fit to the data than the standard regression, as the following diagnostics tell us (the lower the AIC the better)</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(ols3)<span class="sc">$</span>r.squared</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2479886</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(errmod)<span class="sc">$</span>r.squared</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5543411</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(ols3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8966.455</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(errmod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8619.511</code></pre>
</div>
</div>
<p>The differences are such that there is little doubt that the error model offers a much improved fit but if we do wish to test that difference statistically then</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(ols3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>'log Lik.' -4473.228 (df=10)</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(errmod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>'log Lik.' -4298.755 (df=11)</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>degf <span class="ot">&lt;-</span> <span class="fu">attr</span>(<span class="fu">logLik</span>(errmod), <span class="st">"df"</span>) <span class="sc">-</span> <span class="fu">attr</span>(<span class="fu">logLik</span>(ols3), <span class="st">"df"</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>LR <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> (<span class="fu">logLik</span>(ols3) <span class="sc">-</span> <span class="fu">logLik</span>(errmod))</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>LR <span class="sc">&gt;</span> <span class="fu">qchisq</span>(<span class="fl">0.99</span>, degf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Using the error model changes the estimates of the regression coefficients.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ols3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 5
  term               estimate std.error statistic  p.value
  &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 (Intercept)        185.       15.2       12.2   7.36e-32
2 IMD                 -0.338     0.0941    -3.59  3.45e- 4
3 age0.11              1.51      0.519      2.92  3.61e- 3
4 age25.34             3.15      0.464      6.80  1.87e-11
5 age35.39             3.96      1.56       2.55  1.11e- 2
6 age50.59             5.67      0.696      8.15  1.15e-15
7 carebeds             0.0290    0.0138     2.10  3.56e- 2
8 poly(density, 2)1   23.8      43.1        0.553 5.81e- 1
9 poly(density, 2)2 -267.       35.5       -7.54  1.11e-13</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(errmod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 5
   term               estimate std.error statistic  p.value
   &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1 (Intercept)        228.       13.2        17.3  0       
 2 IMD                 -0.595     0.0895     -6.65 2.91e-11
 3 age0.11              1.89      0.449       4.19 2.74e- 5
 4 age25.34             2.61      0.416       6.28 3.41e-10
 5 age35.39             3.73      1.37        2.72 6.48e- 3
 6 age50.59             3.34      0.608       5.49 4.06e- 8
 7 carebeds             0.0513    0.0102      5.04 4.59e- 7
 8 poly(density, 2)1 -112.       38.1        -2.94 3.31e- 3
 9 poly(density, 2)2 -120.       28.9        -4.15 3.36e- 5
10 lambda               0.698     0.0289     24.1  0       </code></pre>
</div>
</div>
<p>For example, where the estimate for <code>age50.59</code>, which is the estimate of the effect size, used to be 5.67, now it is 3.34. The 95% confidence intervals for those and the other coefficient estimates change too:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(ols3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                          2.5 %        97.5 %
(Intercept)        1.555316e+02  215.12202256
IMD               -5.225593e-01   -0.15331307
age0.11            4.956890e-01    2.53253071
age25.34           2.244363e+00    4.06480619
age35.39           9.064758e-01    7.01079426
age50.59           4.308470e+00    7.03988250
carebeds           1.958051e-03    0.05604307
poly(density, 2)1 -6.079177e+01  108.44040596
poly(density, 2)2 -3.369641e+02 -197.81320842</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(errmod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                          2.5 %       97.5 %
lambda               0.64088632   0.75414292
(Intercept)        202.56207479 254.28400302
IMD                 -0.77096355  -0.41999367
age0.11              1.00421465   2.76603904
age25.34             1.79707790   3.42806121
age35.39             1.04490941   6.41504341
age50.59             2.14671968   4.53186855
carebeds             0.03138441   0.07129323
poly(density, 2)1 -186.71104488 -37.26797279
poly(density, 2)2 -176.71095604 -63.29967108</code></pre>
</div>
</div>
</section>
<section id="spatially-lagged-y-model" class="level3">
<h3 class="anchored" data-anchor-id="spatially-lagged-y-model">Spatially lagged y model</h3>
<p>Although the spatial error model fits the data better than the standard regression model, it tells us only that there is an unexplained spatial structure to the residuals, not what caused it. It may offer better estimates of the model parameters and their statistical significance but it does not presuppose any particular spatial process generating the patterns in the values. A different model that explicitly tests for whether the value at a location is functionally dependent on the values of neighbouring location is the spatially lagged y model: <span class="math inline">\(y = \rho Wy + X\beta + \epsilon\)</span>. It models an ‘overspill’ or chain effect where the outcome (the Y value) at any location is affected by the outcomes at surrounding locations.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>lagmod <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(<span class="fu">formula</span>(ols3), <span class="at">data =</span> covid, <span class="at">listw =</span> spweight)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lagmod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:lagsarlm(formula = formula(ols3), data = covid, listw = spweight)

Residuals:
     Min       1Q   Median       3Q      Max 
-98.8140 -14.8770   1.0467  14.7420 110.1081 

Type: lag 
Coefficients: (asymptotic standard errors) 
                     Estimate  Std. Error z value  Pr(&gt;|z|)
(Intercept)         17.353053   14.403449  1.2048 0.2282865
IMD                 -0.371501    0.074903 -4.9598 7.057e-07
age0.11              1.377790    0.411239  3.3503 0.0008071
age25.34             2.678105    0.367344  7.2905 3.089e-13
age35.39             1.885234    1.235376  1.5260 0.1269996
age50.59             3.636195    0.553621  6.5680 5.099e-11
carebeds             0.042747    0.010887  3.9264 8.623e-05
poly(density, 2)1  -69.714323   34.062240 -2.0467 0.0406900
poly(density, 2)2 -156.910147   28.073145 -5.5893 2.279e-08

Rho: 0.63167, LR test value: 342.73, p-value: &lt; 2.22e-16
Asymptotic standard error: 0.02966
    z-value: 21.297, p-value: &lt; 2.22e-16
Wald statistic: 453.57, p-value: &lt; 2.22e-16

Log likelihood: -4301.863 for lag model
ML residual variance (sigma squared): 591.59, (sigma: 24.323)
Number of observations: 924 
Number of parameters estimated: 11 
AIC: 8625.7, (AIC for lm: 8966.5)
LM test for residual autocorrelation
test value: 3.5747, p-value: 0.058666</code></pre>
</div>
</div>
<p>Its test for residual autocorrelation does not generate a statistically significant result at a 95% level, meaning there is no statistically significant spatial structure now left in the residuals, although it is close.</p>
<p>Note that the beta estimates of the lagged y-model cannot be interpreted in the same way as for a standard regression model. For example, the beta estimate of -0.372 for the <code>IMD</code> variable does not mean that if (hypothetically) we increased that variable by one unit at each location we should then expect the COVID-19 to everywhere decrease by 0.372 holding the other X variables constant. That is the correct interpretation for a standard (OLS) regression model and also for the spatial error model but not for where the lag of the Y variable is included as a predictor variable. The reason is because if we did raise the <code>IMD</code> value it would start something akin to a ‘chain reaction’ through the feedback of Y via the lagged Y values: the (hypothetical) increase in deprivation at the one location, decreases the COVID-19 rate at neighbouring locations, which decrease the rate at their neighbours and so forth. The total impact is a sum of the direct effect – that predicted to happen through the 1 unit change in <code>IMD</code> – and the indirect effect, which is that caused by ‘the chain reaction’ / feedback / ‘overspill’ in the system:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">impacts</span>(lagmod, <span class="at">listw =</span> spweight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Impact measures (lag, exact):
                        Direct     Indirect       Total
IMD                 -0.4123765   -0.5962427   -1.008619
age0.11              1.5293852    2.2112916    3.740677
age25.34             2.9727718    4.2982405    7.271012
age35.39             2.0926626    3.0257174    5.118380
age50.59             4.0362781    5.8359319    9.872210
carebeds             0.0474502    0.0686068    0.116057
poly(density, 2)1  -77.3848529 -111.8884092 -189.273262
poly(density, 2)2 -174.1746617 -251.8338548 -426.008517</code></pre>
</div>
</div>
<p>Although it wasn’t especially noticeable, there was a short pause as those impacts were calculated. The calculations could take much longer if the size of the spatial weights matrix was larger. As <a href="https://maczokni.github.io/crime_mapping_textbook/spatial-regression-models.html#fitting-and-interpreting-a-spatially-lagged-model" target="_blank">this author</a> notes, after <a href="https://www.routledge.com/Introduction-to-Spatial-Econometrics/LeSage-Pace/p/book/9781420064247" target="_blank">Lesage and Pace, 2009</a>, a faster approximation method can be used, here with <code>R = 1000</code> simulated distributions for the impact measures.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">as</span>(spweight, <span class="st">"CsparseMatrix"</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>trMC <span class="ot">&lt;-</span> <span class="fu">trW</span>(W, <span class="at">type =</span> <span class="st">"MC"</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>im <span class="ot">&lt;-</span><span class="fu">summary</span>(<span class="fu">impacts</span>(lagmod, <span class="at">tr =</span> trMC, <span class="at">R =</span> <span class="dv">1000</span>), <span class="at">zstats =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(im<span class="sc">$</span>res, <span class="at">row.names =</span> <span class="fu">names</span>(lagmod<span class="sc">$</span>coefficients)[<span class="sc">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                         direct      indirect        total
IMD                 -0.41234303   -0.59627520   -1.0086182
age0.11              1.52926088    2.21141200    3.7406729
age25.34             2.97253020    4.29847454    7.2710047
age35.39             2.09249257    3.02588213    5.1183747
age50.59             4.03595005    5.83624971    9.8721998
carebeds             0.04744634    0.06861054    0.1160569
poly(density, 2)1  -77.37856403 -111.89450219 -189.2730662
poly(density, 2)2 -174.16050695 -251.84756879 -426.0080757</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># The [-1] is to omit the intercept</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>An advantage of this approach is that we can also obtain z and p-values for the impact measures; i.e.&nbsp;measures of statistical significance.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(im<span class="sc">$</span>zmat, <span class="at">row.names =</span> <span class="fu">names</span>(lagmod<span class="sc">$</span>coefficients)[<span class="sc">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                     Direct  Indirect     Total
IMD               -5.054252 -4.460659 -4.844566
age0.11            3.392005  3.159568  3.307439
age25.34           7.182828  5.441949  6.344744
age35.39           1.478177  1.462558  1.475798
age50.59           6.828153  5.536535  6.324506
carebeds           4.000674  3.615156  3.843870
poly(density, 2)1 -2.026951 -1.956900 -1.999277
poly(density, 2)2 -5.557780 -4.679914 -5.184039</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(im<span class="sc">$</span>pzmat, <span class="at">row.names =</span> <span class="fu">names</span>(lagmod<span class="sc">$</span>coefficients)[<span class="sc">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                        Direct     Indirect        Total
IMD               4.320814e-07 8.170800e-06 1.268885e-06
age0.11           6.938313e-04 1.580033e-03 9.415314e-04
age25.34          6.827872e-13 5.270089e-08 2.227960e-10
age35.39          1.393604e-01 1.435883e-01 1.399982e-01
age50.59          8.601564e-12 3.085133e-08 2.540441e-10
carebeds          6.316242e-05 3.001670e-04 1.211090e-04
poly(density, 2)1 4.266746e-02 5.035924e-02 4.557836e-02
poly(density, 2)2 2.732270e-08 2.869958e-06 2.171321e-07</code></pre>
</div>
</div>
<p>Most but not all of the impacts are significant at, say, a 95% confidence (i.e p &lt; 0.05). We can drop <code>age35.39</code> from the model with little loss of fit.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>lagmod2 <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(Rate <span class="sc">~</span>  IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span> carebeds <span class="sc">+</span> </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">poly</span>(density, <span class="dv">2</span>), <span class="at">data =</span> covid, <span class="at">listw =</span> spweight)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(lagmod, lagmod2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        Model df    AIC  logLik Test L.Ratio p-value
lagmod      1 11 8625.7 -4301.9    1                
lagmod2     2 10 8626.1 -4303.0    2  2.3408 0.12602</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">glance</span>(lagmod), <span class="fu">glance</span>(lagmod2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  r.squared   AIC   BIC deviance logLik  nobs
      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;
1     0.532 8626. 8679.  546629. -4302.   924
2     0.532 8626. 8674.  547460. -4303.   924</code></pre>
</div>
</div>
<p><br> In fact, an increase of 1 unit in, for example, the <code>IMD</code> variable, will play out slightly differently in different places because they have different neighbours with different Y values and are at different distances from each other. The code below, which is from the first edition of <a href="https://uk.sagepub.com/en-gb/eur/spatial-regression-models/book262155" target="_blank">Ward &amp; Gleditsch (2008, pp.47)</a>, will calculate the impact (of a one unit change in <code>IMD</code>) at each location but below I have limited it to the first ten so that it doesn’t take too long to run.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(covid)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>I <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> n, <span class="at">ncol =</span> n)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(I) <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> lagmod<span class="sc">$</span>rho</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> lagmod<span class="sc">$</span>coefficients[<span class="st">"age25.34"</span>]</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>weights.matrix <span class="ot">&lt;-</span> <span class="fu">listw2mat</span>(spweight)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times=</span><span class="dv">10</span>)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, \(i) {</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>  xvector <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="at">times=</span>n)</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>  xvector[i] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>  impact <span class="ot">&lt;-</span> <span class="fu">solve</span>(I <span class="sc">-</span> rho <span class="sc">*</span> weights.matrix) <span class="sc">%*%</span> xvector <span class="sc">*</span> beta</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  results[i] <span class="ot">&lt;-</span> impact[i]</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 2.953840 2.973231 2.949515 2.908907 3.025483 2.901597 2.949316 2.960332
 [9] 2.949171 2.946591</code></pre>
</div>
</div>
</section>
<section id="choosing-between-the-spatial-error-and-lagged-y-model" class="level3">
<h3 class="anchored" data-anchor-id="choosing-between-the-spatial-error-and-lagged-y-model">Choosing between the spatial error and lagged y model</h3>
<p>Before fitting the spatial error and lagged y models, we could have looked for evidence in support of them using the function <code>lm.LMtests()</code>. This tests the basic OLS specification against the more general spatial error and lagged y models. Anselin and Rey (2014, p.110) offer the following decision tree that can, in the absence of a more theoretical basis for the model choice (e.g.&nbsp;the type of process being modelled), be used in conjunction with the test results to help select the model.</p>
<p><img src="flowchart.jpg" class="img-fluid"></p>
<p><font size="2">Source: <a href="https://www.amazon.co.uk/Modern-Spatial-Econometrics-Practice-GeoDaSpace/dp/0986342106" target="&quot;_blank">Modern Spatial Econometrics in Practice</a></font></p>
<p>In the first step, we find that in this instance both the LM-Error and LM-Lag tests are significant.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>ols4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(Rate <span class="sc">~</span>  IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span> carebeds <span class="sc">+</span> <span class="fu">poly</span>(density, <span class="dv">2</span>), <span class="at">data =</span> covid)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.LMtests</span>(ols4, spweight, <span class="at">test=</span><span class="fu">c</span>(<span class="st">"LMerr"</span>, <span class="st">"LMlag"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Lagrange multiplier diagnostics for spatial dependence

data:  
model: lm(formula = Rate ~ IMD + age0.11 + age25.34 + age50.59 +
carebeds + poly(density, 2), data = covid)
weights: spweight

LMerr = 411.48, df = 1, p-value &lt; 2.2e-16


    Lagrange multiplier diagnostics for spatial dependence

data:  
model: lm(formula = Rate ~ IMD + age0.11 + age25.34 + age50.59 +
carebeds + poly(density, 2), data = covid)
weights: spweight

LMlag = 463.85, df = 1, p-value &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Moving on to the robust tests, only the LM-Lag test is significant. Given the nature of COVID-19 as an infectious disease, it does seem reasonable to suppose that high rates of infection in any an area will ‘overspill’ into neighbouring areas too.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.LMtests</span>(ols4, spweight, <span class="at">test=</span><span class="fu">c</span>(<span class="st">"RLMerr"</span>, <span class="st">"RLMlag"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Lagrange multiplier diagnostics for spatial dependence

data:  
model: lm(formula = Rate ~ IMD + age0.11 + age25.34 + age50.59 +
carebeds + poly(density, 2), data = covid)
weights: spweight

RLMerr = 2.3319, df = 1, p-value = 0.1267


    Lagrange multiplier diagnostics for spatial dependence

data:  
model: lm(formula = Rate ~ IMD + age0.11 + age25.34 + age50.59 +
carebeds + poly(density, 2), data = covid)
weights: spweight

RLMlag = 54.693, df = 1, p-value = 1.409e-13</code></pre>
</div>
</div>
</section>
</section>
<section id="a-geographically-weighted-spatial-weights-matrix" class="level2">
<h2 class="anchored" data-anchor-id="a-geographically-weighted-spatial-weights-matrix">A geographically weighted spatial weights matrix</h2>
<p>As with the tests of spatial autocorrelation in an earlier session and as with the geographically weighted statistics, the results of the spatial regression models are dependent on the specification of the spatial weights matrix which can suffer from being somewhat arbitrary. We could, if we wish, try calibrating it around the geographically weighted mean.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(GWmodel)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(Rate <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> covid_sp, <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To now create the corresponding inverse distance spatial weights matrix for the models, we can use the <code>nn2</code> function in the <code>RANN</code> package to find the $bw = $ 18 nearest neighbours to each centroid point:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"RANN"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>]))  <span class="fu">install.packages</span>(<span class="st">"RANN"</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(RANN)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(<span class="fu">st_centroid</span>(<span class="fu">st_geometry</span>(covid)))</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>knn <span class="ot">&lt;-</span> <span class="fu">nn2</span>(coords, coords, <span class="at">k =</span> bw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Having done so, those neighbours can be geographically weighted using a bisquare kernel, as in the GWR calibration above. (A Gaussian kernel is obtained if <code>(1 - (x / max(x))^2)^2</code> is replaced by <code>exp(-0.5 * (x / max(x))^2)</code> in the code below).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> knn<span class="sc">$</span>nn.dists</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>glist <span class="ot">&lt;-</span> <span class="fu">apply</span>(d, <span class="dv">1</span>, \(x) {</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span> <span class="sc">-</span> (x <span class="sc">/</span> <span class="fu">max</span>(x))<span class="sc">^</span><span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>}, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>knearnb <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(<span class="fu">st_centroid</span>(<span class="fu">st_geometry</span>(covid)), <span class="at">k =</span> bw))</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>spweightK <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(knearnb, glist, <span class="at">style =</span> <span class="st">"C"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The results are not very successful though. The lag model with contiguous spatial weights fits the data better,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>lagmod3 <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(<span class="fu">formula</span>(ols4), <span class="at">data =</span> covid, <span class="at">listw =</span> spweightK)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">glance</span>(lagmod2), <span class="fu">glance</span>(lagmod3))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  r.squared   AIC   BIC deviance logLik  nobs
      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;
1     0.532 8626. 8674.  547460. -4303.   924
2     0.254 8959. 9008.  860562. -4470.   924</code></pre>
</div>
</div>
<p>In addition, the inverse distance weights are not row-standardised, which may cause some knock-on problems. They could become row-standardised (<code>spweightK &lt;- nb2listw(knearnb, glist, style = "W")</code>) but if they are, by re-scaling each row of the weights to equal one, then the inverse distance weighting is altered.</p>
</section>
<section id="geographically-weighted-regression" class="level2">
<h2 class="anchored" data-anchor-id="geographically-weighted-regression">Geographically Weighted Regression</h2>
<p>The following charts shows the simple, bivariate regression relationship between <code>Rate</code> and <code>age0.11</code>.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">x =</span> age0<span class="fl">.11</span>, <span class="at">y =</span> Rate)) <span class="sc">+</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Intriguingly, it doesn’t seem to be linear relationship but a polynomial one.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">x =</span> age0<span class="fl">.11</span>, <span class="at">y =</span> Rate)) <span class="sc">+</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">formula =</span> y <span class="sc">~</span> <span class="fu">poly</span>(x, <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>It could be that the relationship is indeed curved but it might also be that the nature of the relationship is spatially dependent – that the relationship between <code>Rate</code> and <code>age0.11</code> depends upon where it is measured. A <code>coplot()</code> from R’s base graphics lends weight to the second idea: note how the regression relationship changes with <code>X</code> and <code>Y</code>, which are the centroids of the neighbourhoods in the North West of England.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>coplot_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">st_coordinates</span>(<span class="fu">st_centroid</span>(covid)), <span class="at">Rate =</span> covid<span class="sc">$</span>Rate, <span class="at">age0.11 =</span> covid<span class="sc">$</span>age0<span class="fl">.11</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>PointsWithLine <span class="ot">=</span> <span class="cf">function</span>(x, y, ...) {</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">pch=</span><span class="dv">20</span>, <span class="at">col=</span><span class="st">"black"</span>)</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x))</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="fu">coplot</span>(Rate <span class="sc">~</span> age0<span class="fl">.11</span> <span class="sc">|</span> X <span class="sc">*</span> Y, <span class="at">data =</span> coplot_df, <span class="at">panel =</span> PointsWithLine, <span class="at">overlap =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Imagine, now, that instead of dividing the geography of the North West’s neighbourhoods into a <span class="math inline">\(6 \times 6\)</span> grid, as in the coplot, we instead go from location to location within the study region, calculating a <a href="https://www.sciencedirect.com/science/article/pii/B9780080449104004478?via%3Dihub" target="_blank">geographically weighted regression</a> at and around each one of them. This builds on the idea of geographically weighted statistics that allow the measured value of the statistic to vary locally from location to location across the study region; with geographically weighted it is the locally estimated regression coefficients that are allowed to vary. These are used to look for spatial variation in the regression relationships.</p>
<p>If the bandwidth is not known or there is no theoretical justification for it, it can be found using an automated selection procedure, here with a more complex model than the bivariate relationship shown in the coplot, instead using all the variables included in the choice between the spatial error and lagged y model, above.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(GWmodel)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(<span class="fu">formula</span>(ols4), <span class="at">data =</span> covid_sp, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The model can then be fitted.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>gwrmod <span class="ot">&lt;-</span> <span class="fu">gwr.basic</span>(<span class="fu">formula</span>(ols4), <span class="at">data =</span> covid_sp, <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">bw =</span> bw)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>gwrmod</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   ***********************************************************************
   *                       Package   GWmodel                             *
   ***********************************************************************
   Program starts at: 2023-11-28 13:03:15.967711 
   Call:
   gwr.basic(formula = formula(ols4), data = covid_sp, bw = bw, 
    adaptive = TRUE)

   Dependent (y) variable:  Rate
   Independent variables:  IMD age0.11 age25.34 age50.59 carebeds density
   Number of data points: 924
   ***********************************************************************
   *                    Results of Global Regression                     *
   ***********************************************************************

   Call:
    lm(formula = formula, data = data)

   Residuals:
     Min       1Q   Median       3Q      Max 
-123.194  -18.380    1.473   20.623  127.554 

   Coefficients:
                       Estimate Std. Error t value Pr(&gt;|t|)    
   (Intercept)        188.50375   15.17560  12.422  &lt; 2e-16 ***
   IMD                 -0.39649    0.09149  -4.334 1.63e-05 ***
   age0.11              2.30191    0.41777   5.510 4.66e-08 ***
   age25.34             3.93517    0.34898  11.276  &lt; 2e-16 ***
   age50.59             5.80810    0.69596   8.345 2.59e-16 ***
   carebeds             0.02904    0.01382   2.101   0.0359 *  
   poly(density, 2)1   29.14870   43.19300   0.675   0.4999    
   poly(density, 2)2 -292.74904   34.12420  -8.579  &lt; 2e-16 ***

   ---Significance stars
   Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 
   Residual standard error: 30.88 on 916 degrees of freedom
   Multiple R-squared: 0.2427
   Adjusted R-squared: 0.2369 
   F-statistic: 41.93 on 7 and 916 DF,  p-value: &lt; 2.2e-16 
   ***Extra Diagnostic information
   Residual sum of squares: 873446.4
   Sigma(hat): 30.77887
   AIC:  8970.975
   AICc:  8971.172
   BIC:  8151.892
   ***********************************************************************
   *          Results of Geographically Weighted Regression              *
   ***********************************************************************

   *********************Model calibration information*********************
   Kernel function: bisquare 
   Adaptive bandwidth: 80 (number of nearest neighbours)
   Regression points: the same locations as observations are used.
   Distance metric: Euclidean distance metric is used.

   ****************Summary of GWR coefficient estimates:******************
                            Min.     1st Qu.      Median     3rd Qu.     Max.
   Intercept         -3.9934e+01  1.3693e+02  2.1422e+02  2.6180e+02 419.5064
   IMD               -2.7499e+00 -7.8059e-01 -4.4223e-01 -1.6702e-01   0.6501
   age0.11           -4.0541e+00  2.3759e-01  3.4220e+00  6.1701e+00  12.5921
   age25.34          -3.9387e+00  1.6469e+00  2.6274e+00  4.2843e+00  13.8157
   age50.59          -9.5346e+00  2.1727e+00  5.3255e+00  8.6233e+00  14.3515
   carebeds          -5.6126e-02  2.5983e-02  5.8662e-02  8.7463e-02   0.2220
   poly(density, 2)1 -2.7204e+03 -4.1814e+02 -1.5602e+02  4.1180e-01 667.9061
   poly(density, 2)2 -2.1980e+03 -5.4619e+02 -2.5300e+02 -1.2247e+02 643.0451
   ************************Diagnostic information*************************
   Number of data points: 924 
   Effective number of parameters (2trace(S) - trace(S'S)): 270.2441 
   Effective degrees of freedom (n-2trace(S) + trace(S'S)): 653.7559 
   AICc (GWR book, Fotheringham, et al. 2002, p. 61, eq 2.33): 8552.959 
   AIC (GWR book, Fotheringham, et al. 2002,GWR p. 96, eq. 4.22): 8216.682 
   BIC (GWR book, Fotheringham, et al. 2002,GWR p. 61, eq. 2.34): 8513.32 
   Residual sum of squares: 313860.8 
   R-square value:  0.7278617 
   Adjusted R-square value:  0.6151951 

   ***********************************************************************
   Program stops at: 2023-11-28 13:03:16.195223 </code></pre>
</div>
</div>
<p>The output requires some interpretation! The results of the global regression are those obtained from a standard OLS regression (i.e.&nbsp;<code>summary(lm(formula(ols4), data = covid_sp))</code>). It is ‘global’ because it is a model for the entire study region, without spatial variation in the regression estimates. The results of the geographically weighted regression are the results from, in this case, 924 separate but spatially overlapping regression models fitted, with geographic weighting, to spatial subsets of the data. All the local estimates are contained in the spatial data frame, <code>gwrmod$SDF</code>, including those for <code>age0.11</code> which are in <code>gwrmod$SDF$age0.11</code> and have the following distribution,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
-4.0541  0.2376  3.4220  3.3645  6.1701 12.5921 </code></pre>
</div>
</div>
<p>This is the same summary of the distribution that is included in the GWR coefficient estimates. What it means is that in at least one location the relationship of <code>age0.11</code> to <code>Rate</code> is, conditional on the other variables, negative. It is more usual for it to be positive – more children, more infections (perhaps a school effect?) – but the estimated effect size varies quite substantially across the locations in the study region. Its interquartile range is from 0.238 to 6.17. Mapping these local estimates reveals an interesting geography – it is largely in and around Manchester where a greater number of children of primary school age or younger appears to <em>lower</em> instead of raising the infection rate.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR <span class="ot">&lt;-</span> gwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> covid, <span class="fu">aes</span>(<span class="at">fill =</span> age0<span class="fl">.11</span>GWR)) <span class="sc">+</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">trans =</span> <span class="st">"reverse"</span>) <span class="sc">+</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_colourbar</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>With a bit of effort we can get all the variables on the same chart…</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"gridExtra"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) <span class="fu">install.packages</span>(<span class="st">"gridExtra"</span>,</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>                                                          <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(gridExtra)</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">8</span>, \(j) {</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(gwrmod<span class="sc">$</span>SDF[, j]) <span class="sc">%&gt;%</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">beta =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> beta)) <span class="sc">+</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">col =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">trans =</span> <span class="st">"reverse"</span>) <span class="sc">+</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_colourbar</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggtitle</span>(<span class="fu">names</span>(gwrmod<span class="sc">$</span>SDF[j]))</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(<span class="at">grobs =</span> g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>… however, not all of these regression estimates are necessarily statistically significant. If we use the estimated t-values to isolate those that are not (t-values less than -1.96 or greater than +1.96 can be considered significant at a 95% confidence), then, for the <code>age0.11</code> variable we obtain,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR[<span class="fu">abs</span>(gwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span>_TV) <span class="sc">&lt;</span> <span class="fl">1.96</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> covid, <span class="fu">aes</span>(<span class="at">fill =</span> age0<span class="fl">.11</span>GWR)) <span class="sc">+</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">trans =</span> <span class="st">"reverse"</span>) <span class="sc">+</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_colourbar</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>and, with a bit more data wrangling, for the full set,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>sdf <span class="ot">&lt;-</span> <span class="fu">slot</span>(gwrmod<span class="sc">$</span>SDF, <span class="st">"data"</span>)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">8</span>, \(j) {</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(gwrmod<span class="sc">$</span>SDF[, j]) </span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(sdf) <span class="sc">==</span> <span class="fu">paste0</span>(<span class="fu">names</span>(x)[<span class="dv">1</span>],<span class="st">"_TV"</span>))</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  x[<span class="fu">abs</span>(sdf[, t]) <span class="sc">&lt;</span> <span class="fl">1.96</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">%&gt;%</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">beta =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> beta)) <span class="sc">+</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">col =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>                           <span class="at">trans =</span> <span class="st">"reverse"</span>) <span class="sc">+</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_colourbar</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggtitle</span>(<span class="fu">names</span>(gwrmod<span class="sc">$</span>SDF[j]))</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(<span class="at">grobs =</span> g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">I am sure there is a more elegant way of doing this. Don’t worry about the code especially - the point is that not every estimate, everywhere, is significant.</font></p>
<p><br> As with the basic GW statistics, we can undertake a randomisation test to suggest whether the spatial variation in the coefficient estimates is statistically significant. <strong>However</strong> this takes some time to run – with the default <code>nsims = 99</code> simulations it took about 12 minutes on my laptop. <strong>I have ‘commented it out’ in the code block below with the suggestion that you don’t run it now.</strong></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I suggest you do not run this</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="co"># gwr.mc &lt;- gwr.montecarlo(formula(ols4), covid_sp, adaptive = TRUE, bw = bw)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Instead, let’s jump straight to the results, which I have saved in a pre-prepared workspace.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/workspaces/gwrmc.RData"</span>)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(url)</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(url)</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>gwr.mc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                  p-value
(Intercept)          0.40
IMD                  0.38
age0.11              0.00
age25.34             0.15
age50.59             0.22
carebeds             0.97
poly(density, 2)1    0.00
poly(density, 2)2    0.00</code></pre>
</div>
</div>
<section id="mixed-gwr" class="level3">
<h3 class="anchored" data-anchor-id="mixed-gwr">Mixed GWR</h3>
<p>It appears that only the <code>age0.11</code> and <code>density</code> variables exhibit significant spatial variation (p-value &lt; 0.05). In principle it is possible to drop the other variables out from the local estimates and treat them as fixed, global estimates instead, in a Mixed GWR model (mixed global and local regression estimates). In practice, it is generating an error.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This appears to generate an error</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>gwrmixd <span class="ot">&lt;-</span> <span class="fu">gwr.mixed</span>(Rate <span class="sc">~</span> IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span> carebeds <span class="sc">+</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">poly</span>(density, <span class="dv">2</span>),</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> covid_sp,</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">fixed.vars =</span> <span class="fu">c</span>(<span class="st">"IMD"</span>, <span class="st">"age25.34"</span>, <span class="st">"age50.59"</span>, <span class="st">"carebeds"</span>),</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">bw =</span> bw, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can work around this, though, using partial regressions, regressing <code>Rate</code>, <code>age0.11</code> and <code>poly(density, 2)</code> on the fixed variables and using their residuals.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>density<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">poly</span>(covid<span class="sc">$</span>density, <span class="dv">2</span>)[, <span class="dv">1</span>]</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>density<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">poly</span>(covid<span class="sc">$</span>density, <span class="dv">2</span>)[, <span class="dv">2</span>]</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>covid_sp<span class="sc">$</span>RateR <span class="ot">&lt;-</span> <span class="fu">residuals</span>(<span class="fu">lm</span>(Rate <span class="sc">~</span> IMD <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span> carebeds,</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> covid_sp))</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>covid_sp<span class="sc">$</span>age0<span class="fl">.11</span>R <span class="ot">&lt;-</span> <span class="fu">residuals</span>(<span class="fu">lm</span>(age0<span class="fl">.11</span> <span class="sc">~</span> IMD <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>                                    carebeds, <span class="at">data =</span> covid_sp))</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>covid_sp<span class="sc">$</span>density<span class="fl">.1</span>R <span class="ot">&lt;-</span> <span class="fu">residuals</span>(<span class="fu">lm</span>(density<span class="fl">.1</span> <span class="sc">~</span> IMD <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>                                    carebeds, <span class="at">data =</span> covid_sp))</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>covid_sp<span class="sc">$</span>density<span class="fl">.2</span>R <span class="ot">&lt;-</span> <span class="fu">residuals</span>(<span class="fu">lm</span>(density<span class="fl">.2</span> <span class="sc">~</span> IMD <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>                                    carebeds, <span class="at">data =</span> covid_sp))</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>fml <span class="ot">&lt;-</span> <span class="fu">formula</span>(RateR <span class="sc">~</span> age0<span class="fl">.11</span>R <span class="sc">+</span> density<span class="fl">.1</span>R <span class="sc">+</span> density<span class="fl">.2</span>R)</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(fml, <span class="at">data =</span> covid_sp, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>gwrmixd <span class="ot">&lt;-</span> <span class="fu">gwr.basic</span>(fml, <span class="at">data =</span> covid_sp, <span class="at">bw =</span> bw, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here are the statistically significant results for the <code>age0.11</code> variable.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR <span class="ot">&lt;-</span> gwrmixd<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span>R</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR[<span class="fu">abs</span>(gwrmixd<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span>R_TV) <span class="sc">&gt;</span> <span class="fl">1.96</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> covid, <span class="fu">aes</span>(<span class="at">fill =</span> age0<span class="fl">.11</span>GWR)) <span class="sc">+</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">na.value =</span> <span class="st">"white"</span>, <span class="at">trans =</span> <span class="st">"reverse"</span>) <span class="sc">+</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_colourbar</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="multiscale-gwr" class="level3">
<h3 class="anchored" data-anchor-id="multiscale-gwr">Multiscale GWR</h3>
<p>It is also possible to fit a Multiscale GWR, which allows for the possibility of a different bandwith for each variable – see <code>?gwr.multiscale</code>. Since there is no particular reason to presume that the bandwidth should be the same for all the variables, arguably Multiscale GWR should be preferred over standard GWR, at least in the first instance. Its main drawback, however, is that it takes a while to run – over 3 hours for the code chunk below! (In principle it can be parallelised but it generated an error for me when I tried this with <code>parallel.method = cluster</code>.)</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>density<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">poly</span>(covid<span class="sc">$</span>density, <span class="dv">2</span>)[, <span class="dv">1</span>]</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>density<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">poly</span>(covid<span class="sc">$</span>density, <span class="dv">2</span>)[, <span class="dv">2</span>]</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Do not run!</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Took over 3 hours!</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="co">#gwrmulti &lt;- gwr.multiscale(Rate ~ IMD + age0.11 + age25.34 + age50.59 + carebeds +</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="co"># density.1 + density.2, data = covid_sp, adaptive = TRUE)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To save time, the results are available below. The bandwidths do appear to vary.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/workspaces/gwrmulti.RData"</span>)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(url)</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(url)</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>gwrmulti</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   ***********************************************************************
   *                       Package   GWmodel                             *
   ***********************************************************************
   Program starts at: 2022-08-21 14:44:09.844854 
   Call:
   gwr.multiscale(formula = Rate ~ IMD + age0.11 + age25.34 + age50.59 + 
    carebeds + density.1 + density.2, data = covid_sp, adaptive = TRUE)

   Dependent (y) variable:  Rate
   Independent variables:  IMD age0.11 age25.34 age50.59 carebeds density.1 density.2
   Number of data points: 924
   ***********************************************************************
   *                       Multiscale (PSDM) GWR                          *
   ***********************************************************************

   *********************Model calibration information*********************
   Kernel function: bisquare 
   Adaptive bandwidths for each coefficient(number of nearest neighbours): 
              (Intercept) IMD age0.11 age25.34 age50.59 carebeds density.1
   Bandwidth           28 922      34      922      132      841       380
              density.2
   Bandwidth        186

   ****************Summary of GWR coefficient estimates:******************
                    Min.     1st Qu.      Median     3rd Qu.     Max.
   Intercept   40.390229  158.475456  197.569654  250.106703 341.7481
   IMD         -0.457266   -0.429212   -0.427347   -0.425449  -0.4210
   age0.11     -4.383024   -0.168031    3.233327    5.482906  15.0608
   age25.34     2.970842    2.980326    2.990406    2.999560   3.0909
   age50.59    -1.540099    3.976661    4.868116    6.199428  10.9802
   carebeds     0.041884    0.045506    0.050615    0.056445   0.0873
   density.1 -228.739192 -171.871215 -117.550561   -6.118907  67.3146
   density.2 -639.370049 -216.959473 -130.236970  -77.397916  26.1626
   ************************Diagnostic information*************************
   Number of data points: 924 
   Effective number of parameters (2trace(S) - trace(S'S)): 227.0379 
   Effective degrees of freedom (n-2trace(S) + trace(S'S)): 696.9621 
   AICc value:  8395.1 
   AIC value:  8142.156 
   BIC value:  8216.88 
   Residual sum of squares:  301719.5 
   R-square value:  0.738389 
   Adjusted R-square value:  0.6530458 

   ***********************************************************************
   Program stops at: 2022-08-21 17:46:34.178011 </code></pre>
</div>
</div>
</section>
<section id="geographically-and-temporally-weighted-regression" class="level3">
<h3 class="anchored" data-anchor-id="geographically-and-temporally-weighted-regression">Geographically and temporally weighted regression</h3>
<p>It also possible to add a time dimension and undertake geographically and temporally weighted regression in <code>GWmodel</code>. The following workspace loads monthly COVID-19 data for Manchester neighbourhoods.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/workspaces/manchester.RData"</span>)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(url)</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here are the monthly rates.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> Rate )) <span class="sc">+</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> month) <span class="sc">+</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"RdBu"</span>) <span class="sc">+</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>If now want to explore how the regression relationships vary in space-time then we can use the <code>bw.gtwr()</code> and <code>gtwr()</code> functions, for which we also need to specify a vector of time tags (<code>obs.tv = ...</code>). In these data, they are simply a numeric value, <code>covid$month_code</code> but see <code>?bw.gtwr()</code> and <code>?gtwr()</code> for further possibilities and for further information about the model.</p>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">The model will take a little time to run – enough time for you to get a cup of tea or coffee!</font></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>covid_sp <span class="ot">&lt;-</span> <span class="fu">as_Spatial</span>(covid)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>fml <span class="ot">&lt;-</span> <span class="fu">formula</span>(Rate <span class="sc">~</span> IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span> carebeds <span class="sc">+</span> <span class="fu">poly</span>(density, <span class="dv">2</span>))</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gtwr</span>(fml, <span class="at">data =</span> covid_sp, <span class="at">obs.tv =</span> covid<span class="sc">$</span>month_code, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>gtwrmod <span class="ot">&lt;-</span> <span class="fu">gtwr</span>(fml, <span class="at">data =</span> covid_sp, <span class="at">st.bw =</span> bw, <span class="at">obs.tv =</span> covid<span class="sc">$</span>month_code, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here are the summary results of the model,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>gtwrmod</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   ***********************************************************************
   *                       Package   GWmodel                             *
   ***********************************************************************
   Program starts at: 2022-08-21 09:11:51.585376 
   Call:
   gtwr(formula = fml, data = covid_sp, obs.tv = covid$month_code, 
    st.bw = bw, adaptive = TRUE)

   Dependent (y) variable:  Rate
   Independent variables:  IMD age0.11 age25.34 age50.59 carebeds density
   Number of data points: 1768
   ***********************************************************************
   *                    Results of Global Regression                     *
   ***********************************************************************

   Call:
    lm(formula = formula, data = data)

   Residuals:
    Min      1Q  Median      3Q     Max 
-3.8388 -2.4526 -0.6694  0.8773 23.0668 

   Coefficients:
                       Estimate Std. Error t value Pr(&gt;|t|)   
   (Intercept)        1.2277082  0.8772151   1.400  0.16182   
   IMD                0.0022343  0.0088457   0.253  0.80062   
   age0.11           -0.0311138  0.0307405  -1.012  0.31161   
   age25.34           0.0316351  0.0174764   1.810  0.07044 . 
   age50.59           0.1492102  0.0483997   3.083  0.00208 **
   carebeds           0.0009431  0.0014616   0.645  0.51886   
   poly(density, 2)1  8.4668105  5.2762201   1.605  0.10874   
   poly(density, 2)2 -5.6870143  3.6957704  -1.539  0.12404   

   ---Significance stars
   Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 
   Residual standard error: 3.542 on 1760 degrees of freedom
   Multiple R-squared: 0.007583
   Adjusted R-squared: 0.003636 
   F-statistic: 1.921 on 7 and 1760 DF,  p-value: 0.06261 
   ***Extra Diagnostic information
   Residual sum of squares: 22079.68
   Sigma(hat): 3.535908
   AIC:  9499.228
   AICc:  9499.331
   ***********************************************************************
   *    Results of Geographically and Temporally Weighted Regression     *
   ***********************************************************************

   *********************Model calibration information*********************
   Kernel function for geographically and temporally weighting: bisquare 
   Adaptive bandwidth for geographically and temporally  weighting: 606 (number of nearest neighbours)
   Regression points: the same locations as observations are used.
   Distance metric for geographically and temporally  weighting: A distance matrix is specified for this model calibration.

   ****************Summary of GTWR coefficient estimates:*****************
                              Min.       1st Qu.        Median       3rd Qu.
   Intercept          -7.467273452  -1.429007024  -0.431890521   0.188930147
   IMD                -0.060866478   0.000867536   0.006925644   0.016466529
   age0.11            -0.263923302  -0.041615611   0.007456504   0.032878161
   age25.34           -0.081155344   0.017377385   0.030977770   0.063555110
   age50.59           -0.284989530   0.110990723   0.159690984   0.238809884
   carebeds           -0.008797590   0.000070766   0.000863682   0.001820529
   poly(density, 2)1 -22.971393286   5.633766857  12.761674565  22.069777132
   poly(density, 2)2 -32.065614018  -8.663319026  -6.150064261  -3.539132987
                        Max.
   Intercept          6.5631
   IMD                0.0631
   age0.11            0.1432
   age25.34           0.2475
   age50.59           1.0677
   carebeds           0.0066
   poly(density, 2)1 94.7435
   poly(density, 2)2 38.3984
   ************************Diagnostic information*************************
   Number of data points: 1768 
   Effective number of parameters (2trace(S) - trace(S'S)): 57.81766 
   Effective degrees of freedom (n-2trace(S) + trace(S'S)): 1710.182 
   AICc (GWR book, Fotheringham, et al. 2002, p. 61, eq 2.33): 9304.009 
   AIC (GWR book, Fotheringham, et al. 2002,GWR p. 96, eq. 4.22): 9247.793 
   Residual sum of squares: 18798.49 
   R-square value:  0.1550625 
   Adjusted R-square value:  0.1264803 

   ***********************************************************************
   Program stops at: 2022-08-21 09:13:00.997402 </code></pre>
</div>
</div>
<p>They should be treated cautiously because the <code>Rate</code> value is strongly positively skewed such that it may have been better to have transformed it (e.g.&nbsp;taken its square root) prior to analysis. Even so, there is some evidence that the predictor <code>age0.11</code> variable, for example, varies spatially <em>and</em> temporally.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR <span class="ot">&lt;-</span> gtwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR[<span class="fu">abs</span>(gtwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span>_TV) <span class="sc">&lt;</span> <span class="fl">1.96</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> age0<span class="fl">.11</span>GWR)) <span class="sc">+</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> month) <span class="sc">+</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">na.value =</span> <span class="st">"white"</span>, <span class="at">trans =</span> <span class="st">"reverse"</span>) <span class="sc">+</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_colourbar</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="spregress_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="generalised-gwr-models-with-poisson-and-binomial-options" class="level3">
<h3 class="anchored" data-anchor-id="generalised-gwr-models-with-poisson-and-binomial-options">Generalised GWR models with Poisson and Binomial options</h3>
<p>See <code>?ggwr.basic</code>.</p>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this session we have looked at spatial regression models as a way to address the problem of spatial autocorrelation in regression residuals and to allow for the possibility that regression relationships vary across a map. In presenting these methods, at least some could be taken as offering a ‘technical fix’ to the statistical issue of spatial dependencies in the data, violating assumptions of independence. Whilst that may be true, and the more spatial approaches can be used as diagnostic tools to check for a mis-specified model, notably one that lacks a critical explanatory variable or where the relationship between the X and Y variables is non-linear, the limitation of this thinking is that it treats geography as an error to be resolved and/or it rests on the belief that with sufficient information the geographical differences will be explained. What geographically weighted regression, for example, reminds us is that the nature of the relationship may be complex because it is changing in form across the study region as the socio-spatial causes also vary from place to place. Such spatial complexity may be challenging to accommodate within the parameters of conventional aspatial or spatially naïve statistical thinking but ignoring the geographical variation is not a solution. What spatial thinking brings to the table is the recognition of geographical context and the knowledge that geographically rooted social outcomes are not independent of where the processes giving rise to those outcomes are taking place.</p>
</section>
<section id="further-reading" class="level2">
<h2 class="anchored" data-anchor-id="further-reading">Further Reading</h2>
<p><img src="spatial_regression.jpg" class="img-fluid" width="100"></p>
<p><a href="https://uk.sagepub.com/en-gb/eur/spatial-regression-models/book262155" target="_blank">Spatial Regression Models (2nd edition) by MD Ward &amp; KS Gleditsch (2018)</a></p>
<p>Comber et al.&nbsp;(2022) A Route Map for Successful Applications of Geographically Weighted Regression. <a href="https://doi.org/10.1111/gean.12316" target="_blank">https://doi.org/10.1111/gean.12316</a></p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./gwstats.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Geographically Weighted Statistics</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./multilevel.html" class="pagination-link">
        <span class="nav-page-text">Continuous and discrete views of the spatial variable</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb117" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Spatial Regression"</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="co">  fig-height: 7</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>installed <span class="ot">&lt;-</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>]</span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"remotes"</span>, <span class="st">"sf"</span>, <span class="st">"tidyverse"</span>, <span class="st">"ggplot2"</span>, <span class="st">"GWmodel"</span>, <span class="st">"car"</span>, <span class="st">"broom"</span>,</span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>              <span class="st">"spatialreg"</span>, <span class="st">"RANN"</span>, <span class="st">"gridExtra"</span>)</span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>install <span class="ot">&lt;-</span> pkgs[<span class="sc">!</span>(pkgs <span class="sc">%in%</span> installed)]</span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(install)) <span class="fu">install.packages</span>(install, <span class="at">dependencies =</span> <span class="cn">TRUE</span>, <span class="at">repos =</span> <span class="st">"https://cloud.r-project.org"</span>)</span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a>In the previous session we looked at geographically weighted statistics, including geographically weighted correlation, which examines whether the correlation -- and therefore the direction and/or the strength of the relationship -- between two variables varies across a map. In this session we extend from correlation to looking at regression modelling with a spatial component (spatial regression). The data we shall use are a map of the rate of COVID-19 infections per thousand population in neighbourhoods of the North West of England over the period from the week commencing 2020-03-07 to the week commencing 2022-04-16. That rate is calculated as the total number of reported infections per neighbourhood, divided by the <span class="co">[</span><span class="ot">mid-2020 ONS estimated population</span><span class="co">](https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/middlesuperoutputareamidyearpopulationestimates)</span>{target="blank"}.</span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a>There are three problems with these data, which originate (prior to adjustment) from <span class="co">[</span><span class="ot">https://coronavirus.data.gov.uk/details/download</span><span class="co">](https://coronavirus.data.gov.uk/details/download)</span>{target="_blank"}:</span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>The rate, as calculated, does not allow for re-infection (i.e. the same person can catch COVID-19 more than once).</span>
<span id="cb117-27"><a href="#cb117-27" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Not everyone who had COVID was tested for a positive diagnosis. Limitations in the testing regime are described in <span class="co">[</span><span class="ot">this paper</span><span class="co">](https://link.springer.com/article/10.1007/s12061-021-09400-8)</span>{target="_blank"} and are most severe earlier in the pandemic and again towards the end of the data period when testing was scaled-back and then largely withdrawn.</span>
<span id="cb117-28"><a href="#cb117-28" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>For data protection reasons, where a neighbourhood had less than three cases in a week, that number was reported as zero even though it could really be one or two. This undercount adds up, although, unsurprisingly it affects the largest cities most (because they have more neighbourhoods to be undercounted) in weeks when COVID is not especially prevalent (because in other weeks there are more often more than two cases per neighbourhoods). An adjustment has been made to the data to allow for this censoring of the data but not for the undercount caused by not testing positive.</span>
<span id="cb117-29"><a href="#cb117-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-30"><a href="#cb117-30" aria-hidden="true" tabindex="-1"></a>Despite their shortcomings, the data are sufficient to illustrate the methods, below.</span>
<span id="cb117-31"><a href="#cb117-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-32"><a href="#cb117-32" aria-hidden="true" tabindex="-1"></a><span class="fu">## Getting Started</span></span>
<span id="cb117-33"><a href="#cb117-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-34"><a href="#cb117-34" aria-hidden="true" tabindex="-1"></a>The data are downloaded as follows. The required packages should be installed already, from previous sessions. As before, you may wish to begin by opening the R Project that you created for these classes.</span>
<span id="cb117-35"><a href="#cb117-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-38"><a href="#cb117-38" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-39"><a href="#cb117-39" aria-hidden="true" tabindex="-1"></a>installed <span class="ot">&lt;-</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>]</span>
<span id="cb117-40"><a href="#cb117-40" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sf"</span>, <span class="st">"tidyverse"</span>, <span class="st">"ggplot2"</span>, <span class="st">"spdep"</span>, <span class="st">"GWmodel"</span>)</span>
<span id="cb117-41"><a href="#cb117-41" aria-hidden="true" tabindex="-1"></a>install <span class="ot">&lt;-</span> pkgs[<span class="sc">!</span>(pkgs <span class="sc">%in%</span> installed)]</span>
<span id="cb117-42"><a href="#cb117-42" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(install)) <span class="fu">install.packages</span>(install, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-43"><a href="#cb117-43" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"ggsflabel"</span> <span class="sc">%in%</span> installed)) remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"yutannihilation/ggsflabel"</span>)</span>
<span id="cb117-44"><a href="#cb117-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-45"><a href="#cb117-45" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(sf)</span>
<span id="cb117-46"><a href="#cb117-46" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb117-47"><a href="#cb117-47" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggplot2)</span>
<span id="cb117-48"><a href="#cb117-48" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggsflabel)</span>
<span id="cb117-49"><a href="#cb117-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-50"><a href="#cb117-50" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"covid.geojson"</span>)) <span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/data/covid.geojson"</span>,</span>
<span id="cb117-51"><a href="#cb117-51" aria-hidden="true" tabindex="-1"></a><span class="st">"covid.geojson"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-52"><a href="#cb117-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-53"><a href="#cb117-53" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(<span class="st">"covid.geojson"</span>) <span class="sc">|&gt;</span></span>
<span id="cb117-54"><a href="#cb117-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(regionName <span class="sc">==</span> <span class="st">"North West"</span>) <span class="ot">-&gt;</span></span>
<span id="cb117-55"><a href="#cb117-55" aria-hidden="true" tabindex="-1"></a>  covid</span>
<span id="cb117-56"><a href="#cb117-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-57"><a href="#cb117-57" aria-hidden="true" tabindex="-1"></a><span class="co"># The step below is just to reformat some of the names of the data variables,</span></span>
<span id="cb117-58"><a href="#cb117-58" aria-hidden="true" tabindex="-1"></a><span class="co"># replacing age0-11 with age0.11, age12_17 with age 12.17, and so forth.</span></span>
<span id="cb117-59"><a href="#cb117-59" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(covid) <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"-"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">."</span>, <span class="fu">names</span>(covid))</span>
<span id="cb117-60"><a href="#cb117-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-61"><a href="#cb117-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-62"><a href="#cb117-62" aria-hidden="true" tabindex="-1"></a>Looking at a map of the COVID-19 rates, it appears that there are patches of higher rates that tend to cluster in cities such as Preston, Manchester and Liverpool, although not exclusively so.</span>
<span id="cb117-63"><a href="#cb117-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-64"><a href="#cb117-64" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width=75}</span>
<span id="cb117-65"><a href="#cb117-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-66"><a href="#cb117-66" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;font</span> <span class="er">size</span> <span class="ot">=</span> <span class="st">3</span><span class="kw">&gt;</span>Don't forget that you can, if you wish, use the <span class="in">`cols4all`</span> and it's functions, e.g. <span class="in">`scale_fill_continuous_c4a_seq()`</span> instead of <span class="in">`scale_fill_distiller()`</span> in the code chunk below.<span class="kw">&lt;/font&gt;</span></span>
<span id="cb117-67"><a href="#cb117-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-70"><a href="#cb117-70" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-71"><a href="#cb117-71" aria-hidden="true" tabindex="-1"></a>covid <span class="sc">|&gt;</span></span>
<span id="cb117-72"><a href="#cb117-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Rate <span class="sc">&gt;</span> <span class="dv">400</span>) <span class="sc">|&gt;</span></span>
<span id="cb117-73"><a href="#cb117-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(LtlaName) <span class="sc">|&gt;</span>   <span class="co"># LtlaName is the name of the local authority</span></span>
<span id="cb117-74"><a href="#cb117-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(LtlaName)) <span class="ot">-&gt;</span></span>
<span id="cb117-75"><a href="#cb117-75" aria-hidden="true" tabindex="-1"></a>  high_rate</span>
<span id="cb117-76"><a href="#cb117-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-77"><a href="#cb117-77" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb117-78"><a href="#cb117-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> covid, <span class="fu">aes</span>(<span class="at">fill =</span> Rate), <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb117-79"><a href="#cb117-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"YlOrRd"</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb117-80"><a href="#cb117-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_label_repel</span>(<span class="at">data =</span> high_rate, <span class="fu">aes</span>(<span class="at">label =</span> LtlaName), <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb117-81"><a href="#cb117-81" aria-hidden="true" tabindex="-1"></a>                      <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb117-82"><a href="#cb117-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb117-83"><a href="#cb117-83" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-84"><a href="#cb117-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-85"><a href="#cb117-85" aria-hidden="true" tabindex="-1"></a>... and with variation within the cities such as Manchester:</span>
<span id="cb117-86"><a href="#cb117-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-89"><a href="#cb117-89" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-90"><a href="#cb117-90" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> covid <span class="sc">|&gt;</span> <span class="fu">filter</span>(LtlaName <span class="sc">==</span> <span class="st">"Manchester"</span>)) <span class="sc">+</span></span>
<span id="cb117-91"><a href="#cb117-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Rate), <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb117-92"><a href="#cb117-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"YlOrRd"</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb117-93"><a href="#cb117-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb117-94"><a href="#cb117-94" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-95"><a href="#cb117-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-96"><a href="#cb117-96" aria-hidden="true" tabindex="-1"></a>Across the map there appears to be a pattern of positive spatial autocorrelation in the COVID-19 rates of contiguous neighbours ('hot spots'), as evident using a Moran test,</span>
<span id="cb117-97"><a href="#cb117-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-100"><a href="#cb117-100" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-101"><a href="#cb117-101" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(spdep)</span>
<span id="cb117-102"><a href="#cb117-102" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(<span class="fu">poly2nb</span>(covid, <span class="at">snap =</span> <span class="dv">1</span>))</span>
<span id="cb117-103"><a href="#cb117-103" aria-hidden="true" tabindex="-1"></a><span class="fu">moran.test</span>(covid<span class="sc">$</span>Rate, spweight)</span>
<span id="cb117-104"><a href="#cb117-104" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-105"><a href="#cb117-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-106"><a href="#cb117-106" aria-hidden="true" tabindex="-1"></a>Some of the 'hot spots' of infection are suggested using the geographically-weighted means,</span>
<span id="cb117-107"><a href="#cb117-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-110"><a href="#cb117-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-111"><a href="#cb117-111" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: false</span></span>
<span id="cb117-112"><a href="#cb117-112" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(GWmodel)</span>
<span id="cb117-113"><a href="#cb117-113" aria-hidden="true" tabindex="-1"></a>covid_sp <span class="ot">&lt;-</span> <span class="fu">as_Spatial</span>(covid)</span>
<span id="cb117-114"><a href="#cb117-114" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(Rate <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> covid_sp,</span>
<span id="cb117-115"><a href="#cb117-115" aria-hidden="true" tabindex="-1"></a>             <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>, <span class="at">longlat =</span> F)</span>
<span id="cb117-116"><a href="#cb117-116" aria-hidden="true" tabindex="-1"></a>gwstats <span class="ot">&lt;-</span> <span class="fu">gwss</span>(covid_sp, <span class="at">vars =</span> <span class="st">"Rate"</span>, <span class="at">bw =</span> bw, <span class="at">kernel =</span> <span class="st">"bisquare"</span>,</span>
<span id="cb117-117"><a href="#cb117-117" aria-hidden="true" tabindex="-1"></a>                <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">longlat =</span> F)</span>
<span id="cb117-118"><a href="#cb117-118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-119"><a href="#cb117-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-120"><a href="#cb117-120" aria-hidden="true" tabindex="-1"></a>Plotting these,</span>
<span id="cb117-121"><a href="#cb117-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-124"><a href="#cb117-124" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-125"><a href="#cb117-125" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>Rate_LM <span class="ot">&lt;-</span> gwstats<span class="sc">$</span>SDF<span class="sc">$</span>Rate_LM</span>
<span id="cb117-126"><a href="#cb117-126" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> Rate_LM)) <span class="sc">+</span></span>
<span id="cb117-127"><a href="#cb117-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb117-128"><a href="#cb117-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"YlOrRd"</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb117-129"><a href="#cb117-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb117-130"><a href="#cb117-130" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-131"><a href="#cb117-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-132"><a href="#cb117-132" aria-hidden="true" tabindex="-1"></a>They also are suggested using the G-statistic with a somewhat arbitrary bandwidth of 5km.</span>
<span id="cb117-133"><a href="#cb117-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-136"><a href="#cb117-136" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-137"><a href="#cb117-137" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(covid, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-138"><a href="#cb117-138" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">5000</span>)</span>
<span id="cb117-139"><a href="#cb117-139" aria-hidden="true" tabindex="-1"></a>spweightB <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-140"><a href="#cb117-140" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(covid<span class="sc">$</span>Rate, spweightB)</span>
<span id="cb117-141"><a href="#cb117-141" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(covid<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb117-142"><a href="#cb117-142" aria-hidden="true" tabindex="-1"></a>          <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb117-143"><a href="#cb117-143" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(covid<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb117-144"><a href="#cb117-144" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(covid<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-145"><a href="#cb117-145" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>,</span>
<span id="cb117-146"><a href="#cb117-146" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb117-147"><a href="#cb117-147" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp)) <span class="sc">+</span></span>
<span id="cb117-148"><a href="#cb117-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb117-149"><a href="#cb117-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"G"</span>, <span class="at">values =</span> pal, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb117-150"><a href="#cb117-150" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb117-151"><a href="#cb117-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb117-152"><a href="#cb117-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb117-153"><a href="#cb117-153" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-154"><a href="#cb117-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-155"><a href="#cb117-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-156"><a href="#cb117-156" aria-hidden="true" tabindex="-1"></a><span class="fu">## An initial model to explain the spatial patterns in the COVID-19 rates</span></span>
<span id="cb117-157"><a href="#cb117-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-158"><a href="#cb117-158" aria-hidden="true" tabindex="-1"></a>It is likely that the spatial variation in the COVID-19 rates is due to differences in the physical attributes of the different neighbourhoods and/or of the populations who live in them. For example, the rates may be related to the relative level of deprivation in the neighbourhoods (the <span class="co">[</span><span class="ot">Index of Multiple Deprivation</span><span class="co">](https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019)</span>{target="_blank"}, <span class="in">`IMD`</span>), the age composition of their populations (e.g. percentage aged 0 to 11, <span class="in">`age0.11`</span>), the population density (<span class="in">`density`</span>), the number of carehome beds (<span class="in">`carebeds`</span>, because particularly early on in the pandemic, carehome residents were at very high risk), and whether they contain an Accident and Emergency hospital (<span class="in">`AandE`</span>, coded 1 if they do and 0 if they don't). Incorporating this into a standard regression model gives, </span>
<span id="cb117-159"><a href="#cb117-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-162"><a href="#cb117-162" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-163"><a href="#cb117-163" aria-hidden="true" tabindex="-1"></a>ols1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(Rate <span class="sc">~</span> IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age12<span class="fl">.17</span> <span class="sc">+</span> age18<span class="fl">.24</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age35<span class="fl">.39</span> <span class="sc">+</span> </span>
<span id="cb117-164"><a href="#cb117-164" aria-hidden="true" tabindex="-1"></a>             age50<span class="fl">.59</span> <span class="sc">+</span> age60<span class="fl">.69</span> <span class="sc">+</span> age70plus <span class="sc">+</span> density <span class="sc">+</span></span>
<span id="cb117-165"><a href="#cb117-165" aria-hidden="true" tabindex="-1"></a>             carebeds <span class="sc">+</span> AandE, <span class="at">data =</span> covid)</span>
<span id="cb117-166"><a href="#cb117-166" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ols1)</span>
<span id="cb117-167"><a href="#cb117-167" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-168"><a href="#cb117-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-169"><a href="#cb117-169" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/br&gt;</span></span>
<span id="cb117-170"><a href="#cb117-170" aria-hidden="true" tabindex="-1"></a>which, as its R-squared value of <span class="in">`r round(summary(ols1)$r.squared, 3)`</span> suggests, goes some way to explaining the variation in the rates. Note that you can tidier output for some models using tidyvere's <span class="co">[</span><span class="ot">broom</span><span class="co">](https://broom.tidymodels.org/)</span>{target="_blank"} package and functions.</span>
<span id="cb117-171"><a href="#cb117-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-174"><a href="#cb117-174" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-175"><a href="#cb117-175" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(broom)</span>
<span id="cb117-176"><a href="#cb117-176" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ols1)</span>
<span id="cb117-177"><a href="#cb117-177" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(ols1)</span>
<span id="cb117-178"><a href="#cb117-178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-179"><a href="#cb117-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-180"><a href="#cb117-180" aria-hidden="true" tabindex="-1"></a>Looking at R's standard diagnostic plots there is not any strong evidence that the standard ]residual Normality assumption](https://thestatsgeek.com/2013/08/07/assumptions-for-linear-regression/){target="_blank"} of the regression statistics is being violated although, not very surprisingly, the variance inflation values (VIF) do suggest [high levels of colinearity](https://www.britannica.com/topic/collinearity-statistics){target="_blank"} between the age variables.</span>
<span id="cb117-181"><a href="#cb117-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-184"><a href="#cb117-184" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-185"><a href="#cb117-185" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb117-186"><a href="#cb117-186" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ols1)</span>
<span id="cb117-187"><a href="#cb117-187" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"car"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) <span class="fu">install.packages</span>(<span class="st">"car"</span>)</span>
<span id="cb117-188"><a href="#cb117-188" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(car)</span>
<span id="cb117-189"><a href="#cb117-189" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(ols1)</span>
<span id="cb117-190"><a href="#cb117-190" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-191"><a href="#cb117-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-192"><a href="#cb117-192" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width=75}</span>
<span id="cb117-193"><a href="#cb117-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-194"><a href="#cb117-194" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;font</span> <span class="er">size</span> <span class="ot">=</span> <span class="st">3</span><span class="kw">&gt;</span>There are no hard and fast rules but, in broad terms, a VIF value of 4 or 5 or above is worth considering as a potential issue and a value above 10 suggests a very high level of multicollinearity. The simple solution to the issue is to drop some of the colinear variables but not all: if X1 and X2 are highly correlated, you only need to consider dropping X1 or X2, not both.<span class="kw">&lt;/font&gt;</span></span>
<span id="cb117-195"><a href="#cb117-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-196"><a href="#cb117-196" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/br&gt;</span></span>
<span id="cb117-197"><a href="#cb117-197" aria-hidden="true" tabindex="-1"></a>Although I am generally cautious about automated selection procedures, in this case a stepwise model selection appears useful to address the colinearity:</span>
<span id="cb117-198"><a href="#cb117-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-201"><a href="#cb117-201" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-202"><a href="#cb117-202" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: false</span></span>
<span id="cb117-203"><a href="#cb117-203" aria-hidden="true" tabindex="-1"></a>ols2 <span class="ot">&lt;-</span> <span class="fu">step</span>(ols1)</span>
<span id="cb117-204"><a href="#cb117-204" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-205"><a href="#cb117-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-206"><a href="#cb117-206" aria-hidden="true" tabindex="-1"></a>The results are,</span>
<span id="cb117-207"><a href="#cb117-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-210"><a href="#cb117-210" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-211"><a href="#cb117-211" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ols2)</span>
<span id="cb117-212"><a href="#cb117-212" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(ols2)</span>
<span id="cb117-213"><a href="#cb117-213" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(ols2)</span>
<span id="cb117-214"><a href="#cb117-214" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-215"><a href="#cb117-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-216"><a href="#cb117-216" aria-hidden="true" tabindex="-1"></a>An analysis of variance (ANOVA) shows there is no statistically gain in using the model with more variables (<span class="in">`ols1`</span>) so we can prefer the simpler (<span class="in">`ols2`</span>).</span>
<span id="cb117-217"><a href="#cb117-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-220"><a href="#cb117-220" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-221"><a href="#cb117-221" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(ols2, ols1)</span>
<span id="cb117-222"><a href="#cb117-222" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-223"><a href="#cb117-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-224"><a href="#cb117-224" aria-hidden="true" tabindex="-1"></a>Looking again at the model (<span class="in">`tidy(ols2)`</span>), it may seem surprising that the deprivation index is negatively correlated with the COVID rate -- implying more deprivation, fewer infections (geographies of health often work in the opposite direction; being poorer can come with a 'health premium') -- but this is due to the later variants of the disease that spread quickly through more affluent populations when restrictions on mobility and social interaction have been relaxed.</span>
<span id="cb117-225"><a href="#cb117-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-226"><a href="#cb117-226" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial dependencies in the model residuals</span></span>
<span id="cb117-227"><a href="#cb117-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-228"><a href="#cb117-228" aria-hidden="true" tabindex="-1"></a>Although the model appears to fit the data reasonably well, there is a problem. The residuals -- the differences between what the model predicts as the COVID-19 rate at each location and what those rates actually are -- are supposed to be random noise, meaning their values should be independent of their location and of each other, with no spatial structure. They are not. In fact, if we apply a Moran's test to the residuals, using the test for regression residuals, <span class="in">`lm.morantest()`</span>, we find that they are significantly spatially correlated:</span>
<span id="cb117-229"><a href="#cb117-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-232"><a href="#cb117-232" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-233"><a href="#cb117-233" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(ols2, spweight)</span>
<span id="cb117-234"><a href="#cb117-234" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-235"><a href="#cb117-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-236"><a href="#cb117-236" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/br&gt;</span></span>
<span id="cb117-237"><a href="#cb117-237" aria-hidden="true" tabindex="-1"></a>The pattern is evident if we map the <span class="co">[</span><span class="ot">standardised residuals</span><span class="co">](https://www.statology.org/standardized-residuals)</span>{target="_blank"} from the function <span class="in">`rstandard()`</span>. At the risk of geographic over-simplification, there is something of a north-south divide, with a patch of negative residuals to the north of the study region. These are rural neighbouhoods where the model is under-predicting the rate of COVID-19 cases.</span>
<span id="cb117-238"><a href="#cb117-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-241"><a href="#cb117-241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-242"><a href="#cb117-242" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids <span class="ot">&lt;-</span> <span class="fu">rstandard</span>(ols2)</span>
<span id="cb117-243"><a href="#cb117-243" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(covid<span class="sc">$</span>resids), <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb117-244"><a href="#cb117-244" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(covid<span class="sc">$</span>resids))</span>
<span id="cb117-245"><a href="#cb117-245" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(covid<span class="sc">$</span>resids, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-246"><a href="#cb117-246" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb117-247"><a href="#cb117-247" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> resids_gp)) <span class="sc">+</span></span>
<span id="cb117-248"><a href="#cb117-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb117-249"><a href="#cb117-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"Standardised residual"</span>, <span class="at">values =</span> pal) <span class="sc">+</span></span>
<span id="cb117-250"><a href="#cb117-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb117-251"><a href="#cb117-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb117-252"><a href="#cb117-252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-253"><a href="#cb117-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-254"><a href="#cb117-254" aria-hidden="true" tabindex="-1"></a><span class="fu">### Looking again at the model</span></span>
<span id="cb117-255"><a href="#cb117-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-256"><a href="#cb117-256" aria-hidden="true" tabindex="-1"></a>It is possible that the spatial structure in the residuals exists because the model has been mis-specified. In particular, we might wonder if it was a mistake to drop the population density variable which perhaps had a polynomial (non-linear) relationship with the COVID rates. Let's find out.</span>
<span id="cb117-257"><a href="#cb117-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-260"><a href="#cb117-260" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-261"><a href="#cb117-261" aria-hidden="true" tabindex="-1"></a>ols3 <span class="ot">&lt;-</span> <span class="fu">update</span>(ols2, . <span class="sc">~</span> . <span class="sc">+</span> <span class="fu">poly</span>(density, <span class="dv">2</span>))</span>
<span id="cb117-262"><a href="#cb117-262" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-263"><a href="#cb117-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-264"><a href="#cb117-264" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/br&gt;</span></span>
<span id="cb117-265"><a href="#cb117-265" aria-hidden="true" tabindex="-1"></a>Certainly, of the three models, this is the best fit to the data, as we can see from the various model fit diagnostics that are easily gathered together using the <span class="in">`glance()`</span> function. Note the *highest*, adjusted r-squared value and *lowest* AIC value, for example. </span>
<span id="cb117-266"><a href="#cb117-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-269"><a href="#cb117-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-270"><a href="#cb117-270" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">glance</span>(ols1), <span class="fu">glance</span>(ols2), <span class="fu">glance</span>(ols3))</span>
<span id="cb117-271"><a href="#cb117-271" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-272"><a href="#cb117-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-273"><a href="#cb117-273" aria-hidden="true" tabindex="-1"></a>An analysis of variance also suggests that the model fit has improved significantly.</span>
<span id="cb117-274"><a href="#cb117-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-277"><a href="#cb117-277" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-278"><a href="#cb117-278" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(ols2, ols3)</span>
<span id="cb117-279"><a href="#cb117-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-280"><a href="#cb117-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-281"><a href="#cb117-281" aria-hidden="true" tabindex="-1"></a>However, there is still spatial autocorrelation left in the model residuals, albeit slightly reduced from before.</span>
<span id="cb117-282"><a href="#cb117-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-285"><a href="#cb117-285" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-286"><a href="#cb117-286" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(ols2, spweight)<span class="sc">$</span>estimate</span>
<span id="cb117-287"><a href="#cb117-287" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(ols3, spweight)<span class="sc">$</span>estimate</span>
<span id="cb117-288"><a href="#cb117-288" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-289"><a href="#cb117-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-290"><a href="#cb117-290" aria-hidden="true" tabindex="-1"></a>The map of the residuals now looks like:</span>
<span id="cb117-291"><a href="#cb117-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-294"><a href="#cb117-294" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-295"><a href="#cb117-295" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids <span class="ot">&lt;-</span> <span class="fu">rstandard</span>(ols3)</span>
<span id="cb117-296"><a href="#cb117-296" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(covid<span class="sc">$</span>resids), <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb117-297"><a href="#cb117-297" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(covid<span class="sc">$</span>resids))</span>
<span id="cb117-298"><a href="#cb117-298" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>resids_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(covid<span class="sc">$</span>resids, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-299"><a href="#cb117-299" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb117-300"><a href="#cb117-300" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> resids_gp)) <span class="sc">+</span></span>
<span id="cb117-301"><a href="#cb117-301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb117-302"><a href="#cb117-302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"Standardised residual"</span>, <span class="at">values =</span> pal) <span class="sc">+</span></span>
<span id="cb117-303"><a href="#cb117-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb117-304"><a href="#cb117-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb117-305"><a href="#cb117-305" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-306"><a href="#cb117-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-307"><a href="#cb117-307" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial regression models</span></span>
<span id="cb117-308"><a href="#cb117-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-309"><a href="#cb117-309" aria-hidden="true" tabindex="-1"></a><span class="fu">### Spatial error model</span></span>
<span id="cb117-310"><a href="#cb117-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-311"><a href="#cb117-311" aria-hidden="true" tabindex="-1"></a>One way to handle the error structure is to fit a spatial simultaneous autoregressive error model which decomposes the error (the residuals) into two parts: a spatially lagged component (the bit that allows for geographical clustering in the residuals) and a remaining error: $y = X\beta + \lambda W \xi + \epsilon$. The model can be fitted using R's <span class="in">`spatialreg`</span> package.</span>
<span id="cb117-312"><a href="#cb117-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-315"><a href="#cb117-315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-316"><a href="#cb117-316" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"spatialreg"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) <span class="fu">install.packages</span>(<span class="st">"spatialreg"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-317"><a href="#cb117-317" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(spatialreg)</span>
<span id="cb117-318"><a href="#cb117-318" aria-hidden="true" tabindex="-1"></a>errmod <span class="ot">&lt;-</span> <span class="fu">errorsarlm</span>(<span class="fu">formula</span>(ols3), <span class="at">data =</span> covid, <span class="at">listw =</span> spweight)</span>
<span id="cb117-319"><a href="#cb117-319" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(errmod)</span>
<span id="cb117-320"><a href="#cb117-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-321"><a href="#cb117-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-322"><a href="#cb117-322" aria-hidden="true" tabindex="-1"></a>The spatial component, $\lambda$, the spatial autocorrelation in the residuals, is significant as a number of test statistics that are with it in the summary above show. What it confirms is what we could interpret from the earlier Moran's test of the regression residuals: having allowed for the variables that help to predict the COVID-rates there is still an unexplained geographic pattern whereby places for which the model over-predict the rate tend to be surrounded by other places where it does the same, and places where it under-predicts are surrounded by other under-predictions. The spatial error model gives a better fit to the data than the standard regression, as the following diagnostics tell us (the lower the AIC the better)</span>
<span id="cb117-323"><a href="#cb117-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-326"><a href="#cb117-326" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-327"><a href="#cb117-327" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(ols3)<span class="sc">$</span>r.squared</span>
<span id="cb117-328"><a href="#cb117-328" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(errmod)<span class="sc">$</span>r.squared</span>
<span id="cb117-329"><a href="#cb117-329" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(ols3)</span>
<span id="cb117-330"><a href="#cb117-330" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(errmod)</span>
<span id="cb117-331"><a href="#cb117-331" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-332"><a href="#cb117-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-333"><a href="#cb117-333" aria-hidden="true" tabindex="-1"></a>The differences are such that there is little doubt that the error model offers a much improved fit but if we do wish to test that difference statistically then</span>
<span id="cb117-334"><a href="#cb117-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-337"><a href="#cb117-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-338"><a href="#cb117-338" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(ols3)</span>
<span id="cb117-339"><a href="#cb117-339" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(errmod)</span>
<span id="cb117-340"><a href="#cb117-340" aria-hidden="true" tabindex="-1"></a>degf <span class="ot">&lt;-</span> <span class="fu">attr</span>(<span class="fu">logLik</span>(errmod), <span class="st">"df"</span>) <span class="sc">-</span> <span class="fu">attr</span>(<span class="fu">logLik</span>(ols3), <span class="st">"df"</span>)</span>
<span id="cb117-341"><a href="#cb117-341" aria-hidden="true" tabindex="-1"></a>LR <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> (<span class="fu">logLik</span>(ols3) <span class="sc">-</span> <span class="fu">logLik</span>(errmod))</span>
<span id="cb117-342"><a href="#cb117-342" aria-hidden="true" tabindex="-1"></a>LR <span class="sc">&gt;</span> <span class="fu">qchisq</span>(<span class="fl">0.99</span>, degf)</span>
<span id="cb117-343"><a href="#cb117-343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-344"><a href="#cb117-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-345"><a href="#cb117-345" aria-hidden="true" tabindex="-1"></a>Using the error model changes the estimates of the regression coefficients.</span>
<span id="cb117-346"><a href="#cb117-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-349"><a href="#cb117-349" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-350"><a href="#cb117-350" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ols3)</span>
<span id="cb117-351"><a href="#cb117-351" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(errmod)</span>
<span id="cb117-352"><a href="#cb117-352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-353"><a href="#cb117-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-354"><a href="#cb117-354" aria-hidden="true" tabindex="-1"></a>For example, where the estimate for <span class="in">`age50.59`</span>, which is the estimate of the effect size, used to be <span class="in">`r round(ols3$coefficients[6],2)`</span>, now it is  <span class="in">`r round(errmod$coefficients[6],2)`</span>. The 95% confidence intervals for those and the other coefficient estimates change too:</span>
<span id="cb117-355"><a href="#cb117-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-358"><a href="#cb117-358" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-359"><a href="#cb117-359" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(ols3)</span>
<span id="cb117-360"><a href="#cb117-360" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(errmod)</span>
<span id="cb117-361"><a href="#cb117-361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-362"><a href="#cb117-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-363"><a href="#cb117-363" aria-hidden="true" tabindex="-1"></a><span class="fu">### Spatially lagged y model</span></span>
<span id="cb117-364"><a href="#cb117-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-365"><a href="#cb117-365" aria-hidden="true" tabindex="-1"></a>Although the spatial error model fits the data better than the standard regression model, it tells us only that there is an unexplained spatial structure to the residuals, not what caused it. It may offer better estimates of the model parameters and their statistical significance but it does not presuppose any particular spatial process generating the patterns in the values. A different model that explicitly tests for whether the value at a location is functionally dependent on the values of neighbouring location is the spatially lagged y model: $y = \rho Wy + X\beta + \epsilon$. It models an ‘overspill’ or chain effect where the outcome (the Y value) at any location is affected by the outcomes at surrounding locations.</span>
<span id="cb117-366"><a href="#cb117-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-369"><a href="#cb117-369" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-370"><a href="#cb117-370" aria-hidden="true" tabindex="-1"></a>lagmod <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(<span class="fu">formula</span>(ols3), <span class="at">data =</span> covid, <span class="at">listw =</span> spweight)</span>
<span id="cb117-371"><a href="#cb117-371" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lagmod)</span>
<span id="cb117-372"><a href="#cb117-372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-373"><a href="#cb117-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-374"><a href="#cb117-374" aria-hidden="true" tabindex="-1"></a>Its test for residual autocorrelation does not generate a statistically significant result at a 95% level, meaning there is no statistically significant spatial structure now left in the residuals, although it is close. </span>
<span id="cb117-375"><a href="#cb117-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-376"><a href="#cb117-376" aria-hidden="true" tabindex="-1"></a>Note that the beta estimates of the lagged y-model cannot be interpreted in the same way as for a standard regression model. For example, the beta estimate of <span class="in">`r round(lagmod$coefficients[2],3)`</span> for the <span class="in">`IMD`</span> variable does not mean that if (hypothetically) we increased that variable by one unit at each location we should then expect the COVID-19 to everywhere decrease by <span class="in">`r abs(round(lagmod$coefficients[2],3))`</span> holding the other X variables constant. That is the correct interpretation for a standard (OLS) regression model and also for the spatial error model but not for where the lag of the Y variable is included as a predictor variable. The reason is because if we did raise the <span class="in">`IMD`</span> value it would start something akin to a ‘chain reaction’ through the feedback of Y via the lagged Y values: the (hypothetical) increase in deprivation at the one location, decreases the COVID-19 rate at neighbouring locations, which decrease the rate at their neighbours and so forth. The total impact is a sum of the direct effect – that predicted to happen through the 1 unit change in <span class="in">`IMD`</span> – and the indirect effect, which is that caused by ‘the chain reaction’ / feedback / ‘overspill’ in the system:</span>
<span id="cb117-377"><a href="#cb117-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-378"><a href="#cb117-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-381"><a href="#cb117-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-382"><a href="#cb117-382" aria-hidden="true" tabindex="-1"></a><span class="fu">impacts</span>(lagmod, <span class="at">listw =</span> spweight)</span>
<span id="cb117-383"><a href="#cb117-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-384"><a href="#cb117-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-385"><a href="#cb117-385" aria-hidden="true" tabindex="-1"></a>Although it wasn't especially noticeable, there was a short pause as those impacts were calculated. The calculations could take much longer if the size of the spatial weights matrix was larger. As <span class="co">[</span><span class="ot">this author</span><span class="co">](https://maczokni.github.io/crime_mapping_textbook/spatial-regression-models.html#fitting-and-interpreting-a-spatially-lagged-model)</span>{target="_blank"} notes, after [Lesage and Pace, 2009](https://www.routledge.com/Introduction-to-Spatial-Econometrics/LeSage-Pace/p/book/9781420064247){target="_blank"}, a faster approximation method can be used, here with <span class="in">`R = 1000`</span> simulated distributions for the impact measures.</span>
<span id="cb117-386"><a href="#cb117-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-389"><a href="#cb117-389" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-390"><a href="#cb117-390" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">as</span>(spweight, <span class="st">"CsparseMatrix"</span>)</span>
<span id="cb117-391"><a href="#cb117-391" aria-hidden="true" tabindex="-1"></a>trMC <span class="ot">&lt;-</span> <span class="fu">trW</span>(W, <span class="at">type =</span> <span class="st">"MC"</span>)</span>
<span id="cb117-392"><a href="#cb117-392" aria-hidden="true" tabindex="-1"></a>im <span class="ot">&lt;-</span><span class="fu">summary</span>(<span class="fu">impacts</span>(lagmod, <span class="at">tr =</span> trMC, <span class="at">R =</span> <span class="dv">1000</span>), <span class="at">zstats =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-393"><a href="#cb117-393" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(im<span class="sc">$</span>res, <span class="at">row.names =</span> <span class="fu">names</span>(lagmod<span class="sc">$</span>coefficients)[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb117-394"><a href="#cb117-394" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># The [-1] is to omit the intercept</span></span>
<span id="cb117-395"><a href="#cb117-395" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-396"><a href="#cb117-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-397"><a href="#cb117-397" aria-hidden="true" tabindex="-1"></a>An advantage of this approach is that we can also obtain z and p-values for the impact measures; i.e. measures of statistical significance.</span>
<span id="cb117-398"><a href="#cb117-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-401"><a href="#cb117-401" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-402"><a href="#cb117-402" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(im<span class="sc">$</span>zmat, <span class="at">row.names =</span> <span class="fu">names</span>(lagmod<span class="sc">$</span>coefficients)[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb117-403"><a href="#cb117-403" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(im<span class="sc">$</span>pzmat, <span class="at">row.names =</span> <span class="fu">names</span>(lagmod<span class="sc">$</span>coefficients)[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb117-404"><a href="#cb117-404" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-405"><a href="#cb117-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-406"><a href="#cb117-406" aria-hidden="true" tabindex="-1"></a>Most but not all of the impacts are significant at, say, a 95% confidence (i.e p &lt; 0.05). We can drop <span class="in">`age35.39`</span> from the model with little loss of fit.</span>
<span id="cb117-407"><a href="#cb117-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-410"><a href="#cb117-410" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-411"><a href="#cb117-411" aria-hidden="true" tabindex="-1"></a>lagmod2 <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(Rate <span class="sc">~</span>  IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span> carebeds <span class="sc">+</span> </span>
<span id="cb117-412"><a href="#cb117-412" aria-hidden="true" tabindex="-1"></a>    <span class="fu">poly</span>(density, <span class="dv">2</span>), <span class="at">data =</span> covid, <span class="at">listw =</span> spweight)</span>
<span id="cb117-413"><a href="#cb117-413" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(lagmod, lagmod2)</span>
<span id="cb117-414"><a href="#cb117-414" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">glance</span>(lagmod), <span class="fu">glance</span>(lagmod2))</span>
<span id="cb117-415"><a href="#cb117-415" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-416"><a href="#cb117-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-417"><a href="#cb117-417" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/br&gt;</span></span>
<span id="cb117-418"><a href="#cb117-418" aria-hidden="true" tabindex="-1"></a>In fact, an increase of 1 unit in, for example, the <span class="in">`IMD`</span> variable, will play out slightly differently in different places because they have different neighbours with different Y values and are at different distances from each other. The code below, which is from the first edition of <span class="co">[</span><span class="ot">Ward &amp; Gleditsch (2008, pp.47)</span><span class="co">](https://uk.sagepub.com/en-gb/eur/spatial-regression-models/book262155)</span>{target="_blank"}, will calculate the impact (of a one unit change in <span class="in">`IMD`</span>) at each location but below I have limited it to the first ten so that it doesn't take too long to run.</span>
<span id="cb117-419"><a href="#cb117-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-422"><a href="#cb117-422" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-423"><a href="#cb117-423" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(covid)</span>
<span id="cb117-424"><a href="#cb117-424" aria-hidden="true" tabindex="-1"></a>I <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> n, <span class="at">ncol =</span> n)</span>
<span id="cb117-425"><a href="#cb117-425" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(I) <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb117-426"><a href="#cb117-426" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> lagmod<span class="sc">$</span>rho</span>
<span id="cb117-427"><a href="#cb117-427" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> lagmod<span class="sc">$</span>coefficients[<span class="st">"age25.34"</span>]</span>
<span id="cb117-428"><a href="#cb117-428" aria-hidden="true" tabindex="-1"></a>weights.matrix <span class="ot">&lt;-</span> <span class="fu">listw2mat</span>(spweight)</span>
<span id="cb117-429"><a href="#cb117-429" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times=</span><span class="dv">10</span>)</span>
<span id="cb117-430"><a href="#cb117-430" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, \(i) {</span>
<span id="cb117-431"><a href="#cb117-431" aria-hidden="true" tabindex="-1"></a>  xvector <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="at">times=</span>n)</span>
<span id="cb117-432"><a href="#cb117-432" aria-hidden="true" tabindex="-1"></a>  xvector[i] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb117-433"><a href="#cb117-433" aria-hidden="true" tabindex="-1"></a>  impact <span class="ot">&lt;-</span> <span class="fu">solve</span>(I <span class="sc">-</span> rho <span class="sc">*</span> weights.matrix) <span class="sc">%*%</span> xvector <span class="sc">*</span> beta</span>
<span id="cb117-434"><a href="#cb117-434" aria-hidden="true" tabindex="-1"></a>  results[i] <span class="ot">&lt;-</span> impact[i]</span>
<span id="cb117-435"><a href="#cb117-435" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb117-436"><a href="#cb117-436" aria-hidden="true" tabindex="-1"></a>results</span>
<span id="cb117-437"><a href="#cb117-437" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-438"><a href="#cb117-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-439"><a href="#cb117-439" aria-hidden="true" tabindex="-1"></a><span class="fu">### Choosing between the spatial error and lagged y model</span></span>
<span id="cb117-440"><a href="#cb117-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-441"><a href="#cb117-441" aria-hidden="true" tabindex="-1"></a>Before fitting the spatial error and lagged y models, we could have looked for evidence in support of them using the function <span class="in">`lm.LMtests()`</span>. This tests the basic OLS specification against the more general spatial error and lagged y models. Anselin and Rey (2014, p.110) offer the following decision tree that can, in the absence of a more theoretical basis for the model choice (e.g. the type of process being modelled), be used in conjunction with the test results to help select the model.</span>
<span id="cb117-442"><a href="#cb117-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-443"><a href="#cb117-443" aria-hidden="true" tabindex="-1"></a><span class="al">![](flowchart.jpg)</span></span>
<span id="cb117-444"><a href="#cb117-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-445"><a href="#cb117-445" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;font</span> <span class="er">size</span> <span class="ot">=</span> <span class="st">2</span><span class="kw">&gt;</span>Source: <span class="co">[</span><span class="ot">Modern Spatial Econometrics in Practice</span><span class="co">](https://www.amazon.co.uk/Modern-Spatial-Econometrics-Practice-GeoDaSpace/dp/0986342106)</span>{target="_blank}<span class="kw">&lt;/font&gt;</span></span>
<span id="cb117-446"><a href="#cb117-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-447"><a href="#cb117-447" aria-hidden="true" tabindex="-1"></a>In the first step, we find that in this instance both the LM-Error and LM-Lag tests are significant.</span>
<span id="cb117-448"><a href="#cb117-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-451"><a href="#cb117-451" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-452"><a href="#cb117-452" aria-hidden="true" tabindex="-1"></a>ols4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(Rate <span class="sc">~</span>  IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span> carebeds <span class="sc">+</span> <span class="fu">poly</span>(density, <span class="dv">2</span>), <span class="at">data =</span> covid)</span>
<span id="cb117-453"><a href="#cb117-453" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.LMtests</span>(ols4, spweight, <span class="at">test=</span><span class="fu">c</span>(<span class="st">"LMerr"</span>, <span class="st">"LMlag"</span>))</span>
<span id="cb117-454"><a href="#cb117-454" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-455"><a href="#cb117-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-456"><a href="#cb117-456" aria-hidden="true" tabindex="-1"></a>Moving on to the robust tests, only the LM-Lag test is significant. Given the nature of COVID-19 as an infectious disease, it does seem reasonable to suppose that high rates of infection in any an area will 'overspill' into neighbouring areas too.</span>
<span id="cb117-457"><a href="#cb117-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-460"><a href="#cb117-460" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-461"><a href="#cb117-461" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.LMtests</span>(ols4, spweight, <span class="at">test=</span><span class="fu">c</span>(<span class="st">"RLMerr"</span>, <span class="st">"RLMlag"</span>))</span>
<span id="cb117-462"><a href="#cb117-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-463"><a href="#cb117-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-464"><a href="#cb117-464" aria-hidden="true" tabindex="-1"></a><span class="fu">## A geographically weighted spatial weights matrix</span></span>
<span id="cb117-465"><a href="#cb117-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-466"><a href="#cb117-466" aria-hidden="true" tabindex="-1"></a>As with the tests of spatial autocorrelation in an earlier session and as with the geographically weighted statistics, the results of the spatial regression models are dependent on the specification of the spatial weights matrix which can suffer from being somewhat arbitrary. We could, if we wish, try calibrating it around the geographically weighted mean.</span>
<span id="cb117-467"><a href="#cb117-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-470"><a href="#cb117-470" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-471"><a href="#cb117-471" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: false</span></span>
<span id="cb117-472"><a href="#cb117-472" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(GWmodel)</span>
<span id="cb117-473"><a href="#cb117-473" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(Rate <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> covid_sp, <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">kernel =</span> <span class="st">"bisquare"</span>)</span>
<span id="cb117-474"><a href="#cb117-474" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-475"><a href="#cb117-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-476"><a href="#cb117-476" aria-hidden="true" tabindex="-1"></a>To now create the corresponding inverse distance spatial weights matrix for the models, we can use the <span class="in">`nn2`</span> function in the <span class="in">`RANN`</span> package to find the $bw = $ <span class="in">`r bw`</span> nearest neighbours to each centroid point:</span>
<span id="cb117-477"><a href="#cb117-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-480"><a href="#cb117-480" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-481"><a href="#cb117-481" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"RANN"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>]))  <span class="fu">install.packages</span>(<span class="st">"RANN"</span>)</span>
<span id="cb117-482"><a href="#cb117-482" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(RANN)</span>
<span id="cb117-483"><a href="#cb117-483" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(<span class="fu">st_centroid</span>(<span class="fu">st_geometry</span>(covid)))</span>
<span id="cb117-484"><a href="#cb117-484" aria-hidden="true" tabindex="-1"></a>knn <span class="ot">&lt;-</span> <span class="fu">nn2</span>(coords, coords, <span class="at">k =</span> bw)</span>
<span id="cb117-485"><a href="#cb117-485" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-486"><a href="#cb117-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-487"><a href="#cb117-487" aria-hidden="true" tabindex="-1"></a>Having done so, those neighbours can be geographically weighted using a bisquare kernel, as in the GWR calibration above. (A Gaussian kernel is obtained if <span class="in">`(1 - (x / max(x))^2)^2`</span> is replaced by <span class="in">`exp(-0.5 * (x / max(x))^2)`</span> in the code below).</span>
<span id="cb117-488"><a href="#cb117-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-491"><a href="#cb117-491" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-492"><a href="#cb117-492" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> knn<span class="sc">$</span>nn.dists</span>
<span id="cb117-493"><a href="#cb117-493" aria-hidden="true" tabindex="-1"></a>glist <span class="ot">&lt;-</span> <span class="fu">apply</span>(d, <span class="dv">1</span>, \(x) {</span>
<span id="cb117-494"><a href="#cb117-494" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span> <span class="sc">-</span> (x <span class="sc">/</span> <span class="fu">max</span>(x))<span class="sc">^</span><span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb117-495"><a href="#cb117-495" aria-hidden="true" tabindex="-1"></a>}, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb117-496"><a href="#cb117-496" aria-hidden="true" tabindex="-1"></a>knearnb <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(<span class="fu">st_centroid</span>(<span class="fu">st_geometry</span>(covid)), <span class="at">k =</span> bw))</span>
<span id="cb117-497"><a href="#cb117-497" aria-hidden="true" tabindex="-1"></a>spweightK <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(knearnb, glist, <span class="at">style =</span> <span class="st">"C"</span>)</span>
<span id="cb117-498"><a href="#cb117-498" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-499"><a href="#cb117-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-500"><a href="#cb117-500" aria-hidden="true" tabindex="-1"></a>The results are not very successful though. The lag model with contiguous spatial weights fits the data better,</span>
<span id="cb117-501"><a href="#cb117-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-504"><a href="#cb117-504" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-505"><a href="#cb117-505" aria-hidden="true" tabindex="-1"></a>lagmod3 <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(<span class="fu">formula</span>(ols4), <span class="at">data =</span> covid, <span class="at">listw =</span> spweightK)</span>
<span id="cb117-506"><a href="#cb117-506" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">glance</span>(lagmod2), <span class="fu">glance</span>(lagmod3))</span>
<span id="cb117-507"><a href="#cb117-507" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-508"><a href="#cb117-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-509"><a href="#cb117-509" aria-hidden="true" tabindex="-1"></a>In addition, the inverse distance weights are not row-standardised, which may cause some knock-on problems. They could become row-standardised (<span class="in">`spweightK &lt;- nb2listw(knearnb, glist, style = "W")`</span>) but if they are, by re-scaling each row of the weights to equal one, then the inverse distance weighting is altered.</span>
<span id="cb117-510"><a href="#cb117-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-511"><a href="#cb117-511" aria-hidden="true" tabindex="-1"></a><span class="fu">## Geographically Weighted Regression</span></span>
<span id="cb117-512"><a href="#cb117-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-513"><a href="#cb117-513" aria-hidden="true" tabindex="-1"></a>The following charts shows the simple, bivariate regression relationship between <span class="in">`Rate`</span> and <span class="in">`age0.11`</span>.</span>
<span id="cb117-514"><a href="#cb117-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-517"><a href="#cb117-517" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-518"><a href="#cb117-518" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height = 3</span></span>
<span id="cb117-519"><a href="#cb117-519" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">x =</span> age0<span class="fl">.11</span>, <span class="at">y =</span> Rate)) <span class="sc">+</span></span>
<span id="cb117-520"><a href="#cb117-520" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb117-521"><a href="#cb117-521" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span>
<span id="cb117-522"><a href="#cb117-522" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-523"><a href="#cb117-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-524"><a href="#cb117-524" aria-hidden="true" tabindex="-1"></a>Intriguingly, it doesn't seem to be linear relationship but a polynomial one.</span>
<span id="cb117-525"><a href="#cb117-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-528"><a href="#cb117-528" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-529"><a href="#cb117-529" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height = 3</span></span>
<span id="cb117-530"><a href="#cb117-530" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">x =</span> age0<span class="fl">.11</span>, <span class="at">y =</span> Rate)) <span class="sc">+</span></span>
<span id="cb117-531"><a href="#cb117-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb117-532"><a href="#cb117-532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">formula =</span> y <span class="sc">~</span> <span class="fu">poly</span>(x, <span class="dv">2</span>))</span>
<span id="cb117-533"><a href="#cb117-533" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-534"><a href="#cb117-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-535"><a href="#cb117-535" aria-hidden="true" tabindex="-1"></a>It could be that the relationship is indeed curved but it might also be that the nature of the relationship is spatially dependent -- that the relationship between <span class="in">`Rate`</span> and <span class="in">`age0.11`</span> depends upon where it is measured. A <span class="in">`coplot()`</span> from R's base graphics lends weight to the second idea: note how the regression relationship changes with <span class="in">`X`</span> and <span class="in">`Y`</span>, which are the centroids of the neighbourhoods in the North West of England.</span>
<span id="cb117-536"><a href="#cb117-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-539"><a href="#cb117-539" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-540"><a href="#cb117-540" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height = 6</span></span>
<span id="cb117-541"><a href="#cb117-541" aria-hidden="true" tabindex="-1"></a>coplot_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">st_coordinates</span>(<span class="fu">st_centroid</span>(covid)), <span class="at">Rate =</span> covid<span class="sc">$</span>Rate, <span class="at">age0.11 =</span> covid<span class="sc">$</span>age0<span class="fl">.11</span>)</span>
<span id="cb117-542"><a href="#cb117-542" aria-hidden="true" tabindex="-1"></a>PointsWithLine <span class="ot">=</span> <span class="cf">function</span>(x, y, ...) {</span>
<span id="cb117-543"><a href="#cb117-543" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">pch=</span><span class="dv">20</span>, <span class="at">col=</span><span class="st">"black"</span>)</span>
<span id="cb117-544"><a href="#cb117-544" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x))</span>
<span id="cb117-545"><a href="#cb117-545" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb117-546"><a href="#cb117-546" aria-hidden="true" tabindex="-1"></a><span class="fu">coplot</span>(Rate <span class="sc">~</span> age0<span class="fl">.11</span> <span class="sc">|</span> X <span class="sc">*</span> Y, <span class="at">data =</span> coplot_df, <span class="at">panel =</span> PointsWithLine, <span class="at">overlap =</span> <span class="dv">0</span>)</span>
<span id="cb117-547"><a href="#cb117-547" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-548"><a href="#cb117-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-549"><a href="#cb117-549" aria-hidden="true" tabindex="-1"></a>Imagine, now, that instead of dividing the geography of the North West's neighbourhoods into a $6 \times 6$ grid, as in the coplot, we instead go from location to location within the study region, calculating a <span class="co">[</span><span class="ot">geographically weighted regression</span><span class="co">](https://www.sciencedirect.com/science/article/pii/B9780080449104004478?via%3Dihub)</span>{target="_blank"} at and around each one of them. This builds on the idea of geographically weighted statistics that allow the measured value of the statistic to vary locally from location to location across the study region; with geographically weighted it is the locally estimated regression coefficients that are allowed to vary. These are used to look for spatial variation in the regression relationships.</span>
<span id="cb117-550"><a href="#cb117-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-551"><a href="#cb117-551" aria-hidden="true" tabindex="-1"></a>If the bandwidth is not known or there is no theoretical justification for it, it can be found using an automated selection procedure, here with a more complex model than the bivariate relationship shown in the coplot, instead using all the variables included in the choice between the spatial error and lagged y model, above.</span>
<span id="cb117-552"><a href="#cb117-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-555"><a href="#cb117-555" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-556"><a href="#cb117-556" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: false</span></span>
<span id="cb117-557"><a href="#cb117-557" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(GWmodel)</span>
<span id="cb117-558"><a href="#cb117-558" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(<span class="fu">formula</span>(ols4), <span class="at">data =</span> covid_sp, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-559"><a href="#cb117-559" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-560"><a href="#cb117-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-561"><a href="#cb117-561" aria-hidden="true" tabindex="-1"></a>The model can then be fitted.</span>
<span id="cb117-562"><a href="#cb117-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-565"><a href="#cb117-565" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-566"><a href="#cb117-566" aria-hidden="true" tabindex="-1"></a>gwrmod <span class="ot">&lt;-</span> <span class="fu">gwr.basic</span>(<span class="fu">formula</span>(ols4), <span class="at">data =</span> covid_sp, <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">bw =</span> bw)</span>
<span id="cb117-567"><a href="#cb117-567" aria-hidden="true" tabindex="-1"></a>gwrmod</span>
<span id="cb117-568"><a href="#cb117-568" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-569"><a href="#cb117-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-570"><a href="#cb117-570" aria-hidden="true" tabindex="-1"></a>The output requires some interpretation! The results of the global regression are those obtained from a standard OLS regression (i.e. <span class="in">`summary(lm(formula(ols4), data = covid_sp))`</span>). It is 'global' because it is a model for the entire study region, without spatial variation in the regression estimates. The results of the geographically weighted regression are the results from, in this case, <span class="in">`r nrow(covid)`</span> separate but spatially overlapping regression models fitted, with geographic weighting, to spatial subsets of the data. All the local estimates are contained in the spatial data frame, <span class="in">`gwrmod$SDF`</span>, including those for <span class="in">`age0.11`</span> which are in <span class="in">`gwrmod$SDF$age0.11`</span> and have the following distribution,</span>
<span id="cb117-571"><a href="#cb117-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-574"><a href="#cb117-574" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-575"><a href="#cb117-575" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span>)</span>
<span id="cb117-576"><a href="#cb117-576" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-577"><a href="#cb117-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-578"><a href="#cb117-578" aria-hidden="true" tabindex="-1"></a>This is the same summary of the distribution that is included in the GWR coefficient estimates. What it means is that in at least one location the relationship of <span class="in">`age0.11`</span> to <span class="in">`Rate`</span> is, conditional on the other variables, negative. It is more usual for it to be positive -- more children, more infections (perhaps a school effect?) -- but the estimated effect size varies quite substantially across the locations in the study region. Its interquartile range is from <span class="in">`r round(quantile(gwrmod$SDF$age0.11, probs = 0.25), 3)`</span> to <span class="in">`r round(quantile(gwrmod$SDF$age0.11, probs = 0.75), 3)`</span>. Mapping these local estimates reveals an interesting geography -- it is largely in and around Manchester where a greater number of children of primary school age or younger appears to *lower* instead of raising the infection rate.</span>
<span id="cb117-579"><a href="#cb117-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-582"><a href="#cb117-582" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-583"><a href="#cb117-583" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR <span class="ot">&lt;-</span> gwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span></span>
<span id="cb117-584"><a href="#cb117-584" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> covid, <span class="fu">aes</span>(<span class="at">fill =</span> age0<span class="fl">.11</span>GWR)) <span class="sc">+</span></span>
<span id="cb117-585"><a href="#cb117-585" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb117-586"><a href="#cb117-586" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">trans =</span> <span class="st">"reverse"</span>) <span class="sc">+</span></span>
<span id="cb117-587"><a href="#cb117-587" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb117-588"><a href="#cb117-588" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_colourbar</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb117-589"><a href="#cb117-589" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-590"><a href="#cb117-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-591"><a href="#cb117-591" aria-hidden="true" tabindex="-1"></a>With a bit of effort we can get all the variables on the same chart...</span>
<span id="cb117-592"><a href="#cb117-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-595"><a href="#cb117-595" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-596"><a href="#cb117-596" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"gridExtra"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])) <span class="fu">install.packages</span>(<span class="st">"gridExtra"</span>,</span>
<span id="cb117-597"><a href="#cb117-597" aria-hidden="true" tabindex="-1"></a>                                                          <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-598"><a href="#cb117-598" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(gridExtra)</span>
<span id="cb117-599"><a href="#cb117-599" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">8</span>, \(j) {</span>
<span id="cb117-600"><a href="#cb117-600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(gwrmod<span class="sc">$</span>SDF[, j]) <span class="sc">%&gt;%</span></span>
<span id="cb117-601"><a href="#cb117-601" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">beta =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb117-602"><a href="#cb117-602" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> beta)) <span class="sc">+</span></span>
<span id="cb117-603"><a href="#cb117-603" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">col =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb117-604"><a href="#cb117-604" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">trans =</span> <span class="st">"reverse"</span>) <span class="sc">+</span></span>
<span id="cb117-605"><a href="#cb117-605" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb117-606"><a href="#cb117-606" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_colourbar</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb117-607"><a href="#cb117-607" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggtitle</span>(<span class="fu">names</span>(gwrmod<span class="sc">$</span>SDF[j]))</span>
<span id="cb117-608"><a href="#cb117-608" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb117-609"><a href="#cb117-609" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(<span class="at">grobs =</span> g)</span>
<span id="cb117-610"><a href="#cb117-610" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-611"><a href="#cb117-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-612"><a href="#cb117-612" aria-hidden="true" tabindex="-1"></a>... however, not all of these regression estimates are necessarily statistically significant. If we use the estimated t-values to isolate those that are not (t-values less than -1.96 or greater than +1.96 can be considered significant at a 95% confidence), then, for the <span class="in">`age0.11`</span> variable we obtain,</span>
<span id="cb117-613"><a href="#cb117-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-616"><a href="#cb117-616" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-617"><a href="#cb117-617" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR[<span class="fu">abs</span>(gwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span>_TV) <span class="sc">&lt;</span> <span class="fl">1.96</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb117-618"><a href="#cb117-618" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> covid, <span class="fu">aes</span>(<span class="at">fill =</span> age0<span class="fl">.11</span>GWR)) <span class="sc">+</span></span>
<span id="cb117-619"><a href="#cb117-619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb117-620"><a href="#cb117-620" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb117-621"><a href="#cb117-621" aria-hidden="true" tabindex="-1"></a>                       <span class="at">trans =</span> <span class="st">"reverse"</span>) <span class="sc">+</span></span>
<span id="cb117-622"><a href="#cb117-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb117-623"><a href="#cb117-623" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_colourbar</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb117-624"><a href="#cb117-624" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-625"><a href="#cb117-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-626"><a href="#cb117-626" aria-hidden="true" tabindex="-1"></a>and, with a bit more data wrangling, for the full set,</span>
<span id="cb117-627"><a href="#cb117-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-630"><a href="#cb117-630" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-631"><a href="#cb117-631" aria-hidden="true" tabindex="-1"></a>sdf <span class="ot">&lt;-</span> <span class="fu">slot</span>(gwrmod<span class="sc">$</span>SDF, <span class="st">"data"</span>)</span>
<span id="cb117-632"><a href="#cb117-632" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">8</span>, \(j) {</span>
<span id="cb117-633"><a href="#cb117-633" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(gwrmod<span class="sc">$</span>SDF[, j]) </span>
<span id="cb117-634"><a href="#cb117-634" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(sdf) <span class="sc">==</span> <span class="fu">paste0</span>(<span class="fu">names</span>(x)[<span class="dv">1</span>],<span class="st">"_TV"</span>))</span>
<span id="cb117-635"><a href="#cb117-635" aria-hidden="true" tabindex="-1"></a>  x[<span class="fu">abs</span>(sdf[, t]) <span class="sc">&lt;</span> <span class="fl">1.96</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb117-636"><a href="#cb117-636" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">%&gt;%</span></span>
<span id="cb117-637"><a href="#cb117-637" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">beta =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb117-638"><a href="#cb117-638" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> beta)) <span class="sc">+</span></span>
<span id="cb117-639"><a href="#cb117-639" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">col =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb117-640"><a href="#cb117-640" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb117-641"><a href="#cb117-641" aria-hidden="true" tabindex="-1"></a>                           <span class="at">trans =</span> <span class="st">"reverse"</span>) <span class="sc">+</span></span>
<span id="cb117-642"><a href="#cb117-642" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb117-643"><a href="#cb117-643" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_colourbar</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb117-644"><a href="#cb117-644" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggtitle</span>(<span class="fu">names</span>(gwrmod<span class="sc">$</span>SDF[j]))</span>
<span id="cb117-645"><a href="#cb117-645" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb117-646"><a href="#cb117-646" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(<span class="at">grobs =</span> g)</span>
<span id="cb117-647"><a href="#cb117-647" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-648"><a href="#cb117-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-649"><a href="#cb117-649" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width=75}</span>
<span id="cb117-650"><a href="#cb117-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-651"><a href="#cb117-651" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;font</span> <span class="er">size</span> <span class="ot">=</span> <span class="st">3</span><span class="kw">&gt;</span>I am sure there is a more elegant way of doing this. Don't worry about the code especially - the point is that not every estimate, everywhere, is significant.<span class="kw">&lt;/font&gt;</span></span>
<span id="cb117-652"><a href="#cb117-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-653"><a href="#cb117-653" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/br&gt;</span></span>
<span id="cb117-654"><a href="#cb117-654" aria-hidden="true" tabindex="-1"></a>As with the basic GW statistics, we can undertake a randomisation test to suggest whether the spatial variation in the coefficient estimates is statistically significant. **However** this takes some time to run -- with the default `nsims = 99` simulations it took about 12 minutes on my laptop. **I have 'commented it out' in the code block below with the suggestion that you don't run it now.**</span>
<span id="cb117-655"><a href="#cb117-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-658"><a href="#cb117-658" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-659"><a href="#cb117-659" aria-hidden="true" tabindex="-1"></a><span class="co"># I suggest you do not run this</span></span>
<span id="cb117-660"><a href="#cb117-660" aria-hidden="true" tabindex="-1"></a><span class="co"># gwr.mc &lt;- gwr.montecarlo(formula(ols4), covid_sp, adaptive = TRUE, bw = bw)</span></span>
<span id="cb117-661"><a href="#cb117-661" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-662"><a href="#cb117-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-663"><a href="#cb117-663" aria-hidden="true" tabindex="-1"></a>Instead, let's jump straight to the results, which I have saved in a pre-prepared workspace.</span>
<span id="cb117-664"><a href="#cb117-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-667"><a href="#cb117-667" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-668"><a href="#cb117-668" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/workspaces/gwrmc.RData"</span>)</span>
<span id="cb117-669"><a href="#cb117-669" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(url)</span>
<span id="cb117-670"><a href="#cb117-670" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(url)</span>
<span id="cb117-671"><a href="#cb117-671" aria-hidden="true" tabindex="-1"></a>gwr.mc</span>
<span id="cb117-672"><a href="#cb117-672" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-673"><a href="#cb117-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-674"><a href="#cb117-674" aria-hidden="true" tabindex="-1"></a><span class="fu">### Mixed GWR</span></span>
<span id="cb117-675"><a href="#cb117-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-676"><a href="#cb117-676" aria-hidden="true" tabindex="-1"></a>It appears that only the <span class="in">`age0.11`</span> and <span class="in">`density`</span> variables exhibit significant spatial variation (p-value &lt; 0.05). In principle it is possible to drop the other variables out from the local estimates and treat them as fixed, global estimates instead, in a Mixed GWR model (mixed global and local regression estimates). In practice, it is generating an error.</span>
<span id="cb117-677"><a href="#cb117-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-680"><a href="#cb117-680" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-681"><a href="#cb117-681" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb117-682"><a href="#cb117-682" aria-hidden="true" tabindex="-1"></a><span class="co"># This appears to generate an error</span></span>
<span id="cb117-683"><a href="#cb117-683" aria-hidden="true" tabindex="-1"></a>gwrmixd <span class="ot">&lt;-</span> <span class="fu">gwr.mixed</span>(Rate <span class="sc">~</span> IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span> carebeds <span class="sc">+</span></span>
<span id="cb117-684"><a href="#cb117-684" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">poly</span>(density, <span class="dv">2</span>),</span>
<span id="cb117-685"><a href="#cb117-685" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> covid_sp,</span>
<span id="cb117-686"><a href="#cb117-686" aria-hidden="true" tabindex="-1"></a>          <span class="at">fixed.vars =</span> <span class="fu">c</span>(<span class="st">"IMD"</span>, <span class="st">"age25.34"</span>, <span class="st">"age50.59"</span>, <span class="st">"carebeds"</span>),</span>
<span id="cb117-687"><a href="#cb117-687" aria-hidden="true" tabindex="-1"></a>          <span class="at">bw =</span> bw, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-688"><a href="#cb117-688" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-689"><a href="#cb117-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-690"><a href="#cb117-690" aria-hidden="true" tabindex="-1"></a>We can work around this, though, using partial regressions, regressing <span class="in">`Rate`</span>, <span class="in">`age0.11`</span> and <span class="in">`poly(density, 2)`</span> on the fixed variables and using their residuals.</span>
<span id="cb117-691"><a href="#cb117-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-694"><a href="#cb117-694" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-695"><a href="#cb117-695" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: false</span></span>
<span id="cb117-696"><a href="#cb117-696" aria-hidden="true" tabindex="-1"></a>density<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">poly</span>(covid<span class="sc">$</span>density, <span class="dv">2</span>)[, <span class="dv">1</span>]</span>
<span id="cb117-697"><a href="#cb117-697" aria-hidden="true" tabindex="-1"></a>density<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">poly</span>(covid<span class="sc">$</span>density, <span class="dv">2</span>)[, <span class="dv">2</span>]</span>
<span id="cb117-698"><a href="#cb117-698" aria-hidden="true" tabindex="-1"></a>covid_sp<span class="sc">$</span>RateR <span class="ot">&lt;-</span> <span class="fu">residuals</span>(<span class="fu">lm</span>(Rate <span class="sc">~</span> IMD <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span> carebeds,</span>
<span id="cb117-699"><a href="#cb117-699" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> covid_sp))</span>
<span id="cb117-700"><a href="#cb117-700" aria-hidden="true" tabindex="-1"></a>covid_sp<span class="sc">$</span>age0<span class="fl">.11</span>R <span class="ot">&lt;-</span> <span class="fu">residuals</span>(<span class="fu">lm</span>(age0<span class="fl">.11</span> <span class="sc">~</span> IMD <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span></span>
<span id="cb117-701"><a href="#cb117-701" aria-hidden="true" tabindex="-1"></a>                                    carebeds, <span class="at">data =</span> covid_sp))</span>
<span id="cb117-702"><a href="#cb117-702" aria-hidden="true" tabindex="-1"></a>covid_sp<span class="sc">$</span>density<span class="fl">.1</span>R <span class="ot">&lt;-</span> <span class="fu">residuals</span>(<span class="fu">lm</span>(density<span class="fl">.1</span> <span class="sc">~</span> IMD <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span></span>
<span id="cb117-703"><a href="#cb117-703" aria-hidden="true" tabindex="-1"></a>                                    carebeds, <span class="at">data =</span> covid_sp))</span>
<span id="cb117-704"><a href="#cb117-704" aria-hidden="true" tabindex="-1"></a>covid_sp<span class="sc">$</span>density<span class="fl">.2</span>R <span class="ot">&lt;-</span> <span class="fu">residuals</span>(<span class="fu">lm</span>(density<span class="fl">.2</span> <span class="sc">~</span> IMD <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span></span>
<span id="cb117-705"><a href="#cb117-705" aria-hidden="true" tabindex="-1"></a>                                    carebeds, <span class="at">data =</span> covid_sp))</span>
<span id="cb117-706"><a href="#cb117-706" aria-hidden="true" tabindex="-1"></a>fml <span class="ot">&lt;-</span> <span class="fu">formula</span>(RateR <span class="sc">~</span> age0<span class="fl">.11</span>R <span class="sc">+</span> density<span class="fl">.1</span>R <span class="sc">+</span> density<span class="fl">.2</span>R)</span>
<span id="cb117-707"><a href="#cb117-707" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(fml, <span class="at">data =</span> covid_sp, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-708"><a href="#cb117-708" aria-hidden="true" tabindex="-1"></a>gwrmixd <span class="ot">&lt;-</span> <span class="fu">gwr.basic</span>(fml, <span class="at">data =</span> covid_sp, <span class="at">bw =</span> bw, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-709"><a href="#cb117-709" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-710"><a href="#cb117-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-711"><a href="#cb117-711" aria-hidden="true" tabindex="-1"></a>Here are the statistically significant results for the <span class="in">`age0.11`</span> variable.</span>
<span id="cb117-712"><a href="#cb117-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-715"><a href="#cb117-715" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-716"><a href="#cb117-716" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR <span class="ot">&lt;-</span> gwrmixd<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span>R</span>
<span id="cb117-717"><a href="#cb117-717" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR[<span class="fu">abs</span>(gwrmixd<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span>R_TV) <span class="sc">&gt;</span> <span class="fl">1.96</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb117-718"><a href="#cb117-718" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> covid, <span class="fu">aes</span>(<span class="at">fill =</span> age0<span class="fl">.11</span>GWR)) <span class="sc">+</span></span>
<span id="cb117-719"><a href="#cb117-719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb117-720"><a href="#cb117-720" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">na.value =</span> <span class="st">"white"</span>, <span class="at">trans =</span> <span class="st">"reverse"</span>) <span class="sc">+</span></span>
<span id="cb117-721"><a href="#cb117-721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb117-722"><a href="#cb117-722" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_colourbar</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb117-723"><a href="#cb117-723" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-724"><a href="#cb117-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-725"><a href="#cb117-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-726"><a href="#cb117-726" aria-hidden="true" tabindex="-1"></a><span class="fu">### Multiscale GWR</span></span>
<span id="cb117-727"><a href="#cb117-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-728"><a href="#cb117-728" aria-hidden="true" tabindex="-1"></a>It is also possible to fit a Multiscale GWR, which allows for the possibility of a different bandwith for each variable -- see <span class="in">`?gwr.multiscale`</span>. Since there is no particular reason to presume that the bandwidth should be the same for all the variables, arguably Multiscale GWR should be preferred over standard GWR, at least in the first instance. Its main drawback, however, is that it takes a while to run -- over 3 hours for the code chunk below! (In principle it can be parallelised but it generated an error for me when I tried this with <span class="in">`parallel.method = cluster`</span>.)</span>
<span id="cb117-729"><a href="#cb117-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-732"><a href="#cb117-732" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-733"><a href="#cb117-733" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb117-734"><a href="#cb117-734" aria-hidden="true" tabindex="-1"></a>density<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">poly</span>(covid<span class="sc">$</span>density, <span class="dv">2</span>)[, <span class="dv">1</span>]</span>
<span id="cb117-735"><a href="#cb117-735" aria-hidden="true" tabindex="-1"></a>density<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">poly</span>(covid<span class="sc">$</span>density, <span class="dv">2</span>)[, <span class="dv">2</span>]</span>
<span id="cb117-736"><a href="#cb117-736" aria-hidden="true" tabindex="-1"></a><span class="co"># Do not run!</span></span>
<span id="cb117-737"><a href="#cb117-737" aria-hidden="true" tabindex="-1"></a><span class="co"># Took over 3 hours!</span></span>
<span id="cb117-738"><a href="#cb117-738" aria-hidden="true" tabindex="-1"></a><span class="co">#gwrmulti &lt;- gwr.multiscale(Rate ~ IMD + age0.11 + age25.34 + age50.59 + carebeds +</span></span>
<span id="cb117-739"><a href="#cb117-739" aria-hidden="true" tabindex="-1"></a><span class="co"># density.1 + density.2, data = covid_sp, adaptive = TRUE)</span></span>
<span id="cb117-740"><a href="#cb117-740" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-741"><a href="#cb117-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-742"><a href="#cb117-742" aria-hidden="true" tabindex="-1"></a>To save time, the results are available below. The bandwidths do appear to vary.</span>
<span id="cb117-743"><a href="#cb117-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-746"><a href="#cb117-746" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-747"><a href="#cb117-747" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/workspaces/gwrmulti.RData"</span>)</span>
<span id="cb117-748"><a href="#cb117-748" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(url)</span>
<span id="cb117-749"><a href="#cb117-749" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(url)</span>
<span id="cb117-750"><a href="#cb117-750" aria-hidden="true" tabindex="-1"></a>gwrmulti</span>
<span id="cb117-751"><a href="#cb117-751" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-752"><a href="#cb117-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-753"><a href="#cb117-753" aria-hidden="true" tabindex="-1"></a><span class="fu">### Geographically and temporally weighted regression</span></span>
<span id="cb117-754"><a href="#cb117-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-755"><a href="#cb117-755" aria-hidden="true" tabindex="-1"></a>It also possible to add a time dimension and undertake geographically and temporally weighted regression in <span class="in">`GWmodel`</span>. The following workspace loads monthly COVID-19 data for Manchester neighbourhoods.</span>
<span id="cb117-756"><a href="#cb117-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-759"><a href="#cb117-759" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-760"><a href="#cb117-760" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/workspaces/manchester.RData"</span>)</span>
<span id="cb117-761"><a href="#cb117-761" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(url)</span>
<span id="cb117-762"><a href="#cb117-762" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(url)</span>
<span id="cb117-763"><a href="#cb117-763" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-764"><a href="#cb117-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-765"><a href="#cb117-765" aria-hidden="true" tabindex="-1"></a>Here are the monthly rates.</span>
<span id="cb117-766"><a href="#cb117-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-769"><a href="#cb117-769" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-770"><a href="#cb117-770" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> Rate )) <span class="sc">+</span></span>
<span id="cb117-771"><a href="#cb117-771" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb117-772"><a href="#cb117-772" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> month) <span class="sc">+</span></span>
<span id="cb117-773"><a href="#cb117-773" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"RdBu"</span>) <span class="sc">+</span></span>
<span id="cb117-774"><a href="#cb117-774" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb117-775"><a href="#cb117-775" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-776"><a href="#cb117-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-777"><a href="#cb117-777" aria-hidden="true" tabindex="-1"></a>If now want to explore how the regression relationships vary in space-time then we can use the <span class="in">`bw.gtwr()`</span> and <span class="in">`gtwr()`</span> functions, for which we also need to specify a vector of time tags (<span class="in">`obs.tv = ...`</span>). In these data, they are simply a numeric value, <span class="in">`covid$month_code`</span> but see <span class="in">`?bw.gtwr()`</span> and <span class="in">`?gtwr()`</span> for further possibilities and for further information about the model.</span>
<span id="cb117-778"><a href="#cb117-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-779"><a href="#cb117-779" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width=75}</span>
<span id="cb117-780"><a href="#cb117-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-781"><a href="#cb117-781" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;font</span> <span class="er">size</span> <span class="ot">=</span> <span class="st">3</span><span class="kw">&gt;</span>The model will take a little time to run -- enough time for you to get a cup of tea or coffee!<span class="kw">&lt;/font&gt;</span></span>
<span id="cb117-782"><a href="#cb117-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-785"><a href="#cb117-785" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-786"><a href="#cb117-786" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb117-787"><a href="#cb117-787" aria-hidden="true" tabindex="-1"></a>covid_sp <span class="ot">&lt;-</span> <span class="fu">as_Spatial</span>(covid)</span>
<span id="cb117-788"><a href="#cb117-788" aria-hidden="true" tabindex="-1"></a>fml <span class="ot">&lt;-</span> <span class="fu">formula</span>(Rate <span class="sc">~</span> IMD <span class="sc">+</span> age0<span class="fl">.11</span> <span class="sc">+</span> age25<span class="fl">.34</span> <span class="sc">+</span> age50<span class="fl">.59</span> <span class="sc">+</span> carebeds <span class="sc">+</span> <span class="fu">poly</span>(density, <span class="dv">2</span>))</span>
<span id="cb117-789"><a href="#cb117-789" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">bw.gtwr</span>(fml, <span class="at">data =</span> covid_sp, <span class="at">obs.tv =</span> covid<span class="sc">$</span>month_code, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-790"><a href="#cb117-790" aria-hidden="true" tabindex="-1"></a>gtwrmod <span class="ot">&lt;-</span> <span class="fu">gtwr</span>(fml, <span class="at">data =</span> covid_sp, <span class="at">st.bw =</span> bw, <span class="at">obs.tv =</span> covid<span class="sc">$</span>month_code, <span class="at">adaptive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-791"><a href="#cb117-791" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-792"><a href="#cb117-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-795"><a href="#cb117-795" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-796"><a href="#cb117-796" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb117-797"><a href="#cb117-797" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/raw/main/MandM/workspaces/gtwrmod.RData"</span>)</span>
<span id="cb117-798"><a href="#cb117-798" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(url)</span>
<span id="cb117-799"><a href="#cb117-799" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(url)</span>
<span id="cb117-800"><a href="#cb117-800" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-801"><a href="#cb117-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-802"><a href="#cb117-802" aria-hidden="true" tabindex="-1"></a>Here are the summary results of the model,</span>
<span id="cb117-803"><a href="#cb117-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-806"><a href="#cb117-806" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-807"><a href="#cb117-807" aria-hidden="true" tabindex="-1"></a>gtwrmod</span>
<span id="cb117-808"><a href="#cb117-808" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-809"><a href="#cb117-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-810"><a href="#cb117-810" aria-hidden="true" tabindex="-1"></a>They should be treated cautiously because the <span class="in">`Rate`</span> value is strongly positively skewed such that it may have been better to have transformed it (e.g. taken its square root) prior to analysis. Even so, there is some evidence that the predictor <span class="in">`age0.11`</span> variable, for example, varies spatially *and* temporally.</span>
<span id="cb117-811"><a href="#cb117-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-814"><a href="#cb117-814" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb117-815"><a href="#cb117-815" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR <span class="ot">&lt;-</span> gtwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span></span>
<span id="cb117-816"><a href="#cb117-816" aria-hidden="true" tabindex="-1"></a>covid<span class="sc">$</span>age0<span class="fl">.11</span>GWR[<span class="fu">abs</span>(gtwrmod<span class="sc">$</span>SDF<span class="sc">$</span>age0<span class="fl">.11</span>_TV) <span class="sc">&lt;</span> <span class="fl">1.96</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb117-817"><a href="#cb117-817" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(covid, <span class="fu">aes</span>(<span class="at">fill =</span> age0<span class="fl">.11</span>GWR)) <span class="sc">+</span></span>
<span id="cb117-818"><a href="#cb117-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb117-819"><a href="#cb117-819" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> month) <span class="sc">+</span></span>
<span id="cb117-820"><a href="#cb117-820" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="st">"beta"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">na.value =</span> <span class="st">"white"</span>, <span class="at">trans =</span> <span class="st">"reverse"</span>) <span class="sc">+</span></span>
<span id="cb117-821"><a href="#cb117-821" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb117-822"><a href="#cb117-822" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_colourbar</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb117-823"><a href="#cb117-823" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb117-824"><a href="#cb117-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-825"><a href="#cb117-825" aria-hidden="true" tabindex="-1"></a><span class="fu">### Generalised GWR models with Poisson and Binomial options</span></span>
<span id="cb117-826"><a href="#cb117-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-827"><a href="#cb117-827" aria-hidden="true" tabindex="-1"></a>See <span class="in">`?ggwr.basic`</span>.</span>
<span id="cb117-828"><a href="#cb117-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-829"><a href="#cb117-829" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb117-830"><a href="#cb117-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-831"><a href="#cb117-831" aria-hidden="true" tabindex="-1"></a>In this session we have looked at spatial regression models as a way to address the problem of spatial autocorrelation in regression residuals and to allow for the possibility that regression relationships vary across a map. In presenting these methods, at least some could be taken as offering a 'technical fix' to the statistical issue of spatial dependencies in the data, violating assumptions of independence. Whilst that may be true, and the more spatial approaches can be used as diagnostic tools to check for a mis-specified model, notably one that lacks a critical explanatory variable or where the relationship between the X and Y variables is non-linear, the limitation of this thinking is that it treats geography as an error to be resolved and/or it rests on the belief that with sufficient information the geographical differences will be explained. What geographically weighted regression, for example, reminds us is that the nature of the relationship may be complex because it is changing in form across the study region as the socio-spatial causes also vary from place to place. Such spatial complexity may be challenging to accommodate within the parameters of conventional aspatial or spatially naïve statistical thinking but ignoring the geographical variation is not a solution. What spatial thinking brings to the table is the recognition of geographical context and the knowledge that geographically rooted social outcomes are not independent of where the processes giving rise to those outcomes are taking place. </span>
<span id="cb117-832"><a href="#cb117-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-833"><a href="#cb117-833" aria-hidden="true" tabindex="-1"></a><span class="fu">## Further Reading</span></span>
<span id="cb117-834"><a href="#cb117-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-835"><a href="#cb117-835" aria-hidden="true" tabindex="-1"></a><span class="al">![](spatial_regression.jpg)</span>{width=100}</span>
<span id="cb117-836"><a href="#cb117-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-837"><a href="#cb117-837" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Spatial Regression Models (2nd edition) by MD Ward &amp; KS Gleditsch (2018)</span><span class="co">](https://uk.sagepub.com/en-gb/eur/spatial-regression-models/book262155)</span>{target="_blank"}</span>
<span id="cb117-838"><a href="#cb117-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-839"><a href="#cb117-839" aria-hidden="true" tabindex="-1"></a>Comber et al. (2022) A Route Map for Successful Applications of Geographically Weighted Regression. <span class="co">[</span><span class="ot">https://doi.org/10.1111/gean.12316</span><span class="co">](https://doi.org/10.1111/gean.12316)</span>{target="_blank"}</span>
<span id="cb117-840"><a href="#cb117-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-841"><a href="#cb117-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-842"><a href="#cb117-842" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2022-2023, Richard Harris</div>   
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/profrichharris">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>
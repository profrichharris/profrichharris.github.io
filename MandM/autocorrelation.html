<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Measuring spatial autocorrelation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./exercise3.html" rel="next">
<link href="./exercise2.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link active" href="./index.html" aria-current="page"> <i class="bi bi-house" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Mapping and Modelling Geographic Data in R</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./lectures.html"> 
<span class="menu-text">Lectures</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./autocorrelation.html">Measuring spatial autocorrelation</a></li><li class="breadcrumb-item"><a href="./autocorrelation.html">Measuring spatial autocorrelation</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./logo.jpg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./start.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Why R?</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./why.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A Cartographic Answer</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Flavours of R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./base.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Base R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tidyverse</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./program.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Programming</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exercise1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Follow-up exercise</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Mapping the spatial variable</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./themap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The Spatial Variable</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./thematicmaps1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Thematic maps in R (Part 1)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./thematicmaps2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Thematic maps in R (Part 2)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exercise2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Follow-up exercise</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Measuring spatial autocorrelation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./autocorrelation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Measuring spatial autocorrelation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exercise3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Follow-up exercise</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">From Maps to models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gwstats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geographically Weighted Statistics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spregress.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Regression</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">Representations of geographic space</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multilevel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Continuous and discrete views of the spatial variable</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#cols4all" id="toc-cols4all" class="nav-link" data-scroll-target="#cols4all"><code>cols4all</code></a></li>
  <li><a href="#morans-test" id="toc-morans-test" class="nav-link" data-scroll-target="#morans-test">Moran’s test</a>
  <ul class="collapse">
  <li><a href="#creating-a-neighbours-list" id="toc-creating-a-neighbours-list" class="nav-link" data-scroll-target="#creating-a-neighbours-list">Creating a neighbours list</a></li>
  <li><a href="#creating-spatial-weights" id="toc-creating-spatial-weights" class="nav-link" data-scroll-target="#creating-spatial-weights">Creating spatial weights</a></li>
  <li><a href="#calculating-the-morans-value" id="toc-calculating-the-morans-value" class="nav-link" data-scroll-target="#calculating-the-morans-value">Calculating the Moran’s value</a></li>
  </ul></li>
  <li><a href="#moran-plot-and-local-moran-values" id="toc-moran-plot-and-local-moran-values" class="nav-link" data-scroll-target="#moran-plot-and-local-moran-values">Moran plot and local Moran values</a></li>
  <li><a href="#issues-with-the-moran-statistic" id="toc-issues-with-the-moran-statistic" class="nav-link" data-scroll-target="#issues-with-the-moran-statistic">Issues with the Moran statistic</a>
  <ul class="collapse">
  <li><a href="#how-to-define-neighbours" id="toc-how-to-define-neighbours" class="nav-link" data-scroll-target="#how-to-define-neighbours">How to define neighbours?</a></li>
  <li><a href="#how-to-interpet-the-i-statistic" id="toc-how-to-interpet-the-i-statistic" class="nav-link" data-scroll-target="#how-to-interpet-the-i-statistic">How to interpet the I statistic</a></li>
  </ul></li>
  <li><a href="#getis-and-ord-g-statistic" id="toc-getis-and-ord-g-statistic" class="nav-link" data-scroll-target="#getis-and-ord-g-statistic">Getis and Ord G-Statistic</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading">Further Reading</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./autocorrelation.html">Measuring spatial autocorrelation</a></li><li class="breadcrumb-item"><a href="./autocorrelation.html">Measuring spatial autocorrelation</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Measuring spatial autocorrelation</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>We begin by recreating one of the maps from the previous session. You may wish to change your working directory to be the same as previously if it is not already (it should be if you are saving all your files in a Project and begin this session by opening that Project).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>installed <span class="ot">&lt;-</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>]</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tidyverse"</span>, <span class="st">"sf"</span>, <span class="st">"RColorBrewer"</span>, <span class="st">"classInt"</span>, <span class="st">"ggplot2"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>install <span class="ot">&lt;-</span> pkgs[<span class="sc">!</span>(pkgs <span class="sc">%in%</span> installed)]</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(install)) <span class="fu">install.packages</span>(install, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(pkgs, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"municipal.RData"</span>)) <span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/blob/main/MandM/workspaces/municipal.RData?raw=true"</span>, <span class="st">"municipal.RData"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"municipal.RData"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">classIntervals</span>(municipal<span class="sc">$</span>No_schooling, <span class="at">n =</span> <span class="dv">7</span>, <span class="at">style =</span> <span class="st">"jenks"</span>)<span class="sc">$</span>brks</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>municipal<span class="sc">$</span>No_schooling_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(municipal<span class="sc">$</span>No_schooling, brks,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> No_schooling_gp)) <span class="sc">+</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="st">"%"</span>, <span class="at">palette =</span> <span class="st">"RdYlBu"</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Percentage of Population with No Schooling"</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2011 South African Census Data"</span>,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Statistics South Africa"</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Looking at the map, the geographical pattern of the percentage of the population with no schooling appears to be neither random nor uniform. Instead, there is a tendency for similar values to be found in closely located municipalities, creating clusters of red and of blue values (and of yellow too). However, simply ‘eye-balling’ the map to look for patterns isn’t very scientific and it can be very deceptive. You can probably see patterns in the following map, too, but they arise from an entirely <em>random</em> permutation of the previous map’s data – all I have done to generate the map is randomly ‘shuffle’ the data around the locations on the map.</p>
<p><img src="map_permutation.jpg" style="height:200.0%">{width=“200%”}</p>
</section>
<section id="cols4all" class="level2">
<h2 class="anchored" data-anchor-id="cols4all"><code>cols4all</code></h2>
<p>The main focus of today’s session is about assessing whether the patterns we think we see in a map might be random or whether there are clusters of ‘hot spots’ or ‘cold spots’ within it. But, before we get there, it is worth introducing a relatively new package which was published, on <a href="https://cran.r-project.org/" target="_blank">CRAN</a> a few years ago. It is called <a href="https://cran.r-project.org/web/packages/cols4all/index.html" target="_blank">cols4all</a>. It is described as containing “a large collection of palettes, but with the central question: which palettes are good and why?”</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"colorspace"</span> <span class="sc">%in%</span> installed)) <span class="fu">install.packages</span>(<span class="st">"colorspace"</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"cols4all"</span> <span class="sc">%in%</span> installed)) <span class="fu">install.packages</span>(<span class="st">"cols4all"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(cols4all)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If we now activate its dashboard, we can learn a lot about different colour palettes and whether, for example, they are colour-blind friendly (try opening in browser if the dashboard does not load properly but that option appears).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c4a_gui</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>That may generate a message saying <span class="math inline">\(install.packages(c("shinyjs", "kableExtra", "colorblindcheck", "plotly"))\)</span>, in which case, do so, and try <code>c4a_gui()</code> again.</p>
<p><img src="cols4all.png" style="height:200.0%">{width=“200%”}</p>
<p>We can discover, for example, that the diverging palette <code>blue_red3</code> in the <code>hcl</code> series goes from blue to red and is colour-blind friendly. Let’s update the previous map, using <code>cols4all</code> to select the palette and keeping in mind that the fill colour is determined from the variable <code>municipal$No_schooling_gp</code>, which is a discrete (categorical) factor (use <code>class(municipal$No_schooling_gp)</code> to confirm this). You may need to close the dashboard, above, before you can proceed by hitting the <code>esc</code> key after clicking in the R Console. Note the use of the <code>scale_fill_discrete_c4a_cat()</code> function in the <code>ggplot</code> code below – which reads <strong>scale</strong> the <strong>fill</strong> colours of the map using their <strong>discrete</strong> categories and a cols4all (<strong>c4a</strong>) colour category, which is the palette, <code>"hcl.blue_red3"</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> No_schooling_gp)) <span class="sc">+</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete_c4a_cat</span>(<span class="at">name =</span> <span class="st">"%"</span>, <span class="at">palette =</span> <span class="st">"hcl.blue_red3"</span>) <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Percentage of Population with No Schooling"</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2011 South African Census Data"</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Statistics South Africa"</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The principle is very similar if, for example, we want to use <code>by_gu_yl</code> from the <code>kovesi</code> series to apply a diverging palette to the continuous variable <code>No_schooling</code>, with the middle colour of the palette set at the median of the variable.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> No_schooling)) <span class="sc">+</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_continuous_c4a_div</span>(<span class="at">name =</span> <span class="st">"%"</span>, <span class="at">palette =</span> <span class="st">"kovesi.bu_gy_yl"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">mid =</span> <span class="fu">median</span>(municipal<span class="sc">$</span>No_schooling),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                                <span class="at">n.breaks =</span> <span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Percentage of Population with No Schooling"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2011 South African Census Data"</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Statistics South Africa"</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="morans-test" class="level2">
<h2 class="anchored" data-anchor-id="morans-test">Moran’s test</h2>
<p>The classic way of quantifying how similar places are to their neighbours is to calculate the Moran’s statistic. It is a measure of spatial autocorrelation – of how much the values of a variable exhibit spatial clustering of alike values (positive spatial autocorrelation) or of ‘opposite’ values (negative spatial autocorrelation: like the black-white of a chess board, for example). We can calculate this statistic in R using the <a href="https://cran.r-project.org/web/packages/spdep/index.html" target="_blank">spdep</a> package. You may recall that that is a problem with the object (the map) <code>municipal</code> because of an invalid geometry (see previous session and try <code>which(!st_is_valid(municipal))</code> to confirm). We were able to partially ‘fix’ this by changing its coordinate reference system.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"spdep"</span> <span class="sc">%in%</span> installed)) <span class="fu">install.packages</span>(<span class="st">"spdep"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(spdep)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>municipal <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(municipal, <span class="dv">3857</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="creating-a-neighbours-list" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-neighbours-list">Creating a neighbours list</h3>
<p>If the purpose of a Moran’s test is to quantify how similar places are to their neighbours, then the first step is to define neighbours. How to do so isn’t necessarily obvious. Think about if I asked you to identify your neighbours. Would it just be people who lived next door to you? Or within a certain distance of your house? Or those you interact with most? Or…?</p>
<p>In the following example, neighbours are places that share a border (places that are contiguous). Presently it is sufficient for them to meet at a single point, so, if two places happened to be triangular in shape, it would be sufficient for the corners of those triangles to touch to count as neighbours. If the requirement is that they share an edge, not merely a corner, then change the default argument from <code>queen = TRUE</code> to <code>queen = FALSE</code> (see <code>?poly2nb</code> for details).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(municipal)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">The function <code>poly2nb()</code> includes the argument <code>snap</code>, which is the threshold distance boundary points can be apart to still be considered contiguous. It has a default value of <code>sqrt(.Machine$double.eps)</code> which, on my present computer, is equal to 1.4901161^{-8}and is tiny. The problem is it can sometimes be too tiny, not capturing neighbourhood relationships when, for example, there are ‘slivers’ or slight gaps between places. <strong>To avoid this, it can be helpful to replace the default value with a small but still larger distance, e.g.<code>poly2nb(municipal, snap = 1)\</code></strong>. Consider doing this when, for example, you obtain places that appear to have no contiguous neighbours but you know that really they do.</font></p>
<p>The summary of <code>neighbours</code> reveals that, on average, each South African municipality has 5.2 neighbours but it can range from 1 (the 183rd region in the municipal data) to 10 (region 69). The most frequent number is 6.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(neighbours)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Neighbour list object:
Number of regions: 234 
Number of nonzero links: 1216 
Percentage nonzero weights: 2.220761 
Average number of links: 5.196581 
Link number distribution:

 1  2  3  4  5  6  7  8  9 10 
 1  7 24 42 52 69 31  3  4  1 
1 least connected region:
183 with 1 link
1 most connected region:
69 with 10 links</code></pre>
</div>
</div>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">It’s pretty common for the average number of contiguous neighbours to be about 5 and the most frequent number of contiguous neighbours to be 5 or 6. It suggests that the spatial configuration of the places is loosely approximating a hexagonal tessellation, although places on the edge of a study region will typically have fewer contiguous neighbours then those at the centre. But, of course, it isn’t guaranteed.</font></p>
<p>The neighbours of region 69 are,</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>neighbours[[<span class="dv">69</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  60  64  68 139 153 154 157 158 164 165</code></pre>
</div>
</div>
<p>It is instructive to write the list of neighbours to an external neighbours file,</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.nb.gal</span>(neighbours, <span class="st">"neighbours.gal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>… which can then be viewed by using <code>file.edit("neighbours.gal")</code>. The file will look like the below and has a very simple format. The top line say there are 234 regions. Going down, the first of these has 4 neighbours, which are regions 13, 14, 15 and 16. The second has 6 neighbours, which are 3, 4, 8, 18, 189, 234, and so forth. The same information could be encoded in a <span class="math inline">\(234\times234\)</span> matrix, where cell <span class="math inline">\((i, j)\)</span> is given a value of one if <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> are considered neighbours, else zero. The problem with that approach is most of the matrix is sparse (contains nothing but zeros) because most regions are not neighbours. It is quicker and more memory efficient to state which regions are neighbours. The rest, by definition, are not.</p>
<p><img src="neighbours.jpg" class="img-fluid"></p>
<p>These neighbourhood relationships can be viewed as a graph by extracting the coordinate points (<code>st_coordinates()</code>), of the centroids (<code>st_centroid()</code>), of the polygons that represent each municipality, and by using the plot functions for <code>sf</code> (simple features) and <code>nb</code> (neighbours list) objects. Centroids are the centre points of geometric objects. The argument <code>of_largest_polygon = TRUE</code> returns the centroid of the largest (sub)polygon of a MULTIPOLYGON rather than of the whole MULTIPOLYGON, a multipolygon being when one place is represented by multiple polygons such as a mainland and an offshore island (so <code>of_largest_polygon = TRUE</code> would give the point at the centre of the mainland). Setting this argument to true should help the centroid to lie within the boundary of the place, rather than, say, in the sea between the mainland and an island, although it isn’t guaranteed.</p>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">Imagine an area that for some reason is roughly C shaped. Where would the centroid of that be and would it be within the area’s own boundary?</font></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(municipal, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>pts <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(coords)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))  <span class="co"># Remove the margins and white space around the plot</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours, pts, <span class="at">add =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="creating-spatial-weights" class="level3">
<h3 class="anchored" data-anchor-id="creating-spatial-weights">Creating spatial weights</h3>
<p>The neighbourhood list simply defines which places are neighbours. The spatial weights goes a step further and gives a weight to each neighbourhood link. One motivation for doing this is to stop any statistic that is based on a sum across neighbourhood links to be dominated by those neighbourhoods with most neighbours. Moran is one such statistic. Hence, if a region has six neighbours, each of those is given a weight of <span class="math inline">\(1/6\)</span>. If it has four, <span class="math inline">\(1/4\)</span>, and so forth. This is called row-standardisation and is the default style in the conversion of a neighbourhood to a spatial weights list with the function <code>nb2listw()</code>. See <code>?nb2listw</code> for alternative specifications.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Here are the neighbours of and weights for the first region:</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>spweight<span class="sc">$</span>neighbours[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 13 14 15 16</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>spweight<span class="sc">$</span>weights[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.25 0.25 0.25 0.25</code></pre>
</div>
</div>
<section id="dealing-with-places-that-dont-have-any-neighbours" class="level4">
<h4 class="anchored" data-anchor-id="dealing-with-places-that-dont-have-any-neighbours">Dealing with places that don’t have any neighbours</h4>
<p>Not all places have neighbours. Islands, for example, can be separated from the mainland by the sea. If you attempt to create spatial weights using the <code>nb2listw()</code> function with a neighbours list that includes places without neighbours, then you will get an error message:</p>
<p><span style="color:red">Error in nb2listw(neighbours) : Empty neighbour sets found</span>.</p>
<p>There are four ways you can address this problem.</p>
<ul>
<li>Change the <code>snap</code> distance in the function <code>poly2nb()</code> to include, as neighbours, places that appear not to actually share a border but are within a certain threshold distance apart. As noted previously, this can be helpful to deal with digitisation errors – when, for example, there are small gaps between places that do really share a boundary.</li>
<li>Change the way you are defining the neighbourhood relationships – for example, by identifying the <span class="math inline">\(k\)</span> nearest neighbours of each location, regardless of whether they share a border or not (see below). Everywhere has somewhere that is closest to it.</li>
<li>Save the .gal file using <code>write.nb.gal()</code> and then manually edit it to make any connections you wish to between places. You can read the revised version back into R using the function <code>read.gal()</code> – see <code>?read.gal()</code>.</li>
<li>Leave it as it, with some places not having any neighbours, but specify the argument <code>zero.policy = TRUE</code> in <code>nb2listw</code> so it allows empty sets. For example, <code>spweight &lt;- nb2listw(neighbours, zero.policy = TRUE)</code>. Other related functions will also need <code>zero.policy = TRUE</code> to be included, such as <code>moran.test()</code>, <code>moran.plot()</code> and <code>localmoran()</code>.</li>
</ul>
<p>Presently, however, this is not an issue because none of the South African municipalities are without a contiguous neighbour.</p>
</section>
</section>
<section id="calculating-the-morans-value" class="level3">
<h3 class="anchored" data-anchor-id="calculating-the-morans-value">Calculating the Moran’s value</h3>
<p>To recap: we began with a definition of neighbours based on contiguity. We then row-standardised those weights to generate the spatial weights. With those we can now run a Moran’s test to measure the strength of spatial autocorrelation between neighbours in the <code>municipal$No_schooling</code> variable.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>moran <span class="ot">&lt;-</span> <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, spweight)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>moran</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Moran I test under randomisation

data:  municipal$No_schooling  
weights: spweight    

Moran I statistic standard deviate = 14.014, p-value &lt; 2.2e-16
alternative hypothesis: greater
sample estimates:
Moran I statistic       Expectation          Variance 
      0.576702139      -0.004291845       0.001718747 </code></pre>
</div>
</div>
<p>The Moran statistic is 0.577 and the 95% confidence interval is,</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(moran<span class="sc">$</span>estimate[<span class="dv">1</span>]  <span class="sc">+</span> z <span class="sc">*</span> <span class="fu">sqrt</span>(moran<span class="sc">$</span>estimate[<span class="dv">3</span>]), <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.495 0.658</code></pre>
</div>
</div>
<p>Since the confidence interval does not include the expected value of -0.004, we can conclude that there is statistically significant positive autocorrelation in the variables – municipalities with higher percentages of no schooling tend to be surrounded by other municipalities with the same. Similarly, low values tend to be surrounded by other ones that are low.</p>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">The expected value is very close to zero so what we are <em>almost</em> saying is that because the confidence interval does not span zero so there is evidence of positive spatial autocorrelation. Although this is quite close to being true, to actually be correct would require the expected value of the statistic to be zero when there is no spatial autocorrelation. It isn’t. It is presently -0.004 and approaches zero as the number of observations increases: <span class="math inline">\(E(I) = -1 / (n - 1)\)</span>, where <span class="math inline">\(n\)</span> is the number of observations.</font></p>
</section>
</section>
<section id="moran-plot-and-local-moran-values" class="level2">
<h2 class="anchored" data-anchor-id="moran-plot-and-local-moran-values">Moran plot and local Moran values</h2>
<p>Whilst there is positive spatial autocorrelation in the values overall, not everywhere is surrounded by similar values. The following plot has 4 quadrants marked upon it. The top right indicates places where both they and their average neighbour have above average values of <code>municipal$No_schooling</code>. We can describe these as <strong>high-high</strong> clusters on the map. The bottom left indicates places where they and their average neighbour have below average values. These are <strong>low-low</strong> clusters. Both the high-high and the low-low contribute to positive spatial autocorrelation because, for these, the places and their neighbours display similar values. The two other quadrants do not. In the top left are <strong>low-high</strong> clusters. In the bottom right are <strong>high-low</strong>. There reveal clusters of dissimilar values (negative spatial autocorrelation). In the chart, the high-high and low-low places are more plentiful than the low-high and high-low ones, hence the upwards sloping line of best fit and the positive Moran statistic.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Return the plot margins to their default values in R:</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai=</span><span class="fu">c</span>(<span class="fl">1.02</span>,<span class="fl">0.82</span>,<span class="fl">0.82</span>,<span class="fl">0.42</span>))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">moran.plot</span>(municipal<span class="sc">$</span>No_schooling, spweight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It is straightforward to map which quadrant each place belongs to. First, we calculate the <strong>local</strong> Moran statistics proposed by <a href="https://onlinelibrary.wiley.com/doi/10.1111/j.1538-4632.1995.tb00338.x" target="_blank">Anselin (1995)</a>. <strong>A local statistic is one that applies to a subspace of the map, whereas a global statistic is a summary measure for the whole map.</strong> Anselin showed that the (global) Moran statistic can be decomposed into a series of local Moran values, each measuring how similar each place is (individually) to its neighbours. There are 234 municipalities in the data so there will be 234 local Moran values too.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>localm <span class="ot">&lt;-</span> <span class="fu">localmoran</span>(municipal<span class="sc">$</span>No_schooling, spweight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Usefully, if we look at the attributes of <code>localm</code>, we discover an attribute named <code>quadr</code> which contains what we want and which can be mapped.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(<span class="fu">attributes</span>(localm))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "dim"      "dimnames" "call"     "class"    "quadr"   </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">attr</span>(localm, <span class="st">"quadr"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      mean   median    pysal
1 Low-High Low-High Low-High
2  Low-Low  Low-Low  Low-Low
3  Low-Low  Low-Low  Low-Low
4 High-Low High-Low High-Low
5  Low-Low  Low-Low  Low-Low
6  Low-Low  Low-Low  Low-Low</code></pre>
</div>
</div>
<p>In fact, it includes three different versions of what we might want, the differences being due to which average “low” and “high” are defined by (see the text below the section Value in <code>?localmoran</code> for more details). Let’s now map one of them, still using the <code>cols4all</code> package to select a colour palette.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>quadr <span class="ot">&lt;-</span> <span class="fu">attr</span>(localm, <span class="st">"quadr"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> quadr<span class="sc">$</span>median)) <span class="sc">+</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete_c4a_cat</span>(<span class="at">name =</span> <span class="st">"%"</span>, <span class="at">palette =</span> <span class="st">"parks.charmonix"</span>) <span class="sc">+</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Local Moran value groups"</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with No Schooling"</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Unfortunately, the resulting map is somewhat misleading because not all of the local Moran values are statistically significant and some of the various high-high, low-low, etc. pairings my be only trivially alike or dissimilar. Looking at the top of the local Moran data suggests a way of isolating those that are statistically significant and is adopted in the following map.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(localm, <span class="at">n =</span> <span class="dv">3</span>)   <span class="co"># The p-values are in column 5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          Ii          E.Ii     Var.Ii       Z.Ii Pr(z != E(Ii))
1 -0.1260406 -0.0055341954 0.31779548 -0.2137648      0.8307305
2  0.1064341 -0.0020006564 0.07619128  0.3928401      0.6944376
3  0.1402600 -0.0003160278 0.01205565  1.2803122      0.2004354</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the 'quadrants' for insignificant values to NA</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>quadr <span class="ot">&lt;-</span> <span class="fu">attr</span>(localm, <span class="st">"quadr"</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>quadr[localm[,<span class="dv">5</span>] <span class="sc">&gt;</span> <span class="fl">0.05</span> <span class="sc">|</span> <span class="fu">is.na</span>(localm[,<span class="dv">5</span>]), ] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> quadr<span class="sc">$</span>median)) <span class="sc">+</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete_c4a_cat</span>(<span class="at">name =</span> <span class="st">"%"</span>, <span class="at">palette =</span> <span class="st">"parks.charmonix"</span>,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Statistically significant local Moran value groups"</span>,</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with No Schooling"</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Arguably, this new map may still not apply a strict enough definition of statistical significance because the issue of repeat testing has not been tackled. Remember, there are 234 places, 234 local Moran values and therefore 234 tests of significance. Essentially the issue is if we test often enough, then it is hardly surprising if some values emerge as ‘significant’. It’s a bit like a fishing trip where we keep casting until we finally catch something.</p>
<p>The p-values can be adjusted for this using R’s <code>p.adjust()</code> function. The following example uses a false discovery rate method (<code>method = fdr</code>) but other alternatives include <code>method = bonferroni</code>. A question is whether this is now <em>too</em> strict given that there are not 234 independent tests. Rather, the data have overlapping geographies (places share neighbours) as well as spatial dependencies.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>quadr <span class="ot">&lt;-</span> <span class="fu">attr</span>(localm, <span class="st">"quadr"</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>quadr[<span class="fu">p.adjust</span>(localm[,<span class="dv">5</span>], <span class="at">method =</span> <span class="st">"fdr"</span>) <span class="sc">&gt;</span> <span class="fl">0.05</span> <span class="sc">|</span> <span class="fu">is.na</span>(localm[,<span class="dv">5</span>]), ] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># There is now a problem in that only 2 of the 4 categories remain,</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># which are Low-Low and High-High:</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(quadr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        mean    median     pysal
1       &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;
68   Low-Low   Low-Low   Low-Low
92 High-High High-High High-High</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For compatibility with the previous map, I extract its palette</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c4a</span>(<span class="st">"parks.charmonix"</span>, <span class="dv">4</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>pal</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "#008FF8" "#B6AA0D" "#E2C2A2" "#E23B0E"</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># and then only use the first and fourth of those colours in the new map:</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> quadr<span class="sc">$</span>median)) <span class="sc">+</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"%"</span>, <span class="at">type =</span> pal[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>)], <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Statistically significant (p-adjusted) local Moran value groups"</span>,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with No Schooling"</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="issues-with-the-moran-statistic" class="level2">
<h2 class="anchored" data-anchor-id="issues-with-the-moran-statistic">Issues with the Moran statistic</h2>
<section id="how-to-define-neighbours" class="level3">
<h3 class="anchored" data-anchor-id="how-to-define-neighbours">How to define neighbours?</h3>
<section id="n-order-contiguity" class="level4">
<h4 class="anchored" data-anchor-id="n-order-contiguity">n-order contiguity</h4>
<p>Any statistic that includes spatial weights is dependent upon how those weights are defined. How, then, to decide which places are neighbours. The calculations above use first order contiguity – places that share a boundary – but we could extend that definition to include neighbours of neighbours, or more:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">nblag</span>(neighbours, <span class="at">maxlag =</span> <span class="dv">2</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))   <span class="co"># Plot graphics in a 1 row by 2 column grid</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"First order contiguity"</span>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours[[<span class="dv">1</span>]], pts, <span class="at">add =</span> T)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"Second order contiguity"</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours[[<span class="dv">2</span>]], pts, <span class="at">add =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Changing the definition of neighbours does, of course, change the value of the Moran statistic and it will change the local Moran values too.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(neighbours, \(x) {</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nb2listw</span>(x) <span class="sc">%&gt;%</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, .) <span class="ot">-&gt;</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    moran</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  moran<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
Moran I statistic 
        0.5767021 

[[2]]
Moran I statistic 
        0.3890747 </code></pre>
</div>
</div>
<p>In passing, if you remember the discussion around piping and the differences between <code>%&gt;%</code> and <code>|&gt;</code> back when we were looking at ‘Flavours of R’ and `Tidyverse’ then you may recall how the following code is equivalent to the above but is more ‘clunky’:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(neighbours, \(x) {</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nb2listw</span>(x) <span class="sc">|&gt;</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    (\(y) <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, y))() <span class="ot">-&gt;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    moran</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  moran<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
Moran I statistic 
        0.5767021 

[[2]]
Moran I statistic 
        0.3890747 </code></pre>
</div>
</div>
</section>
<section id="k-nearest-neighbours" class="level4">
<h4 class="anchored" data-anchor-id="k-nearest-neighbours">k nearest neighbours</h4>
<p>There is no particular reason to stick with a contiguity-based definition of neighbours. We could, for example, look for the <span class="math inline">\(k\)</span> nearest neighbours (or, more precisely, the <span class="math inline">\(k\)</span> nearest centroids to the centroid of each place), as in the two examples below.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(municipal, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(coords, <span class="at">k =</span> <span class="dv">5</span>))</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"Five nearest neighbours"</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours, pts, <span class="at">add =</span> T)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(coords, <span class="at">k =</span> <span class="dv">10</span>))</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"Ten nearest neighbours"</span>)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours, pts, <span class="at">add =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">The function <code>knearneigh()</code> contains the default argument, <code>longlat = NULL</code>. It should be ok not to change this here to <code>longlat = TRUE</code> because it ought to pick this up from <code>coords</code>’s coordinate reference system. If you suspect it isn’t or if <code>coords</code> is simply a matrix of point coordinates, not an explicitly spatial object, change the default argument to <code>longlat = TRUE</code>.</font></p>
<p>We can, if we wish, run through all the possible values of <span class="math inline">\(k\)</span>, from <span class="math inline">\(1\)</span> to <span class="math inline">\(k_{max} = (n - 1)\)</span> where <span class="math inline">\(n\)</span> is the number of municipalities, and consider the Moran statistics that they generate. The resulting chart shows that the statistic is highly dependent on the scale of the analysis: as <span class="math inline">\(k\)</span> increases, neighbourhood relationships extend over an increasing portion of the map, and the statistic tends to decline. It declines because nearby places tend to have similar values whereas those that are further away introduce more variation because of the spatial heterogeneity across the map. This is an empirical example of Tobler’s first ‘law’ of geography in action: “everything is related to everything else, but near things are more related than distant things.”</p>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">The code would generate a lot of warning messages, warning you that <span class="math inline">\(k\)</span> has become a large subset of all <span class="math inline">\(n\)</span>. However, I have suppressed them by wrapping <code>knearneigh()</code> in the <code>suppressWarnings()</code> function.</font></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(municipal)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>I <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span> (n<span class="dv">-1</span>), \(k) {</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(<span class="fu">knearneigh</span>(coords, k)) <span class="sc">|&gt;</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">knn2nb</span>() <span class="sc">|&gt;</span>       <span class="co"># I am mixing my</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nb2listw</span>() <span class="sc">%&gt;%</span>    <span class="co"># pipes here (deliberately!)</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, .) <span class="ot">-&gt;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    moran</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  moran<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">k =</span> <span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>), <span class="at">I =</span> I), <span class="fu">aes</span>(<span class="at">x =</span> k, <span class="at">y =</span> I)) <span class="sc">+</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Moran statistic"</span>) <span class="sc">+</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="ot">-&gt;</span> g</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>g</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In principle the chart could be used to identify an ‘optimal’ value of <span class="math inline">\(k\)</span>. Unfortunately, the present case offers few clues as to what that optimal value should be. We could use the inflection point of the curve, based on <a href="https://cran.r-project.org/web/packages/inflection/vignettes/inflectionMissionImpossible.html" target="_blank">this tutorial</a>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"inflection"</span> <span class="sc">%in%</span> installed)) <span class="fu">install.packages</span>(<span class="st">"inflection"</span>,</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(inflection)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span> (n<span class="dv">-1</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="fu">check_curve</span>(k, I)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$ctype
[1] "convex_concave"

$index
[1] 0</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>infl_pt <span class="ot">&lt;-</span> <span class="fu">bese</span>(k, I, <span class="at">index =</span> <span class="dv">0</span>)<span class="sc">$</span>iplast</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">The inflection point is at k = "</span>, infl_pt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
The inflection point is at k =  142 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> infl_pt, <span class="at">linetype =</span> <span class="st">"dotted"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The result has correctly identified where the curve turns and you could reasonably argue that this is a good value of <span class="math inline">\(k\)</span> <strong>to avoid</strong> given the Moran’s statistic is higher for values of <span class="math inline">\(k\)</span> either side of it. However, eliminating one value from the choice set still leaves a lot of others to choose from!</p>
<p>We could also try selecting based on seeking to avoid a sharp decrease in the Moran statistic for an increase in <span class="math inline">\(k\)</span> by one. The sharpest fall comes by changing from <span class="math inline">\(k = 3\)</span> to <span class="math inline">\(k = 4\)</span> (the function <code>diff()</code> in the code chunk below calculates the difference between the value of one number in a vector and the next number to its right in that same vector):</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="fu">diff</span>(I)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># It's really diff(I) / diff(k) that should be calculated but diff(k) = 1 in all cases here</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>max_fall <span class="ot">&lt;-</span> k[<span class="fu">which.min</span>(slope)]</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">The greatest fall in the Moran value is between k = "</span>,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    max_fall, <span class="st">"and k = "</span>, max_fall <span class="sc">+</span> <span class="dv">1</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
The greatest fall in the Moran value is between k =  3 and k =  4 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> max_fall, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This shows that the ‘cost’ in increasing from <span class="math inline">\(k = 3\)</span> to <span class="math inline">\(k = 4\)</span> is a <em>relatively</em> big drop in the similarity of the neighbours to each other (it’s still not actually that large though; it’s a drop of 0.032.</p>
<p>We could look at the drop in the Moran statistic over a larger increase in <span class="math inline">\(k\)</span> than one. In the following code chunk the differences are calculated over a span of ten.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="fu">diff</span>(I, <span class="at">lag =</span> <span class="dv">10</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>max_fall <span class="ot">&lt;-</span> k[<span class="fu">which.min</span>(slope)]</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Now the greatest fall in the Moran value is between k = "</span>,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    max_fall, <span class="st">"and k = "</span>, max_fall <span class="sc">+</span> <span class="dv">10</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Now the greatest fall in the Moran value is between k =  1 and k =  11 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(max_fall, max_fall <span class="sc">+</span> <span class="dv">10</span>), <span class="at">linetype =</span> <span class="st">"dotdash"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In either case, what it favours is a small value of <span class="math inline">\(k\)</span>. That is hardly surprising because near neighbours do tend to be more similar – again, that’s <a href="https://en.wikipedia.org/wiki/Tobler%27s_first_law_of_geography" target="_blank">Tobler’s first ‘law’ of geography</a>, which, although not a law at all and with plenty of exceptions, still has a ring of truth to it. Similarities tend to drop away most quickly at fairly short distances and then ‘flatten out’ at greater distances, which is what the curve in the charts above is showing.</p>
<p>So, then, the ‘optimal’ value of <span class="math inline">\(k\)</span> is a small number of nearest neighbours? Not necessarily! When calculating the Moran statistic it is based on the correlation of each location with their neighbours. Imagine there is error in the data; some rogue results. Alternatively, imagine some places are just very unusual. Those errors or outliers will have more influence in the calculation if they are pooled with only a small number of other neighbours, whereas if more neighbours are included so that their unusualness has more chance of being ‘averaged out’. But, if we do choose to include lots of neighbours then we are including ones that are further away and probably less like the location we are correlating them against. We will return to this trade-off when we look at geographically weighted statistics.</p>
<p>How else could we decide on the value of <span class="math inline">\(k\)</span> to select? The p-value for the Moran statistics is not shown in the charts but is least when <span class="math inline">\(k = 200\)</span>. That might be a justification, of sorts, for choosing <span class="math inline">\(k = 200\)</span> but it is splitting hairs somewhat when all but one of the p-values is tiny and well below <span class="math inline">\(p = 0.001\)</span>.</p>
<p>Perhaps the best way is simply to decide on a minimum threshold value for the Moran statistic and use that as the basis for deciding <span class="math inline">\(k\)</span>, but quite how you decide on that threshold is unclear. Here is the maximum value of <span class="math inline">\(k\)</span> for a purely arbitrary threshold of <span class="math inline">\(I &gt; 0.4\)</span>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>threshold_k <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">which</span>(I <span class="sc">&gt;</span> <span class="fl">0.4</span>))</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">The maximum value of k for a Moran value greater than 0.4 is "</span>,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    threshold_k, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
The maximum value of k for a Moran value greater than 0.4 is  21 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> threshold_k, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.4</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="distance-bounds" class="level4">
<h4 class="anchored" data-anchor-id="distance-bounds">Distance bounds</h4>
<p>Other ways of defining neighbours include whether they lie within a lower or upper distance bound of each other: see <code>?dnearneigh</code> and <a href="https://r-spatial.github.io/spdep/articles/nb.html" target="_blank">this vignette on Creating Neighbours</a> for further information.</p>
</section>
</section>
<section id="how-to-interpet-the-i-statistic" class="level3">
<h3 class="anchored" data-anchor-id="how-to-interpet-the-i-statistic">How to interpet the I statistic</h3>
<p>Conceptually, the Moran statistic is easy to understand: it is a (global) measure of the correlation between the values of a variable at a set of locations, and the value of the same variable for those locations’ neighbours.</p>
<p>More simply, it can be thought of as the correlation – the strength of association – between locations and their average neighbour. Keep in mind that it is <em>a</em> measure of correlation, not the more commonly used <a href="https://en.wikipedia.org/wiki/Pearson_correlation_coefficient" target="_blank">Pearson correlation</a>. The difference is evident in the following comparison, with <span class="math inline">\(k = 21\)</span>, where the Moran value is less than two thirds of the Pearson correlation between locations and their average neighbour, where the value for the average neighbour is calculated using <code>last.listw()</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(<span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(coords, <span class="dv">21</span>)))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>pearson <span class="ot">&lt;-</span> <span class="fu">cor</span>(<span class="fu">lag.listw</span>(spweight, municipal<span class="sc">$</span>No_schooling),</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>               municipal<span class="sc">$</span>No_schooling)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>moran <span class="ot">&lt;-</span> <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, spweight)<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">person =</span> pearson, <span class="at">moran =</span> moran, <span class="at">row.names =</span> <span class="st">"correlation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>               person     moran
correlation 0.6643967 0.4013773</code></pre>
</div>
</div>
<p>As <a href="https://us.sagepub.com/en-us/nam/an-introduction-to-r-for-spatial-analysis-and-mapping/book258267" data-targrt="_blank">Brunsdon and Comber</a> note, the value of Moran’s I is not constrained to be in the range from -1 to +1 but changes with the spatial weights matrix. Following, <a href="https://doi.org/10.1111/j.1538-4632.1984.tb00797.x" target="_blank">Jong et al.&nbsp;(1984, p.&nbsp;20)</a>, the extremes for the current spatial weights are,</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">listw2mat</span>(spweight) <span class="sc">%&gt;%</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">range</span>(<span class="fu">eigen</span>((. <span class="sc">+</span> <span class="fu">t</span>(.)) <span class="sc">/</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.420394  1.031139</code></pre>
</div>
</div>
<p>If this is correct then not only is this not in the range -1 to 1, it is not symmetric around the expected (null) value of -0.004.</p>
<p>Given this, it might, perhaps, be regarded as preferable to use the more readily interpreted Pearson correlation between locations and their average neighbour. That correlation, with <span class="math inline">\(k = 21\)</span> nearest neighbours, was calculated above and is 0.664. Whether that figure arose by chance can be assessed using a permutation approach. Given the geography of the South African municipalities, their neighbourhood relations and given the data values, then permuting those values randomly 1000 times allows us to look whether the value of 0.664 is unusual compared to what could arise by chance. Specifically, we look at whether the value is outside of the ‘middle 95%’ of values that have been generated through randomisation. If it is, then it suggests a less than 5-in-100 probability that it arose by chance. (A permutation approach is also available for the global and local Moran statistics: see <code>?moran.mc</code> and <code>?localmoran_perm</code>.)</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(municipal<span class="sc">$</span>No_schooling)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, \(x) {</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample</span>(municipal<span class="sc">$</span>No_schooling, n) <span class="sc">%&gt;%</span> </span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cor</span>(<span class="fu">lag.listw</span>(spweight, .))</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quantile</span>(<span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      2.5%      97.5% 
-0.2181785  0.1471766 </code></pre>
</div>
</div>
<p>Note, however, that there is a subtle but important difference between Moran’s I and the Pearson correlation of the values and their average neighbour. Moran’s I can be used to determine whether, for example, high values of a measurement tend to be surrounded by average neighbours that also have a high value, where the measurement scale is the same for the locations and their average neighbour. What the Pearson correlation is assessing is whether values that are high, <em>relatively speaking, for all the locations</em> are surrounded by average neighbours that have a high value <em>relatively speaking, for all the average neighbours</em>. What they are measuring the correlation of is therefore not the same. The difference can be seen in the formulae below – look at the denominators in each case:</p>
<p><span class="math inline">\(I_{xy} = \dfrac{\sum_{i=1}^{n}(x_i-\bar{x})(y_i-\bar{y})}{\sum_{i=1}^{n}(x_i-\bar{x})^2}\)</span></p>
<p><span class="math inline">\(r_{xy} = \dfrac{\sum_{i=1}^{n}(x_i-\bar{x})(y_i-\bar{y})}{\sqrt{\sum_{i=1}^{n}(x_i-\bar{x})^2}\sqrt{\sum_{i=1}^{n}(y_i-\bar{y})^2}}\)</span></p>
<p>where <span class="math inline">\(I_{xy}\)</span> is the Moran value, <span class="math inline">\(r_{xy}\)</span> is the Pearson value, <span class="math inline">\(x\)</span> is the measured value at each location and <span class="math inline">\(y\)</span> is the (spatially lagged) value for the average neighbour.</p>
</section>
</section>
<section id="getis-and-ord-g-statistic" class="level2">
<h2 class="anchored" data-anchor-id="getis-and-ord-g-statistic">Getis and Ord G-Statistic</h2>
<p>A different method for identifying ‘hot’ or ‘cold spots’ of a variable is provided by the <a href="https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-statistics/h-how-hot-spot-analysis-getis-ord-gi-spatial-stati.htm" target="_blank">G-statistic</a>. As <a href="https://us.sagepub.com/en-us/nam/an-introduction-to-r-for-spatial-analysis-and-mapping/book258267" data-targrt="_blank">Brunsdon and Comber</a> observe, the statistic – which is a local statistic, calculated for each location in turn – is based on the proportion of the total sum of standardised attribute values that are within a threshold distance, <span class="math inline">\(d\)</span>, of each area centroid. Looking at the map below, which is of South African wards (simplified slightly from <a href="https://africaopendata.org/dataset/mdb-wards-2016/resource/d85c5e06-814d-4563-a938-3050e0e6b7e2?inner_span=True" target="_true">this source</a>), we may suspect there are clusters of places with greater percentages of their populations having relatively high incomes and that these are spatial anomalies. Because the percentages are extremely skewed, they have been plotted with a square root transformation applied to the scale of the map (<code>trans = "sqrt"</code>). Note that we are also using a col4all <em>div</em>erging colour palette for a continuous variable.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/blob/main/MandM/workspaces/wards.RData?raw=true"</span>, <span class="st">"wards.RData"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"wards.RData"</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> wards, <span class="fu">aes</span>(<span class="at">fill =</span> High_income)) <span class="sc">+</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">colour =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_continuous_c4a_div</span>(<span class="at">name =</span> <span class="st">"%"</span>, <span class="at">palette =</span> <span class="st">"hcl.blue_yellow2"</span>,</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>                                <span class="at">trans =</span> <span class="st">"sqrt"</span>, <span class="at">mid =</span> <span class="fu">median</span>(wards<span class="sc">$</span>High_income)) <span class="sc">+</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Percentage of Population with income R614401 or greater"</span>,</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2011 South African Census Data"</span>,</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Statistics South Africa"</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The G-statistic requires a binary spatial weights (<code>style = "B"</code>, below), whereby locations either are or are not within the threshold distance of each other. The following has a threshold distance of 20km. Not all of the ward centroids will be within 20km of another which creates situations of zero neighbours. That is tolerated by setting <code>zero.policy = TRUE</code> in the conversion from a neighbours to spatial list.</p>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">As with the function <code>knearneigh()</code>, <code>dnearneigh()</code> has the default argument, <code>longlat = NULL</code>, which should not need changing here to <code>longlat = TRUE</code> because it ought to pick this up from <code>coords</code>’s coordinate reference system. However, don’t take this for granted.</font></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(wards, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(wards<span class="sc">$</span>High_income, spweight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Having calculated the local G values, we can map them, using a manually generated fill palette. The argument <code>na.translate = F</code> removes the NA values from the legend but not from the map, wherein they are shaded white (<code>na.value = "white"</code>). The G values are also standardised z-values, hence values of 1.96 or greater are relatively rate if the assumption that the statistic is Normally distributed is warranted. (If it isn’t, consider using <code>localG_perm</code>.)</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(wards<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp), <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete_c4a_div</span>(<span class="at">name =</span> <span class="st">"G"</span>, <span class="at">palette =</span> <span class="st">"brewer.rd_yl_bu"</span>,</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>                              <span class="at">reverse =</span> <span class="cn">TRUE</span>, <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Local G statistic"</span>,</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with income R614401 or greater"</span>,</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"With a 20km threshold"</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s now add a refinement to the map and, based on what we learned from the previous session, label the cities that appear to contain a hot spot of higher percentages of higher earners. Note the use of <code>st_join()</code> which is a spatial join: it identifies, from geography, which ward the cities are located in and appends the ward data, including the G statistics, to the cities, retaining only those that are in the most significant hot spots. Note that this definition of ‘most significant’ doesn’t address the problem of repeat testing which we also saw with the local Moran statistics.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"remotes"</span> <span class="sc">%in%</span> installed)) <span class="fu">install.packages</span>(<span class="st">"remotes"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"ggsflabel"</span> <span class="sc">%in%</span> installed)) remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"yutannihilation/ggsflabel"</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggsflabel)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"hotosm_zaf_populated_places_points.shp"</span>)) {</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/blob/main/MandM/boundary%20files/hotosm_zaf_populated_places_points_shp.zip?raw=true"</span>,</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>              <span class="st">"cities.zip"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unzip</span>(<span class="st">"cities.zip"</span>)</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(<span class="st">"hotosm_zaf_populated_places_points.shp"</span>) <span class="sc">|&gt;</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(place <span class="sc">==</span> <span class="st">"city"</span>) <span class="sc">|&gt;</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(wards) <span class="sc">|&gt;</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(localG <span class="sc">&gt;</span> <span class="fl">3.29</span>) <span class="ot">-&gt;</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>  cities</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a><span class="fu">last_plot</span>() <span class="sc">+</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_label_repel</span>(<span class="at">data =</span> cities,</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">aes</span>(<span class="at">label =</span> name), <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>                      <span class="at">max.overlaps =</span> <span class="dv">20</span>,</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>                      <span class="at">force =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The results are dependent on the distance threshold defining which places are or are not neighbours. Here are the results with a distance threshold of 100km.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(wards<span class="sc">$</span>High_income, spweight)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>          <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(wards<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp), <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete_c4a_div</span>(<span class="at">name =</span> <span class="st">"G"</span>, <span class="at">palette =</span> <span class="st">"brewer.rd_yl_bu"</span>,</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>                              <span class="at">reverse =</span> <span class="cn">TRUE</span>, <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Local G statistic"</span>,</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with income R614401 or greater"</span>,</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"With a 100km threshold"</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_label_repel</span>(<span class="at">data =</span> cities,</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">aes</span>(<span class="at">label =</span> name), <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>                      <span class="at">max.overlaps =</span> <span class="dv">20</span>,</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>                      <span class="at">force =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>This session has been about identifying and quantifying spatial clustering in data, using a combination of ‘global’ (whole map) and local statistics; specifically, Moran’s I, its local equivalent, the local Moran values, and the Getis-Ord G statistic. These statistics are dependent on the spatial weights matrix used in their calculation, which does, unfortunately, create something of a vicious circle: ideally that matrix would be calibrated to the spatial patterns evident in the data but those patterns are only measured and quantified once the weights matrix has been specified. For example, we could, in principle, use Moran’s I to measure the spatial autocorrelation and select the weights matrix accordingly. However, we need the spatial weights matrix to calculate Moran’s I. One option is to take the view that looking at the patterns at a range of scales is itself revealing so choose lots of bandwidths, not just one, and treat it as a multiscale analysis, as in the following.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sets the threshold distance from 20 to 180km in intervals of 20</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="co"># I chose 9 distances because they can be shown in a 3 x 3 grid of maps</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">20</span>, <span class="at">by =</span> <span class="dv">20</span>, <span class="at">length.out =</span> <span class="dv">9</span>)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the G statistics for each distance and save them</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="co"># as a list of sf features (maps)</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(wards, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>maps <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(d, \(x) {</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, x)</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>    spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    wards<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(wards<span class="sc">$</span>High_income, spweight)</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>    wards<span class="sc">$</span>distance <span class="ot">&lt;-</span> x</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(wards)</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind the maps together into a single object to be used</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a><span class="co"># for the faceting in ggplot2</span></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>maps <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, maps)</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(maps<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>          <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(maps<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>maps<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(maps<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a><span class="co"># This function is used with the labeller argument in the</span></span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a><span class="co"># facet_wrap function to customise the title of each sub-plot</span></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>facet_labels <span class="ot">&lt;-</span> \(x) <span class="fu">paste0</span>(x, <span class="st">"km radius"</span>)</span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> maps, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp)) <span class="sc">+</span></span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete_c4a_div</span>(<span class="at">name =</span> <span class="st">"G"</span>, <span class="at">palette =</span> <span class="st">"brewer.rd_yl_bu"</span>,</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>                              <span class="at">reverse =</span> <span class="cn">TRUE</span>, <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> distance, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">distance =</span> facet_labels)) <span class="sc">+</span></span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="further-reading" class="level2">
<h2 class="anchored" data-anchor-id="further-reading">Further Reading</h2>
<p><img src="bookcover.jpg" class="img-fluid" width="100"></p>
<p>Chapters 7 and 8 of <a href="https://www.paulamoraga.com/book-spatial/index.html" target="_blank">Spatial Data Science with Applications in R</a> by Paula Moraga.</p>
<p><img src="spatial_regression_models.jpg" class="img-fluid" width="100"></p>
<p>Chapter 2 of <a href="https://uk.sagepub.com/en-gb/eur/spatial-regression-models-for-the-social-sciences/book258546">Spatial Regression Models for the Social Sciences</a> by Guangqing Chi and Jun Zhu is recommended. For University of Bristol students, it is available to view as an eBook <a href="https://bris.on.worldcat.org/oclc/1106114802">here</a>.</p>
<p><img src="Rspatial.jpg" class="img-fluid" width="100"></p>
<p>Chapter 8 on Localised Spatial Analysis in <a href="https://us.sagepub.com/en-us/nam/an-introduction-to-r-for-spatial-analysis-and-mapping/book258267" target="_blank">An Introduction to R for Spatial Analysis &amp; Mapping</a> by Chris Brunsdon and Lex Comber.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./exercise2.html" class="pagination-link" aria-label="Follow-up exercise">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Follow-up exercise</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./exercise3.html" class="pagination-link" aria-label="Follow-up exercise">
        <span class="nav-page-text">Follow-up exercise</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb70" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Measuring spatial autocorrelation"</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>installed <span class="ot">&lt;-</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>]</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tidyverse"</span>, <span class="st">"proxy"</span>, <span class="st">"sf"</span>, <span class="st">"RColorBrewer"</span>, <span class="st">"classInt"</span>, <span class="st">"ggplot2"</span>, <span class="st">"sfdep"</span>, <span class="st">"remotes"</span>,</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>              <span class="st">"inflection"</span>, <span class="st">"colorspace"</span>, <span class="st">"cols4all"</span>)</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>install <span class="ot">&lt;-</span> pkgs[<span class="sc">!</span>(pkgs <span class="sc">%in%</span> installed)]</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(install)) <span class="fu">install.packages</span>(install, <span class="at">dependencies =</span> <span class="cn">TRUE</span>, <span class="at">repos =</span> <span class="st">"https://cloud.r-project.org"</span>)</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>We begin by recreating one of the maps from the previous session. You may wish to change your working directory to be the same as previously if it is not already (it should be if you are saving all your files in a Project and begin this session by opening that Project).</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>installed <span class="ot">&lt;-</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>]</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tidyverse"</span>, <span class="st">"sf"</span>, <span class="st">"RColorBrewer"</span>, <span class="st">"classInt"</span>, <span class="st">"ggplot2"</span>)</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>install <span class="ot">&lt;-</span> pkgs[<span class="sc">!</span>(pkgs <span class="sc">%in%</span> installed)]</span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(install)) <span class="fu">install.packages</span>(install, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(pkgs, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>))</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"municipal.RData"</span>)) <span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/blob/main/MandM/workspaces/municipal.RData?raw=true"</span>, <span class="st">"municipal.RData"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"municipal.RData"</span>)</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">classIntervals</span>(municipal<span class="sc">$</span>No_schooling, <span class="at">n =</span> <span class="dv">7</span>, <span class="at">style =</span> <span class="st">"jenks"</span>)<span class="sc">$</span>brks</span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>municipal<span class="sc">$</span>No_schooling_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(municipal<span class="sc">$</span>No_schooling, brks,</span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> No_schooling_gp)) <span class="sc">+</span></span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="st">"%"</span>, <span class="at">palette =</span> <span class="st">"RdYlBu"</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Percentage of Population with No Schooling"</span>,</span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2011 South African Census Data"</span>,</span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Statistics South Africa"</span></span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a>Looking at the map, the geographical pattern of the percentage of the population with no schooling appears to be neither random nor uniform. Instead, there is a tendency for similar values to be found in closely located municipalities, creating clusters of red and of blue values (and of yellow too). However, simply 'eye-balling' the map to look for patterns isn't very scientific and it can be very deceptive. You can probably see patterns in the following map, too, but they arise from an entirely *random* permutation of the previous map's data -- all I have done to generate the map is randomly 'shuffle' the data around the locations on the map.</span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a><span class="al">![](map_permutation.jpg)</span>{height="200%"}{width="200%"}</span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a><span class="fu">## `cols4all`</span></span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a>The main focus of today's session is about assessing whether the patterns we think we see in a map might be random or whether there are clusters of 'hot spots' or 'cold spots' within it. But, before we get there, it is worth introducing a relatively new package which was published, on <span class="co">[</span><span class="ot">CRAN</span><span class="co">](https://cran.r-project.org/)</span>{target="_blank"} a few years ago. It is called <span class="co">[</span><span class="ot">cols4all</span><span class="co">](https://cran.r-project.org/web/packages/cols4all/index.html)</span>{target="_blank"}. It is described as containing "a large collection of palettes, but with the central question: which palettes are good and why?"</span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"colorspace"</span> <span class="sc">%in%</span> installed)) <span class="fu">install.packages</span>(<span class="st">"colorspace"</span>,</span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"cols4all"</span> <span class="sc">%in%</span> installed)) <span class="fu">install.packages</span>(<span class="st">"cols4all"</span>,</span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(cols4all)</span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a>If we now activate its dashboard, we can learn a lot about different colour palettes and whether, for example, they are colour-blind friendly (try opening in browser if the dashboard does not load properly but that option appears).</span>
<span id="cb70-71"><a href="#cb70-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-74"><a href="#cb70-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-75"><a href="#cb70-75" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb70-76"><a href="#cb70-76" aria-hidden="true" tabindex="-1"></a><span class="fu">c4a_gui</span>()</span>
<span id="cb70-77"><a href="#cb70-77" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-78"><a href="#cb70-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-79"><a href="#cb70-79" aria-hidden="true" tabindex="-1"></a>That may generate a message saying $install.packages(c("shinyjs", "kableExtra", "colorblindcheck", "plotly"))$, in which case, do so, and try <span class="in">`c4a_gui()`</span> again.</span>
<span id="cb70-80"><a href="#cb70-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-81"><a href="#cb70-81" aria-hidden="true" tabindex="-1"></a><span class="al">![](cols4all.png)</span>{height="200%"}{width="200%"}</span>
<span id="cb70-82"><a href="#cb70-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-83"><a href="#cb70-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-84"><a href="#cb70-84" aria-hidden="true" tabindex="-1"></a>We can discover, for example, that the diverging palette <span class="in">`blue_red3`</span> in the <span class="in">`hcl`</span> series goes from blue to red and is colour-blind friendly. Let's update the previous map, using <span class="in">`cols4all`</span> to select the palette and keeping in mind that the fill colour is determined from the variable <span class="in">`municipal$No_schooling_gp`</span>, which is a discrete (categorical) factor (use <span class="in">`class(municipal$No_schooling_gp)`</span> to confirm this). You may need to close the dashboard, above, before you can proceed by hitting the <span class="in">`esc`</span> key after clicking in the R Console. Note the use of the <span class="in">`scale_fill_discrete_c4a_cat()`</span> function in the <span class="in">`ggplot`</span> code below -- which reads **scale** the **fill** colours of the map using their **discrete** categories and a cols4all (**c4a**) colour category, which is the palette, <span class="in">`"hcl.blue_red3"`</span>.  </span>
<span id="cb70-85"><a href="#cb70-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-88"><a href="#cb70-88" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-89"><a href="#cb70-89" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> No_schooling_gp)) <span class="sc">+</span></span>
<span id="cb70-90"><a href="#cb70-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb70-91"><a href="#cb70-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete_c4a_cat</span>(<span class="at">name =</span> <span class="st">"%"</span>, <span class="at">palette =</span> <span class="st">"hcl.blue_red3"</span>) <span class="sc">+</span></span>
<span id="cb70-92"><a href="#cb70-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb70-93"><a href="#cb70-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb70-94"><a href="#cb70-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb70-95"><a href="#cb70-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb70-96"><a href="#cb70-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Percentage of Population with No Schooling"</span>,</span>
<span id="cb70-97"><a href="#cb70-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2011 South African Census Data"</span>,</span>
<span id="cb70-98"><a href="#cb70-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Statistics South Africa"</span></span>
<span id="cb70-99"><a href="#cb70-99" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb70-100"><a href="#cb70-100" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-101"><a href="#cb70-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-102"><a href="#cb70-102" aria-hidden="true" tabindex="-1"></a>The principle is very similar if, for example, we want to use <span class="in">`by_gu_yl`</span> from the <span class="in">`kovesi`</span> series to apply a diverging palette to the continuous variable <span class="in">`No_schooling`</span>, with the middle colour of the palette set at the median of the variable.</span>
<span id="cb70-103"><a href="#cb70-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-106"><a href="#cb70-106" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-107"><a href="#cb70-107" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> No_schooling)) <span class="sc">+</span></span>
<span id="cb70-108"><a href="#cb70-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb70-109"><a href="#cb70-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_continuous_c4a_div</span>(<span class="at">name =</span> <span class="st">"%"</span>, <span class="at">palette =</span> <span class="st">"kovesi.bu_gy_yl"</span>,</span>
<span id="cb70-110"><a href="#cb70-110" aria-hidden="true" tabindex="-1"></a>                                <span class="at">mid =</span> <span class="fu">median</span>(municipal<span class="sc">$</span>No_schooling),</span>
<span id="cb70-111"><a href="#cb70-111" aria-hidden="true" tabindex="-1"></a>                                <span class="at">n.breaks =</span> <span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb70-112"><a href="#cb70-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb70-113"><a href="#cb70-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb70-114"><a href="#cb70-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb70-115"><a href="#cb70-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb70-116"><a href="#cb70-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Percentage of Population with No Schooling"</span>,</span>
<span id="cb70-117"><a href="#cb70-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2011 South African Census Data"</span>,</span>
<span id="cb70-118"><a href="#cb70-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Statistics South Africa"</span></span>
<span id="cb70-119"><a href="#cb70-119" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb70-120"><a href="#cb70-120" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-121"><a href="#cb70-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-122"><a href="#cb70-122" aria-hidden="true" tabindex="-1"></a><span class="fu">## Moran's test</span></span>
<span id="cb70-123"><a href="#cb70-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-124"><a href="#cb70-124" aria-hidden="true" tabindex="-1"></a>The classic way of quantifying how similar places are to their neighbours is to calculate the Moran's statistic. It is a measure of spatial autocorrelation -- of how much the values of a variable exhibit spatial clustering of alike values (positive spatial autocorrelation) or of 'opposite' values (negative spatial autocorrelation: like the black-white of a chess board, for example). We can calculate this statistic in R using the <span class="co">[</span><span class="ot">spdep</span><span class="co">](https://cran.r-project.org/web/packages/spdep/index.html)</span>{target="_blank"} package. You may recall that that is a problem with the object (the map) <span class="in">`municipal`</span> because of an invalid geometry (see previous session and try <span class="in">`which(!st_is_valid(municipal))`</span> to confirm). We were able to partially 'fix' this by changing its coordinate reference system.</span>
<span id="cb70-125"><a href="#cb70-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-128"><a href="#cb70-128" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-129"><a href="#cb70-129" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"spdep"</span> <span class="sc">%in%</span> installed)) <span class="fu">install.packages</span>(<span class="st">"spdep"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-130"><a href="#cb70-130" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(spdep)</span>
<span id="cb70-131"><a href="#cb70-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-132"><a href="#cb70-132" aria-hidden="true" tabindex="-1"></a>municipal <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(municipal, <span class="dv">3857</span>)</span>
<span id="cb70-133"><a href="#cb70-133" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-134"><a href="#cb70-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-135"><a href="#cb70-135" aria-hidden="true" tabindex="-1"></a><span class="fu">### Creating a neighbours list</span></span>
<span id="cb70-136"><a href="#cb70-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-137"><a href="#cb70-137" aria-hidden="true" tabindex="-1"></a>If the purpose of a Moran's test is to quantify how similar places are to their neighbours, then the first step is to define neighbours. How to do so isn't necessarily obvious. Think about if I asked you to identify your neighbours. Would it just be people who lived next door to you? Or within a certain distance of your house? Or those you interact with most? Or...?</span>
<span id="cb70-138"><a href="#cb70-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-139"><a href="#cb70-139" aria-hidden="true" tabindex="-1"></a>In the following example, neighbours are places that share a border (places that are contiguous). Presently it is sufficient for them to meet at a single point, so, if two places happened to be triangular in shape, it would be sufficient for the corners of those triangles to touch to count as neighbours. If the requirement is that they share an edge, not merely a corner, then change the default argument from <span class="in">`queen = TRUE`</span> to <span class="in">`queen = FALSE`</span> (see <span class="in">`?poly2nb`</span> for details).</span>
<span id="cb70-140"><a href="#cb70-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-143"><a href="#cb70-143" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-144"><a href="#cb70-144" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(municipal)</span>
<span id="cb70-145"><a href="#cb70-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-146"><a href="#cb70-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-147"><a href="#cb70-147" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width="75"}</span>
<span id="cb70-148"><a href="#cb70-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-149"><a href="#cb70-149" aria-hidden="true" tabindex="-1"></a>&lt;font size = 3&gt;The function <span class="in">`poly2nb()`</span> includes the argument <span class="in">`snap`</span>, which is the threshold distance boundary points can be apart to still be considered contiguous. It has a default value of <span class="in">`sqrt(.Machine$double.eps)`</span> which, on my present computer, is equal to <span class="in">`r sqrt(.Machine$double.eps)`</span>and is tiny. The problem is it can sometimes be too tiny, not capturing neighbourhood relationships when, for example, there are 'slivers' or slight gaps between places. **To avoid this, it can be helpful to replace the default value with a small but still larger distance, e.g.`poly2nb(municipal, snap = 1)\`**. Consider doing this when, for example, you obtain places that appear to have no contiguous neighbours but you know that really they do.&lt;/font&gt;</span>
<span id="cb70-150"><a href="#cb70-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-151"><a href="#cb70-151" aria-hidden="true" tabindex="-1"></a>The summary of <span class="in">`neighbours`</span> reveals that, on average, each South African municipality has 5.2 neighbours but it can range from 1 (the 183rd region in the municipal data) to 10 (region 69). The most frequent number is 6.</span>
<span id="cb70-152"><a href="#cb70-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-155"><a href="#cb70-155" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-156"><a href="#cb70-156" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(neighbours)</span>
<span id="cb70-157"><a href="#cb70-157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-158"><a href="#cb70-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-159"><a href="#cb70-159" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width="75"}</span>
<span id="cb70-160"><a href="#cb70-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-161"><a href="#cb70-161" aria-hidden="true" tabindex="-1"></a>&lt;font size = 3&gt;It's pretty common for the average number of contiguous neighbours to be about 5 and the most frequent number of contiguous neighbours to be 5 or 6. It suggests that the spatial configuration of the places is loosely approximating a hexagonal tessellation, although places on the edge of a study region will typically have fewer contiguous neighbours then those at the centre. But, of course, it isn't guaranteed.&lt;/font&gt;</span>
<span id="cb70-162"><a href="#cb70-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-163"><a href="#cb70-163" aria-hidden="true" tabindex="-1"></a>The neighbours of region 69 are,</span>
<span id="cb70-164"><a href="#cb70-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-167"><a href="#cb70-167" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-168"><a href="#cb70-168" aria-hidden="true" tabindex="-1"></a>neighbours[[<span class="dv">69</span>]]</span>
<span id="cb70-169"><a href="#cb70-169" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-170"><a href="#cb70-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-171"><a href="#cb70-171" aria-hidden="true" tabindex="-1"></a>It is instructive to write the list of neighbours to an external neighbours file,</span>
<span id="cb70-172"><a href="#cb70-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-175"><a href="#cb70-175" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-176"><a href="#cb70-176" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb70-177"><a href="#cb70-177" aria-hidden="true" tabindex="-1"></a><span class="fu">write.nb.gal</span>(neighbours, <span class="st">"neighbours.gal"</span>)</span>
<span id="cb70-178"><a href="#cb70-178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-179"><a href="#cb70-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-180"><a href="#cb70-180" aria-hidden="true" tabindex="-1"></a>... which can then be viewed by using <span class="in">`file.edit("neighbours.gal")`</span>. The file will look like the below and has a very simple format. The top line say there are 234 regions. Going down, the first of these has 4 neighbours, which are regions 13, 14, 15 and 16. The second has 6 neighbours, which are 3, 4, 8, 18, 189, 234, and so forth. The same information could be encoded in a $234\times234$ matrix, where cell $(i, j)$ is given a value of one if $i$ and $j$ are considered neighbours, else zero. The problem with that approach is most of the matrix is sparse (contains nothing but zeros) because most regions are not neighbours. It is quicker and more memory efficient to state which regions are neighbours. The rest, by definition, are not.</span>
<span id="cb70-181"><a href="#cb70-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-182"><a href="#cb70-182" aria-hidden="true" tabindex="-1"></a><span class="al">![](neighbours.jpg)</span></span>
<span id="cb70-183"><a href="#cb70-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-184"><a href="#cb70-184" aria-hidden="true" tabindex="-1"></a>These neighbourhood relationships can be viewed as a graph by extracting the coordinate points (<span class="in">`st_coordinates()`</span>), of the centroids (<span class="in">`st_centroid()`</span>), of the polygons that represent each municipality, and by using the plot functions for <span class="in">`sf`</span> (simple features) and <span class="in">`nb`</span> (neighbours list) objects. Centroids are the centre points of geometric objects. The argument <span class="in">`of_largest_polygon = TRUE`</span> returns the centroid of the largest (sub)polygon of a MULTIPOLYGON rather than of the whole MULTIPOLYGON, a multipolygon being when one place is represented by multiple polygons such as a mainland and an offshore island (so <span class="in">`of_largest_polygon = TRUE`</span> would give the point at the centre of the mainland). Setting this argument to true should help the centroid to lie within the boundary of the place, rather than, say, in the sea between the mainland and an island, although it isn't guaranteed.</span>
<span id="cb70-185"><a href="#cb70-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-186"><a href="#cb70-186" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width="75"}</span>
<span id="cb70-187"><a href="#cb70-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-188"><a href="#cb70-188" aria-hidden="true" tabindex="-1"></a>&lt;font size = 3&gt;Imagine an area that for some reason is roughly C shaped. Where would the centroid of that be and would it be within the area's own boundary?&lt;/font&gt;</span>
<span id="cb70-189"><a href="#cb70-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-192"><a href="#cb70-192" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-193"><a href="#cb70-193" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(municipal, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-194"><a href="#cb70-194" aria-hidden="true" tabindex="-1"></a>pts <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(coords)</span>
<span id="cb70-195"><a href="#cb70-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-196"><a href="#cb70-196" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))  <span class="co"># Remove the margins and white space around the plot</span></span>
<span id="cb70-197"><a href="#cb70-197" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>)</span>
<span id="cb70-198"><a href="#cb70-198" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours, pts, <span class="at">add =</span> T)</span>
<span id="cb70-199"><a href="#cb70-199" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-200"><a href="#cb70-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-201"><a href="#cb70-201" aria-hidden="true" tabindex="-1"></a><span class="fu">### Creating spatial weights</span></span>
<span id="cb70-202"><a href="#cb70-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-203"><a href="#cb70-203" aria-hidden="true" tabindex="-1"></a>The neighbourhood list simply defines which places are neighbours. The spatial weights goes a step further and gives a weight to each neighbourhood link. One motivation for doing this is to stop any statistic that is based on a sum across neighbourhood links to be dominated by those neighbourhoods with most neighbours. Moran is one such statistic. Hence, if a region has six neighbours, each of those is given a weight of $1/6$. If it has four, $1/4$, and so forth. This is called row-standardisation and is the default style in the conversion of a neighbourhood to a spatial weights list with the function <span class="in">`nb2listw()`</span>. See <span class="in">`?nb2listw`</span> for alternative specifications.</span>
<span id="cb70-204"><a href="#cb70-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-207"><a href="#cb70-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-208"><a href="#cb70-208" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours)</span>
<span id="cb70-209"><a href="#cb70-209" aria-hidden="true" tabindex="-1"></a><span class="co"># Here are the neighbours of and weights for the first region:</span></span>
<span id="cb70-210"><a href="#cb70-210" aria-hidden="true" tabindex="-1"></a>spweight<span class="sc">$</span>neighbours[[<span class="dv">1</span>]]</span>
<span id="cb70-211"><a href="#cb70-211" aria-hidden="true" tabindex="-1"></a>spweight<span class="sc">$</span>weights[[<span class="dv">1</span>]]</span>
<span id="cb70-212"><a href="#cb70-212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-213"><a href="#cb70-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-214"><a href="#cb70-214" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Dealing with places that don't have any neighbours</span></span>
<span id="cb70-215"><a href="#cb70-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-216"><a href="#cb70-216" aria-hidden="true" tabindex="-1"></a>Not all places have neighbours. Islands, for example, can be separated from the mainland by the sea. If you attempt to create spatial weights using the <span class="in">`nb2listw()`</span> function with a neighbours list that includes places without neighbours, then you will get an error message:</span>
<span id="cb70-217"><a href="#cb70-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-218"><a href="#cb70-218" aria-hidden="true" tabindex="-1"></a>&lt;span style="color:red"&gt;Error in nb2listw(neighbours) : Empty neighbour sets found&lt;/span&gt;.</span>
<span id="cb70-219"><a href="#cb70-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-220"><a href="#cb70-220" aria-hidden="true" tabindex="-1"></a>There are four ways you can address this problem. </span>
<span id="cb70-221"><a href="#cb70-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-222"><a href="#cb70-222" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Change the <span class="in">`snap`</span> distance in the function <span class="in">`poly2nb()`</span> to include, as neighbours, places that appear not to actually share a border but are within a certain threshold distance apart. As noted previously, this can be helpful to deal with digitisation errors -- when, for example, there are small gaps between places that do really share a boundary.</span>
<span id="cb70-223"><a href="#cb70-223" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Change the way you are defining the neighbourhood relationships -- for example, by identifying the $k$ nearest neighbours of each location, regardless of whether they share a border or not (see below). Everywhere has somewhere that is closest to it.</span>
<span id="cb70-224"><a href="#cb70-224" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Save the .gal file using <span class="in">`write.nb.gal()`</span> and then manually edit it to make any connections you wish to between places. You can read the revised version back into R using the function <span class="in">`read.gal()`</span> -- see <span class="in">`?read.gal()`</span>.</span>
<span id="cb70-225"><a href="#cb70-225" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Leave it as it, with some places not having any neighbours, but specify the argument <span class="in">`zero.policy = TRUE`</span> in <span class="in">`nb2listw`</span> so it allows empty sets. For example, <span class="in">`spweight &lt;- nb2listw(neighbours, zero.policy = TRUE)`</span>. Other related functions will also need <span class="in">`zero.policy = TRUE`</span> to be included, such as <span class="in">`moran.test()`</span>, <span class="in">`moran.plot()`</span> and <span class="in">`localmoran()`</span>.</span>
<span id="cb70-226"><a href="#cb70-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-227"><a href="#cb70-227" aria-hidden="true" tabindex="-1"></a>Presently, however, this is not an issue because none of the South African municipalities are without a contiguous neighbour. </span>
<span id="cb70-228"><a href="#cb70-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-229"><a href="#cb70-229" aria-hidden="true" tabindex="-1"></a><span class="fu">### Calculating the Moran's value</span></span>
<span id="cb70-230"><a href="#cb70-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-231"><a href="#cb70-231" aria-hidden="true" tabindex="-1"></a>To recap: we began with a definition of neighbours based on contiguity. We then row-standardised those weights to generate the spatial weights. With those we can now run a Moran's test to measure the strength of spatial autocorrelation between neighbours in the <span class="in">`municipal$No_schooling`</span> variable.</span>
<span id="cb70-232"><a href="#cb70-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-235"><a href="#cb70-235" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-236"><a href="#cb70-236" aria-hidden="true" tabindex="-1"></a>moran <span class="ot">&lt;-</span> <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, spweight)</span>
<span id="cb70-237"><a href="#cb70-237" aria-hidden="true" tabindex="-1"></a>moran</span>
<span id="cb70-238"><a href="#cb70-238" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-239"><a href="#cb70-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-240"><a href="#cb70-240" aria-hidden="true" tabindex="-1"></a>The Moran statistic is <span class="in">`r round(moran$estimate[1], 3)`</span> and the 95% confidence interval is,</span>
<span id="cb70-241"><a href="#cb70-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-244"><a href="#cb70-244" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-245"><a href="#cb70-245" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>)</span>
<span id="cb70-246"><a href="#cb70-246" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(moran<span class="sc">$</span>estimate[<span class="dv">1</span>]  <span class="sc">+</span> z <span class="sc">*</span> <span class="fu">sqrt</span>(moran<span class="sc">$</span>estimate[<span class="dv">3</span>]), <span class="dv">3</span>)</span>
<span id="cb70-247"><a href="#cb70-247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-248"><a href="#cb70-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-249"><a href="#cb70-249" aria-hidden="true" tabindex="-1"></a>Since the confidence interval does not include the expected value of <span class="in">`r round(moran$estimate[2], 3)`</span>, we can conclude that there is statistically significant positive autocorrelation in the variables -- municipalities with higher percentages of no schooling tend to be surrounded by other municipalities with the same. Similarly, low values tend to be surrounded by other ones that are low.</span>
<span id="cb70-250"><a href="#cb70-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-251"><a href="#cb70-251" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width="75"}</span>
<span id="cb70-252"><a href="#cb70-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-253"><a href="#cb70-253" aria-hidden="true" tabindex="-1"></a>&lt;font size = 3&gt;The expected value is very close to zero so what we are *almost* saying is that because the confidence interval does not span zero so there is evidence of positive spatial autocorrelation. Although this is quite close to being true, to actually be correct would require the expected value of the statistic to be zero when there is no spatial autocorrelation. It isn't. It is presently <span class="in">`r round(moran$estimate[2], 3)`</span> and approaches zero as the number of observations increases: $E(I) = -1 / (n - 1)$, where $n$ is the number of observations.&lt;/font&gt;</span>
<span id="cb70-254"><a href="#cb70-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-255"><a href="#cb70-255" aria-hidden="true" tabindex="-1"></a><span class="fu">## Moran plot and local Moran values</span></span>
<span id="cb70-256"><a href="#cb70-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-257"><a href="#cb70-257" aria-hidden="true" tabindex="-1"></a>Whilst there is positive spatial autocorrelation in the values overall, not everywhere is surrounded by similar values. The following plot has 4 quadrants marked upon it. The top right indicates places where both they and their average neighbour have above average values of <span class="in">`municipal$No_schooling`</span>. We can describe these as **high-high** clusters on the map. The bottom left indicates places where they and their average neighbour have below average values. These are **low-low** clusters. Both the high-high and the low-low contribute to positive spatial autocorrelation because, for these, the places and their neighbours display similar values. The two other quadrants do not. In the top left are **low-high** clusters. In the bottom right are **high-low**. There reveal clusters of dissimilar values (negative spatial autocorrelation). In the chart, the high-high and low-low places are more plentiful than the low-high and high-low ones, hence the upwards sloping line of best fit and the positive Moran statistic.</span>
<span id="cb70-258"><a href="#cb70-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-261"><a href="#cb70-261" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-262"><a href="#cb70-262" aria-hidden="true" tabindex="-1"></a><span class="co"># Return the plot margins to their default values in R:</span></span>
<span id="cb70-263"><a href="#cb70-263" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai=</span><span class="fu">c</span>(<span class="fl">1.02</span>,<span class="fl">0.82</span>,<span class="fl">0.82</span>,<span class="fl">0.42</span>))</span>
<span id="cb70-264"><a href="#cb70-264" aria-hidden="true" tabindex="-1"></a><span class="fu">moran.plot</span>(municipal<span class="sc">$</span>No_schooling, spweight)</span>
<span id="cb70-265"><a href="#cb70-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-266"><a href="#cb70-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-267"><a href="#cb70-267" aria-hidden="true" tabindex="-1"></a>It is straightforward to map which quadrant each place belongs to. First, we calculate the **local** Moran statistics proposed by [Anselin (1995)](https://onlinelibrary.wiley.com/doi/10.1111/j.1538-4632.1995.tb00338.x){target="_blank"}. **A local statistic is one that applies to a subspace of the map, whereas a global statistic is a summary measure for the whole map.** Anselin showed that the (global) Moran statistic can be decomposed into a series of local Moran values, each measuring how similar each place is (individually) to its neighbours. There are 234 municipalities in the data so there will be 234 local Moran values too.</span>
<span id="cb70-268"><a href="#cb70-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-271"><a href="#cb70-271" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-272"><a href="#cb70-272" aria-hidden="true" tabindex="-1"></a>localm <span class="ot">&lt;-</span> <span class="fu">localmoran</span>(municipal<span class="sc">$</span>No_schooling, spweight)</span>
<span id="cb70-273"><a href="#cb70-273" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-274"><a href="#cb70-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-275"><a href="#cb70-275" aria-hidden="true" tabindex="-1"></a>Usefully, if we look at the attributes of <span class="in">`localm`</span>, we discover an attribute named <span class="in">`quadr`</span> which contains what we want and which can be mapped. </span>
<span id="cb70-276"><a href="#cb70-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-279"><a href="#cb70-279" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-280"><a href="#cb70-280" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(<span class="fu">attributes</span>(localm))</span>
<span id="cb70-281"><a href="#cb70-281" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">attr</span>(localm, <span class="st">"quadr"</span>))</span>
<span id="cb70-282"><a href="#cb70-282" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-283"><a href="#cb70-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-284"><a href="#cb70-284" aria-hidden="true" tabindex="-1"></a>In fact, it includes three different versions of what we might want, the differences being due to which average "low" and "high" are defined by (see the text below the section Value in <span class="in">`?localmoran`</span> for more details). Let's now map one of them, still using the <span class="in">`cols4all`</span> package to select a colour palette.</span>
<span id="cb70-285"><a href="#cb70-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-288"><a href="#cb70-288" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-289"><a href="#cb70-289" aria-hidden="true" tabindex="-1"></a>quadr <span class="ot">&lt;-</span> <span class="fu">attr</span>(localm, <span class="st">"quadr"</span>)</span>
<span id="cb70-290"><a href="#cb70-290" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> quadr<span class="sc">$</span>median)) <span class="sc">+</span></span>
<span id="cb70-291"><a href="#cb70-291" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb70-292"><a href="#cb70-292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete_c4a_cat</span>(<span class="at">name =</span> <span class="st">"%"</span>, <span class="at">palette =</span> <span class="st">"parks.charmonix"</span>) <span class="sc">+</span></span>
<span id="cb70-293"><a href="#cb70-293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb70-294"><a href="#cb70-294" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb70-295"><a href="#cb70-295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb70-296"><a href="#cb70-296" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Local Moran value groups"</span>,</span>
<span id="cb70-297"><a href="#cb70-297" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with No Schooling"</span></span>
<span id="cb70-298"><a href="#cb70-298" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-299"><a href="#cb70-299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-300"><a href="#cb70-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-301"><a href="#cb70-301" aria-hidden="true" tabindex="-1"></a>Unfortunately, the resulting map is somewhat misleading because not all of the local Moran values are statistically significant and some of the various high-high, low-low, etc. pairings my be only trivially alike or dissimilar. Looking at the top of the local Moran data suggests a way of isolating those that are statistically significant and is adopted in the following map.</span>
<span id="cb70-302"><a href="#cb70-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-305"><a href="#cb70-305" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-306"><a href="#cb70-306" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(localm, <span class="at">n =</span> <span class="dv">3</span>)   <span class="co"># The p-values are in column 5</span></span>
<span id="cb70-307"><a href="#cb70-307" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the 'quadrants' for insignificant values to NA</span></span>
<span id="cb70-308"><a href="#cb70-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-309"><a href="#cb70-309" aria-hidden="true" tabindex="-1"></a>quadr <span class="ot">&lt;-</span> <span class="fu">attr</span>(localm, <span class="st">"quadr"</span>)</span>
<span id="cb70-310"><a href="#cb70-310" aria-hidden="true" tabindex="-1"></a>quadr[localm[,<span class="dv">5</span>] <span class="sc">&gt;</span> <span class="fl">0.05</span> <span class="sc">|</span> <span class="fu">is.na</span>(localm[,<span class="dv">5</span>]), ] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb70-311"><a href="#cb70-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-312"><a href="#cb70-312" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> quadr<span class="sc">$</span>median)) <span class="sc">+</span></span>
<span id="cb70-313"><a href="#cb70-313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb70-314"><a href="#cb70-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete_c4a_cat</span>(<span class="at">name =</span> <span class="st">"%"</span>, <span class="at">palette =</span> <span class="st">"parks.charmonix"</span>,</span>
<span id="cb70-315"><a href="#cb70-315" aria-hidden="true" tabindex="-1"></a>                              <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb70-316"><a href="#cb70-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb70-317"><a href="#cb70-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb70-318"><a href="#cb70-318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb70-319"><a href="#cb70-319" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Statistically significant local Moran value groups"</span>,</span>
<span id="cb70-320"><a href="#cb70-320" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with No Schooling"</span></span>
<span id="cb70-321"><a href="#cb70-321" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-322"><a href="#cb70-322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-323"><a href="#cb70-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-324"><a href="#cb70-324" aria-hidden="true" tabindex="-1"></a>Arguably, this new map may still not apply a strict enough definition of statistical significance because the issue of repeat testing has not been tackled. Remember, there are 234 places, 234 local Moran values and therefore 234 tests of significance. Essentially the issue is if we test often enough, then it is hardly surprising if some values emerge as 'significant'. It's a bit like a fishing trip where we keep casting until we finally catch something.</span>
<span id="cb70-325"><a href="#cb70-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-326"><a href="#cb70-326" aria-hidden="true" tabindex="-1"></a>The p-values can be adjusted for this using R's <span class="in">`p.adjust()`</span> function. The following example uses a false discovery rate method (<span class="in">`method = fdr`</span>) but other alternatives include <span class="in">`method = bonferroni`</span>. A question is whether this is now *too* strict given that there are not 234 independent tests. Rather, the data have overlapping geographies (places share neighbours) as well as spatial dependencies.</span>
<span id="cb70-327"><a href="#cb70-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-330"><a href="#cb70-330" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-331"><a href="#cb70-331" aria-hidden="true" tabindex="-1"></a>quadr <span class="ot">&lt;-</span> <span class="fu">attr</span>(localm, <span class="st">"quadr"</span>)</span>
<span id="cb70-332"><a href="#cb70-332" aria-hidden="true" tabindex="-1"></a>quadr[<span class="fu">p.adjust</span>(localm[,<span class="dv">5</span>], <span class="at">method =</span> <span class="st">"fdr"</span>) <span class="sc">&gt;</span> <span class="fl">0.05</span> <span class="sc">|</span> <span class="fu">is.na</span>(localm[,<span class="dv">5</span>]), ] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb70-333"><a href="#cb70-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-334"><a href="#cb70-334" aria-hidden="true" tabindex="-1"></a><span class="co"># There is now a problem in that only 2 of the 4 categories remain,</span></span>
<span id="cb70-335"><a href="#cb70-335" aria-hidden="true" tabindex="-1"></a><span class="co"># which are Low-Low and High-High:</span></span>
<span id="cb70-336"><a href="#cb70-336" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(quadr)</span>
<span id="cb70-337"><a href="#cb70-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-338"><a href="#cb70-338" aria-hidden="true" tabindex="-1"></a><span class="co"># For compatibility with the previous map, I extract its palette</span></span>
<span id="cb70-339"><a href="#cb70-339" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c4a</span>(<span class="st">"parks.charmonix"</span>, <span class="dv">4</span>)</span>
<span id="cb70-340"><a href="#cb70-340" aria-hidden="true" tabindex="-1"></a>pal</span>
<span id="cb70-341"><a href="#cb70-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-342"><a href="#cb70-342" aria-hidden="true" tabindex="-1"></a><span class="co"># and then only use the first and fourth of those colours in the new map:</span></span>
<span id="cb70-343"><a href="#cb70-343" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> quadr<span class="sc">$</span>median)) <span class="sc">+</span></span>
<span id="cb70-344"><a href="#cb70-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb70-345"><a href="#cb70-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"%"</span>, <span class="at">type =</span> pal[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>)], <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb70-346"><a href="#cb70-346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb70-347"><a href="#cb70-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb70-348"><a href="#cb70-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb70-349"><a href="#cb70-349" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Statistically significant (p-adjusted) local Moran value groups"</span>,</span>
<span id="cb70-350"><a href="#cb70-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with No Schooling"</span></span>
<span id="cb70-351"><a href="#cb70-351" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-352"><a href="#cb70-352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-353"><a href="#cb70-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-354"><a href="#cb70-354" aria-hidden="true" tabindex="-1"></a><span class="fu">## Issues with the Moran statistic</span></span>
<span id="cb70-355"><a href="#cb70-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-356"><a href="#cb70-356" aria-hidden="true" tabindex="-1"></a><span class="fu">### How to define neighbours?</span></span>
<span id="cb70-357"><a href="#cb70-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-358"><a href="#cb70-358" aria-hidden="true" tabindex="-1"></a><span class="fu">#### n-order contiguity</span></span>
<span id="cb70-359"><a href="#cb70-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-360"><a href="#cb70-360" aria-hidden="true" tabindex="-1"></a>Any statistic that includes spatial weights is dependent upon how those weights are defined. How, then, to decide which places are neighbours. The calculations above use first order contiguity -- places that share a boundary -- but we could extend that definition to include neighbours of neighbours, or more:</span>
<span id="cb70-361"><a href="#cb70-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-364"><a href="#cb70-364" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-365"><a href="#cb70-365" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">nblag</span>(neighbours, <span class="at">maxlag =</span> <span class="dv">2</span>)</span>
<span id="cb70-366"><a href="#cb70-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-367"><a href="#cb70-367" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb70-368"><a href="#cb70-368" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))   <span class="co"># Plot graphics in a 1 row by 2 column grid</span></span>
<span id="cb70-369"><a href="#cb70-369" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"First order contiguity"</span>)</span>
<span id="cb70-370"><a href="#cb70-370" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours[[<span class="dv">1</span>]], pts, <span class="at">add =</span> T)</span>
<span id="cb70-371"><a href="#cb70-371" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"Second order contiguity"</span>)</span>
<span id="cb70-372"><a href="#cb70-372" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours[[<span class="dv">2</span>]], pts, <span class="at">add =</span> T)</span>
<span id="cb70-373"><a href="#cb70-373" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-374"><a href="#cb70-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-375"><a href="#cb70-375" aria-hidden="true" tabindex="-1"></a>Changing the definition of neighbours does, of course, change the value of the Moran statistic and it will change the local Moran values too.</span>
<span id="cb70-376"><a href="#cb70-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-379"><a href="#cb70-379" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-380"><a href="#cb70-380" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(neighbours, \(x) {</span>
<span id="cb70-381"><a href="#cb70-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nb2listw</span>(x) <span class="sc">%&gt;%</span></span>
<span id="cb70-382"><a href="#cb70-382" aria-hidden="true" tabindex="-1"></a>    <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, .) <span class="ot">-&gt;</span></span>
<span id="cb70-383"><a href="#cb70-383" aria-hidden="true" tabindex="-1"></a>    moran</span>
<span id="cb70-384"><a href="#cb70-384" aria-hidden="true" tabindex="-1"></a>  moran<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb70-385"><a href="#cb70-385" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb70-386"><a href="#cb70-386" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-387"><a href="#cb70-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-388"><a href="#cb70-388" aria-hidden="true" tabindex="-1"></a>In passing, if you remember the discussion around piping and the differences between <span class="in">`%&gt;%`</span> and <span class="in">`|&gt;`</span> back when we were looking at 'Flavours of R' and <span class="sc">\`</span>Tidyverse' then you may recall how the following code is equivalent to the above but is more 'clunky':</span>
<span id="cb70-389"><a href="#cb70-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-392"><a href="#cb70-392" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-393"><a href="#cb70-393" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(neighbours, \(x) {</span>
<span id="cb70-394"><a href="#cb70-394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nb2listw</span>(x) <span class="sc">|&gt;</span></span>
<span id="cb70-395"><a href="#cb70-395" aria-hidden="true" tabindex="-1"></a>    (\(y) <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, y))() <span class="ot">-&gt;</span></span>
<span id="cb70-396"><a href="#cb70-396" aria-hidden="true" tabindex="-1"></a>    moran</span>
<span id="cb70-397"><a href="#cb70-397" aria-hidden="true" tabindex="-1"></a>  moran<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb70-398"><a href="#cb70-398" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb70-399"><a href="#cb70-399" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-400"><a href="#cb70-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-401"><a href="#cb70-401" aria-hidden="true" tabindex="-1"></a><span class="fu">#### k nearest neighbours</span></span>
<span id="cb70-402"><a href="#cb70-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-403"><a href="#cb70-403" aria-hidden="true" tabindex="-1"></a>There is no particular reason to stick with a contiguity-based definition of neighbours. We could, for example, look for the $k$ nearest neighbours (or, more precisely, the $k$ nearest centroids to the centroid of each place), as in the two examples below.</span>
<span id="cb70-404"><a href="#cb70-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-407"><a href="#cb70-407" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-408"><a href="#cb70-408" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb70-409"><a href="#cb70-409" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb70-410"><a href="#cb70-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-411"><a href="#cb70-411" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(municipal, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-412"><a href="#cb70-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-413"><a href="#cb70-413" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(coords, <span class="at">k =</span> <span class="dv">5</span>))</span>
<span id="cb70-414"><a href="#cb70-414" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"Five nearest neighbours"</span>)</span>
<span id="cb70-415"><a href="#cb70-415" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours, pts, <span class="at">add =</span> T)</span>
<span id="cb70-416"><a href="#cb70-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-417"><a href="#cb70-417" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(coords, <span class="at">k =</span> <span class="dv">10</span>))</span>
<span id="cb70-418"><a href="#cb70-418" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"Ten nearest neighbours"</span>)</span>
<span id="cb70-419"><a href="#cb70-419" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours, pts, <span class="at">add =</span> T)</span>
<span id="cb70-420"><a href="#cb70-420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-421"><a href="#cb70-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-422"><a href="#cb70-422" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width="75"}</span>
<span id="cb70-423"><a href="#cb70-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-424"><a href="#cb70-424" aria-hidden="true" tabindex="-1"></a>&lt;font size = 3&gt;The function <span class="in">`knearneigh()`</span> contains the default argument, <span class="in">`longlat = NULL`</span>. It should be ok not to change this here to <span class="in">`longlat = TRUE`</span> because it ought to pick this up from <span class="in">`coords`</span>'s coordinate reference system. If you suspect it isn't or if <span class="in">`coords`</span> is simply a matrix of point coordinates, not an explicitly spatial object, change the default argument to <span class="in">`longlat = TRUE`</span>.&lt;/font&gt;</span>
<span id="cb70-425"><a href="#cb70-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-426"><a href="#cb70-426" aria-hidden="true" tabindex="-1"></a>We can, if we wish, run through all the possible values of $k$, from $1$ to $k_{max} = (n - 1)$ where $n$ is the number of municipalities, and consider the Moran statistics that they generate. The resulting chart shows that the statistic is highly dependent on the scale of the analysis: as $k$ increases, neighbourhood relationships extend over an increasing portion of the map, and the statistic tends to decline. It declines because nearby places tend to have similar values whereas those that are further away introduce more variation because of the spatial heterogeneity across the map. This is an empirical example of Tobler's first 'law' of geography in action: "everything is related to everything else, but near things are more related than distant things."</span>
<span id="cb70-427"><a href="#cb70-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-428"><a href="#cb70-428" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width="75"}</span>
<span id="cb70-429"><a href="#cb70-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-430"><a href="#cb70-430" aria-hidden="true" tabindex="-1"></a>&lt;font size = 3&gt;The code would generate a lot of warning messages, warning you that $k$ has become a large subset of all $n$. However, I have suppressed them by wrapping <span class="in">`knearneigh()`</span> in the <span class="in">`suppressWarnings()`</span> function.&lt;/font&gt;</span>
<span id="cb70-431"><a href="#cb70-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-434"><a href="#cb70-434" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-435"><a href="#cb70-435" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(municipal)</span>
<span id="cb70-436"><a href="#cb70-436" aria-hidden="true" tabindex="-1"></a>I <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span> (n<span class="dv">-1</span>), \(k) {</span>
<span id="cb70-437"><a href="#cb70-437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(<span class="fu">knearneigh</span>(coords, k)) <span class="sc">|&gt;</span></span>
<span id="cb70-438"><a href="#cb70-438" aria-hidden="true" tabindex="-1"></a>    <span class="fu">knn2nb</span>() <span class="sc">|&gt;</span>       <span class="co"># I am mixing my</span></span>
<span id="cb70-439"><a href="#cb70-439" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nb2listw</span>() <span class="sc">%&gt;%</span>    <span class="co"># pipes here (deliberately!)</span></span>
<span id="cb70-440"><a href="#cb70-440" aria-hidden="true" tabindex="-1"></a>    <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, .) <span class="ot">-&gt;</span></span>
<span id="cb70-441"><a href="#cb70-441" aria-hidden="true" tabindex="-1"></a>    moran</span>
<span id="cb70-442"><a href="#cb70-442" aria-hidden="true" tabindex="-1"></a>  moran<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb70-443"><a href="#cb70-443" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb70-444"><a href="#cb70-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-445"><a href="#cb70-445" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">k =</span> <span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>), <span class="at">I =</span> I), <span class="fu">aes</span>(<span class="at">x =</span> k, <span class="at">y =</span> I)) <span class="sc">+</span></span>
<span id="cb70-446"><a href="#cb70-446" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb70-447"><a href="#cb70-447" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Moran statistic"</span>) <span class="sc">+</span></span>
<span id="cb70-448"><a href="#cb70-448" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="ot">-&gt;</span> g</span>
<span id="cb70-449"><a href="#cb70-449" aria-hidden="true" tabindex="-1"></a>g</span>
<span id="cb70-450"><a href="#cb70-450" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-451"><a href="#cb70-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-452"><a href="#cb70-452" aria-hidden="true" tabindex="-1"></a>In principle the chart could be used to identify an 'optimal' value of $k$. Unfortunately, the present case offers few clues as to what that optimal value should be. We could use the inflection point of the curve, based on <span class="co">[</span><span class="ot">this tutorial</span><span class="co">](https://cran.r-project.org/web/packages/inflection/vignettes/inflectionMissionImpossible.html)</span>{target="_blank"}:</span>
<span id="cb70-453"><a href="#cb70-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-456"><a href="#cb70-456" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-457"><a href="#cb70-457" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"inflection"</span> <span class="sc">%in%</span> installed)) <span class="fu">install.packages</span>(<span class="st">"inflection"</span>,</span>
<span id="cb70-458"><a href="#cb70-458" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-459"><a href="#cb70-459" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(inflection)</span>
<span id="cb70-460"><a href="#cb70-460" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span> (n<span class="dv">-1</span>)</span>
<span id="cb70-461"><a href="#cb70-461" aria-hidden="true" tabindex="-1"></a><span class="fu">check_curve</span>(k, I)</span>
<span id="cb70-462"><a href="#cb70-462" aria-hidden="true" tabindex="-1"></a>infl_pt <span class="ot">&lt;-</span> <span class="fu">bese</span>(k, I, <span class="at">index =</span> <span class="dv">0</span>)<span class="sc">$</span>iplast</span>
<span id="cb70-463"><a href="#cb70-463" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">The inflection point is at k = "</span>, infl_pt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb70-464"><a href="#cb70-464" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> infl_pt, <span class="at">linetype =</span> <span class="st">"dotted"</span>)</span>
<span id="cb70-465"><a href="#cb70-465" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-466"><a href="#cb70-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-467"><a href="#cb70-467" aria-hidden="true" tabindex="-1"></a>The result has correctly identified where the curve turns and you could reasonably argue that this is a good value of $k$ **to avoid** given the Moran's statistic is higher for values of $k$ either side of it. However, eliminating one value from the choice set still leaves a lot of others to choose from!</span>
<span id="cb70-468"><a href="#cb70-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-469"><a href="#cb70-469" aria-hidden="true" tabindex="-1"></a>We could also try selecting based on seeking to avoid a sharp decrease in the Moran statistic for an increase in $k$ by one. The sharpest fall comes by changing from $k = 3$ to $k = 4$ (the function <span class="in">`diff()`</span> in the code chunk below calculates the difference between the value of one number in a vector and the next number to its right in that same vector):</span>
<span id="cb70-470"><a href="#cb70-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-473"><a href="#cb70-473" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-474"><a href="#cb70-474" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="fu">diff</span>(I)</span>
<span id="cb70-475"><a href="#cb70-475" aria-hidden="true" tabindex="-1"></a>  <span class="co"># It's really diff(I) / diff(k) that should be calculated but diff(k) = 1 in all cases here</span></span>
<span id="cb70-476"><a href="#cb70-476" aria-hidden="true" tabindex="-1"></a>max_fall <span class="ot">&lt;-</span> k[<span class="fu">which.min</span>(slope)]</span>
<span id="cb70-477"><a href="#cb70-477" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">The greatest fall in the Moran value is between k = "</span>,</span>
<span id="cb70-478"><a href="#cb70-478" aria-hidden="true" tabindex="-1"></a>    max_fall, <span class="st">"and k = "</span>, max_fall <span class="sc">+</span> <span class="dv">1</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb70-479"><a href="#cb70-479" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> max_fall, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span>
<span id="cb70-480"><a href="#cb70-480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-481"><a href="#cb70-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-482"><a href="#cb70-482" aria-hidden="true" tabindex="-1"></a>This shows that the 'cost' in increasing from $k = 3$ to $k = 4$ is a *relatively* big drop in the similarity of the neighbours to each other (it's still not actually that large though; it's a drop of <span class="in">`r round(abs(min(slope)),3)`</span>.</span>
<span id="cb70-483"><a href="#cb70-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-484"><a href="#cb70-484" aria-hidden="true" tabindex="-1"></a>We could look at the drop in the Moran statistic over a larger increase in $k$ than one. In the following code chunk the differences are calculated over a span of ten.</span>
<span id="cb70-485"><a href="#cb70-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-488"><a href="#cb70-488" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-489"><a href="#cb70-489" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="fu">diff</span>(I, <span class="at">lag =</span> <span class="dv">10</span>)</span>
<span id="cb70-490"><a href="#cb70-490" aria-hidden="true" tabindex="-1"></a>max_fall <span class="ot">&lt;-</span> k[<span class="fu">which.min</span>(slope)]</span>
<span id="cb70-491"><a href="#cb70-491" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Now the greatest fall in the Moran value is between k = "</span>,</span>
<span id="cb70-492"><a href="#cb70-492" aria-hidden="true" tabindex="-1"></a>    max_fall, <span class="st">"and k = "</span>, max_fall <span class="sc">+</span> <span class="dv">10</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb70-493"><a href="#cb70-493" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(max_fall, max_fall <span class="sc">+</span> <span class="dv">10</span>), <span class="at">linetype =</span> <span class="st">"dotdash"</span>)</span>
<span id="cb70-494"><a href="#cb70-494" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-495"><a href="#cb70-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-496"><a href="#cb70-496" aria-hidden="true" tabindex="-1"></a>In either case, what it favours is a small value of $k$. That is hardly surprising because near neighbours do tend to be more similar -- again, that's <span class="co">[</span><span class="ot">Tobler's first 'law' of geography</span><span class="co">](https://en.wikipedia.org/wiki/Tobler%27s_first_law_of_geography)</span>{target="_blank"}, which, although not a law at all and with plenty of exceptions, still has a ring of truth to it. Similarities tend to drop away most quickly at fairly short distances and then 'flatten out' at greater distances, which is what the curve in the charts above is showing.</span>
<span id="cb70-497"><a href="#cb70-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-498"><a href="#cb70-498" aria-hidden="true" tabindex="-1"></a>So, then, the 'optimal' value of $k$ is a small number of nearest neighbours? Not necessarily! When calculating the Moran statistic it is based on the correlation of each location with their neighbours. Imagine there is error in the data; some rogue results. Alternatively, imagine some places are just very unusual. Those errors or outliers will have more influence in the calculation if they are pooled with only a small number of other neighbours, whereas if more neighbours are included so that their unusualness has more chance of being 'averaged out'. But, if we do choose to include lots of neighbours then we are including ones that are further away and probably less like the location we are correlating them against. We will return to this trade-off when we look at geographically weighted statistics.</span>
<span id="cb70-499"><a href="#cb70-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-500"><a href="#cb70-500" aria-hidden="true" tabindex="-1"></a>How else could we decide on the value of $k$ to select? The p-value for the Moran statistics is not shown in the charts but is least when $k = 200$. That might be a justification, of sorts, for choosing $k = 200$ but it is splitting hairs somewhat when all but one of the p-values is tiny and well below $p = 0.001$.</span>
<span id="cb70-501"><a href="#cb70-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-502"><a href="#cb70-502" aria-hidden="true" tabindex="-1"></a>Perhaps the best way is simply to decide on a minimum threshold value for the Moran statistic and use that as the basis for deciding $k$, but quite how you decide on that threshold is unclear. Here is the maximum value of $k$ for a purely arbitrary threshold of $I &gt; 0.4$.</span>
<span id="cb70-503"><a href="#cb70-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-506"><a href="#cb70-506" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-507"><a href="#cb70-507" aria-hidden="true" tabindex="-1"></a>threshold_k <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">which</span>(I <span class="sc">&gt;</span> <span class="fl">0.4</span>))</span>
<span id="cb70-508"><a href="#cb70-508" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">The maximum value of k for a Moran value greater than 0.4 is "</span>,</span>
<span id="cb70-509"><a href="#cb70-509" aria-hidden="true" tabindex="-1"></a>    threshold_k, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb70-510"><a href="#cb70-510" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> threshold_k, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb70-511"><a href="#cb70-511" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.4</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>)</span>
<span id="cb70-512"><a href="#cb70-512" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-513"><a href="#cb70-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-514"><a href="#cb70-514" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Distance bounds</span></span>
<span id="cb70-515"><a href="#cb70-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-516"><a href="#cb70-516" aria-hidden="true" tabindex="-1"></a>Other ways of defining neighbours include whether they lie within a lower or upper distance bound of each other: see <span class="in">`?dnearneigh`</span> and <span class="co">[</span><span class="ot">this vignette on Creating Neighbours</span><span class="co">](https://r-spatial.github.io/spdep/articles/nb.html)</span>{target="_blank"} for further information.</span>
<span id="cb70-517"><a href="#cb70-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-518"><a href="#cb70-518" aria-hidden="true" tabindex="-1"></a><span class="fu">### How to interpet the I statistic</span></span>
<span id="cb70-519"><a href="#cb70-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-520"><a href="#cb70-520" aria-hidden="true" tabindex="-1"></a>Conceptually, the Moran statistic is easy to understand: it is a (global) measure of the correlation between the values of a variable at a set of locations, and the value of the same variable for those locations' neighbours.</span>
<span id="cb70-521"><a href="#cb70-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-522"><a href="#cb70-522" aria-hidden="true" tabindex="-1"></a>More simply, it can be thought of as the correlation -- the strength of association -- between locations and their average neighbour. Keep in mind that it is *a* measure of correlation, not the more commonly used <span class="co">[</span><span class="ot">Pearson correlation</span><span class="co">](https://en.wikipedia.org/wiki/Pearson_correlation_coefficient)</span>{target="_blank"}. The difference is evident in the following comparison, with $k = 21$, where the Moran value is less than two thirds of the Pearson correlation between locations and their average neighbour, where the value for the average neighbour is calculated using <span class="in">`last.listw()`</span>.</span>
<span id="cb70-523"><a href="#cb70-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-526"><a href="#cb70-526" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-527"><a href="#cb70-527" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(<span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(coords, <span class="dv">21</span>)))</span>
<span id="cb70-528"><a href="#cb70-528" aria-hidden="true" tabindex="-1"></a>pearson <span class="ot">&lt;-</span> <span class="fu">cor</span>(<span class="fu">lag.listw</span>(spweight, municipal<span class="sc">$</span>No_schooling),</span>
<span id="cb70-529"><a href="#cb70-529" aria-hidden="true" tabindex="-1"></a>               municipal<span class="sc">$</span>No_schooling)</span>
<span id="cb70-530"><a href="#cb70-530" aria-hidden="true" tabindex="-1"></a>moran <span class="ot">&lt;-</span> <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, spweight)<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb70-531"><a href="#cb70-531" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">person =</span> pearson, <span class="at">moran =</span> moran, <span class="at">row.names =</span> <span class="st">"correlation"</span>)</span>
<span id="cb70-532"><a href="#cb70-532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-533"><a href="#cb70-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-534"><a href="#cb70-534" aria-hidden="true" tabindex="-1"></a>As <span class="co">[</span><span class="ot">Brunsdon and Comber</span><span class="co">](https://us.sagepub.com/en-us/nam/an-introduction-to-r-for-spatial-analysis-and-mapping/book258267)</span>{targrt="_blank"} note, the value of Moran's I is not constrained to be in the range from -1 to +1 but changes with the spatial weights matrix. Following, <span class="co">[</span><span class="ot">Jong et al. (1984, p. 20)</span><span class="co">](https://doi.org/10.1111/j.1538-4632.1984.tb00797.x)</span>{target="_blank"}, the extremes for the current spatial weights are,</span>
<span id="cb70-535"><a href="#cb70-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-538"><a href="#cb70-538" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-539"><a href="#cb70-539" aria-hidden="true" tabindex="-1"></a><span class="fu">listw2mat</span>(spweight) <span class="sc">%&gt;%</span></span>
<span id="cb70-540"><a href="#cb70-540" aria-hidden="true" tabindex="-1"></a>  <span class="fu">range</span>(<span class="fu">eigen</span>((. <span class="sc">+</span> <span class="fu">t</span>(.)) <span class="sc">/</span> <span class="dv">2</span>))</span>
<span id="cb70-541"><a href="#cb70-541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-542"><a href="#cb70-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-543"><a href="#cb70-543" aria-hidden="true" tabindex="-1"></a>If this is correct then not only is this not in the range -1 to 1, it is not symmetric around the expected (null) value of <span class="in">`r round(-1/(nrow(municipal) - 1), 3)`</span>.</span>
<span id="cb70-544"><a href="#cb70-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-545"><a href="#cb70-545" aria-hidden="true" tabindex="-1"></a>Given this, it might, perhaps, be regarded as preferable to use the more readily interpreted Pearson correlation between locations and their average neighbour. That correlation, with $k = 21$ nearest neighbours, was calculated above and is <span class="in">`r round(pearson, 3)`</span>. Whether that figure arose by chance can be assessed using a permutation approach. Given the geography of the South African municipalities, their neighbourhood relations and given the data values, then permuting those values randomly 1000 times allows us to look whether the value of <span class="in">`r round(pearson, 3)`</span> is unusual compared to what could arise by chance. Specifically, we look at whether the value is outside of the 'middle 95%' of values that have been generated through randomisation. If it is, then it suggests a less than 5-in-100 probability that it arose by chance. (A permutation approach is also available for the global and local Moran statistics: see <span class="in">`?moran.mc`</span> and <span class="in">`?localmoran_perm`</span>.)</span>
<span id="cb70-546"><a href="#cb70-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-549"><a href="#cb70-549" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-550"><a href="#cb70-550" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(municipal<span class="sc">$</span>No_schooling)</span>
<span id="cb70-551"><a href="#cb70-551" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, \(x) {</span>
<span id="cb70-552"><a href="#cb70-552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample</span>(municipal<span class="sc">$</span>No_schooling, n) <span class="sc">%&gt;%</span> </span>
<span id="cb70-553"><a href="#cb70-553" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cor</span>(<span class="fu">lag.listw</span>(spweight, .))</span>
<span id="cb70-554"><a href="#cb70-554" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span></span>
<span id="cb70-555"><a href="#cb70-555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quantile</span>(<span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb70-556"><a href="#cb70-556" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-557"><a href="#cb70-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-558"><a href="#cb70-558" aria-hidden="true" tabindex="-1"></a>Note, however, that there is a subtle but important difference between Moran's I and the Pearson correlation of the values and their average neighbour. Moran's I can be used to determine whether, for example, high values of a measurement tend to be surrounded by average neighbours that also have a high value, where the measurement scale is the same for the locations and their average neighbour. What the Pearson correlation is assessing is whether values that are high, *relatively speaking, for all the locations* are surrounded by average neighbours that have a high value *relatively speaking, for all the average neighbours*. What they are measuring the correlation of is therefore not the same. The difference can be seen in the formulae below -- look at the denominators in each case:</span>
<span id="cb70-559"><a href="#cb70-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-560"><a href="#cb70-560" aria-hidden="true" tabindex="-1"></a>$I_{xy} = \dfrac{\sum_{i=1}^{n}(x_i-\bar{x})(y_i-\bar{y})}{\sum_{i=1}^{n}(x_i-\bar{x})^2}$</span>
<span id="cb70-561"><a href="#cb70-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-562"><a href="#cb70-562" aria-hidden="true" tabindex="-1"></a>$r_{xy} = \dfrac{\sum_{i=1}^{n}(x_i-\bar{x})(y_i-\bar{y})}{\sqrt{\sum_{i=1}^{n}(x_i-\bar{x})^2}\sqrt{\sum_{i=1}^{n}(y_i-\bar{y})^2}}$</span>
<span id="cb70-563"><a href="#cb70-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-564"><a href="#cb70-564" aria-hidden="true" tabindex="-1"></a>where $I_{xy}$ is the Moran value, $r_{xy}$ is the Pearson value, $x$ is the measured value at each location and $y$ is the (spatially lagged) value for the average neighbour.</span>
<span id="cb70-565"><a href="#cb70-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-566"><a href="#cb70-566" aria-hidden="true" tabindex="-1"></a><span class="fu">## Getis and Ord G-Statistic</span></span>
<span id="cb70-567"><a href="#cb70-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-568"><a href="#cb70-568" aria-hidden="true" tabindex="-1"></a>A different method for identifying 'hot' or 'cold spots' of a variable is provided by the <span class="co">[</span><span class="ot">G-statistic</span><span class="co">](https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-statistics/h-how-hot-spot-analysis-getis-ord-gi-spatial-stati.htm)</span>{target="_blank"}. As <span class="co">[</span><span class="ot">Brunsdon and Comber</span><span class="co">](https://us.sagepub.com/en-us/nam/an-introduction-to-r-for-spatial-analysis-and-mapping/book258267)</span>{targrt="_blank"} observe, the statistic -- which is a local statistic, calculated for each location in turn -- is based on the proportion of the total sum of standardised attribute values that are within a threshold distance, $d$, of each area centroid. Looking at the map below, which is of South African wards (simplified slightly from <span class="co">[</span><span class="ot">this source</span><span class="co">](https://africaopendata.org/dataset/mdb-wards-2016/resource/d85c5e06-814d-4563-a938-3050e0e6b7e2?inner_span=True)</span>{target="_true"}), we may suspect there are clusters of places with greater percentages of their populations having relatively high incomes and that these are spatial anomalies. Because the percentages are extremely skewed, they have been plotted with a square root transformation applied to the scale of the map (<span class="in">`trans = "sqrt"`</span>). Note that we are also using a col4all *div*erging colour palette for a continuous variable.</span>
<span id="cb70-569"><a href="#cb70-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-572"><a href="#cb70-572" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-573"><a href="#cb70-573" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/blob/main/MandM/workspaces/wards.RData?raw=true"</span>, <span class="st">"wards.RData"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-574"><a href="#cb70-574" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"wards.RData"</span>)</span>
<span id="cb70-575"><a href="#cb70-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-576"><a href="#cb70-576" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> wards, <span class="fu">aes</span>(<span class="at">fill =</span> High_income)) <span class="sc">+</span></span>
<span id="cb70-577"><a href="#cb70-577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">colour =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb70-578"><a href="#cb70-578" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_continuous_c4a_div</span>(<span class="at">name =</span> <span class="st">"%"</span>, <span class="at">palette =</span> <span class="st">"hcl.blue_yellow2"</span>,</span>
<span id="cb70-579"><a href="#cb70-579" aria-hidden="true" tabindex="-1"></a>                                <span class="at">trans =</span> <span class="st">"sqrt"</span>, <span class="at">mid =</span> <span class="fu">median</span>(wards<span class="sc">$</span>High_income)) <span class="sc">+</span></span>
<span id="cb70-580"><a href="#cb70-580" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb70-581"><a href="#cb70-581" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb70-582"><a href="#cb70-582" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Percentage of Population with income R614401 or greater"</span>,</span>
<span id="cb70-583"><a href="#cb70-583" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2011 South African Census Data"</span>,</span>
<span id="cb70-584"><a href="#cb70-584" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Statistics South Africa"</span></span>
<span id="cb70-585"><a href="#cb70-585" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-586"><a href="#cb70-586" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-587"><a href="#cb70-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-588"><a href="#cb70-588" aria-hidden="true" tabindex="-1"></a>The G-statistic requires a binary spatial weights (<span class="in">`style = "B"`</span>, below), whereby locations either are or are not within the threshold distance of each other. The following has a threshold distance of 20km. Not all of the ward centroids will be within 20km of another which creates situations of zero neighbours. That is tolerated by setting <span class="in">`zero.policy = TRUE`</span> in the conversion from a neighbours to spatial list.</span>
<span id="cb70-589"><a href="#cb70-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-590"><a href="#cb70-590" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width="75"}</span>
<span id="cb70-591"><a href="#cb70-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-592"><a href="#cb70-592" aria-hidden="true" tabindex="-1"></a>&lt;font size = 3&gt;As with the function <span class="in">`knearneigh()`</span>, <span class="in">`dnearneigh()`</span> has the default argument, <span class="in">`longlat = NULL`</span>, which should not need changing here to <span class="in">`longlat = TRUE`</span> because it ought to pick this up from <span class="in">`coords`</span>'s coordinate reference system. However, don't take this for granted.&lt;/font&gt;</span>
<span id="cb70-593"><a href="#cb70-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-596"><a href="#cb70-596" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-597"><a href="#cb70-597" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(wards, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-598"><a href="#cb70-598" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb70-599"><a href="#cb70-599" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-600"><a href="#cb70-600" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(wards<span class="sc">$</span>High_income, spweight)</span>
<span id="cb70-601"><a href="#cb70-601" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-602"><a href="#cb70-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-603"><a href="#cb70-603" aria-hidden="true" tabindex="-1"></a>Having calculated the local G values, we can map them, using a manually generated fill palette. The argument <span class="in">`na.translate = F`</span> removes the NA values from the legend but not from the map, wherein they are shaded white (<span class="in">`na.value = "white"`</span>). The G values are also standardised z-values, hence values of 1.96 or greater are relatively rate if the assumption that the statistic is Normally distributed is warranted. (If it isn't, consider using <span class="in">`localG_perm`</span>.)</span>
<span id="cb70-604"><a href="#cb70-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-607"><a href="#cb70-607" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-608"><a href="#cb70-608" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb70-609"><a href="#cb70-609" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb70-610"><a href="#cb70-610" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(wards<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-611"><a href="#cb70-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-612"><a href="#cb70-612" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb70-613"><a href="#cb70-613" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp), <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb70-614"><a href="#cb70-614" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete_c4a_div</span>(<span class="at">name =</span> <span class="st">"G"</span>, <span class="at">palette =</span> <span class="st">"brewer.rd_yl_bu"</span>,</span>
<span id="cb70-615"><a href="#cb70-615" aria-hidden="true" tabindex="-1"></a>                              <span class="at">reverse =</span> <span class="cn">TRUE</span>, <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb70-616"><a href="#cb70-616" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb70-617"><a href="#cb70-617" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb70-618"><a href="#cb70-618" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb70-619"><a href="#cb70-619" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Local G statistic"</span>,</span>
<span id="cb70-620"><a href="#cb70-620" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with income R614401 or greater"</span>,</span>
<span id="cb70-621"><a href="#cb70-621" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"With a 20km threshold"</span></span>
<span id="cb70-622"><a href="#cb70-622" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-623"><a href="#cb70-623" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-624"><a href="#cb70-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-625"><a href="#cb70-625" aria-hidden="true" tabindex="-1"></a>Let's now add a refinement to the map and, based on what we learned from the previous session, label the cities that appear to contain a hot spot of higher percentages of higher earners. Note the use of <span class="in">`st_join()`</span> which is a spatial join: it identifies, from geography, which ward the cities are located in and appends the ward data, including the G statistics, to the cities, retaining only those that are in the most significant hot spots. Note that this definition of 'most significant' doesn't address the problem of repeat testing which we also saw with the local Moran statistics.</span>
<span id="cb70-626"><a href="#cb70-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-629"><a href="#cb70-629" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-630"><a href="#cb70-630" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"remotes"</span> <span class="sc">%in%</span> installed)) <span class="fu">install.packages</span>(<span class="st">"remotes"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-631"><a href="#cb70-631" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"ggsflabel"</span> <span class="sc">%in%</span> installed)) remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"yutannihilation/ggsflabel"</span>)</span>
<span id="cb70-632"><a href="#cb70-632" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggsflabel)</span>
<span id="cb70-633"><a href="#cb70-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-634"><a href="#cb70-634" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"hotosm_zaf_populated_places_points.shp"</span>)) {</span>
<span id="cb70-635"><a href="#cb70-635" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/blob/main/MandM/boundary%20files/hotosm_zaf_populated_places_points_shp.zip?raw=true"</span>,</span>
<span id="cb70-636"><a href="#cb70-636" aria-hidden="true" tabindex="-1"></a>              <span class="st">"cities.zip"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-637"><a href="#cb70-637" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unzip</span>(<span class="st">"cities.zip"</span>)</span>
<span id="cb70-638"><a href="#cb70-638" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-639"><a href="#cb70-639" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-640"><a href="#cb70-640" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(<span class="st">"hotosm_zaf_populated_places_points.shp"</span>) <span class="sc">|&gt;</span></span>
<span id="cb70-641"><a href="#cb70-641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(place <span class="sc">==</span> <span class="st">"city"</span>) <span class="sc">|&gt;</span></span>
<span id="cb70-642"><a href="#cb70-642" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(wards) <span class="sc">|&gt;</span></span>
<span id="cb70-643"><a href="#cb70-643" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(localG <span class="sc">&gt;</span> <span class="fl">3.29</span>) <span class="ot">-&gt;</span></span>
<span id="cb70-644"><a href="#cb70-644" aria-hidden="true" tabindex="-1"></a>  cities</span>
<span id="cb70-645"><a href="#cb70-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-646"><a href="#cb70-646" aria-hidden="true" tabindex="-1"></a><span class="fu">last_plot</span>() <span class="sc">+</span></span>
<span id="cb70-647"><a href="#cb70-647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb70-648"><a href="#cb70-648" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_label_repel</span>(<span class="at">data =</span> cities,</span>
<span id="cb70-649"><a href="#cb70-649" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">aes</span>(<span class="at">label =</span> name), <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb70-650"><a href="#cb70-650" aria-hidden="true" tabindex="-1"></a>                      <span class="at">max.overlaps =</span> <span class="dv">20</span>,</span>
<span id="cb70-651"><a href="#cb70-651" aria-hidden="true" tabindex="-1"></a>                      <span class="at">force =</span> <span class="dv">2</span>)</span>
<span id="cb70-652"><a href="#cb70-652" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-653"><a href="#cb70-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-654"><a href="#cb70-654" aria-hidden="true" tabindex="-1"></a>The results are dependent on the distance threshold defining which places are or are not neighbours. Here are the results with a distance threshold of 100km.</span>
<span id="cb70-655"><a href="#cb70-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-658"><a href="#cb70-658" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-659"><a href="#cb70-659" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb70-660"><a href="#cb70-660" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-661"><a href="#cb70-661" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(wards<span class="sc">$</span>High_income, spweight)</span>
<span id="cb70-662"><a href="#cb70-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-663"><a href="#cb70-663" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb70-664"><a href="#cb70-664" aria-hidden="true" tabindex="-1"></a>          <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb70-665"><a href="#cb70-665" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb70-666"><a href="#cb70-666" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(wards<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-667"><a href="#cb70-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-668"><a href="#cb70-668" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb70-669"><a href="#cb70-669" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp), <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb70-670"><a href="#cb70-670" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete_c4a_div</span>(<span class="at">name =</span> <span class="st">"G"</span>, <span class="at">palette =</span> <span class="st">"brewer.rd_yl_bu"</span>,</span>
<span id="cb70-671"><a href="#cb70-671" aria-hidden="true" tabindex="-1"></a>                              <span class="at">reverse =</span> <span class="cn">TRUE</span>, <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb70-672"><a href="#cb70-672" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb70-673"><a href="#cb70-673" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb70-674"><a href="#cb70-674" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb70-675"><a href="#cb70-675" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb70-676"><a href="#cb70-676" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Local G statistic"</span>,</span>
<span id="cb70-677"><a href="#cb70-677" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with income R614401 or greater"</span>,</span>
<span id="cb70-678"><a href="#cb70-678" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"With a 100km threshold"</span></span>
<span id="cb70-679"><a href="#cb70-679" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb70-680"><a href="#cb70-680" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_label_repel</span>(<span class="at">data =</span> cities,</span>
<span id="cb70-681"><a href="#cb70-681" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">aes</span>(<span class="at">label =</span> name), <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb70-682"><a href="#cb70-682" aria-hidden="true" tabindex="-1"></a>                      <span class="at">max.overlaps =</span> <span class="dv">20</span>,</span>
<span id="cb70-683"><a href="#cb70-683" aria-hidden="true" tabindex="-1"></a>                      <span class="at">force =</span> <span class="dv">2</span>)</span>
<span id="cb70-684"><a href="#cb70-684" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-685"><a href="#cb70-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-686"><a href="#cb70-686" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb70-687"><a href="#cb70-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-688"><a href="#cb70-688" aria-hidden="true" tabindex="-1"></a>This session has been about identifying and quantifying spatial clustering in data, using a combination of 'global' (whole map) and local statistics; specifically, Moran's I, its local equivalent, the local Moran values, and the Getis-Ord G statistic. These statistics are dependent on the spatial weights matrix used in their calculation, which does, unfortunately, create something of a vicious circle: ideally that matrix would be calibrated to the spatial patterns evident in the data but those patterns are only measured and quantified once the weights matrix has been specified. For example, we could, in principle, use Moran's I to measure the spatial autocorrelation and select the weights matrix accordingly. However, we need the spatial weights matrix to calculate Moran's I. One option is to take the view that looking at the patterns at a range of scales is itself revealing so choose lots of bandwidths, not just one, and treat it as a multiscale analysis, as in the following.</span>
<span id="cb70-689"><a href="#cb70-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-692"><a href="#cb70-692" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-693"><a href="#cb70-693" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 6</span></span>
<span id="cb70-694"><a href="#cb70-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-695"><a href="#cb70-695" aria-hidden="true" tabindex="-1"></a><span class="co"># Sets the threshold distance from 20 to 180km in intervals of 20</span></span>
<span id="cb70-696"><a href="#cb70-696" aria-hidden="true" tabindex="-1"></a><span class="co"># I chose 9 distances because they can be shown in a 3 x 3 grid of maps</span></span>
<span id="cb70-697"><a href="#cb70-697" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">20</span>, <span class="at">by =</span> <span class="dv">20</span>, <span class="at">length.out =</span> <span class="dv">9</span>)</span>
<span id="cb70-698"><a href="#cb70-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-699"><a href="#cb70-699" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the G statistics for each distance and save them</span></span>
<span id="cb70-700"><a href="#cb70-700" aria-hidden="true" tabindex="-1"></a><span class="co"># as a list of sf features (maps)</span></span>
<span id="cb70-701"><a href="#cb70-701" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(wards, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-702"><a href="#cb70-702" aria-hidden="true" tabindex="-1"></a>maps <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(</span>
<span id="cb70-703"><a href="#cb70-703" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(d, \(x) {</span>
<span id="cb70-704"><a href="#cb70-704" aria-hidden="true" tabindex="-1"></a>    neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, x)</span>
<span id="cb70-705"><a href="#cb70-705" aria-hidden="true" tabindex="-1"></a>    spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-706"><a href="#cb70-706" aria-hidden="true" tabindex="-1"></a>    wards<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(wards<span class="sc">$</span>High_income, spweight)</span>
<span id="cb70-707"><a href="#cb70-707" aria-hidden="true" tabindex="-1"></a>    wards<span class="sc">$</span>distance <span class="ot">&lt;-</span> x</span>
<span id="cb70-708"><a href="#cb70-708" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(wards)</span>
<span id="cb70-709"><a href="#cb70-709" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb70-710"><a href="#cb70-710" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-711"><a href="#cb70-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-712"><a href="#cb70-712" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind the maps together into a single object to be used</span></span>
<span id="cb70-713"><a href="#cb70-713" aria-hidden="true" tabindex="-1"></a><span class="co"># for the faceting in ggplot2</span></span>
<span id="cb70-714"><a href="#cb70-714" aria-hidden="true" tabindex="-1"></a>maps <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, maps)</span>
<span id="cb70-715"><a href="#cb70-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-716"><a href="#cb70-716" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(maps<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb70-717"><a href="#cb70-717" aria-hidden="true" tabindex="-1"></a>          <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb70-718"><a href="#cb70-718" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(maps<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb70-719"><a href="#cb70-719" aria-hidden="true" tabindex="-1"></a>maps<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(maps<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-720"><a href="#cb70-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-721"><a href="#cb70-721" aria-hidden="true" tabindex="-1"></a><span class="co"># This function is used with the labeller argument in the</span></span>
<span id="cb70-722"><a href="#cb70-722" aria-hidden="true" tabindex="-1"></a><span class="co"># facet_wrap function to customise the title of each sub-plot</span></span>
<span id="cb70-723"><a href="#cb70-723" aria-hidden="true" tabindex="-1"></a>facet_labels <span class="ot">&lt;-</span> \(x) <span class="fu">paste0</span>(x, <span class="st">"km radius"</span>)</span>
<span id="cb70-724"><a href="#cb70-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-725"><a href="#cb70-725" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> maps, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp)) <span class="sc">+</span></span>
<span id="cb70-726"><a href="#cb70-726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb70-727"><a href="#cb70-727" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete_c4a_div</span>(<span class="at">name =</span> <span class="st">"G"</span>, <span class="at">palette =</span> <span class="st">"brewer.rd_yl_bu"</span>,</span>
<span id="cb70-728"><a href="#cb70-728" aria-hidden="true" tabindex="-1"></a>                              <span class="at">reverse =</span> <span class="cn">TRUE</span>, <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb70-729"><a href="#cb70-729" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> distance, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">distance =</span> facet_labels)) <span class="sc">+</span></span>
<span id="cb70-730"><a href="#cb70-730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb70-731"><a href="#cb70-731" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb70-732"><a href="#cb70-732" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb70-733"><a href="#cb70-733" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb70-734"><a href="#cb70-734" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb70-735"><a href="#cb70-735" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb70-736"><a href="#cb70-736" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-737"><a href="#cb70-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-738"><a href="#cb70-738" aria-hidden="true" tabindex="-1"></a><span class="fu">## Further Reading</span></span>
<span id="cb70-739"><a href="#cb70-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-740"><a href="#cb70-740" aria-hidden="true" tabindex="-1"></a><span class="al">![](bookcover.jpg)</span>{width="100"}</span>
<span id="cb70-741"><a href="#cb70-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-742"><a href="#cb70-742" aria-hidden="true" tabindex="-1"></a>Chapters 7 and 8 of <span class="co">[</span><span class="ot">Spatial Data Science with Applications in R</span><span class="co">](https://www.paulamoraga.com/book-spatial/index.html)</span>{target="_blank"} by Paula Moraga.</span>
<span id="cb70-743"><a href="#cb70-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-744"><a href="#cb70-744" aria-hidden="true" tabindex="-1"></a><span class="al">![](spatial_regression_models.jpg)</span>{width="100"}</span>
<span id="cb70-745"><a href="#cb70-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-746"><a href="#cb70-746" aria-hidden="true" tabindex="-1"></a>Chapter 2 of <span class="co">[</span><span class="ot">Spatial Regression Models for the Social Sciences</span><span class="co">](https://uk.sagepub.com/en-gb/eur/spatial-regression-models-for-the-social-sciences/book258546)</span> by Guangqing Chi and Jun Zhu is recommended. For University of Bristol students, it is available to view as an eBook <span class="co">[</span><span class="ot">here</span><span class="co">](https://bris.on.worldcat.org/oclc/1106114802)</span>.</span>
<span id="cb70-747"><a href="#cb70-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-748"><a href="#cb70-748" aria-hidden="true" tabindex="-1"></a><span class="al">![](Rspatial.jpg)</span>{width="100"}</span>
<span id="cb70-749"><a href="#cb70-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-750"><a href="#cb70-750" aria-hidden="true" tabindex="-1"></a>Chapter 8 on Localised Spatial Analysis in <span class="co">[</span><span class="ot">An Introduction to R for Spatial Analysis &amp; Mapping</span><span class="co">](https://us.sagepub.com/en-us/nam/an-introduction-to-r-for-spatial-analysis-and-mapping/book258267)</span>{target="_blank"} by Chris Brunsdon and Lex Comber.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2022-2023, Richard Harris</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.514">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Measuring spatial autocorrelation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<script src="site_libs/quarto-search/autocomplete-preset-algolia.umd.js"></script>
<meta name="quarto:offset" content="./">
<link href="./gwstats.html" rel="next">
<link href="./thematicmaps.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 20,
  "algolia": {
    "application-id": "J0U99Q1IO1",
    "search-only-api-key": "133b4b1fa29f2b12275f6a48a26418db",
    "index-name": "dev_profrichharris",
    "analytics-events": false,
    "show-logo": true,
    "libDir": "site_libs"
  },
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.5.1/dist/algoliasearch-lite.umd.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link active" href="./index.html" aria-current="page"><i class="bi bi-house" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./index.html">Mapping and Modelling Geographic Data in R</a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Measuring spatial autocorrelation</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./" class="sidebar-logo-link">
      <img src="./logo.jpg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Introduction</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./start.html" class="sidebar-item-text sidebar-link">Getting Started</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Why R</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./why.html" class="sidebar-item-text sidebar-link">A Cartographic Answer</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Flavours of R</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./base.html" class="sidebar-item-text sidebar-link">Base R</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tidyverse.html" class="sidebar-item-text sidebar-link">Tidyverse</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./programming.html" class="sidebar-item-text sidebar-link">Programming</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">Mapping the spatial variable</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./themap.html" class="sidebar-item-text sidebar-link">The Spatial Variable</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./thematicmaps.html" class="sidebar-item-text sidebar-link">Thematic maps in R</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">Measuring spatial autocorrelation</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./autocorrelation.html" class="sidebar-item-text sidebar-link active">Measuring spatial autocorrelation</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">From Maps to models</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gwstats.html" class="sidebar-item-text sidebar-link">Geographically Weighted Statistics</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spregress.html" class="sidebar-item-text sidebar-link">Spatial Regression</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">Representations of geographic space</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multilevel.html" class="sidebar-item-text sidebar-link">Continuous and discrete views of the spatial variable</a>
  </div>
</li>
    </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#morans-test" id="toc-morans-test" class="nav-link" data-scroll-target="#morans-test">Moran’s test</a>
  <ul class="collapse">
  <li><a href="#creating-a-neighbours-list" id="toc-creating-a-neighbours-list" class="nav-link" data-scroll-target="#creating-a-neighbours-list">Creating a neighbours list</a></li>
  <li><a href="#creating-spatial-weights" id="toc-creating-spatial-weights" class="nav-link" data-scroll-target="#creating-spatial-weights">Creating spatial weights</a></li>
  <li><a href="#calculating-the-morans-value" id="toc-calculating-the-morans-value" class="nav-link" data-scroll-target="#calculating-the-morans-value">Calculating the Moran’s value</a></li>
  </ul></li>
  <li><a href="#moran-plot-and-local-moran-values" id="toc-moran-plot-and-local-moran-values" class="nav-link" data-scroll-target="#moran-plot-and-local-moran-values">Moran plot and local Moran values</a></li>
  <li><a href="#issues-with-the-moran-statistic" id="toc-issues-with-the-moran-statistic" class="nav-link" data-scroll-target="#issues-with-the-moran-statistic">Issues with the Moran statistic</a>
  <ul class="collapse">
  <li><a href="#how-to-define-neighbours" id="toc-how-to-define-neighbours" class="nav-link" data-scroll-target="#how-to-define-neighbours">How to define neighbours?</a></li>
  <li><a href="#how-to-interpet-the-i-statistic" id="toc-how-to-interpet-the-i-statistic" class="nav-link" data-scroll-target="#how-to-interpet-the-i-statistic">How to interpet the I statistic</a></li>
  </ul></li>
  <li><a href="#getis-and-ord-g-statistic" id="toc-getis-and-ord-g-statistic" class="nav-link" data-scroll-target="#getis-and-ord-g-statistic">Getis and Ord G-Statistic</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading">Further Reading</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block">Measuring spatial autocorrelation</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>We begin by recreating one of the maps from the previous session. You may wish to change your working directory to be the same as previously if it is not already.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>installed <span class="ot">&lt;-</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>]</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>required <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tidyverse"</span>, <span class="st">"sf"</span>, <span class="st">"RColorBrewer"</span>, <span class="st">"classInt"</span>, <span class="st">"ggplot2"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>install <span class="ot">&lt;-</span> required[<span class="sc">!</span>(required <span class="sc">%in%</span> installed)]</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(install)) <span class="fu">install.packages</span>(install, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(sf)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(RColorBrewer)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(classInt)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggplot2)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"municipal.RData"</span>)) <span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/blob/main/MandM/workspaces/municipal.RData?raw=true"</span>, <span class="st">"municipal.RData"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"municipal.RData"</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">classIntervals</span>(municipal<span class="sc">$</span>No_schooling, <span class="at">n =</span> <span class="dv">7</span>, <span class="at">style =</span> <span class="st">"jenks"</span>)<span class="sc">$</span>brks</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>municipal<span class="sc">$</span>No_schooling_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(municipal<span class="sc">$</span>No_schooling, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> No_schooling_gp)) <span class="sc">+</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="st">"%"</span>, <span class="at">palette =</span> <span class="st">"RdYlBu"</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Percentage of Population with No Schooling"</span>,</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2011 South African Census Data"</span>,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Statistics South Africa"</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Looking at the map, the geographical patterning of the percentage of the population with no schooling appears to be neither random nor uniform, with a tendency for similar values to be found in closely located municipalities, creating clusters of red and of blue values (and of yellow too). However, simply ‘eye-balling’ the map to look for patterns isn’t very scientific and it can be very deceptive. You can probably see patterns in the following map, too, but they arise from an entirely <em>random</em> permutation of the previous map’s data.</p>
<p><img src="map_permutation.jpg" class="img-fluid"></p>
</section>
<section id="morans-test" class="level2">
<h2 class="anchored" data-anchor-id="morans-test">Moran’s test</h2>
<p>The classic way of quantifying how similar places are to their neighbours is to calculate the Moran’s statistic, which is a measure of spatial autocorrelation – of how much the values of a variable exhibit spatial clustering of alike values (positive spatial autocorrelation) or of ‘opposite’ values (negative spatial autocorrelation). We can calculate this statistic in R using the <a href="https://cran.r-project.org/web/packages/spdep/index.html" target="_blank">spdep</a> package. We will slice out area 128 from the analysis as this is the one with an invalid geometry (see previous session and try <code>which(!st_is_valid(municipal))</code> to confirm).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"spdep"</span> <span class="sc">%in%</span> installed)) <span class="fu">install.packages</span>(<span class="st">"spdep"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(spdep)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>municipal <span class="sc">%&gt;%</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="sc">-</span><span class="dv">128</span>) <span class="ot">-&gt;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  municipal</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="creating-a-neighbours-list" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-neighbours-list">Creating a neighbours list</h3>
<p>The first step is to define neighbours. In the following example, these are places that share a border (which are contiguous). Presently it is sufficient for them to meet at a single point. If the requirement is that they share an edge not merely a corner then change the default argument from <code>queen = TRUE</code> to <code>queen = FALSE</code> (see <code>?poly2nb</code> for details).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(municipal)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The summary of <code>neighbours</code> reveals that, on average, each South African municipality has 5.2 neighbours but it can range from 1 (the 182nd region in the municipal data) to 10 (region 69). The most frequent number is 6.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(neighbours)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Neighbour list object:
Number of regions: 233 
Number of nonzero links: 1210 
Percentage nonzero weights: 2.228812 
Average number of links: 5.193133 
Link number distribution:

 1  2  3  4  5  6  7  8  9 10 
 1  8 22 43 51 70 30  3  4  1 
1 least connected region:
182 with 1 link
1 most connected region:
69 with 10 links</code></pre>
</div>
</div>
<p>The neighbours of region 69 are,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>neighbours[[<span class="dv">69</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  60  64  68 138 152 153 156 157 163 164</code></pre>
</div>
</div>
<p>It is instructive to write the list of neighbours to an external neighbours file,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.nb.gal</span>(neighbours, <span class="st">"neighbours.gal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>… which can then be viewed by using <code>file.edit("neighbours.gal")</code>. The file will look like the below and has a very simple format. The top line say there are 233 regions. Going down, the first of these has 4 neighbours, which are regions 13, 14, 15 and 16. The second has 6 neighbours, which are 3, 4, 8, 18, 188, 233, and so forth. The same information could be encoded in a <span class="math inline">\(233\times233\)</span> matrix, where cell <span class="math inline">\((i, j)\)</span> is given a value of one if <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> are considered neighbours, else zero. The problem with that approach is most of the matrix is sparse because most regions are not neighbours. It is quicker to state which regions are neighbours. The rest, by definition, are not.</p>
<p><img src="neighbours.jpg" class="img-fluid"></p>
<p>These neighbourhood relationships can be viewed as a graph by extracting the coordinate points (<code>st_coordinates()</code>), of the centroids (<code>st_centroid()</code>), of the polygons that represent each municipality, and by using the plot functions for <code>sf</code> (simple features) and <code>nb</code> (neighbours list) objects. The argument <code>of_largest_polygon = TRUE</code> returns the centroid of the largest (sub)polygon of a MULTIPOLYGON rather than of the whole MULTIPOLYGON, a multipolygon being when one place is represented by multiple polygons (e.g.&nbsp;a mainland and an offshore island). Setting this argument to true means that the centroid will like within the boundary of the place, which isn’t otherwise guarenteed (e.g.&nbsp;it could be in the sea between the mainland and an island).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(municipal, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>pts <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(coords)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))  <span class="co"># Remove the margins and white space around the plot</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours, pts, <span class="at">add =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="creating-spatial-weights" class="level3">
<h3 class="anchored" data-anchor-id="creating-spatial-weights">Creating spatial weights</h3>
<p>The neighbourhood list simply defines which places are neighbours. The spatial weights give a weight to each neighbourhood link. One motivation for doing this is to stop any statistic based on a sum across neighbourhood links to be dominated by those neighbourhoods with most neighbours. Moran is one such statistic. Hence, if a region has six neighbours, each of those is given a weight of <span class="math inline">\(1/6\)</span>. If it has four, <span class="math inline">\(1/4\)</span>, and so forth. This is called row-standardisation and is the default style in the conversion of a neighbourhood to a spatial weights list with the function <code>nb2listw()</code>. See <code>?nb2listw</code> for alternative specifications.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Here are the neighbours of and weights for the first region:</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>spweight<span class="sc">$</span>neighbours[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 13 14 15 16</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>spweight<span class="sc">$</span>weights[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.25 0.25 0.25 0.25</code></pre>
</div>
</div>
</section>
<section id="calculating-the-morans-value" class="level3">
<h3 class="anchored" data-anchor-id="calculating-the-morans-value">Calculating the Moran’s value</h3>
<p>Now we have the spatial weights, we can run a Moran’s test to measure the strength of spatial autocorrelation in the <code>municipal$No_schooling</code> variable.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>moran <span class="ot">&lt;-</span> <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, spweight)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>moran</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Moran I test under randomisation

data:  municipal$No_schooling  
weights: spweight    

Moran I statistic standard deviate = 13.968, p-value &lt; 2.2e-16
alternative hypothesis: greater
sample estimates:
Moran I statistic       Expectation          Variance 
      0.576519069      -0.004310345       0.001729177 </code></pre>
</div>
</div>
<p>The Moran statistic is 0.577 and the 95% confidence interval is,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(moran<span class="sc">$</span>estimate[<span class="dv">1</span>]  <span class="sc">+</span> z <span class="sc">*</span> <span class="fu">sqrt</span>(moran<span class="sc">$</span>estimate[<span class="dv">3</span>]), <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.495 0.658</code></pre>
</div>
</div>
<p>Since the confidence interval does not include the expected value of -0.004, we can conclude that there is statistically significant positive autocorrelation in the variables – municipalities with higher percentages of no schooling tend to be surrounded by other municipalities with the same, and similarly, low values tends to be surrounded by other ones that are low.</p>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">The expected value is very close to zero so what we are <em>almost</em> saying is that because the confidence interval does not span zero so there is evidence of positive spatial autocorrelation. Although this is quite close to being true, to actually be correct would require that the expected value of the statistic is zero with no spatial autocorrelation. It isn’t. It is presently -0.004 and approaches zero as the number of observations increases: <span class="math inline">\(E(I) = -1 / (n - 1).\)</span>, where <span class="math inline">\(n\)</span> is the number of observations.</font></p>
</section>
</section>
<section id="moran-plot-and-local-moran-values" class="level2">
<h2 class="anchored" data-anchor-id="moran-plot-and-local-moran-values">Moran plot and local Moran values</h2>
<p>Whilst there is positive spatial autocorrelation in the values overall, not everywhere is surrounded by similar values. The following plot has 4 quadrants marked upon it. The top right indicates places where both they and their average neighbour have above average values of <code>municipal$No_schooling</code>. We can describe these as <strong>high-high</strong> clusters on the map. The bottom left indicates places where they and their average neighbour have below average values. These are <strong>low-low</strong> clusters. Both the high-high and the low-low contribute to positive spatial autocorrelation because, for these, the places and their neighbours display similar values. The two other quadrants do not. In the top left are <strong>low-high</strong> clusters. In the bottom right are <strong>high-low</strong>. There reveal clusters of dissimilar values (negative spatial autocorrelation). In the chart, the high-high and low-low places are more plentiful than the low-high and high-low ones, hence the upwards sloping line of best fit and the positive Moran statistic.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">moran.plot</span>(municipal<span class="sc">$</span>No_schooling, spweight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>It is straightforward to map which quadrant each place belongs to. First, we calculate the <strong>local</strong> Moran statistics proposed by <a href="https://onlinelibrary.wiley.com/doi/10.1111/j.1538-4632.1995.tb00338.x" target="_blank">Anselin (1995)</a>. A local statistic is one that applies to a subspace of the map, whereas a global statistic is a summary measure for the whole map. Anselin showed that the (global) Moran statistic can be decomposed into a series of local Moran values, each measuring how similar <em>each</em> place is (individually) to its neighbours. There are 233 municipalities in the data so there will be 233 local Moran values too.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>localm <span class="ot">&lt;-</span> <span class="fu">localmoran</span>(municipal<span class="sc">$</span>No_schooling, spweight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Usefully, if we look at the attributes of <code>localm</code>, we discover an attribute named <code>quadr</code> which contains what we want and which can be mapped. In fact, it includes three different versions of what we might want, the differences being due to which average low and high are defined by (see below the section Value in <code>?localmoran</code>).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(<span class="fu">attributes</span>(localm))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "dim"      "dimnames" "call"     "class"    "quadr"   </code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>quadr <span class="ot">&lt;-</span> <span class="fu">attr</span>(localm, <span class="st">"quadr"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(quadr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      mean   median    pysal
1 Low-High Low-High Low-High
2  Low-Low  Low-Low  Low-Low
3  Low-Low  Low-Low  Low-Low
4 High-Low High-Low High-Low
5  Low-Low  Low-Low  Low-Low
6  Low-Low  Low-Low  Low-Low</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> quadr<span class="sc">$</span>pysal)) <span class="sc">+</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="st">""</span>, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"orange"</span>, <span class="st">"purple"</span>, <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Local Moran value groups"</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with No Schooling"</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Unfortunately, the resulting map is somewhat misleading because not all of the local Moran values are statistically significant and some of the various high-high, low-low, etc. pairings my be only trivially alike or dissimilar. Looking at top of the local Moran data suggests a way of isolating those that are statistically significant and is adopted in the following map.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(localm, <span class="at">n =</span> <span class="dv">3</span>)   <span class="co"># The p-values are in column 5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          Ii          E.Ii     Var.Ii       Z.Ii Pr(z != E(Ii))
1 -0.1271124 -0.0055224972 0.31575429 -0.2163830      0.8286892
2  0.1047729 -0.0019928929 0.07556466  0.3883944      0.6977242
3  0.1385483 -0.0003126832 0.01187599  1.2742226      0.2025845</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>quadr[localm[,<span class="dv">5</span>] <span class="sc">&gt;</span> <span class="fl">0.05</span>, ] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> quadr<span class="sc">$</span>pysal)) <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="st">""</span>, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"orange"</span>, <span class="st">"purple"</span>, <span class="st">"red"</span>), <span class="at">na.value =</span> <span class="st">"grey80"</span>) <span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Statistically significant local Moran value groups"</span>,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with No Schooling"</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Arguably, this new map may still not apply a strict enough definition of statistical significance because the issue of repeat testing has not been tackled. Remember, there are 233 places, 233 local Moran values and therefore 233 tests of significance. The p-values can be adjusted for this using R’s <code>p.adjust()</code> function. The following example uses a false discovery rate method (<code>method = fdr</code>) but other alternatives include <code>method = bonferroni</code>. A question is whether this is now <em>too</em> strict given that there are not 233 independent tests. Rather, the data have overlapping geographies (places share neighbours) as well as spatial dependencies.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>quadr[<span class="fu">p.adjust</span>(localm[,<span class="dv">5</span>], <span class="at">method =</span> <span class="st">"fdr"</span>) <span class="sc">&gt;</span> <span class="fl">0.05</span>, ] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> quadr<span class="sc">$</span>pysal)) <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="st">""</span>, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>), <span class="at">na.value =</span> <span class="st">"grey80"</span>) <span class="sc">+</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Statistically significant (p-adjusted) local Moran value groups"</span>,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with No Schooling"</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="issues-with-the-moran-statistic" class="level2">
<h2 class="anchored" data-anchor-id="issues-with-the-moran-statistic">Issues with the Moran statistic</h2>
<section id="how-to-define-neighbours" class="level3">
<h3 class="anchored" data-anchor-id="how-to-define-neighbours">How to define neighbours?</h3>
<p>Any statistic that includes spatial weights is dependent upon how those weights are defined: how, then, to decide which places are neighbours and also how much weight each neighbourhood connection is given in the calculation? The calculations above use first order contiguity (places that share a boundary) but we could extend that definition to include neighbours of neighbours (or more):</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">nblag</span>(neighbours, <span class="at">maxlag =</span> <span class="dv">2</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))   <span class="co"># Plot graphics in a 1 row by 2 column grid</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"First order contiguity"</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours[[<span class="dv">1</span>]], pts, <span class="at">add =</span> T)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"Second order contiguity"</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours[[<span class="dv">2</span>]], pts, <span class="at">add =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Changing the definition of neighbours does, of course, change the Moran statistic and it will change the local Moran values too.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(neighbours, \(x) {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nb2listw</span>(x) <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, .) <span class="ot">-&gt;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    moran</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  moran<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Moran I statistic Moran I statistic 
        0.5765191         0.3883236 </code></pre>
</div>
</div>
<p>There is no particular reason to stick with a contiguity-based definition. We could, for example, look for the <span class="math inline">\(k\)</span> nearest neighbours (or, more precisely, the <span class="math inline">\(k\)</span> nearest centroids to the centroid of each region), as in the two examples below.</p>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">The function <code>knearneigh()</code> contains the default argument, <code>longlat = NULL</code>. It should be ok not to change this here to <code>longlat = TRUE</code> because it ought to pick this up from <code>coords</code>’s coordinate reference system. If you suspect it isn’t or if <code>coords</code> is simply a matrix of point coordinates, not an explicitly spatial object, change the default argument to <code>longlat = TRUE</code>.</font></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(coords, <span class="at">k =</span> <span class="dv">5</span>))</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"Five nearest neighbours"</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours, pts, <span class="at">add =</span> T)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(coords, <span class="at">k =</span> <span class="dv">10</span>))</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"Ten nearest neighbours"</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours, pts, <span class="at">add =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In fact, we can run through all the possible values of <span class="math inline">\(k\)</span> (from <span class="math inline">\(1\)</span> to <span class="math inline">\(k_{max} = (n - 1)\)</span> where <span class="math inline">\(n\)</span> is the number of municipalities) and consider the Moran statistics that they generate. The resulting chart shows that the statistic is highly dependent on the scale of the analysis: as <span class="math inline">\(k\)</span> increases, neighbourhood relationships extend over an increasing portion of the map, and the statistic tends to decline. It declines because nearby places tend to have similar values whereas those that are further away are more varied.</p>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">The code will generate a lot of warning messages. You can ignore them. They are warning you that <span class="math inline">\(k\)</span> has become a large subset of all <span class="math inline">\(n\)</span>.</font></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(municipal)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span> (n<span class="dv">-1</span>), \(k) {</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">knearneigh</span>(coords, k) <span class="sc">%&gt;%</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    knn2nb <span class="sc">%&gt;%</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    nb2listw <span class="sc">%&gt;%</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, .) <span class="ot">-&gt;</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    moran</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  moran<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">k =</span> <span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>), <span class="at">y =</span> y), <span class="fu">aes</span>(<span class="at">x =</span> k, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Moran statistic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In principle the chart could be used to identify an ‘optimal’ value of <span class="math inline">\(k\)</span>. Unfortunately, the present case offers few clues as to what that optimal value should be. The p-value for these statistics is not shown but is least when <span class="math inline">\(k = 27\)</span>. That might be a justification, of sorts, for choosing <span class="math inline">\(k = 27\)</span> but it is splitting hairs somewhat when all the p-values are tiny and well below <span class="math inline">\(p = 0.001\)</span>.</p>
<p>Other ways of defining neighbours include whether they lie within a lower or upper distance bound of each other: see <code>?dnearneigh</code> and <a href="https://r-spatial.github.io/spdep/articles/nb.html" target="_blank">this vignette on Creating Neighbours</a>.</p>
</section>
<section id="how-to-interpet-the-i-statistic" class="level3">
<h3 class="anchored" data-anchor-id="how-to-interpet-the-i-statistic">How to interpet the I statistic</h3>
<p>Conceptually, the Moran statistic is easy to understand: it is a (global) measure of the correlation between the values of a variable at a set of locations, and the value of the same variable for those locations’ neighbours. More simply, it is the correlation between locations and their neighbours.</p>
<p>Except it isn’t. Or, rather, it is <em>a</em> measure of correlation, just not the more commonly used Pearson correlation. The difference is evident in the following comparison where the Moran value is almost half the Pearson correlation between locations and their average neighbour (where the value for the average neighbour is calculated using <code>last.listw()</code>).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(<span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(coords, <span class="dv">30</span>)))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>pearson <span class="ot">&lt;-</span> <span class="fu">cor</span>(<span class="fu">lag.listw</span>(spweight, municipal<span class="sc">$</span>No_schooling), municipal<span class="sc">$</span>No_schooling)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>moran <span class="ot">&lt;-</span> <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, spweight)<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">person =</span> pearson, <span class="at">moran =</span> moran, <span class="at">row.names =</span> <span class="st">"correlation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>              person     moran
correlation 0.636569 0.3346272</code></pre>
</div>
</div>
<p>As <a href="https://us.sagepub.com/en-us/nam/an-introduction-to-r-for-spatial-analysis-and-mapping/book258267" data-targrt="_blank">Brunsdon and Comber</a> note, the value of Moran’s I is not constrained to be in the range from -1 to +1 but changes with the spatial weights matrix. Following, <a href="https://doi.org/10.1111/j.1538-4632.1984.tb00797.x" target="_blank">Jong et al.&nbsp;(1984, p.&nbsp;20)</a>, the extremes for the current spatial weights are,</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">listw2mat</span>(spweight) <span class="sc">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">range</span>(<span class="fu">eigen</span>((. <span class="sc">+</span> <span class="fu">t</span>(.)) <span class="sc">/</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.3985514  1.0317251</code></pre>
</div>
</div>
<p>Not only is this not in the range -1 to 1, it is not symmetric around the expected (null) value of -0.004.</p>
<p>Personally, I am not persuaded that the global Moran’s value is preferable to the more readily interpreted Pearson correlation between locations and their average neighbour. That correlation with <span class="math inline">\(k = 30\)</span> nearest neighbours was calculated above and is 0.637. A confidence interval for this can be calculated using a permutation approach, for example. Given the geography of the South African municipalities, their neighbourhood relations and given the data values, then permuting those values randomly 1000 times around the municipalities generates a 95% confidence interval that the correlation is a long way out of, indicating the positive autocorrelation to be significant. (A permutation approach is also available for the global and local Moran statistics: see <code>?moran.mc</code> and <code>?localmoran_perm</code>.)</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(municipal<span class="sc">$</span>No_schooling)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, \(x) {</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample</span>(municipal<span class="sc">$</span>No_schooling, n) <span class="sc">%&gt;%</span> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cor</span>(<span class="fu">lag.listw</span>(spweight, .))</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quantile</span>(<span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      2.5%      97.5% 
-0.2347859  0.1271044 </code></pre>
</div>
</div>
</section>
</section>
<section id="getis-and-ord-g-statistic" class="level2">
<h2 class="anchored" data-anchor-id="getis-and-ord-g-statistic">Getis and Ord G-Statistic</h2>
<p>A different method for identifying ‘hot’ or ‘cold spots’ of a variable is provided by the <a href="https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-statistics/h-how-hot-spot-analysis-getis-ord-gi-spatial-stati.htm" target="_blank">G-statistic</a>. As <a href="https://us.sagepub.com/en-us/nam/an-introduction-to-r-for-spatial-analysis-and-mapping/book258267" data-targrt="_blank">Brunsdon and Comber</a> observe, the statistic – which is a local statistic, calculated for each location in turn – is based on the proportion of the total sum of standardised attribute values that are within a threshold distance, <span class="math inline">\(d\)</span>, of each area centroid. Looking at the map below, which is of South African wards (simplified slightly from <a href="https://africaopendata.org/dataset/mdb-wards-2016/resource/d85c5e06-814d-4563-a938-3050e0e6b7e2?inner_span=True" target="_true">this source</a>), we may suspect there are clusters of places with greater percentages of their populations having relatively high incomes and that these are spatial anomalies. Because the percentages are extremely skewed, they have been plotted with a square root transformation applied to the scale of the map (<code>trans = "sqrt"</code>) – notice how the values 0 to 4% (which are the original values, not the square roots) occupy more of the legend than the values 4 to 8 do, and so forth.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/blob/main/MandM/workspaces/wards.RData?raw=true"</span>, <span class="st">"wards.RData"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"wards.RData"</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> wards, <span class="fu">aes</span>(<span class="at">fill =</span> High_income)) <span class="sc">+</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">colour =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="st">"%"</span>, <span class="at">guide =</span> <span class="st">"colourbar"</span>, <span class="at">direction =</span> <span class="dv">1</span>, <span class="at">trans =</span> <span class="st">"sqrt"</span>,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">palette =</span> <span class="st">"Reds"</span>) <span class="sc">+</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Percentage of Population with income R614401 or greater"</span>,</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2011 South African Census Data"</span>,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Statistics South Africa"</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The G-statistic requires a binary spatial weights (<code>style = "B"</code>, below), whereby locations either are or are not within the threshold distance of each other. The following has a threshold distance of 20km. Not all of the ward centroids will be within 20km of another which creates situations of zero neighbours, which is tolerated by setting <code>zero.policy = TRUE</code> in the conversion from a neighbours to spatial list.</p>
<p><img src="hazard.gif" class="img-fluid" width="75"></p>
<p><font size="3">As with the function <code>knearneigh()</code>, <code>dnearneigh()</code> has the default argument, <code>longlat = NULL</code>, which should not need changing here to <code>longlat = TRUE</code> because it ought to pick this up from <code>coords</code>’s coordinate reference system. However, don’t take this for granted.</font></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(wards, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(wards<span class="sc">$</span>High_income, spweight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Having calculated the local G values, we can map them, using a manually generated fill palette. The argument <code>na.translate = F</code> removes the NA values from the legend but not from the map, wherein they are shaded white (<code>na.value = "white"</code>). The G values are also standardised z-values, hence values of 1.96 or greater are relatively rate if the assumption that the statistic is Normally distributed is warranted. (If it isn’t, consider using <code>localG_perm</code>.)</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>, <span class="fu">max</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(wards<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp), <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"G"</span>, <span class="at">values =</span> pal, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Local G statistic"</span>,</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with income R614401 or greater"</span>,</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"With a 20km threshold"</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let’s now add a refinement to the map and, based on what we learned from the previous session, label the cities that appear to contain a hot spot of higher percentages of higher earners. Note the use of <code>st_join()</code> which is a spatial join: it identifies, from geography, which ward the cities are located in and appends the ward data, including the G statistics, to the cities, retaining only those that are in the most significant hot spots. Note that this definition of ‘most significant’ doesn’t address the problem of repeat testing which we also saw with the local Moran statistics and, of course, the results are dependent on the distance threshold defining which places are or are not neighbours.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"remotes"</span> <span class="sc">%in%</span> installed)) <span class="fu">install.packages</span>(<span class="st">"remotes"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"ggsflabel"</span> <span class="sc">%in%</span> installed)) remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"yutannihilation/ggsflabel"</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggsflabel)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"hotosm_zaf_populated_places_points.shp"</span>)) {</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/blob/main/MandM/boundary%20files/hotosm_zaf_populated_places_points_shp.zip?raw=true"</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>              <span class="st">"cities.zip"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unzip</span>(<span class="st">"cities.zip"</span>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(<span class="st">"hotosm_zaf_populated_places_points.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(place <span class="sc">==</span> <span class="st">"city"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(wards) <span class="sc">%&gt;%</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(localG <span class="sc">&gt;</span> <span class="fl">3.29</span>) <span class="ot">-&gt;</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  cities</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="fu">last_plot</span>() <span class="sc">+</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_label_repel</span>(<span class="at">data =</span> cities,</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">aes</span>(<span class="at">label =</span> name), <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>                      <span class="at">max.overlaps =</span> <span class="dv">20</span>,</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>                      <span class="at">force =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here are the results with a distance threshold of 100km.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(wards<span class="sc">$</span>High_income, spweight)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(wards<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp), <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"G"</span>, <span class="at">values =</span> pal, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Local G statistic"</span>,</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with income R614401 or greater"</span>,</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"With a 100km threshold"</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_label_repel</span>(<span class="at">data =</span> cities,</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">aes</span>(<span class="at">label =</span> name), <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>                      <span class="at">max.overlaps =</span> <span class="dv">20</span>,</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>                      <span class="at">force =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>This session has been about identifying and quantifying spatial clustering in data, using a combination of ‘global’ (whole map) and local statistics; specifically, Moran’s I, its local equivalent and the Getis-Ord G statistic. These statistics are dependent on the spatial weights matrix used in their calculation, which does, unfortunately, create something of a vicious circle: ideally that matrix would be calibrated to the spatial patterns evident in the data but they are only evident once the weights matrix has been specified. One option is to take the view that looking at the patterns at a range of scales is itself revealing so choose lots of bandwidths, not just one, and treat it as a multiscale analysis, as in the following.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sets the threshold distance from 20 to 180km in intervals of 20</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co"># I chose 9 distances because they can be shown in a 3 x 3 grid of maps</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">20</span>, <span class="at">by =</span> <span class="dv">20</span>, <span class="at">length.out =</span> <span class="dv">9</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the G statistics for each distance and save them</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co"># as a list of sf features (maps)</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(wards, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>maps <span class="ot">&lt;-</span> <span class="fu">lapply</span>(d, \(x) {</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, x)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  wards<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(wards<span class="sc">$</span>High_income, spweight)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  wards<span class="sc">$</span>distance <span class="ot">&lt;-</span> x</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(wards)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind the maps together into a single object to be used</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="co"># for the faceting in ggplot2</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>maps <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, maps)</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(maps<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(maps<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>maps<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(maps<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> maps, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp)) <span class="sc">+</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"G"</span>, <span class="at">values =</span> pal, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> distance) <span class="sc">+</span></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="autocorrelation_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="further-reading" class="level2">
<h2 class="anchored" data-anchor-id="further-reading">Further Reading</h2>
<p><img src="Rspatial.jpg" class="img-fluid" width="100"></p>
<p>Chapter 8 on Localised Spatial Analysis in <a href="https://us.sagepub.com/en-us/nam/an-introduction-to-r-for-spatial-analysis-and-mapping/book258267" target="_blank">An Introduction to R for Spatial Analysis &amp; Mapping</a> by Chris Brunsdon and Lex Comber.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./thematicmaps.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Thematic maps in R</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./gwstats.html" class="pagination-link">
        <span class="nav-page-text">Geographically Weighted Statistics</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb46" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Measuring spatial autocorrelation"</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>installed <span class="ot">&lt;-</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>]</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>required <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tidyverse"</span>, <span class="st">"sf"</span>, <span class="st">"RColorBrewer"</span>, <span class="st">"classInt"</span>, <span class="st">"ggplot2"</span>, <span class="st">"spdep"</span>, <span class="st">"remotes"</span>)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>install <span class="ot">&lt;-</span> required[<span class="sc">!</span>(required <span class="sc">%in%</span> installed)]</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(install)) <span class="fu">install.packages</span>(install, <span class="at">dependencies =</span> <span class="cn">TRUE</span>, <span class="at">repos =</span> <span class="st">"https://cloud.r-project.org"</span>)</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>We begin by recreating one of the maps from the previous session. You may wish to change your working directory to be the same as previously if it is not already.</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>installed <span class="ot">&lt;-</span> <span class="fu">installed.packages</span>()[,<span class="dv">1</span>]</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>required <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tidyverse"</span>, <span class="st">"sf"</span>, <span class="st">"RColorBrewer"</span>, <span class="st">"classInt"</span>, <span class="st">"ggplot2"</span>)</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>install <span class="ot">&lt;-</span> required[<span class="sc">!</span>(required <span class="sc">%in%</span> installed)]</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(install)) <span class="fu">install.packages</span>(install, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(sf)</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(RColorBrewer)</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(classInt)</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggplot2)</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"municipal.RData"</span>)) <span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/blob/main/MandM/workspaces/municipal.RData?raw=true"</span>, <span class="st">"municipal.RData"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"municipal.RData"</span>)</span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">classIntervals</span>(municipal<span class="sc">$</span>No_schooling, <span class="at">n =</span> <span class="dv">7</span>, <span class="at">style =</span> <span class="st">"jenks"</span>)<span class="sc">$</span>brks</span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>municipal<span class="sc">$</span>No_schooling_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(municipal<span class="sc">$</span>No_schooling, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> No_schooling_gp)) <span class="sc">+</span></span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="st">"%"</span>, <span class="at">palette =</span> <span class="st">"RdYlBu"</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Percentage of Population with No Schooling"</span>,</span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2011 South African Census Data"</span>,</span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Statistics South Africa"</span></span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>Looking at the map, the geographical patterning of the percentage of the population with no schooling appears to be neither random nor uniform, with a tendency for similar values to be found in closely located municipalities, creating clusters of red and of blue values (and of yellow too). However, simply 'eye-balling' the map to look for patterns isn't very scientific and it can be very deceptive. You can probably see patterns in the following map, too, but they arise from an entirely *random* permutation of the previous map's data.</span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a><span class="al">![](map_permutation.jpg)</span></span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a><span class="fu">## Moran's test</span></span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a>The classic way of quantifying how similar places are to their neighbours is to calculate the Moran's statistic, which is a measure of spatial autocorrelation -- of how much the values of a variable exhibit spatial clustering of alike values (positive spatial autocorrelation) or of 'opposite' values (negative spatial autocorrelation). We can calculate this statistic in R using the <span class="co">[</span><span class="ot">spdep</span><span class="co">](https://cran.r-project.org/web/packages/spdep/index.html)</span>{target="_blank"} package. We will slice out area 128 from the analysis as this is the one with an invalid geometry (see previous session and try <span class="in">`which(!st_is_valid(municipal))`</span> to confirm). </span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"spdep"</span> <span class="sc">%in%</span> installed)) <span class="fu">install.packages</span>(<span class="st">"spdep"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(spdep)</span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a>municipal <span class="sc">%&gt;%</span></span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="sc">-</span><span class="dv">128</span>) <span class="ot">-&gt;</span></span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a>  municipal</span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a><span class="fu">### Creating a neighbours list</span></span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a>The first step is to define neighbours. In the following example, these are places that share a border (which are contiguous). Presently it is sufficient for them to meet at a single point. If the requirement is that they share an edge not merely a corner then change the default argument from <span class="in">`queen = TRUE`</span> to <span class="in">`queen = FALSE`</span> (see <span class="in">`?poly2nb`</span> for details).</span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-80"><a href="#cb46-80" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-81"><a href="#cb46-81" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(municipal)</span>
<span id="cb46-82"><a href="#cb46-82" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-83"><a href="#cb46-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-84"><a href="#cb46-84" aria-hidden="true" tabindex="-1"></a>The summary of <span class="in">`neighbours`</span> reveals that, on average, each South African municipality has 5.2 neighbours but it can range from 1 (the 182nd region in the municipal data) to 10 (region 69). The most frequent number is 6. </span>
<span id="cb46-85"><a href="#cb46-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-88"><a href="#cb46-88" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-89"><a href="#cb46-89" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(neighbours)</span>
<span id="cb46-90"><a href="#cb46-90" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-91"><a href="#cb46-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-92"><a href="#cb46-92" aria-hidden="true" tabindex="-1"></a>The neighbours of region 69 are,</span>
<span id="cb46-93"><a href="#cb46-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-96"><a href="#cb46-96" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-97"><a href="#cb46-97" aria-hidden="true" tabindex="-1"></a>neighbours[[<span class="dv">69</span>]]</span>
<span id="cb46-98"><a href="#cb46-98" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-99"><a href="#cb46-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-100"><a href="#cb46-100" aria-hidden="true" tabindex="-1"></a>It is instructive to write the list of neighbours to an external neighbours file,</span>
<span id="cb46-101"><a href="#cb46-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-104"><a href="#cb46-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-105"><a href="#cb46-105" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb46-106"><a href="#cb46-106" aria-hidden="true" tabindex="-1"></a><span class="fu">write.nb.gal</span>(neighbours, <span class="st">"neighbours.gal"</span>)</span>
<span id="cb46-107"><a href="#cb46-107" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-108"><a href="#cb46-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-109"><a href="#cb46-109" aria-hidden="true" tabindex="-1"></a>... which can then be viewed by using <span class="in">`file.edit("neighbours.gal")`</span>. The file will look like the below and has a very simple format. The top line say there are 233 regions. Going down, the first of these has 4 neighbours, which are regions 13, 14, 15 and 16. The second has 6 neighbours, which are 3, 4, 8, 18, 188, 233, and so forth. The same information could be encoded in a $233\times233$ matrix, where cell $(i, j)$ is given a value of one if $i$ and $j$ are considered neighbours, else zero. The problem with that approach is most of the matrix is sparse because most regions are not neighbours. It is quicker to state which regions are neighbours. The rest, by definition, are not.</span>
<span id="cb46-110"><a href="#cb46-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-111"><a href="#cb46-111" aria-hidden="true" tabindex="-1"></a><span class="al">![](neighbours.jpg)</span></span>
<span id="cb46-112"><a href="#cb46-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-113"><a href="#cb46-113" aria-hidden="true" tabindex="-1"></a>These neighbourhood relationships can be viewed as a graph by extracting the coordinate points (<span class="in">`st_coordinates()`</span>), of the centroids (<span class="in">`st_centroid()`</span>), of the polygons that represent each municipality, and by using the plot functions for <span class="in">`sf`</span> (simple features) and <span class="in">`nb`</span> (neighbours list) objects. The argument <span class="in">`of_largest_polygon = TRUE`</span> returns the centroid of the largest (sub)polygon of a MULTIPOLYGON rather than of the whole MULTIPOLYGON, a multipolygon being when one place is represented by multiple polygons (e.g. a mainland and an offshore island). Setting this argument to true means that the centroid will like within the boundary of the place, which isn't otherwise guarenteed (e.g. it could be in the sea between the mainland and an island).</span>
<span id="cb46-114"><a href="#cb46-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-117"><a href="#cb46-117" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-118"><a href="#cb46-118" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(municipal, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-119"><a href="#cb46-119" aria-hidden="true" tabindex="-1"></a>pts <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(coords)</span>
<span id="cb46-120"><a href="#cb46-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-121"><a href="#cb46-121" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))  <span class="co"># Remove the margins and white space around the plot</span></span>
<span id="cb46-122"><a href="#cb46-122" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>)</span>
<span id="cb46-123"><a href="#cb46-123" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours, pts, <span class="at">add =</span> T)</span>
<span id="cb46-124"><a href="#cb46-124" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-125"><a href="#cb46-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-126"><a href="#cb46-126" aria-hidden="true" tabindex="-1"></a><span class="fu">### Creating spatial weights</span></span>
<span id="cb46-127"><a href="#cb46-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-128"><a href="#cb46-128" aria-hidden="true" tabindex="-1"></a>The neighbourhood list simply defines which places are neighbours. The spatial weights give a weight to each neighbourhood link. One motivation for doing this is to stop any statistic based on a sum across neighbourhood links to be dominated by those neighbourhoods with most neighbours. Moran is one such statistic. Hence, if a region has six neighbours, each of those is given a weight of $1/6$. If it has four, $1/4$, and so forth. This is called row-standardisation and is the default style in the conversion of a neighbourhood to a spatial weights list with the function <span class="in">`nb2listw()`</span>. See <span class="in">`?nb2listw`</span> for alternative specifications.</span>
<span id="cb46-129"><a href="#cb46-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-132"><a href="#cb46-132" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-133"><a href="#cb46-133" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours)</span>
<span id="cb46-134"><a href="#cb46-134" aria-hidden="true" tabindex="-1"></a><span class="co"># Here are the neighbours of and weights for the first region:</span></span>
<span id="cb46-135"><a href="#cb46-135" aria-hidden="true" tabindex="-1"></a>spweight<span class="sc">$</span>neighbours[[<span class="dv">1</span>]]</span>
<span id="cb46-136"><a href="#cb46-136" aria-hidden="true" tabindex="-1"></a>spweight<span class="sc">$</span>weights[[<span class="dv">1</span>]]</span>
<span id="cb46-137"><a href="#cb46-137" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-138"><a href="#cb46-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-139"><a href="#cb46-139" aria-hidden="true" tabindex="-1"></a><span class="fu">### Calculating the Moran's value</span></span>
<span id="cb46-140"><a href="#cb46-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-141"><a href="#cb46-141" aria-hidden="true" tabindex="-1"></a>Now we have the spatial weights, we can run a Moran's test to measure the strength of spatial autocorrelation in the <span class="in">`municipal$No_schooling`</span> variable.</span>
<span id="cb46-142"><a href="#cb46-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-145"><a href="#cb46-145" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-146"><a href="#cb46-146" aria-hidden="true" tabindex="-1"></a>moran <span class="ot">&lt;-</span> <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, spweight)</span>
<span id="cb46-147"><a href="#cb46-147" aria-hidden="true" tabindex="-1"></a>moran</span>
<span id="cb46-148"><a href="#cb46-148" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-149"><a href="#cb46-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-150"><a href="#cb46-150" aria-hidden="true" tabindex="-1"></a>The Moran statistic is <span class="in">`r round(moran$estimate[1], 3)`</span> and the 95% confidence interval is,</span>
<span id="cb46-151"><a href="#cb46-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-154"><a href="#cb46-154" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-155"><a href="#cb46-155" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>)</span>
<span id="cb46-156"><a href="#cb46-156" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(moran<span class="sc">$</span>estimate[<span class="dv">1</span>]  <span class="sc">+</span> z <span class="sc">*</span> <span class="fu">sqrt</span>(moran<span class="sc">$</span>estimate[<span class="dv">3</span>]), <span class="dv">3</span>)</span>
<span id="cb46-157"><a href="#cb46-157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-158"><a href="#cb46-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-159"><a href="#cb46-159" aria-hidden="true" tabindex="-1"></a>Since the confidence interval does not include the expected value of <span class="in">`r round(moran$estimate[2], 3)`</span>, we can conclude that there is statistically significant positive autocorrelation in the variables -- municipalities with higher percentages of no schooling tend to be surrounded by other municipalities with the same, and similarly, low values tends to be surrounded by other ones that are low.</span>
<span id="cb46-160"><a href="#cb46-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-161"><a href="#cb46-161" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width=75}</span>
<span id="cb46-162"><a href="#cb46-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-163"><a href="#cb46-163" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;font</span> <span class="er">size</span> <span class="ot">=</span> <span class="st">3</span><span class="kw">&gt;</span>The expected value is very close to zero so what we are *almost* saying is that because the confidence interval does not span zero so there is evidence of positive spatial autocorrelation. Although this is quite close to being true, to actually be correct would require that the expected value of the statistic is zero with no spatial autocorrelation. It isn't. It is presently <span class="in">`r round(moran$estimate[2], 3)`</span> and approaches zero as the number of observations increases: $E(I) = -1 / (n - 1).$, where $n$ is the number of observations.<span class="kw">&lt;/font&gt;</span></span>
<span id="cb46-164"><a href="#cb46-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-165"><a href="#cb46-165" aria-hidden="true" tabindex="-1"></a><span class="fu">## Moran plot and local Moran values</span></span>
<span id="cb46-166"><a href="#cb46-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-167"><a href="#cb46-167" aria-hidden="true" tabindex="-1"></a>Whilst there is positive spatial autocorrelation in the values overall, not everywhere is surrounded by similar values. The following plot has 4 quadrants marked upon it. The top right indicates places where both they and their average neighbour have above average values of <span class="in">`municipal$No_schooling`</span>. We can describe these as **high-high** clusters on the map. The bottom left indicates places where they and their average neighbour have below average values. These are **low-low** clusters. Both the high-high and the low-low contribute to positive spatial autocorrelation because, for these, the places and their neighbours display similar values. The two other quadrants do not. In the top left are **low-high** clusters. In the bottom right are **high-low**. There reveal clusters of dissimilar values (negative spatial autocorrelation). In the chart, the high-high and low-low places are more plentiful than the low-high and high-low ones, hence the upwards sloping line of best fit and the positive Moran statistic.</span>
<span id="cb46-168"><a href="#cb46-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-171"><a href="#cb46-171" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-172"><a href="#cb46-172" aria-hidden="true" tabindex="-1"></a><span class="fu">moran.plot</span>(municipal<span class="sc">$</span>No_schooling, spweight)</span>
<span id="cb46-173"><a href="#cb46-173" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-174"><a href="#cb46-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-175"><a href="#cb46-175" aria-hidden="true" tabindex="-1"></a>It is straightforward to map which quadrant each place belongs to. First, we calculate the **local** Moran statistics proposed by <span class="co">[</span><span class="ot">Anselin (1995)</span><span class="co">](https://onlinelibrary.wiley.com/doi/10.1111/j.1538-4632.1995.tb00338.x)</span>{target="_blank"}. A local statistic is one that applies to a subspace of the map, whereas a global statistic is a summary measure for the whole map. Anselin showed that the (global) Moran statistic can be decomposed into a series of local Moran values, each measuring how similar *each* place is (individually) to its neighbours. There are 233 municipalities in the data so there will be 233 local Moran values too.</span>
<span id="cb46-176"><a href="#cb46-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-179"><a href="#cb46-179" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-180"><a href="#cb46-180" aria-hidden="true" tabindex="-1"></a>localm <span class="ot">&lt;-</span> <span class="fu">localmoran</span>(municipal<span class="sc">$</span>No_schooling, spweight)</span>
<span id="cb46-181"><a href="#cb46-181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-182"><a href="#cb46-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-183"><a href="#cb46-183" aria-hidden="true" tabindex="-1"></a>Usefully, if we look at the attributes of <span class="in">`localm`</span>, we discover an attribute named <span class="in">`quadr`</span> which contains what we want and which can be mapped. In fact, it includes three different versions of what we might want, the differences being due to which average low and high are defined by (see below the section Value in <span class="in">`?localmoran`</span>).</span>
<span id="cb46-184"><a href="#cb46-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-187"><a href="#cb46-187" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-188"><a href="#cb46-188" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(<span class="fu">attributes</span>(localm))</span>
<span id="cb46-189"><a href="#cb46-189" aria-hidden="true" tabindex="-1"></a>quadr <span class="ot">&lt;-</span> <span class="fu">attr</span>(localm, <span class="st">"quadr"</span>)</span>
<span id="cb46-190"><a href="#cb46-190" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(quadr)</span>
<span id="cb46-191"><a href="#cb46-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-192"><a href="#cb46-192" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> quadr<span class="sc">$</span>pysal)) <span class="sc">+</span></span>
<span id="cb46-193"><a href="#cb46-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb46-194"><a href="#cb46-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="st">""</span>, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"orange"</span>, <span class="st">"purple"</span>, <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb46-195"><a href="#cb46-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb46-196"><a href="#cb46-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb46-197"><a href="#cb46-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb46-198"><a href="#cb46-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb46-199"><a href="#cb46-199" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Local Moran value groups"</span>,</span>
<span id="cb46-200"><a href="#cb46-200" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with No Schooling"</span></span>
<span id="cb46-201"><a href="#cb46-201" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-202"><a href="#cb46-202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-203"><a href="#cb46-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-204"><a href="#cb46-204" aria-hidden="true" tabindex="-1"></a>Unfortunately, the resulting map is somewhat misleading because not all of the local Moran values are statistically significant and some of the various high-high, low-low, etc. pairings my be only trivially alike or dissimilar. Looking at top of the local Moran data suggests a way of isolating those that are statistically significant and is adopted in the following map.</span>
<span id="cb46-205"><a href="#cb46-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-208"><a href="#cb46-208" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-209"><a href="#cb46-209" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(localm, <span class="at">n =</span> <span class="dv">3</span>)   <span class="co"># The p-values are in column 5</span></span>
<span id="cb46-210"><a href="#cb46-210" aria-hidden="true" tabindex="-1"></a>quadr[localm[,<span class="dv">5</span>] <span class="sc">&gt;</span> <span class="fl">0.05</span>, ] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb46-211"><a href="#cb46-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-212"><a href="#cb46-212" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> quadr<span class="sc">$</span>pysal)) <span class="sc">+</span></span>
<span id="cb46-213"><a href="#cb46-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb46-214"><a href="#cb46-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="st">""</span>, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"orange"</span>, <span class="st">"purple"</span>, <span class="st">"red"</span>), <span class="at">na.value =</span> <span class="st">"grey80"</span>) <span class="sc">+</span></span>
<span id="cb46-215"><a href="#cb46-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb46-216"><a href="#cb46-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb46-217"><a href="#cb46-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb46-218"><a href="#cb46-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb46-219"><a href="#cb46-219" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Statistically significant local Moran value groups"</span>,</span>
<span id="cb46-220"><a href="#cb46-220" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with No Schooling"</span></span>
<span id="cb46-221"><a href="#cb46-221" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-222"><a href="#cb46-222" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-223"><a href="#cb46-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-224"><a href="#cb46-224" aria-hidden="true" tabindex="-1"></a>Arguably, this new map may still not apply a strict enough definition of statistical significance because the issue of repeat testing has not been tackled. Remember, there are 233 places, 233 local Moran values and therefore 233 tests of significance. The p-values can be adjusted for this using R's <span class="in">`p.adjust()`</span> function. The following example uses a false discovery rate method (<span class="in">`method = fdr`</span>) but other alternatives include <span class="in">`method = bonferroni`</span>. A question is whether this is now *too* strict given that there are not 233 independent tests. Rather, the data have overlapping geographies (places share neighbours) as well as spatial dependencies.</span>
<span id="cb46-225"><a href="#cb46-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-228"><a href="#cb46-228" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-229"><a href="#cb46-229" aria-hidden="true" tabindex="-1"></a>quadr[<span class="fu">p.adjust</span>(localm[,<span class="dv">5</span>], <span class="at">method =</span> <span class="st">"fdr"</span>) <span class="sc">&gt;</span> <span class="fl">0.05</span>, ] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb46-230"><a href="#cb46-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-231"><a href="#cb46-231" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> municipal, <span class="fu">aes</span>(<span class="at">fill =</span> quadr<span class="sc">$</span>pysal)) <span class="sc">+</span></span>
<span id="cb46-232"><a href="#cb46-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb46-233"><a href="#cb46-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="st">""</span>, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>), <span class="at">na.value =</span> <span class="st">"grey80"</span>) <span class="sc">+</span></span>
<span id="cb46-234"><a href="#cb46-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb46-235"><a href="#cb46-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb46-236"><a href="#cb46-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb46-237"><a href="#cb46-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb46-238"><a href="#cb46-238" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Statistically significant (p-adjusted) local Moran value groups"</span>,</span>
<span id="cb46-239"><a href="#cb46-239" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with No Schooling"</span></span>
<span id="cb46-240"><a href="#cb46-240" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-241"><a href="#cb46-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-242"><a href="#cb46-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-243"><a href="#cb46-243" aria-hidden="true" tabindex="-1"></a><span class="fu">## Issues with the Moran statistic</span></span>
<span id="cb46-244"><a href="#cb46-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-245"><a href="#cb46-245" aria-hidden="true" tabindex="-1"></a><span class="fu">### How to define neighbours?</span></span>
<span id="cb46-246"><a href="#cb46-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-247"><a href="#cb46-247" aria-hidden="true" tabindex="-1"></a>Any statistic that includes spatial weights is dependent upon how those weights are defined: how, then, to decide which places are neighbours and also how much weight each neighbourhood connection is given in the calculation? The calculations above use first order contiguity (places that share a boundary) but we could extend that definition to include neighbours of neighbours (or more):</span>
<span id="cb46-248"><a href="#cb46-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-251"><a href="#cb46-251" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-252"><a href="#cb46-252" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">nblag</span>(neighbours, <span class="at">maxlag =</span> <span class="dv">2</span>)</span>
<span id="cb46-253"><a href="#cb46-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-254"><a href="#cb46-254" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb46-255"><a href="#cb46-255" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))   <span class="co"># Plot graphics in a 1 row by 2 column grid</span></span>
<span id="cb46-256"><a href="#cb46-256" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"First order contiguity"</span>)</span>
<span id="cb46-257"><a href="#cb46-257" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours[[<span class="dv">1</span>]], pts, <span class="at">add =</span> T)</span>
<span id="cb46-258"><a href="#cb46-258" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"Second order contiguity"</span>)</span>
<span id="cb46-259"><a href="#cb46-259" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours[[<span class="dv">2</span>]], pts, <span class="at">add =</span> T)</span>
<span id="cb46-260"><a href="#cb46-260" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-261"><a href="#cb46-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-262"><a href="#cb46-262" aria-hidden="true" tabindex="-1"></a>Changing the definition of neighbours does, of course, change the Moran statistic and it will change the local Moran values too.</span>
<span id="cb46-263"><a href="#cb46-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-266"><a href="#cb46-266" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-267"><a href="#cb46-267" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(neighbours, \(x) {</span>
<span id="cb46-268"><a href="#cb46-268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nb2listw</span>(x) <span class="sc">%&gt;%</span></span>
<span id="cb46-269"><a href="#cb46-269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, .) <span class="ot">-&gt;</span></span>
<span id="cb46-270"><a href="#cb46-270" aria-hidden="true" tabindex="-1"></a>    moran</span>
<span id="cb46-271"><a href="#cb46-271" aria-hidden="true" tabindex="-1"></a>  moran<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb46-272"><a href="#cb46-272" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb46-273"><a href="#cb46-273" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-274"><a href="#cb46-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-275"><a href="#cb46-275" aria-hidden="true" tabindex="-1"></a>There is no particular reason to stick with a contiguity-based definition. We could, for example, look for the $k$ nearest neighbours (or, more precisely, the $k$ nearest centroids to the centroid of each region), as in the two examples below.</span>
<span id="cb46-276"><a href="#cb46-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-277"><a href="#cb46-277" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width=75}</span>
<span id="cb46-278"><a href="#cb46-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-279"><a href="#cb46-279" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;font</span> <span class="er">size</span> <span class="ot">=</span> <span class="st">3</span><span class="kw">&gt;</span>The function <span class="in">`knearneigh()`</span> contains the default argument, <span class="in">`longlat = NULL`</span>. It should be ok not to change this here to <span class="in">`longlat = TRUE`</span> because it ought to pick this up from <span class="in">`coords`</span>'s coordinate reference system. If you suspect it isn't or if <span class="in">`coords`</span> is simply a matrix of point coordinates, not an explicitly spatial object, change the default argument to <span class="in">`longlat = TRUE`</span>.<span class="kw">&lt;/font&gt;</span></span>
<span id="cb46-280"><a href="#cb46-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-283"><a href="#cb46-283" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-284"><a href="#cb46-284" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb46-285"><a href="#cb46-285" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb46-286"><a href="#cb46-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-287"><a href="#cb46-287" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(coords, <span class="at">k =</span> <span class="dv">5</span>))</span>
<span id="cb46-288"><a href="#cb46-288" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"Five nearest neighbours"</span>)</span>
<span id="cb46-289"><a href="#cb46-289" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours, pts, <span class="at">add =</span> T)</span>
<span id="cb46-290"><a href="#cb46-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-291"><a href="#cb46-291" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(coords, <span class="at">k =</span> <span class="dv">10</span>))</span>
<span id="cb46-292"><a href="#cb46-292" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(municipal), <span class="at">border =</span> <span class="st">"grey"</span>, <span class="at">main =</span> <span class="st">"Ten nearest neighbours"</span>)</span>
<span id="cb46-293"><a href="#cb46-293" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(neighbours, pts, <span class="at">add =</span> T)</span>
<span id="cb46-294"><a href="#cb46-294" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-295"><a href="#cb46-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-296"><a href="#cb46-296" aria-hidden="true" tabindex="-1"></a>In fact, we can run through all the possible values of $k$ (from $1$ to $k_{max} = (n - 1)$ where $n$ is the number of municipalities) and consider the Moran statistics that they generate. The resulting chart shows that the statistic is highly dependent on the scale of the analysis: as $k$ increases, neighbourhood relationships extend over an increasing portion of the map, and the statistic tends to decline. It declines because nearby places tend to have similar values whereas those that are further away are more varied.</span>
<span id="cb46-297"><a href="#cb46-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-298"><a href="#cb46-298" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width=75}</span>
<span id="cb46-299"><a href="#cb46-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-300"><a href="#cb46-300" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;font</span> <span class="er">size</span> <span class="ot">=</span> <span class="st">3</span><span class="kw">&gt;</span>The code will generate a lot of warning messages. You can ignore them. They are warning you that $k$ has become a large subset of all $n$.<span class="kw">&lt;/font&gt;</span></span>
<span id="cb46-301"><a href="#cb46-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-304"><a href="#cb46-304" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-305"><a href="#cb46-305" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(municipal)</span>
<span id="cb46-306"><a href="#cb46-306" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span> (n<span class="dv">-1</span>), \(k) {</span>
<span id="cb46-307"><a href="#cb46-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">knearneigh</span>(coords, k) <span class="sc">%&gt;%</span></span>
<span id="cb46-308"><a href="#cb46-308" aria-hidden="true" tabindex="-1"></a>    knn2nb <span class="sc">%&gt;%</span></span>
<span id="cb46-309"><a href="#cb46-309" aria-hidden="true" tabindex="-1"></a>    nb2listw <span class="sc">%&gt;%</span></span>
<span id="cb46-310"><a href="#cb46-310" aria-hidden="true" tabindex="-1"></a>    <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, .) <span class="ot">-&gt;</span></span>
<span id="cb46-311"><a href="#cb46-311" aria-hidden="true" tabindex="-1"></a>    moran</span>
<span id="cb46-312"><a href="#cb46-312" aria-hidden="true" tabindex="-1"></a>  moran<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb46-313"><a href="#cb46-313" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb46-314"><a href="#cb46-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-315"><a href="#cb46-315" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">k =</span> <span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>), <span class="at">y =</span> y), <span class="fu">aes</span>(<span class="at">x =</span> k, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb46-316"><a href="#cb46-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb46-317"><a href="#cb46-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Moran statistic"</span>)</span>
<span id="cb46-318"><a href="#cb46-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-319"><a href="#cb46-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-320"><a href="#cb46-320" aria-hidden="true" tabindex="-1"></a>In principle the chart could be used to identify an 'optimal' value of $k$. Unfortunately, the present case offers few clues as to what that optimal value should be. The p-value for these statistics is not shown but is least when $k = 27$. That might be a justification, of sorts, for choosing $k = 27$ but it is splitting hairs somewhat when all the p-values are tiny and well below $p = 0.001$.</span>
<span id="cb46-321"><a href="#cb46-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-322"><a href="#cb46-322" aria-hidden="true" tabindex="-1"></a>Other ways of defining neighbours include whether they lie within a lower or upper distance bound of each other: see <span class="in">`?dnearneigh`</span> and <span class="co">[</span><span class="ot">this vignette on Creating Neighbours</span><span class="co">](https://r-spatial.github.io/spdep/articles/nb.html)</span>{target="_blank"}.</span>
<span id="cb46-323"><a href="#cb46-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-324"><a href="#cb46-324" aria-hidden="true" tabindex="-1"></a><span class="fu">### How to interpet the I statistic</span></span>
<span id="cb46-325"><a href="#cb46-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-326"><a href="#cb46-326" aria-hidden="true" tabindex="-1"></a>Conceptually, the Moran statistic is easy to understand: it is a (global) measure of the correlation between the values of a variable at a set of locations, and the value of the same variable for those locations' neighbours. More simply, it is the correlation between locations and their neighbours.</span>
<span id="cb46-327"><a href="#cb46-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-328"><a href="#cb46-328" aria-hidden="true" tabindex="-1"></a>Except it isn't. Or, rather, it is *a* measure of correlation, just not the more commonly used Pearson correlation. The difference is evident in the following comparison where the Moran value is almost half the Pearson correlation between locations and their average neighbour (where the value for the average neighbour is calculated using <span class="in">`last.listw()`</span>).</span>
<span id="cb46-329"><a href="#cb46-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-332"><a href="#cb46-332" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-333"><a href="#cb46-333" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(<span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(coords, <span class="dv">30</span>)))</span>
<span id="cb46-334"><a href="#cb46-334" aria-hidden="true" tabindex="-1"></a>pearson <span class="ot">&lt;-</span> <span class="fu">cor</span>(<span class="fu">lag.listw</span>(spweight, municipal<span class="sc">$</span>No_schooling), municipal<span class="sc">$</span>No_schooling)</span>
<span id="cb46-335"><a href="#cb46-335" aria-hidden="true" tabindex="-1"></a>moran <span class="ot">&lt;-</span> <span class="fu">moran.test</span>(municipal<span class="sc">$</span>No_schooling, spweight)<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb46-336"><a href="#cb46-336" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">person =</span> pearson, <span class="at">moran =</span> moran, <span class="at">row.names =</span> <span class="st">"correlation"</span>)</span>
<span id="cb46-337"><a href="#cb46-337" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-338"><a href="#cb46-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-339"><a href="#cb46-339" aria-hidden="true" tabindex="-1"></a>As <span class="co">[</span><span class="ot">Brunsdon and Comber</span><span class="co">](https://us.sagepub.com/en-us/nam/an-introduction-to-r-for-spatial-analysis-and-mapping/book258267)</span>{targrt="_blank"} note, the value of Moran's I is not constrained to be in the range from -1 to +1 but changes with the spatial weights matrix. Following, [Jong et al. (1984, p. 20)](https://doi.org/10.1111/j.1538-4632.1984.tb00797.x){target="_blank"}, the extremes for the current spatial weights are,</span>
<span id="cb46-340"><a href="#cb46-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-343"><a href="#cb46-343" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-344"><a href="#cb46-344" aria-hidden="true" tabindex="-1"></a><span class="fu">listw2mat</span>(spweight) <span class="sc">%&gt;%</span></span>
<span id="cb46-345"><a href="#cb46-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">range</span>(<span class="fu">eigen</span>((. <span class="sc">+</span> <span class="fu">t</span>(.)) <span class="sc">/</span> <span class="dv">2</span>))</span>
<span id="cb46-346"><a href="#cb46-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-347"><a href="#cb46-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-348"><a href="#cb46-348" aria-hidden="true" tabindex="-1"></a>Not only is this not in the range -1 to 1, it is not symmetric around the expected (null) value of <span class="in">`r round(-1/(nrow(municipal) - 1), 3)`</span>.</span>
<span id="cb46-349"><a href="#cb46-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-350"><a href="#cb46-350" aria-hidden="true" tabindex="-1"></a>Personally, I am not persuaded that the global Moran's value is preferable to the more readily interpreted Pearson correlation between locations and their average neighbour. That correlation with $k = 30$ nearest neighbours was calculated above and is <span class="in">`r round(pearson, 3)`</span>. A confidence interval for this can be calculated using a permutation approach, for example. Given the geography of the South African municipalities, their neighbourhood relations and given the data values, then permuting those values randomly 1000 times around the municipalities generates a 95% confidence interval that the correlation is a long way out of, indicating the positive autocorrelation to be significant. (A permutation approach is also available for the global and local Moran statistics: see <span class="in">`?moran.mc`</span> and <span class="in">`?localmoran_perm`</span>.)</span>
<span id="cb46-351"><a href="#cb46-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-354"><a href="#cb46-354" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-355"><a href="#cb46-355" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(municipal<span class="sc">$</span>No_schooling)</span>
<span id="cb46-356"><a href="#cb46-356" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, \(x) {</span>
<span id="cb46-357"><a href="#cb46-357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample</span>(municipal<span class="sc">$</span>No_schooling, n) <span class="sc">%&gt;%</span> </span>
<span id="cb46-358"><a href="#cb46-358" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cor</span>(<span class="fu">lag.listw</span>(spweight, .))</span>
<span id="cb46-359"><a href="#cb46-359" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span></span>
<span id="cb46-360"><a href="#cb46-360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quantile</span>(<span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb46-361"><a href="#cb46-361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-362"><a href="#cb46-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-363"><a href="#cb46-363" aria-hidden="true" tabindex="-1"></a><span class="fu">## Getis and Ord G-Statistic</span></span>
<span id="cb46-364"><a href="#cb46-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-365"><a href="#cb46-365" aria-hidden="true" tabindex="-1"></a>A different method for identifying 'hot' or 'cold spots' of a variable is provided by the <span class="co">[</span><span class="ot">G-statistic</span><span class="co">](https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-statistics/h-how-hot-spot-analysis-getis-ord-gi-spatial-stati.htm)</span>{target="_blank"}. As [Brunsdon and Comber](https://us.sagepub.com/en-us/nam/an-introduction-to-r-for-spatial-analysis-and-mapping/book258267){targrt="_blank"} observe, the statistic -- which is a local statistic, calculated for each location in turn -- is</span>
<span id="cb46-366"><a href="#cb46-366" aria-hidden="true" tabindex="-1"></a>based on the proportion of the total sum of standardised attribute values that are within a threshold distance, $d$, of each area centroid. Looking at the map below, which is of South African wards (simplified slightly from <span class="co">[</span><span class="ot">this source</span><span class="co">](https://africaopendata.org/dataset/mdb-wards-2016/resource/d85c5e06-814d-4563-a938-3050e0e6b7e2?inner_span=True)</span>{target="_true"}), we may suspect there are clusters of places with greater percentages of their populations having relatively high incomes and that these are spatial anomalies. Because the percentages are extremely skewed, they have been plotted with a square root transformation applied to the scale of the map (<span class="in">`trans = "sqrt"`</span>) -- notice how the values 0 to 4% (which are the original values, not the square roots) occupy more of the legend than the values 4 to 8 do, and so forth.</span>
<span id="cb46-367"><a href="#cb46-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-370"><a href="#cb46-370" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-371"><a href="#cb46-371" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/blob/main/MandM/workspaces/wards.RData?raw=true"</span>, <span class="st">"wards.RData"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-372"><a href="#cb46-372" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"wards.RData"</span>)</span>
<span id="cb46-373"><a href="#cb46-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-374"><a href="#cb46-374" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> wards, <span class="fu">aes</span>(<span class="at">fill =</span> High_income)) <span class="sc">+</span></span>
<span id="cb46-375"><a href="#cb46-375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">colour =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb46-376"><a href="#cb46-376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="st">"%"</span>, <span class="at">guide =</span> <span class="st">"colourbar"</span>, <span class="at">direction =</span> <span class="dv">1</span>, <span class="at">trans =</span> <span class="st">"sqrt"</span>,</span>
<span id="cb46-377"><a href="#cb46-377" aria-hidden="true" tabindex="-1"></a>                       <span class="at">palette =</span> <span class="st">"Reds"</span>) <span class="sc">+</span></span>
<span id="cb46-378"><a href="#cb46-378" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb46-379"><a href="#cb46-379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb46-380"><a href="#cb46-380" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb46-381"><a href="#cb46-381" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Percentage of Population with income R614401 or greater"</span>,</span>
<span id="cb46-382"><a href="#cb46-382" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2011 South African Census Data"</span>,</span>
<span id="cb46-383"><a href="#cb46-383" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Statistics South Africa"</span></span>
<span id="cb46-384"><a href="#cb46-384" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-385"><a href="#cb46-385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-386"><a href="#cb46-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-387"><a href="#cb46-387" aria-hidden="true" tabindex="-1"></a>The G-statistic requires a binary spatial weights (<span class="in">`style = "B"`</span>, below), whereby locations either are or are not within the threshold distance of each other. The following has a threshold distance of 20km. Not all of the ward centroids will be within 20km of another which creates situations of zero neighbours, which is tolerated by setting <span class="in">`zero.policy = TRUE`</span> in the conversion from a neighbours to spatial list.</span>
<span id="cb46-388"><a href="#cb46-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-389"><a href="#cb46-389" aria-hidden="true" tabindex="-1"></a><span class="al">![](hazard.gif)</span>{width=75}</span>
<span id="cb46-390"><a href="#cb46-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-391"><a href="#cb46-391" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;font</span> <span class="er">size</span> <span class="ot">=</span> <span class="st">3</span><span class="kw">&gt;</span>As with the function <span class="in">`knearneigh()`</span>, <span class="in">`dnearneigh()`</span> has the default argument, <span class="in">`longlat = NULL`</span>, which should not need changing here to <span class="in">`longlat = TRUE`</span> because it ought to pick this up from <span class="in">`coords`</span>'s coordinate reference system. However, don't take this for granted.<span class="kw">&lt;/font&gt;</span></span>
<span id="cb46-392"><a href="#cb46-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-395"><a href="#cb46-395" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-396"><a href="#cb46-396" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(wards, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-397"><a href="#cb46-397" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb46-398"><a href="#cb46-398" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-399"><a href="#cb46-399" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(wards<span class="sc">$</span>High_income, spweight)</span>
<span id="cb46-400"><a href="#cb46-400" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-401"><a href="#cb46-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-402"><a href="#cb46-402" aria-hidden="true" tabindex="-1"></a>Having calculated the local G values, we can map them, using a manually generated fill palette. The argument <span class="in">`na.translate = F`</span> removes the NA values from the legend but not from the map, wherein they are shaded white (<span class="in">`na.value = "white"`</span>). The G values are also standardised z-values, hence values of 1.96 or greater are relatively rate if the assumption that the statistic is Normally distributed is warranted. (If it isn't, consider using <span class="in">`localG_perm`</span>.) </span>
<span id="cb46-403"><a href="#cb46-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-406"><a href="#cb46-406" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-407"><a href="#cb46-407" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>, <span class="fu">max</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb46-408"><a href="#cb46-408" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(wards<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-409"><a href="#cb46-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-410"><a href="#cb46-410" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb46-411"><a href="#cb46-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-412"><a href="#cb46-412" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb46-413"><a href="#cb46-413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp), <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb46-414"><a href="#cb46-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"G"</span>, <span class="at">values =</span> pal, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb46-415"><a href="#cb46-415" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb46-416"><a href="#cb46-416" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb46-417"><a href="#cb46-417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb46-418"><a href="#cb46-418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb46-419"><a href="#cb46-419" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb46-420"><a href="#cb46-420" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Local G statistic"</span>,</span>
<span id="cb46-421"><a href="#cb46-421" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with income R614401 or greater"</span>,</span>
<span id="cb46-422"><a href="#cb46-422" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"With a 20km threshold"</span></span>
<span id="cb46-423"><a href="#cb46-423" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-424"><a href="#cb46-424" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-425"><a href="#cb46-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-426"><a href="#cb46-426" aria-hidden="true" tabindex="-1"></a>Let's now add a refinement to the map and, based on what we learned from the previous session, label the cities that appear to contain a hot spot of higher percentages of higher earners. Note the use of <span class="in">`st_join()`</span> which is a spatial join: it identifies, from geography, which ward the cities are located in and appends the ward data, including the G statistics, to the cities, retaining only those that are in the most significant hot spots. Note that this definition of 'most significant' doesn't address the problem of repeat testing which we also saw with the local Moran statistics and, of course, the results are dependent on the distance threshold defining which places are or are not neighbours.</span>
<span id="cb46-427"><a href="#cb46-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-430"><a href="#cb46-430" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-431"><a href="#cb46-431" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"remotes"</span> <span class="sc">%in%</span> installed)) <span class="fu">install.packages</span>(<span class="st">"remotes"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-432"><a href="#cb46-432" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>(<span class="st">"ggsflabel"</span> <span class="sc">%in%</span> installed)) remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"yutannihilation/ggsflabel"</span>)</span>
<span id="cb46-433"><a href="#cb46-433" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggsflabel)</span>
<span id="cb46-434"><a href="#cb46-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-435"><a href="#cb46-435" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"hotosm_zaf_populated_places_points.shp"</span>)) {</span>
<span id="cb46-436"><a href="#cb46-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(<span class="st">"https://github.com/profrichharris/profrichharris.github.io/blob/main/MandM/boundary%20files/hotosm_zaf_populated_places_points_shp.zip?raw=true"</span>,</span>
<span id="cb46-437"><a href="#cb46-437" aria-hidden="true" tabindex="-1"></a>              <span class="st">"cities.zip"</span>, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-438"><a href="#cb46-438" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unzip</span>(<span class="st">"cities.zip"</span>)</span>
<span id="cb46-439"><a href="#cb46-439" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-440"><a href="#cb46-440" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-441"><a href="#cb46-441" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(<span class="st">"hotosm_zaf_populated_places_points.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-442"><a href="#cb46-442" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(place <span class="sc">==</span> <span class="st">"city"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-443"><a href="#cb46-443" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(wards) <span class="sc">%&gt;%</span></span>
<span id="cb46-444"><a href="#cb46-444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(localG <span class="sc">&gt;</span> <span class="fl">3.29</span>) <span class="ot">-&gt;</span></span>
<span id="cb46-445"><a href="#cb46-445" aria-hidden="true" tabindex="-1"></a>  cities</span>
<span id="cb46-446"><a href="#cb46-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-447"><a href="#cb46-447" aria-hidden="true" tabindex="-1"></a><span class="fu">last_plot</span>() <span class="sc">+</span></span>
<span id="cb46-448"><a href="#cb46-448" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_label_repel</span>(<span class="at">data =</span> cities,</span>
<span id="cb46-449"><a href="#cb46-449" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">aes</span>(<span class="at">label =</span> name), <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb46-450"><a href="#cb46-450" aria-hidden="true" tabindex="-1"></a>                      <span class="at">max.overlaps =</span> <span class="dv">20</span>,</span>
<span id="cb46-451"><a href="#cb46-451" aria-hidden="true" tabindex="-1"></a>                      <span class="at">force =</span> <span class="dv">2</span>)</span>
<span id="cb46-452"><a href="#cb46-452" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-453"><a href="#cb46-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-454"><a href="#cb46-454" aria-hidden="true" tabindex="-1"></a>Here are the results with a distance threshold of 100km.</span>
<span id="cb46-455"><a href="#cb46-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-458"><a href="#cb46-458" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-459"><a href="#cb46-459" aria-hidden="true" tabindex="-1"></a>neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb46-460"><a href="#cb46-460" aria-hidden="true" tabindex="-1"></a>spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-461"><a href="#cb46-461" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(wards<span class="sc">$</span>High_income, spweight)</span>
<span id="cb46-462"><a href="#cb46-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-463"><a href="#cb46-463" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb46-464"><a href="#cb46-464" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(wards<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb46-465"><a href="#cb46-465" aria-hidden="true" tabindex="-1"></a>wards<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(wards<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-466"><a href="#cb46-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-467"><a href="#cb46-467" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb46-468"><a href="#cb46-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-469"><a href="#cb46-469" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb46-470"><a href="#cb46-470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp), <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb46-471"><a href="#cb46-471" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"G"</span>, <span class="at">values =</span> pal, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb46-472"><a href="#cb46-472" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb46-473"><a href="#cb46-473" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb46-474"><a href="#cb46-474" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb46-475"><a href="#cb46-475" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb46-476"><a href="#cb46-476" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb46-477"><a href="#cb46-477" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Local G statistic"</span>,</span>
<span id="cb46-478"><a href="#cb46-478" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of Population with income R614401 or greater"</span>,</span>
<span id="cb46-479"><a href="#cb46-479" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"With a 100km threshold"</span></span>
<span id="cb46-480"><a href="#cb46-480" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb46-481"><a href="#cb46-481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_label_repel</span>(<span class="at">data =</span> cities,</span>
<span id="cb46-482"><a href="#cb46-482" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">aes</span>(<span class="at">label =</span> name), <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb46-483"><a href="#cb46-483" aria-hidden="true" tabindex="-1"></a>                      <span class="at">max.overlaps =</span> <span class="dv">20</span>,</span>
<span id="cb46-484"><a href="#cb46-484" aria-hidden="true" tabindex="-1"></a>                      <span class="at">force =</span> <span class="dv">2</span>)</span>
<span id="cb46-485"><a href="#cb46-485" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-486"><a href="#cb46-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-487"><a href="#cb46-487" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb46-488"><a href="#cb46-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-489"><a href="#cb46-489" aria-hidden="true" tabindex="-1"></a>This session has been about identifying and quantifying spatial clustering in data, using a combination of 'global' (whole map) and local statistics; specifically, Moran's I, its local equivalent and the Getis-Ord G statistic. These statistics are dependent on the spatial weights matrix used in their calculation, which does, unfortunately, create something of a vicious circle: ideally that matrix would be calibrated to the spatial patterns evident in the data but they are only evident once the weights matrix has been specified. One option is to take the view that looking at the patterns at a range of scales is itself revealing so choose lots of bandwidths, not just one, and treat it as a multiscale analysis, as in the following.</span>
<span id="cb46-490"><a href="#cb46-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-493"><a href="#cb46-493" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-494"><a href="#cb46-494" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 6</span></span>
<span id="cb46-495"><a href="#cb46-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-496"><a href="#cb46-496" aria-hidden="true" tabindex="-1"></a><span class="co"># Sets the threshold distance from 20 to 180km in intervals of 20</span></span>
<span id="cb46-497"><a href="#cb46-497" aria-hidden="true" tabindex="-1"></a><span class="co"># I chose 9 distances because they can be shown in a 3 x 3 grid of maps</span></span>
<span id="cb46-498"><a href="#cb46-498" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">20</span>, <span class="at">by =</span> <span class="dv">20</span>, <span class="at">length.out =</span> <span class="dv">9</span>)</span>
<span id="cb46-499"><a href="#cb46-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-500"><a href="#cb46-500" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the G statistics for each distance and save them</span></span>
<span id="cb46-501"><a href="#cb46-501" aria-hidden="true" tabindex="-1"></a><span class="co"># as a list of sf features (maps)</span></span>
<span id="cb46-502"><a href="#cb46-502" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(wards, <span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-503"><a href="#cb46-503" aria-hidden="true" tabindex="-1"></a>maps <span class="ot">&lt;-</span> <span class="fu">lapply</span>(d, \(x) {</span>
<span id="cb46-504"><a href="#cb46-504" aria-hidden="true" tabindex="-1"></a>  neighbours <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="dv">0</span>, x)</span>
<span id="cb46-505"><a href="#cb46-505" aria-hidden="true" tabindex="-1"></a>  spweight <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbours, <span class="at">style =</span> <span class="st">"B"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-506"><a href="#cb46-506" aria-hidden="true" tabindex="-1"></a>  wards<span class="sc">$</span>localG <span class="ot">&lt;-</span> <span class="fu">localG</span>(wards<span class="sc">$</span>High_income, spweight)</span>
<span id="cb46-507"><a href="#cb46-507" aria-hidden="true" tabindex="-1"></a>  wards<span class="sc">$</span>distance <span class="ot">&lt;-</span> x</span>
<span id="cb46-508"><a href="#cb46-508" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(wards)</span>
<span id="cb46-509"><a href="#cb46-509" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb46-510"><a href="#cb46-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-511"><a href="#cb46-511" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind the maps together into a single object to be used</span></span>
<span id="cb46-512"><a href="#cb46-512" aria-hidden="true" tabindex="-1"></a><span class="co"># for the faceting in ggplot2</span></span>
<span id="cb46-513"><a href="#cb46-513" aria-hidden="true" tabindex="-1"></a>maps <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, maps)</span>
<span id="cb46-514"><a href="#cb46-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-515"><a href="#cb46-515" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(maps<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="sc">-</span><span class="fl">3.29</span>, <span class="sc">-</span><span class="fl">2.58</span>, <span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>, <span class="fl">2.58</span>, <span class="fl">3.29</span>,</span>
<span id="cb46-516"><a href="#cb46-516" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(maps<span class="sc">$</span>localG, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb46-517"><a href="#cb46-517" aria-hidden="true" tabindex="-1"></a>maps<span class="sc">$</span>localG_gp <span class="ot">&lt;-</span> <span class="fu">cut</span>(maps<span class="sc">$</span>localG, brks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-518"><a href="#cb46-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-519"><a href="#cb46-519" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"purple"</span>, <span class="st">"dark blue"</span>, <span class="st">"light blue"</span>, <span class="st">"light grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>)</span>
<span id="cb46-520"><a href="#cb46-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-521"><a href="#cb46-521" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> maps, <span class="fu">aes</span>(<span class="at">fill =</span> localG_gp)) <span class="sc">+</span></span>
<span id="cb46-522"><a href="#cb46-522" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb46-523"><a href="#cb46-523" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"G"</span>, <span class="at">values =</span> pal, <span class="at">na.value =</span> <span class="st">"white"</span>,</span>
<span id="cb46-524"><a href="#cb46-524" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.translate =</span> F) <span class="sc">+</span></span>
<span id="cb46-525"><a href="#cb46-525" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> distance) <span class="sc">+</span></span>
<span id="cb46-526"><a href="#cb46-526" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb46-527"><a href="#cb46-527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb46-528"><a href="#cb46-528" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb46-529"><a href="#cb46-529" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb46-530"><a href="#cb46-530" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb46-531"><a href="#cb46-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb46-532"><a href="#cb46-532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-533"><a href="#cb46-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-534"><a href="#cb46-534" aria-hidden="true" tabindex="-1"></a><span class="fu">## Further Reading</span></span>
<span id="cb46-535"><a href="#cb46-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-536"><a href="#cb46-536" aria-hidden="true" tabindex="-1"></a><span class="al">![](Rspatial.jpg)</span>{width=100}</span>
<span id="cb46-537"><a href="#cb46-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-538"><a href="#cb46-538" aria-hidden="true" tabindex="-1"></a>Chapter 8 on Localised Spatial Analysis in <span class="co">[</span><span class="ot">An Introduction to R for Spatial Analysis &amp; Mapping</span><span class="co">](https://us.sagepub.com/en-us/nam/an-introduction-to-r-for-spatial-analysis-and-mapping/book258267)</span>{target="_blank"} by Chris Brunsdon and Lex Comber.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2022-2023, Richard Harris</div>   
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/profrichharris">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>